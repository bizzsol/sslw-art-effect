<?php
bolt_decrypt( __FILE__ , 'yxQ5HA'); return 0;
##!!!##CgpuYW1lc3BhY2UgQXBwXEh0dHBcQ29udHJvbGxlcnNcUG1zOwoKdXNlIEFwcFxIdHRwXENvbnRyb2xsZXJzXENvbnRyb2xsZXI7Cgp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHJvZHVjdDsKdXNlIEFwcFxNb2RlbHNcSHJcRGVwYXJ0bWVudDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb25EZWxpdmVyeTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uRGVsaXZlcnlJdGVtOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb25JdGVtOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb25UcmFja2luZzsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uVHlwZTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFN1cHBsaWVyczsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFdhcmVob3VzZXM7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xOb3RpZmljYXRpb247CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xDYXRlZ29yeTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFB1cmNoYXNlXFB1cmNoYXNlT3JkZXI7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xJbnZlbnRvcnlNb2RlbHNcSW52ZW50b3J5U3VtbWFyeTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXEludmVudG9yeU1vZGVsc1xJbnZlbnRvcnlEZXRhaWxzOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcSW52ZW50b3J5TW9kZWxzXEludmVudG9yeUxvZ3M7CnVzZSBBcHBcTW9kZWxzXEZpeGVkQXNzZXRzXEZpeGVkQXNzZXRCYXRjaDsKdXNlIEFwcFxNb2RlbHNcRml4ZWRBc3NldHNcRml4ZWRBc3NldEJhdGNoSXRlbTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXEFjY291bnRzXENvc3RDZW50cmU7CnVzZSBcQXBwXFVzZXI7Cgp1c2UgSWxsdW1pbmF0ZVxIdHRwXFJlcXVlc3Q7CnVzZSBJbGx1bWluYXRlXFN1cHBvcnRcRmFjYWRlc1xBdXRoOwp1c2UgSWxsdW1pbmF0ZVxTdXBwb3J0XEZhY2FkZXNcVmlldzsKdXNlIERCLFZhbGlkYXRvciwgU3RyOwp1c2UgRGF0YVRhYmxlczsKCmNsYXNzIFN0b3JlQ29udHJvbGxlciBleHRlbmRzIENvbnRyb2xsZXIKewogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiBoZWFkZXJDb2x1bW5zKCR2YWx1ZT0nJykKICAgIHsKICAgICAgICAkcm93PSBhcnJheSgKICAgICAgICAgICAgWydTTCcsICdTTCddLCAKICAgICAgICAgICAgWydyZWZlcmVuY2Vfbm8nLCAncmVmZXJlbmNlX25vJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsncmVxdWlzaXRpb25fZGF0ZScsICdyZXF1aXNpdGlvbl9kYXRlJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnZGVwYXJ0bWVudCcsICdkZXBhcnRtZW50JywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsncHJvZHVjdF9jYXRlZ29yeScsICdwcm9kdWN0X2NhdGVnb3J5JywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnYXBwcm92ZWRfYnknLCAnYXBwcm92ZWRfYnknLCAndGV4dC1sZWZ0J10sIAogICAgICAgICAgICBbJ3JlcXVpc2l0aW9uX2J5JywgJ3JlcXVpc2l0aW9uX2J5JywgJ3RleHQtbGVmdCddLCAgCiAgICAgICAgICAgIFsnZGVsaXZlcnknLCAnZGVsaXZlcnknLCAndGV4dC1sZWZ0J10sICAKICAgICAgICAgICAgWydhY3Rpb25zJywgJ2FjdGlvbnMnLCAndGV4dC1jZW50ZXInLCd3aWR0aDoxNSUnXQogICAgICAgICk7CiAgICAgICAgcmV0dXJuICRyb3c7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGluZGV4KCRkZWxpdmVyeVN0YXR1cz1udWxsKQogICAgeyAgIAogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRoZWFkZXJDb2x1bW5zPSR0aGlzLT5oZWFkZXJDb2x1bW5zKCk7CgogICAgICAgICAgICAkdGl0bGUgPSAoIWVtcHR5KCRkZWxpdmVyeVN0YXR1cykgPyAnQ29tcGxldGUnIDogJ1BlbmRpbmcnKS4nIERlbGl2ZXJ5IGxpc3QgZm9yIFJlcXVpc2l0aW9uJzsKICAgICAgICAgICAgJGRlbGl2ZXJ5U3RhdHVzPSRkZWxpdmVyeVN0YXR1cz8/J3BhcnRpYWwtZGVsaXZlcmVkJzsKCiAgICAgICAgICAgICRyZXF1aXNpdGlvbnM9UmVxdWlzaXRpb246OndpdGgoJ3JlbFVzZXJzTGlzdCcsJ3JlcXVpc2l0aW9uSXRlbXMnLCdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5JywncmVsUmVxdWlzaXRpb25EZWxpdmVyeS5yZWxEZWxpdmVyeUl0ZW1zJykKICAgICAgICAgICAgLT53aGVuKGlzc2V0KGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfdW5pdF9pZCksIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaHJfdW5pdF9pZCcsYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc191bml0X2lkKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZShbJ3N0YXR1cyc9PjEsJ2RlbGl2ZXJ5X3N0YXR1cyc9PiRkZWxpdmVyeVN0YXR1c10pCiAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ3JlZmVyZW5jZV9ubycsICdkZXNjJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICAKICAgICAgICAgICAgJG9wdGlvbnM9WwogICAgICAgICAgICAgICAgJ2NvbmZpcm0tZGVsaXZlcnknPT5hdXRoKCktPnVzZXIoKS0+aGFzUGVybWlzc2lvblRvKCdjb25maXJtLWRlbGl2ZXJ5JyksCiAgICAgICAgICAgICAgICAnc2VuZC10by1yZnAnPT5hdXRoKCktPnVzZXIoKS0+aGFzUGVybWlzc2lvblRvKCdzZW5kLXRvLXJmcCcpCiAgICAgICAgICAgIF07CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5hamF4KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhdGFibGVzOjpvZigkcmVxdWlzaXRpb25zKQogICAgICAgICAgICAgICAgLT5hZGRJbmRleENvbHVtbigpCiAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3JlZmVyZW5jZV9ubycsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAgJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgb25jbGljaz0ib3Blbk1vZGFsKCcuJHZhbHVlcy0+aWQuJykiICBjbGFzcz0iYnRuIGJ0bi1saW5rIj4nLiR2YWx1ZXMtPnJlZmVyZW5jZV9uby4nPC9hPic7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdyZXF1aXNpdGlvbl9kYXRlJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGUoJ1ktbS1kJywgc3RydG90aW1lKCR2YWx1ZXMtPnJlcXVpc2l0aW9uX2RhdGUpKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncmVxdWlzaXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncmVxdWlzaXRpb25fZGF0ZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncmVxdWlzaXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ3JlcXVpc2l0aW9uX2RhdGUnLCAkb3JkZXIpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdkZXBhcnRtZW50JywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCR2YWx1ZXMtPnJlbFVzZXJzTGlzdC0+ZW1wbG95ZWUtPmRlcGFydG1lbnQtPmhyX2RlcGFydG1lbnRfbmFtZSk/JHZhbHVlcy0+cmVsVXNlcnNMaXN0LT5lbXBsb3llZS0+ZGVwYXJ0bWVudC0+aHJfZGVwYXJ0bWVudF9uYW1lOicnOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdkZXBhcnRtZW50JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsVXNlcnNMaXN0LmVtcGxveWVlLmRlcGFydG1lbnQnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnaHJfZGVwYXJ0bWVudF9uYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdkZXBhcnRtZW50JywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgVXNlcjo6c2VsZWN0KCdocl9kZXBhcnRtZW50LmhyX2RlcGFydG1lbnRfbmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignaHJfYXNfYmFzaWNfaW5mbycsICdocl9hc19iYXNpY19pbmZvLmFzc29jaWF0ZV9pZCcsICc9JywgJ3VzZXJzLmFzc29jaWF0ZV9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignaHJfZGVwYXJ0bWVudCcsICdocl9kZXBhcnRtZW50LmhyX2RlcGFydG1lbnRfaWQnLCAnPScsICdocl9hc19iYXNpY19pbmZvLmFzX2RlcGFydG1lbnRfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCd1c2Vycy5pZCcsICdyZXF1aXNpdGlvbnMuYXV0aG9yX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncHJvZHVjdF9jYXRlZ29yeScsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkdmFsdWVzLT5pdGVtc1swXS0+cHJvZHVjdC0+Y2F0ZWdvcnktPmNhdGVnb3J5LT5uYW1lKT8kdmFsdWVzLT5pdGVtc1swXS0+cHJvZHVjdC0+Y2F0ZWdvcnktPmNhdGVnb3J5LT5uYW1lOicnOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnaXRlbXMucHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWlzaXRpb25JdGVtOjpzZWxlY3QoJ21haW5fY2F0ZWdvcnkubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncHJvZHVjdHMnLCAncHJvZHVjdHMuaWQnLCAnPScsICdyZXF1aXNpdGlvbl9pdGVtcy5wcm9kdWN0X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdjYXRlZ29yaWVzIGFzIHN1Yl9jYXRlZ29yeScsICdzdWJfY2F0ZWdvcnkuaWQnLCAnPScsICdwcm9kdWN0cy5jYXRlZ29yeV9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignY2F0ZWdvcmllcyBhcyBtYWluX2NhdGVnb3J5JywgJ21haW5fY2F0ZWdvcnkuaWQnLCAnPScsICdzdWJfY2F0ZWdvcnkucGFyZW50X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncmVxdWlzaXRpb25faXRlbXMucmVxdWlzaXRpb25faWQnLCAncmVxdWlzaXRpb25zLmlkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYXBwcm92ZWRfYnknLCBmdW5jdGlvbigkdmFsdWVzKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHZhbHVlcy0+YXBwcm92ZWRCeS0+bmFtZSk/ICR2YWx1ZXMtPmFwcHJvdmVkQnktPm5hbWUgOicnOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdhcHByb3ZlZF9ieScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ2FwcHJvdmVkQnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignYXBwcm92ZWRfYnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBVc2VyOjpzZWxlY3QoJ3VzZXJzLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCd1c2Vycy5pZCcsICdyZXF1aXNpdGlvbnMuYXBwcm92ZWRfYnknKQogICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1aXNpdGlvbl9ieScsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkdmFsdWVzLT5yZWxVc2Vyc0xpc3QtPm5hbWUpPyAkdmFsdWVzLT5yZWxVc2Vyc0xpc3QtPm5hbWUgOicnOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZXF1aXNpdGlvbl9ieScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFVzZXJzTGlzdCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdyZXF1aXNpdGlvbl9ieScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFVzZXI6OnNlbGVjdCgndXNlcnMubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3VzZXJzLmlkJywgJ3JlcXVpc2l0aW9ucy5hdXRob3JfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdkZWxpdmVyeScsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGEgaHJlZj0iJy5yb3V0ZSgncG1zLnN0b3JlLW1hbmFnZS5yZXF1aXNpdGlvbi1kZWxpdmVyZWQtbGlzdCcsJHZhbHVlcy0+aWQpLiciIGRhdGEtdG9nZ2xlPSJ0b29sdGlwIiB0aXRsZT0iQ2xpY2sgaGVyZSB0byB2aWV3IGRldGFpbHMiIHRhcmdldD0iX2JsYW5rIj4gVG90YWwgKCcuY291bnQoJHZhbHVlcy0+cmVsUmVxdWlzaXRpb25EZWxpdmVyeSkuJyk8L2E+JzsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYWN0aW9ucycsIGZ1bmN0aW9uKCR2YWx1ZXMpIHVzZSgkb3B0aW9ucyl7CiAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgPSAnJzsKICAgICAgICAgICAgICAgICAgICBpZiAoJHZhbHVlcy0+ZGVsaXZlcnlfc3RhdHVzPT0nZGVsaXZlcmVkJykgewogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucy49JzxzcGFuPkZ1bGwgRGVsaXZlcmVkPC9zcGFuPic7CiAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zLj0nPGRpdiBjbGFzcz0iYnRuLWdyb3VwIj48YnV0dG9uIGNsYXNzPSJidG4gZHJvcGRvd24tdG9nZ2xlIiBkYXRhLXRvZ2dsZT0iZHJvcGRvd24iPjxzcGFuIGlkPSJzdGF0dXNOYW1lJy4kdmFsdWVzLT5pZC4nIj5BY3Rpb248L3NwYW4+PC9idXR0b24+PHVsIGNsYXNzPSJkcm9wZG93bi1tZW51Ij4nOwoKICAgICAgICAgICAgICAgICAgICAgICAgaWYoJG9wdGlvbnNbJ2NvbmZpcm0tZGVsaXZlcnknXSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihyZXF1aXNpdGlvbkhhc1N0b2NrKCR2YWx1ZXMtPmlkKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0nPGxpPjxhIGhyZWY9Iicucm91dGUoJ3Btcy5zdG9yZS1tYW5hZ2Uuc3RvcmUtcmVxdWlzaXRpb24uZGVsaXZlcnknLCR2YWx1ZXMtPmlkKS4nIiB0aXRsZT0iQ2xpY2sgSGVyZSBUbyBDb25maXJtIERlbGl2ZXJ5Ij5Db25maXJtIERlbGl2ZXJ5PC9hPjwvbGk+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYoJG9wdGlvbnNbJ3NlbmQtdG8tcmZwJ10pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoJHZhbHVlcy0+cmVxdWVzdF9zdGF0dXM9PU5VTEwgJiYgJHZhbHVlcy0+aXNfcG9fZ2VuZXJhdGU9PSdubycpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49JzxsaSBpZD0iaGlkZUZyb21MaXN0Jy4kdmFsdWVzLT5pZC4nIj48YSBjbGFzcz0ic2VuZFRvUHVyY2hhc2VEZXBhcnRtZW50IiBvbmNsaWNrPSJzZW5kVG9QdXJjaGFzZURlcGFydG1lbnQoJCh0aGlzKSkiIGRhdGEtc3JjPSInLnJvdXRlKCdwbXMuc3RvcmUtbWFuYWdlLmNoYW5nZS5hY3Rpb24udG8ucmZwJykuJyIgZGF0YS1pZD0iJy4kdmFsdWVzLT5pZC4nIiAgdGl0bGU9IlNlbmQgVG8gUHJvY3VyZW1lbnQgIj5TZW5kIFRvIFByb2N1cmVtZW50PC9hPjwvbGk+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMuPSc8L3VsPjwvZGl2Pic7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiAkYWN0aW9uczsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydyZWZlcmVuY2Vfbm8nLCdkZWxpdmVyeScsJ2FjdGlvbnMnXSkKICAgICAgICAgICAgICAgIC0+bWFrZSh0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnJlcXVpc2l0aW9uLWRlbGl2ZXJ5LmluZGV4JywgY29tcGFjdCgndGl0bGUnLCdoZWFkZXJDb2x1bW5zJykpOwoKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIHN0b3JlSGVhZGVyQ29sdW1ucygkdmFsdWU9JycpCiAgICB7CiAgICAgICAgJHJvdyA9IGFycmF5KAogICAgICAgICAgICBbJ1NMJywgJ1NMJ10sIAogICAgICAgICAgICBbJ3JlZmVyZW5jZV9ubycsICdyZWZlcmVuY2Vfbm8nLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydyZXF1aXNpdGlvbl9kYXRlJywgJ3JlcXVpc2l0aW9uX2RhdGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydkZXBhcnRtZW50JywgJ2RlcGFydG1lbnQnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydwcm9kdWN0X2NhdGVnb3J5JywgJ3Byb2R1Y3RfY2F0ZWdvcnknLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydhcHByb3ZlZF9ieScsICdhcHByb3ZlZF9ieScsICd0ZXh0LWxlZnQnXSwgCiAgICAgICAgICAgIFsnYWN0aW9ucycsICdhY3Rpb25zJywgJ3RleHQtY2VudGVyJywnd2lkdGg6MTUlJ10KICAgICAgICApOwogICAgICAgIHJldHVybiAkcm93OwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBzdG9yZVJlcXVpc2l0aW9uTGlzdFZpZXcoKQogICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgICR0aXRsZSA9ICdTdG9yZSBSZXF1aXNpdGlvbiBMaXN0IFZpZXcnOwogICAgICAgICAgICAkdXNlclVuaXRzID0gYXV0aCgpLT51c2VyKCktPnByaW9yaXRpZXMtPnBsdWNrKCdocl91bml0X2lkJyktPnRvQXJyYXkoKTsKICAgICAgICAgICAgJHVzZXJEZXBhcnRtZW50cyA9IGF1dGgoKS0+dXNlcigpLT5wcmlvcml0aWVzLT5wbHVjaygnaHJfZGVwYXJ0bWVudF9pZCcpLT50b0FycmF5KCk7CiAgICAgICAgICAgICR1c2VyU2VjdGlvbnMgPSBhdXRoKCktPnVzZXIoKS0+cHJpb3JpdGllcy0+cGx1Y2soJ2hyX3NlY3Rpb25faWQnKS0+dG9BcnJheSgpOwoKICAgICAgICAgICAgJGZyb20gPSByZXF1ZXN0KCktPmhhcygnZnJvbScpID8gcmVxdWVzdCgpLT5nZXQoJ2Zyb20nKSA6IGRhdGUoJ1ktbS0wMScpOwogICAgICAgICAgICAkdG8gPSByZXF1ZXN0KCktPmhhcygndG8nKSA/IHJlcXVlc3QoKS0+Z2V0KCd0bycpIDogZGF0ZSgnWS1tLXQnKTsKICAgICAgICAgICAgJGNhdGVnb3J5X2lkID0gcmVxdWVzdCgpLT5oYXMoJ2NhdGVnb3J5X2lkJykgPyByZXF1ZXN0KCktPmdldCgnY2F0ZWdvcnlfaWQnKSA6IDA7CiAgICAgICAgICAgICRkZXBhcnRtZW50X2lkID0gcmVxdWVzdCgpLT5oYXMoJ2RlcGFydG1lbnRfaWQnKSA/IHJlcXVlc3QoKS0+Z2V0KCdkZXBhcnRtZW50X2lkJykgOiAwOwogICAgICAgICAgICAkYXBwcm92ZWRfYnkgPSByZXF1ZXN0KCktPmhhcygnYXBwcm92ZWRfYnknKSA/IHJlcXVlc3QoKS0+Z2V0KCdhcHByb3ZlZF9ieScpIDogMDsKCiAgICAgICAgICAgICRjYXRlZ29yaWVzID0gQ2F0ZWdvcnk6OmRvZXNudEhhdmUoJ2NhdGVnb3J5JykKICAgICAgICAgICAgLT5nZXQoKTsKCiAgICAgICAgICAgICRkZXBhcnRtZW50cyA9IERlcGFydG1lbnQ6OndoZXJlSW4oJ2hyX2RlcGFydG1lbnRfaWQnLCAkdXNlckRlcGFydG1lbnRzKS0+Z2V0KCk7CgogICAgICAgICAgICAkYXBwcm92ZXJzID0gUmVxdWlzaXRpb246OndoZW4oaXNzZXQoYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc191bml0X2lkKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUnLGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2FzX3VuaXRfaWQnLCBhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX3VuaXRfaWQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+Z3JvdXBCeSgnYXBwcm92ZWRfYnknKQogICAgICAgICAgICAtPndoZXJlKFsnc3RhdHVzJz0+MSwnZGVsaXZlcnlfc3RhdHVzJz0+J3Byb2Nlc3NpbmcnLCdpc19zZW5kX3RvX3JmcCc9PidubyddKQogICAgICAgICAgICAtPndoZXJlTm90SW4oJ2RlbGl2ZXJ5X3N0YXR1cycsWydkZWxpdmVyZWQnLCdwYXJ0aWFsLWRlbGl2ZXJlZCddKQogICAgICAgICAgICAtPmdldCgpOwoKICAgICAgICAgICAgJGRhdGEgPSBbCiAgICAgICAgICAgICAgICAndGl0bGUnID0+ICR0aXRsZSwKICAgICAgICAgICAgICAgICdhcHByb3ZlcnMnID0+ICRhcHByb3ZlcnMsCiAgICAgICAgICAgICAgICAnZGVwYXJ0bWVudHMnID0+ICRkZXBhcnRtZW50cywKICAgICAgICAgICAgICAgICdmcm9tJyA9PiAkZnJvbSwKICAgICAgICAgICAgICAgICd0bycgPT4gJHRvLAogICAgICAgICAgICAgICAgJ2NhdGVnb3J5X2lkJyA9PiAkY2F0ZWdvcnlfaWQsCiAgICAgICAgICAgICAgICAnYXBwcm92ZWRfYnknID0+ICRhcHByb3ZlZF9ieSwKICAgICAgICAgICAgICAgICdkZXBhcnRtZW50X2lkJyA9PiAkZGVwYXJ0bWVudF9pZCwKICAgICAgICAgICAgICAgICdjYXRlZ29yaWVzJyA9PiAkY2F0ZWdvcmllcywKICAgICAgICAgICAgICAgICdoZWFkZXJDb2x1bW5zJyA9PiAkdGhpcy0+c3RvcmVIZWFkZXJDb2x1bW5zKCksCiAgICAgICAgICAgIF07CgogICAgICAgICAgICAkcmVxdWlzaXRpb25zID0gUmVxdWlzaXRpb246OndpdGgoWwogICAgICAgICAgICAgICAgJ2l0ZW1zLnByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLAogICAgICAgICAgICAgICAgJ3JlbFVzZXJzTGlzdCcsCiAgICAgICAgICAgICAgICAncmVsVXNlcnNMaXN0LmVtcGxveWVlLnVuaXQnLAogICAgICAgICAgICAgICAgJ2FwcHJvdmVkQnknCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlbFVzZXJzTGlzdC5lbXBsb3llZScsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCR1c2VyVW5pdHMsICR1c2VyRGVwYXJ0bWVudHMsICR1c2VyU2VjdGlvbnMpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignYXNfdW5pdF9pZCcsICR1c2VyVW5pdHMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUluKCdhc19kZXBhcnRtZW50X2lkJywgJHVzZXJEZXBhcnRtZW50cyk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbihzdHJ0b3RpbWUoJGZyb20pPjAsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRmcm9tKXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlRGF0ZSgncmVxdWlzaXRpb25fZGF0ZScsICc+PScsICRmcm9tKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVuKHN0cnRvdGltZSgkdG8pPjAsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCR0byl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZURhdGUoJ3JlcXVpc2l0aW9uX2RhdGUnLCAnPD0nLCAkdG8pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oJGRlcGFydG1lbnRfaWQ+MCwgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGRlcGFydG1lbnRfaWQpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFVzZXJzTGlzdC5lbXBsb3llZScsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRkZXBhcnRtZW50X2lkKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXNfZGVwYXJ0bWVudF9pZCcsICRkZXBhcnRtZW50X2lkKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oJGFwcHJvdmVkX2J5PjAsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRhcHByb3ZlZF9ieSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXBwcm92ZWRfYnknLCRhcHByb3ZlZF9ieSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbigkY2F0ZWdvcnlfaWQ+MCwgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGNhdGVnb3J5X2lkKXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdpdGVtcy5wcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGNhdGVnb3J5X2lkKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaWQnLCAkY2F0ZWdvcnlfaWQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlcmUoWwogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gMSwKICAgICAgICAgICAgICAgICdkZWxpdmVyeV9zdGF0dXMnID0+ICdwcm9jZXNzaW5nJywKICAgICAgICAgICAgICAgICdpc19zZW5kX3RvX3JmcCcgPT4gJ25vJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlTm90SW4oJ2RlbGl2ZXJ5X3N0YXR1cycsIFsKICAgICAgICAgICAgICAgICdkZWxpdmVyZWQnLAogICAgICAgICAgICAgICAgJ3BhcnRpYWwtZGVsaXZlcmVkJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZW4oIWRhdGF0YWJsZU9yZGVyaW5nKCksIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlcmJ5KCdpZCcsICdkZXNjJyk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgJG9wdGlvbnMgPSBbCiAgICAgICAgICAgICAgICAnY29uZmlybS1kZWxpdmVyeSc9PmF1dGgoKS0+dXNlcigpLT5oYXNQZXJtaXNzaW9uVG8oJ2NvbmZpcm0tZGVsaXZlcnknKSwKICAgICAgICAgICAgICAgICdzZW5kLXRvLXJmcCc9PmF1dGgoKS0+dXNlcigpLT5oYXNQZXJtaXNzaW9uVG8oJ3NlbmQtdG8tcmZwJykKICAgICAgICAgICAgXTsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIERhdGF0YWJsZXM6Om9mKCRyZXF1aXNpdGlvbnMpCiAgICAgICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbigncmVmZXJlbmNlX25vJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBvbmNsaWNrPSJvcGVuTW9kYWwoJy4kdmFsdWVzLT5pZC4nKSIgIGNsYXNzPSJidG4gYnRuLWxpbmsiPicuJHZhbHVlcy0+cmVmZXJlbmNlX25vLic8L2E+JzsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3JlcXVpc2l0aW9uX2RhdGUnLCBmdW5jdGlvbigkdmFsdWVzKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZSgnWS1tLWQnLCBzdHJ0b3RpbWUoJHZhbHVlcy0+cmVxdWlzaXRpb25fZGF0ZSkpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZXF1aXNpdGlvbl9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZXF1aXNpdGlvbl9kYXRlJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdyZXF1aXNpdGlvbl9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJCeSgncmVxdWlzaXRpb25fZGF0ZScsICRvcmRlcik7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2RlcGFydG1lbnQnLCBmdW5jdGlvbigkdmFsdWVzKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHZhbHVlcy0+cmVsVXNlcnNMaXN0LT5lbXBsb3llZS0+ZGVwYXJ0bWVudC0+aHJfZGVwYXJ0bWVudF9uYW1lKT8kdmFsdWVzLT5yZWxVc2Vyc0xpc3QtPmVtcGxveWVlLT5kZXBhcnRtZW50LT5ocl9kZXBhcnRtZW50X25hbWU6Jyc7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2RlcGFydG1lbnQnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUuZGVwYXJ0bWVudCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdocl9kZXBhcnRtZW50X25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ2RlcGFydG1lbnQnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBVc2VyOjpzZWxlY3QoJ2hyX2RlcGFydG1lbnQuaHJfZGVwYXJ0bWVudF9uYW1lJykKICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdocl9hc19iYXNpY19pbmZvJywgJ2hyX2FzX2Jhc2ljX2luZm8uYXNzb2NpYXRlX2lkJywgJz0nLCAndXNlcnMuYXNzb2NpYXRlX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdocl9kZXBhcnRtZW50JywgJ2hyX2RlcGFydG1lbnQuaHJfZGVwYXJ0bWVudF9pZCcsICc9JywgJ2hyX2FzX2Jhc2ljX2luZm8uYXNfZGVwYXJ0bWVudF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3VzZXJzLmlkJywgJ3JlcXVpc2l0aW9ucy5hdXRob3JfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24oJHJlcXVpc2l0aW9uKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHJlcXVpc2l0aW9uLT5pdGVtc1swXS0+cHJvZHVjdC0+Y2F0ZWdvcnktPmNhdGVnb3J5LT5uYW1lKT8kcmVxdWlzaXRpb24tPml0ZW1zWzBdLT5wcm9kdWN0LT5jYXRlZ29yeS0+Y2F0ZWdvcnktPm5hbWU6Jyc7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3Byb2R1Y3RfY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdpdGVtcy5wcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3Byb2R1Y3RfY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBSZXF1aXNpdGlvbkl0ZW06OnNlbGVjdCgnbWFpbl9jYXRlZ29yeS5uYW1lJykKICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdwcm9kdWN0cycsICdwcm9kdWN0cy5pZCcsICc9JywgJ3JlcXVpc2l0aW9uX2l0ZW1zLnByb2R1Y3RfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2NhdGVnb3JpZXMgYXMgc3ViX2NhdGVnb3J5JywgJ3N1Yl9jYXRlZ29yeS5pZCcsICc9JywgJ3Byb2R1Y3RzLmNhdGVnb3J5X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdjYXRlZ29yaWVzIGFzIG1haW5fY2F0ZWdvcnknLCAnbWFpbl9jYXRlZ29yeS5pZCcsICc9JywgJ3N1Yl9jYXRlZ29yeS5wYXJlbnRfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1aXNpdGlvbl9pdGVtcy5yZXF1aXNpdGlvbl9pZCcsICdyZXF1aXNpdGlvbnMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhcHByb3ZlZF9ieScsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkdmFsdWVzLT5hcHByb3ZlZEJ5LT5uYW1lKT8gJHZhbHVlcy0+YXBwcm92ZWRCeS0+bmFtZSA6Jyc7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2FwcHJvdmVkX2J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnYXBwcm92ZWRCeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdhcHByb3ZlZF9ieScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFVzZXI6OnNlbGVjdCgndXNlcnMubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3VzZXJzLmlkJywgJ3JlcXVpc2l0aW9ucy5hcHByb3ZlZF9ieScpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FjdGlvbnMnLCBmdW5jdGlvbigkdmFsdWVzKSB1c2UoJG9wdGlvbnMpewogICAgICAgICAgICAgICAgICAgICRhY3Rpb25zID0gJyc7CgogICAgICAgICAgICAgICAgICAgICRhY3Rpb25zLj0nPGRpdiBjbGFzcz0iYnRuLWdyb3VwIj48YnV0dG9uIGNsYXNzPSJidG4gZHJvcGRvd24tdG9nZ2xlIiBkYXRhLXRvZ2dsZT0iZHJvcGRvd24iPjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIGZpbGw9ImN1cnJlbnRDb2xvciIgY2xhc3M9ImJpIGJpLXRocmVlLWRvdHMtdmVydGljYWwiIHZpZXdCb3g9IjAgMCAxNiAxNiI+PHBhdGggZD0iTTkuNSAxM2ExLjUgMS41IDAgMSAxLTMgMCAxLjUgMS41IDAgMCAxIDMgMHptMC01YTEuNSAxLjUgMCAxIDEtMyAwIDEuNSAxLjUgMCAwIDEgMyAwem0wLTVhMS41IDEuNSAwIDEgMS0zIDAgMS41IDEuNSAwIDAgMSAzIDB6Ii8+PC9zdmc+PC9idXR0b24+PHVsIGNsYXNzPSJkcm9wZG93bi1tZW51Ij4nOwoKICAgICAgICAgICAgICAgICAgICBpZigkb3B0aW9uc1snY29uZmlybS1kZWxpdmVyeSddICYmICR2YWx1ZXMtPml0ZW1zWzBdLT5wcm9kdWN0LT5jYXRlZ29yeS0+aXNfc2VydmljZSA9PSAwKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYocmVxdWlzaXRpb25IYXNTdG9jaygkdmFsdWVzLT5pZCkpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0nPGxpPjxhIGhyZWY9Iicucm91dGUoJ3Btcy5zdG9yZS1tYW5hZ2Uuc3RvcmUtcmVxdWlzaXRpb24uZGVsaXZlcnknLCR2YWx1ZXMtPmlkKS4nIiB0aXRsZT0iQ2xpY2sgSGVyZSBUbyBDb25maXJtIERlbGl2ZXJ5Ij5Db25maXJtIERlbGl2ZXJ5PC9hPjwvbGk+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgaWYoJG9wdGlvbnNbJ3NlbmQtdG8tcmZwJ10pewogICAgICAgICAgICAgICAgICAgICAgICBpZigkdmFsdWVzLT5pc19zZW5kX3RvX3JmcD09J25vJyl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSc8bGk+PGEgY2xhc3M9InNlbmRUb1B1cmNoYXNlRGVwYXJ0bWVudCIgb25jbGljaz0ic2VuZFRvUHVyY2hhc2VEZXBhcnRtZW50KCQodGhpcykpIiBkYXRhLXNyYz0iJy5yb3V0ZSgncG1zLnN0b3JlLW1hbmFnZS5zZW5kLnRvLnB1cmNoYXNlLmRlcGFydG1lbnQnKS4nIiBkYXRhLWlkPSInLiR2YWx1ZXMtPmlkLiciIHRpdGxlPSJTZW5kIFRvIFByb2N1cmVtZW50Ij5TZW5kIFRvIFByb2N1cmVtZW50PC9hPjwvbGk+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMuPSc8L3VsPjwvZGl2Pic7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhY3Rpb25zOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+cmF3Q29sdW1ucyhbJ3JlZmVyZW5jZV9ubycsJ2FjdGlvbnMnXSkKICAgICAgICAgICAgICAgIC0+bWFrZSh0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnN0b3JlLnN0b3JlLXJlcXVpc2l0aW9uLWxpc3QtdmlldycsJGRhdGEpOwoKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgIC8qKgogICAgICogUmZwIGxpc3QgdmlldyBzZXJhcmNoLgogICAgICogU2VhcmNoIGJldHdlZW4gZnJvbSBhbmQgdG8gZGF0ZSBhbmQgYWxzbyB1c2VyIGNhbiBzZWFyY2ggYnkgZW1wbG95ZWUKICAgICAqIEBwYXJhbSAgXElsbHVtaW5hdGVcSHR0cFxSZXF1ZXN0ICAkcmVxdWVzdAogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCiAgICAgcHVibGljIGZ1bmN0aW9uIHN0b3JlUmVxdWlzaXRpb25MaXN0Vmlld1NlYXJjaChSZXF1ZXN0ICRyZXF1ZXN0KQogICAgIHsKICAgICAgICAkcmVzcG9uc2UgPSBbXTsKCiAgICAgICAgJGZyb21EYXRlPWRhdGUoJ1ktbS1kJywgc3RydG90aW1lKCRyZXF1ZXN0LT5mcm9tX2RhdGUpKTsKICAgICAgICAkdG9EYXRlPWRhdGUoJ1ktbS1kJywgc3RydG90aW1lKCRyZXF1ZXN0LT50b19kYXRlKSk7CgogICAgICAgICRyZXF1aXNpdGlvbkJ5PSRyZXF1ZXN0LT5yZXF1aXNpdGlvbl9ieTsKICAgICAgICAkcmVxdWlzaXRpb25TdGF0dXM9JHJlcXVlc3QtPnJlcXVpc2l0aW9uX3N0YXR1czsKCiAgICAgICAgJHJlcXVpc3Rpb25EYXRhPVJlcXVpc2l0aW9uOjp3aGVuKGlzc2V0KGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfdW5pdF9pZCksIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdocl91bml0X2lkJyxhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX3VuaXRfaWQpOwogICAgICAgIH0pCiAgICAgICAgLT53aGVyZURhdGUoJ3JlcXVpc2l0aW9uX2RhdGUnLCAnPj0nLCAkZnJvbURhdGUpCiAgICAgICAgLT53aGVyZURhdGUoJ3JlcXVpc2l0aW9uX2RhdGUnLCAnPD0nLCAkdG9EYXRlKQogICAgICAgIC0+d2hlbigkcmVxdWlzaXRpb25CeSwgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHJlcXVpc2l0aW9uQnkpewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXV0aG9yX2lkJywkcmVxdWlzaXRpb25CeSk7CiAgICAgICAgfSkKICAgICAgICAtPndoZXJlKFsnc3RhdHVzJz0+JHJlcXVpc2l0aW9uU3RhdHVzLCdkZWxpdmVyeV9zdGF0dXMnPT4ncHJvY2Vzc2luZycsJ2lzX3NlbmRfdG9fcmZwJz0+J25vJ10pCiAgICAgICAgLT5wYWdpbmF0ZSgzMCk7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmKGNvdW50KCRyZXF1aXN0aW9uRGF0YSk+MCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgJGJvZHkgPSBWaWV3OjptYWtlKCdwbXMuYmFja2VuZC5wYWdlcy5zdG9yZS5zdG9yZS1zZWFyY2gtcmVzdWx0LXZpZXcnLAogICAgICAgICAgICAgICAgICAgIFsncmVxdWlzdGlvbkRhdGEnPT4gJHJlcXVpc3Rpb25EYXRhXSk7CiAgICAgICAgICAgICAgICAkY29udGVudHMgPSAkYm9keS0+cmVuZGVyKCk7CgogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdzdWNjZXNzJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnYm9keSddID0gJGNvbnRlbnRzOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnZXJyb3InOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAnRGF0YSBub3QgZm91bmQuISEnOwogICAgICAgICAgICB9CgogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICRyZXNwb25zZTsKICAgIH0KICAgIC8qKgogICAgICogUmZwIGxpc3QgdmlldyBzZXJhcmNoLgogICAgICogU2VhcmNoIGJldHdlZW4gZnJvbSBhbmQgdG8gZGF0ZSBhbmQgYWxzbyB1c2VyIGNhbiBzZWFyY2ggYnkgZW1wbG95ZWUKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIGRlcGFydG1lbnRXaXNlRW1wbG95ZWUoUmVxdWVzdCAkcmVxdWVzdCkKICAgIHsKICAgICAgICAkcmVzcG9uc2U9W107CiAgICAgICAgJHJlc3BvbnNlWydkYXRhJ109Jyc7CgogICAgICAgICRkZXBhcnRtZW50SWQgPSAkcmVxdWVzdC0+ZGVwYXJ0bWVudF9pZDsKCiAgICAgICAgJGVtcGxveWVlPVJlcXVpc2l0aW9uOjp3aGVyZUhhcygncmVsVXNlcnNMaXN0LmVtcGxveWVlJyxmdW5jdGlvbigkcXVlcnkpIHVzZSgkZGVwYXJ0bWVudElkKXsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2FzX2RlcGFydG1lbnRfaWQnLCRkZXBhcnRtZW50SWQpCiAgICAgICAgICAgIC0+d2hlcmUoJ2FzX3VuaXRfaWQnLCBhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX3VuaXRfaWQpOwogICAgICAgIH0pCiAgICAgICAgLT5ncm91cEJ5KCdhdXRob3JfaWQnKQogICAgICAgIC0+d2hlcmUoWydzdGF0dXMnPT4xLCdkZWxpdmVyeV9zdGF0dXMnPT4ncHJvY2Vzc2luZycsJ2lzX3NlbmRfdG9fcmZwJz0+J25vJ10pCiAgICAgICAgLT53aGVyZU5vdEluKCdkZWxpdmVyeV9zdGF0dXMnLFsnZGVsaXZlcmVkJywncGFydGlhbC1kZWxpdmVyZWQnXSkKICAgICAgICAtPmdldCgpOwoKICAgICAgICAkcmVzcG9uc2VbJ2RhdGEnXSAuPSAnPG9wdGlvbiB2YWx1ZT0iIj4tLVNlbGVjdCBPbmUtLTwvb3B0aW9uPic7CiAgICAgICAgaWYgKCFlbXB0eSgkZW1wbG95ZWUpKSB7CiAgICAgICAgICAgIGZvcmVhY2ggKCRlbXBsb3llZSBhcyAkdmFsdWVzKSB7CiAgICAgICAgICAgICAkcmVzcG9uc2VbJ2RhdGEnXSAuPSAnPG9wdGlvbiB2YWx1ZT0iJyAuICR2YWx1ZXMtPnJlbFVzZXJzTGlzdC0+aWQgLiAnIj4nIC4gJHZhbHVlcy0+cmVsVXNlcnNMaXN0LT5uYW1lIC4gJzwvb3B0aW9uPic7CiAgICAgICAgIH0KICAgICB9ZWxzZXsKICAgICAgICAgJHJlc3BvbnNlWydkYXRhJ10gLj0gIjxvcHRpb24gdmFsdWU9Jyc+Tm8gRW1wbG95ZWUgRm91bmQhITwvb3B0aW9uPiI7CiAgICAgfQoKICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ3N1Y2Nlc3MnOwoKICAgICByZXR1cm4gJHJlc3BvbnNlOwogfQoKIHB1YmxpYyBmdW5jdGlvbiByZnBSZXF1aXNpdGlvbkxpc3QoUmVxdWVzdCAkcmVxdWVzdCl7CiAgICB0cnkgewoKICAgICAgICAkdGl0bGUgPSAnUkZQIFJlcXVpc2l0aW9uIExpc3QnOwogICAgICAgICRmcm9tID0gcmVxdWVzdCgpLT5oYXMoJ2Zyb20nKSA/IHJlcXVlc3QoKS0+Z2V0KCdmcm9tJykgOiBkYXRlKCdZLW0tMDEnKTsKICAgICAgICAkdG8gPSByZXF1ZXN0KCktPmhhcygndG8nKSA/IHJlcXVlc3QoKS0+Z2V0KCd0bycpIDogZGF0ZSgnWS1tLXQnKTsKICAgICAgICAkY2F0ZWdvcnlfaWQgPSByZXF1ZXN0KCktPmhhcygnY2F0ZWdvcnlfaWQnKSA/IHJlcXVlc3QoKS0+Z2V0KCdjYXRlZ29yeV9pZCcpIDogMDsKICAgICAgICAkZGVwYXJ0bWVudF9pZCA9IHJlcXVlc3QoKS0+aGFzKCdkZXBhcnRtZW50X2lkJykgPyByZXF1ZXN0KCktPmdldCgnZGVwYXJ0bWVudF9pZCcpIDogMDsKICAgICAgICAkYXBwcm92ZWRfYnkgPSByZXF1ZXN0KCktPmhhcygnYXBwcm92ZWRfYnknKSA/IHJlcXVlc3QoKS0+Z2V0KCdhcHByb3ZlZF9ieScpIDogMDsKCiAgICAgICAgJGNhdGVnb3JpZXMgPSBDYXRlZ29yeTo6ZG9lc250SGF2ZSgnY2F0ZWdvcnknKS0+Z2V0KCk7CgogICAgICAgICRkZXBhcnRtZW50cyA9IFJlcXVpc2l0aW9uOjp3aGVuKGlzc2V0KGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfdW5pdF9pZCksIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2hyX3VuaXRfaWQnLCBhdXRoKCktPnVzZXIoKS0+cHJpb3JpdGllcy0+cGx1Y2soJ2hyX3VuaXRfaWQnKS0+dG9BcnJheSgpKTsKICAgICAgICB9KQogICAgICAgIC0+am9pbigndXNlcnMnLCd1c2Vycy5pZCcsJz0nLCdyZXF1aXNpdGlvbnMuYXV0aG9yX2lkJykKICAgICAgICAtPmpvaW4oJ2hyX2FzX2Jhc2ljX2luZm8nLCdocl9hc19iYXNpY19pbmZvLmFzc29jaWF0ZV9pZCcsJz0nLCd1c2Vycy5hc3NvY2lhdGVfaWQnKQogICAgICAgIC0+am9pbignaHJfZGVwYXJ0bWVudCcsJ2hyX2RlcGFydG1lbnQuaHJfZGVwYXJ0bWVudF9pZCcsJz0nLCdocl9hc19iYXNpY19pbmZvLmFzX2RlcGFydG1lbnRfaWQnKQogICAgICAgIC0+Z3JvdXBCeSgnaHJfZGVwYXJ0bWVudC5ocl9kZXBhcnRtZW50X2lkJykKICAgICAgICAtPndoZXJlKFsnc3RhdHVzJz0+MSwnaXNfc2VuZF90b19yZnAnPT4neWVzJ10pCiAgICAgICAgLT53aGVyZU5vdEluKCdkZWxpdmVyeV9zdGF0dXMnLFsnZGVsaXZlcmVkJywncGFydGlhbC1kZWxpdmVyZWQnXSkKICAgICAgICAtPmdldChbJ2hyX2RlcGFydG1lbnQuaHJfZGVwYXJ0bWVudF9pZCcsJ2hyX2RlcGFydG1lbnQuaHJfZGVwYXJ0bWVudF9uYW1lJ10pOwoKICAgICAgICAkYXBwcm92ZXJzID0gUmVxdWlzaXRpb246OndpdGgoJ2FwcHJvdmVkQnknKQogICAgICAgIC0+d2hlbihpc3NldChhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX3VuaXRfaWQpLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsVXNlcnNMaXN0LmVtcGxveWVlJyxmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignYXNfdW5pdF9pZCcsIGF1dGgoKS0+dXNlcigpLT5wcmlvcml0aWVzLT5wbHVjaygnaHJfdW5pdF9pZCcpLT50b0FycmF5KCkpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KQogICAgICAgIC0+Z3JvdXBCeSgnYXBwcm92ZWRfYnknKQogICAgICAgIC0+d2hlcmUoWydzdGF0dXMnPT4xLCdpc19zZW5kX3RvX3JmcCc9Pid5ZXMnXSkKICAgICAgICAtPndoZXJlTm90SW4oJ2RlbGl2ZXJ5X3N0YXR1cycsWydkZWxpdmVyZWQnLCdwYXJ0aWFsLWRlbGl2ZXJlZCddKQogICAgICAgIC0+Z2V0KCk7CgogICAgICAgICRyZXF1aXNpdGlvbnMgPSBSZXF1aXNpdGlvbjo6d2l0aChbCiAgICAgICAgICAgICdpdGVtcy5wcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywKICAgICAgICAgICAgJ2l0ZW1zLnByb2R1Y3QucmVsSW52ZW50b3J5RGV0YWlscycsCiAgICAgICAgICAgICdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUudW5pdCcsCiAgICAgICAgICAgICdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUuZGVwYXJ0bWVudCcsCiAgICAgICAgICAgICdhcHByb3ZlZEJ5JywKICAgICAgICBdKQogICAgICAgIC0+d2hlbihpc3NldChhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX3VuaXRfaWQpLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdocl91bml0X2lkJywgYXV0aCgpLT51c2VyKCktPnByaW9yaXRpZXMtPnBsdWNrKCdocl91bml0X2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgfSkKICAgICAgICAtPndoZW4oc3RydG90aW1lKCRmcm9tKT4wLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkZnJvbSl7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlRGF0ZSgncmVxdWlzaXRpb25fZGF0ZScsICc+PScsICRmcm9tKTsKICAgICAgICB9KQogICAgICAgIC0+d2hlbihzdHJ0b3RpbWUoJHRvKT4wLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkdG8pewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZURhdGUoJ3JlcXVpc2l0aW9uX2RhdGUnLCAnPD0nLCAkdG8pOwogICAgICAgIH0pCiAgICAgICAgLT53aGVuKCRkZXBhcnRtZW50X2lkPjAsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRkZXBhcnRtZW50X2lkKXsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFVzZXJzTGlzdC5lbXBsb3llZScsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRkZXBhcnRtZW50X2lkKXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhc19kZXBhcnRtZW50X2lkJywgJGRlcGFydG1lbnRfaWQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KQogICAgICAgIC0+d2hlbigkYXBwcm92ZWRfYnk+MCwgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGFwcHJvdmVkX2J5KXsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2FwcHJvdmVkX2J5JywkYXBwcm92ZWRfYnkpOwogICAgICAgIH0pCiAgICAgICAgLT53aGVuKCRjYXRlZ29yeV9pZD4wLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkY2F0ZWdvcnlfaWQpewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnaXRlbXMucHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRjYXRlZ29yeV9pZCl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaWQnLCAkY2F0ZWdvcnlfaWQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KQogICAgICAgIC0+d2hlcmUoWwogICAgICAgICAgICAnc3RhdHVzJyA9PiAxLAogICAgICAgICAgICAnaXNfc2VuZF90b19yZnAnID0+ICd5ZXMnCiAgICAgICAgXSkKICAgICAgICAtPndoZXJlTm90SW4oJ2RlbGl2ZXJ5X3N0YXR1cycsIFsKICAgICAgICAgICAgJ2RlbGl2ZXJlZCcsCiAgICAgICAgICAgICdwYXJ0aWFsLWRlbGl2ZXJlZCcKICAgICAgICBdKQogICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJieSgncmVmZXJlbmNlX25vJywgJ2Rlc2MnKTsKICAgICAgICB9KTsKCiAgICAgICAgJG9wdGlvbnMgPSBbCiAgICAgICAgICAgICdjb25maXJtLWRlbGl2ZXJ5Jz0+YXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25UbygnY29uZmlybS1kZWxpdmVyeScpLAogICAgICAgIF07CgogICAgICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgICAgICByZXR1cm4gRGF0YXRhYmxlczo6b2YoJHJlcXVpc2l0aW9ucykKICAgICAgICAgICAgLT5hZGRJbmRleENvbHVtbigpCiAgICAgICAgICAgIC0+ZWRpdENvbHVtbigncmVmZXJlbmNlX25vJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICByZXR1cm4gICc8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIG9uY2xpY2s9Im9wZW5Nb2RhbCgnLiR2YWx1ZXMtPmlkLicpIiAgY2xhc3M9ImJ0biBidG4tbGluayI+Jy4kdmFsdWVzLT5yZWZlcmVuY2Vfbm8uJzwvYT4nOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3JlcXVpc2l0aW9uX2RhdGUnLCBmdW5jdGlvbigkdmFsdWVzKXsKICAgICAgICAgICAgICAgIHJldHVybiBkYXRlKCdZLW0tZCcsc3RydG90aW1lKCR2YWx1ZXMtPnJlcXVpc2l0aW9uX2RhdGUpKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3JlcXVpc2l0aW9uX2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncmVxdWlzaXRpb25fZGF0ZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3JlcXVpc2l0aW9uX2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ3JlcXVpc2l0aW9uX2RhdGUnLCAkb3JkZXIpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmFkZENvbHVtbignZGVwYXJ0bWVudCcsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCR2YWx1ZXMtPnJlbFVzZXJzTGlzdC0+ZW1wbG95ZWUtPmRlcGFydG1lbnQtPmhyX2RlcGFydG1lbnRfbmFtZSk/JHZhbHVlcy0+cmVsVXNlcnNMaXN0LT5lbXBsb3llZS0+ZGVwYXJ0bWVudC0+aHJfZGVwYXJ0bWVudF9uYW1lOicnOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmZpbHRlckNvbHVtbignZGVwYXJ0bWVudCcsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsVXNlcnNMaXN0LmVtcGxveWVlLmRlcGFydG1lbnQnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdocl9kZXBhcnRtZW50X25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ2RlcGFydG1lbnQnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFVzZXI6OnNlbGVjdCgnaHJfZGVwYXJ0bWVudC5ocl9kZXBhcnRtZW50X25hbWUnKQogICAgICAgICAgICAgICAgICAgIC0+am9pbignaHJfYXNfYmFzaWNfaW5mbycsICdocl9hc19iYXNpY19pbmZvLmFzc29jaWF0ZV9pZCcsICc9JywgJ3VzZXJzLmFzc29jaWF0ZV9pZCcpCiAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdocl9kZXBhcnRtZW50JywgJ2hyX2RlcGFydG1lbnQuaHJfZGVwYXJ0bWVudF9pZCcsICc9JywgJ2hyX2FzX2Jhc2ljX2luZm8uYXNfZGVwYXJ0bWVudF9pZCcpCiAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigndXNlcnMuaWQnLCAncmVxdWlzaXRpb25zLmF1dGhvcl9pZCcpCiAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmFkZENvbHVtbigncHJvZHVjdF9jYXRlZ29yeScsIGZ1bmN0aW9uKCRyZXF1aXNpdGlvbil7CiAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHJlcXVpc2l0aW9uLT5pdGVtc1swXS0+cHJvZHVjdC0+Y2F0ZWdvcnktPmNhdGVnb3J5LT5uYW1lKT8kcmVxdWlzaXRpb24tPml0ZW1zWzBdLT5wcm9kdWN0LT5jYXRlZ29yeS0+Y2F0ZWdvcnktPm5hbWU6Jyc7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdpdGVtcy5wcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncHJvZHVjdF9jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWlzaXRpb25JdGVtOjpzZWxlY3QoJ21haW5fY2F0ZWdvcnkubmFtZScpCiAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdwcm9kdWN0cycsICdwcm9kdWN0cy5pZCcsICc9JywgJ3JlcXVpc2l0aW9uX2l0ZW1zLnByb2R1Y3RfaWQnKQogICAgICAgICAgICAgICAgICAgIC0+am9pbignY2F0ZWdvcmllcyBhcyBzdWJfY2F0ZWdvcnknLCAnc3ViX2NhdGVnb3J5LmlkJywgJz0nLCAncHJvZHVjdHMuY2F0ZWdvcnlfaWQnKQogICAgICAgICAgICAgICAgICAgIC0+am9pbignY2F0ZWdvcmllcyBhcyBtYWluX2NhdGVnb3J5JywgJ21haW5fY2F0ZWdvcnkuaWQnLCAnPScsICdzdWJfY2F0ZWdvcnkucGFyZW50X2lkJykKICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1aXNpdGlvbl9pdGVtcy5yZXF1aXNpdGlvbl9pZCcsICdyZXF1aXNpdGlvbnMuaWQnKQogICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FwcHJvdmVkX2J5JywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHZhbHVlcy0+YXBwcm92ZWRCeS0+bmFtZSk/ICR2YWx1ZXMtPmFwcHJvdmVkQnktPm5hbWUgOicnOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmZpbHRlckNvbHVtbignYXBwcm92ZWRfYnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ2FwcHJvdmVkQnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdhcHByb3ZlZF9ieScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgVXNlcjo6c2VsZWN0KCd1c2Vycy5uYW1lJykKICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCd1c2Vycy5pZCcsICdyZXF1aXNpdGlvbnMuYXBwcm92ZWRfYnknKQogICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FjdGlvbnMnLCBmdW5jdGlvbigkdmFsdWVzKSB1c2UoJG9wdGlvbnMpewoKICAgICAgICAgICAgICAgICRhY3Rpb25zID0gJyc7CiAgICAgICAgICAgICAgICAkYWN0aW9ucy49JzxkaXYgY2xhc3M9ImJ0bi1ncm91cCI+PGJ1dHRvbiBjbGFzcz0iYnRuIGRyb3Bkb3duLXRvZ2dsZSIgZGF0YS10b2dnbGU9ImRyb3Bkb3duIj48c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiBmaWxsPSJjdXJyZW50Q29sb3IiIGNsYXNzPSJiaSBiaS10aHJlZS1kb3RzLXZlcnRpY2FsIiB2aWV3Qm94PSIwIDAgMTYgMTYiPjxwYXRoIGQ9Ik05LjUgMTNhMS41IDEuNSAwIDEgMS0zIDAgMS41IDEuNSAwIDAgMSAzIDB6bTAtNWExLjUgMS41IDAgMSAxLTMgMCAxLjUgMS41IDAgMCAxIDMgMHptMC01YTEuNSAxLjUgMCAxIDEtMyAwIDEuNSAxLjUgMCAwIDEgMyAweiIvPjwvc3ZnPjwvYnV0dG9uPjx1bCBjbGFzcz0iZHJvcGRvd24tbWVudSI+JzsKCiAgICAgICAgICAgICAgICAkc3RvY2tRdHk9MDsKICAgICAgICAgICAgICAgIGlmKGlzc2V0KCR2YWx1ZXMtPml0ZW1zKSl7CiAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCgkdmFsdWVzLT5pdGVtcyBhcyAkaXRlbSl7CiAgICAgICAgICAgICAgICAgICAgICAgICRzdG9ja1F0eSArPSBpc3NldCgkaXRlbS0+cHJvZHVjdC0+cmVsSW52ZW50b3J5RGV0YWlscyk/IGNvbGxlY3QoJGl0ZW0tPnByb2R1Y3QtPnJlbEludmVudG9yeURldGFpbHMpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlbihpc3NldChhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX3VuaXRfaWQpLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2hyX3VuaXRfaWQnLGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfdW5pdF9pZCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pLT5zdW0oJ3F0eScpOjA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIGlmKCRzdG9ja1F0eSA+IDAgJiYgcmVxdWlzaXRpb25IYXNTdG9jaygkdmFsdWVzLT5pZCkpewogICAgICAgICAgICAgICAgICAgIGlmKCRvcHRpb25zWydjb25maXJtLWRlbGl2ZXJ5J10gJiYgJHZhbHVlcy0+aXRlbXNbMF0tPnByb2R1Y3QtPmNhdGVnb3J5LT5pc19zZXJ2aWNlID09IDApewogICAgICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICAgICAkbm9uTm90aWZpZWQgPSAkdmFsdWVzLT5pdGVtcygpLT5kb2VzbnRIYXZlKCdub3RpZmljYXRpb24nKS0+Y291bnQoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCRub25Ob3RpZmllZCA+IDApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMuPSc8bGk+PGEgaHJlZj0iJy5yb3V0ZSgncG1zLnN0b3JlLW1hbmFnZS5yZXF1aXNpdGlvbi5pdGVtcy5saXN0JywkdmFsdWVzLT5pZCkuJyI+U2hvdyBOb3RpZmljYXRpb248L2E+PC9saT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSc8bGk+PGEgaHJlZj0iJy5yb3V0ZSgncG1zLnN0b3JlLW1hbmFnZS5zdG9yZS1yZXF1aXNpdGlvbi5kZWxpdmVyeScsJHZhbHVlcy0+aWQpLiciIHRpdGxlPSJDbGljayBIZXJlIFRvIENvbmZpcm0gRGVsaXZlcnkiPkNvbmZpcm0gRGVsaXZlcnk8L2E+PC9saT4nOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSAnPGxpPjxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgdGl0bGU9IlRyYWNrIFByb2dyZXNzIgogICAgICAgICAgICAgICAgY2xhc3M9InRyYWNraW5nUmVxdWlzdGlvblN0YXR1cyIgb25jbGljaz0idHJhY2tpbmdSZXF1aXN0aW9uU3RhdHVzKCQodGhpcykpIiBkYXRhLWlkPSInLiR2YWx1ZXMtPmlkLiciPjxpIGNsYXNzPSJsYSBsYS1tYXAiPjwvaT5UcmFjayBQcm9ncmVzczwvYT48L2xpPic7CgogICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSB0YXJnZXQ9Il9fYmxhbmsiIGhyZWY9Iicucm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5oaXN0b3J5JywkdmFsdWVzLT5pZCkuJyI+PGkgY2xhc3M9ImxhIGxhLWhpc3RvcnkiIHRpdGxlPSJSZXF1aXNpdGlvbiBIaXN0b3J5Ij48L2k+UmVxdWlzaXRpb24gSGlzdG9yeTwvYT48L2xpPC9hPjwvbGk+JzsKCiAgICAgICAgICAgICAgICAkYWN0aW9ucy49JzwvdWw+PC9kaXY+JzsKICAgICAgICAgICAgICAgIHJldHVybiAkYWN0aW9uczsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsncmVmZXJlbmNlX25vJywnYWN0aW9ucyddKQogICAgICAgICAgICAtPm1ha2UodHJ1ZSk7CiAgICAgICAgfQoKICAgICAgICAkZGF0YT1bCiAgICAgICAgICAgICd0aXRsZScgPT4gJHRpdGxlLAogICAgICAgICAgICAnYXBwcm92ZXJzJyA9PiAkYXBwcm92ZXJzLAogICAgICAgICAgICAnZGVwYXJ0bWVudHMnID0+ICRkZXBhcnRtZW50cywKICAgICAgICAgICAgJ2Zyb20nID0+ICRmcm9tLAogICAgICAgICAgICAndG8nID0+ICR0bywKICAgICAgICAgICAgJ2NhdGVnb3J5X2lkJyA9PiAkY2F0ZWdvcnlfaWQsCiAgICAgICAgICAgICdhcHByb3ZlZF9ieScgPT4gJGFwcHJvdmVkX2J5LAogICAgICAgICAgICAnZGVwYXJ0bWVudF9pZCcgPT4gJGRlcGFydG1lbnRfaWQsCiAgICAgICAgICAgICdjYXRlZ29yaWVzJyA9PiAkY2F0ZWdvcmllcywKICAgICAgICAgICAgJ2hlYWRlckNvbHVtbnMnID0+ICR0aGlzLT5zdG9yZUhlYWRlckNvbHVtbnMoKSwKICAgICAgICBdOwoKICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMuc3RvcmUuc3RvcmUtcmZwLXJlcXVpc2l0aW9uLWxpc3QnLCAkZGF0YSk7CgogICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgIH0KfQoKICAgIC8qKgogICAgICogUmZwIGxpc3QgdmlldyBzZXJhcmNoLgogICAgICogU2VhcmNoIGJldHdlZW4gZnJvbSBhbmQgdG8gZGF0ZSBhbmQgYWxzbyB1c2VyIGNhbiBzZWFyY2ggYnkgZW1wbG95ZWUKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIHJmcERlcGFydG1lbnRXaXNlRW1wbG95ZWUoUmVxdWVzdCAkcmVxdWVzdCkKICAgIHsKICAgICAgICAkcmVzcG9uc2U9W107CiAgICAgICAgJHJlc3BvbnNlWydkYXRhJ109Jyc7CgogICAgICAgICRkZXBhcnRtZW50SWQgPSAkcmVxdWVzdC0+ZGVwYXJ0bWVudF9pZDsKCiAgICAgICAgJGVtcGxveWVlPVJlcXVpc2l0aW9uOjp3aGVyZUhhcygncmVsVXNlcnNMaXN0LmVtcGxveWVlJyxmdW5jdGlvbigkcXVlcnkpIHVzZSgkZGVwYXJ0bWVudElkKXsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2FzX2RlcGFydG1lbnRfaWQnLCAkZGVwYXJ0bWVudElkKQogICAgICAgICAgICAtPndoZW4oaXNzZXQoYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc191bml0X2lkKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2hyX3VuaXRfaWQnLGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfdW5pdF9pZCk7CiAgICAgICAgICAgfSk7CiAgICAgICAgfSkKICAgICAgICAtPndoZXJlKFsnc3RhdHVzJz0+MSwnaXNfc2VuZF90b19yZnAnPT4neWVzJ10pCiAgICAgICAgLT53aGVyZU5vdEluKCdkZWxpdmVyeV9zdGF0dXMnLFsnZGVsaXZlcmVkJywncGFydGlhbC1kZWxpdmVyZWQnXSkKICAgICAgICAtPmdyb3VwQnkoJ2F1dGhvcl9pZCcpCiAgICAgICAgLT5nZXQoKTsKCiAgICAgICAgJHJlc3BvbnNlWydkYXRhJ10gLj0gJzxvcHRpb24gdmFsdWU9IiI+LS1TZWxlY3QgT25lLS08L29wdGlvbj4nOwogICAgICAgIGlmICghZW1wdHkoJGVtcGxveWVlKSkgewogICAgICAgICAgICBmb3JlYWNoICgkZW1wbG95ZWUgYXMgJHZhbHVlcykgewogICAgICAgICAgICAgJHJlc3BvbnNlWydkYXRhJ10gLj0gJzxvcHRpb24gdmFsdWU9IicgLiAkdmFsdWVzLT5yZWxVc2Vyc0xpc3QtPmlkIC4gJyI+JyAuICR2YWx1ZXMtPnJlbFVzZXJzTGlzdC0+bmFtZSAuICc8L29wdGlvbj4nOwogICAgICAgICB9CiAgICAgfWVsc2V7CiAgICAgICAgICRyZXNwb25zZVsnZGF0YSddIC49ICI8b3B0aW9uIHZhbHVlPScnPk5vIEVtcGxveWVlIEZvdW5kISE8L29wdGlvbj4iOwogICAgIH0KCiAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdzdWNjZXNzJzsKCiAgICAgcmV0dXJuICRyZXNwb25zZTsKIH0KCiAgICAvKioKICAgICogUmZwIGxpc3QgdmlldyBzZXJhcmNoLgogICAgKiBTZWFyY2ggYmV0d2VlbiBmcm9tIGFuZCB0byBkYXRlIGFuZCBhbHNvIHVzZXIgY2FuIHNlYXJjaCBieSBlbXBsb3llZQogICAgKiBAcGFyYW0gIFxJbGx1bWluYXRlXEh0dHBcUmVxdWVzdCAgJHJlcXVlc3QKICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiByZnBSZXF1aXNpdGlvblNlYXJjaChSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewogICAgICAgICRyZXNwb25zZSA9IFtdOwogICAgICAgICRmcm9tRGF0ZT1kYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkcmVxdWVzdC0+ZnJvbV9kYXRlKSk7CiAgICAgICAgJHRvRGF0ZT1kYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkcmVxdWVzdC0+dG9fZGF0ZSkpOwogICAgICAgICRkZXBhcnRtZW50SWQ9JHJlcXVlc3QtPmRlcGFydG1lbnRfaWQ7CgogICAgICAgICRyZXF1aXNpdGlvbkJ5PSRyZXF1ZXN0LT5yZXF1aXNpdGlvbl9ieTsKICAgICAgICAkcmVxdWlzaXRpb25TdGF0dXM9JHJlcXVlc3QtPnJlcXVpc2l0aW9uX3N0YXR1czsKCiAgICAgICAgJHJlcXVpc2l0aW9uPVJlcXVpc2l0aW9uOjp3aGVyZURhdGUoJ3JlcXVpc2l0aW9uX2RhdGUnLCAnPj0nLCAkZnJvbURhdGUpCiAgICAgICAgLT53aGVyZURhdGUoJ3JlcXVpc2l0aW9uX2RhdGUnLCAnPD0nLCAkdG9EYXRlKQogICAgICAgIC0+d2hlbigkcmVxdWlzaXRpb25CeSwgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHJlcXVpc2l0aW9uQnkpewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXV0aG9yX2lkJywkcmVxdWlzaXRpb25CeSk7CiAgICAgICAgfSkKICAgICAgICAtPndoZW4oJGRlcGFydG1lbnRJZCwgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGRlcGFydG1lbnRJZCl7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUnLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkZGVwYXJ0bWVudElkKXsKICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhc19kZXBhcnRtZW50X2lkJywkZGVwYXJ0bWVudElkKTsKICAgICAgICAgfSk7CiAgICAgICAgfSkKICAgICAgICAtPndoZW4oaXNzZXQoYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc191bml0X2lkKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2hyX3VuaXRfaWQnLGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfdW5pdF9pZCk7CiAgICAgICAgfSkKICAgICAgICAtPndoZXJlKFsnc3RhdHVzJz0+JHJlcXVpc2l0aW9uU3RhdHVzLCdpc19zZW5kX3RvX3JmcCc9Pid5ZXMnXSkKICAgICAgICAtPndoZXJlTm90SW4oJ2RlbGl2ZXJ5X3N0YXR1cycsWydkZWxpdmVyZWQnLCdwYXJ0aWFsLWRlbGl2ZXJlZCddKQogICAgICAgIC0+cGFnaW5hdGUoMzApOwoKCgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmKGlzc2V0KCRyZXF1aXNpdGlvblswXSkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICRib2R5ID0gVmlldzo6bWFrZSgncG1zLmJhY2tlbmQucGFnZXMuc3RvcmUucmZwLXNlYXJjaC1yZXN1bHQtdmlldycsCiAgICAgICAgICAgICAgICAgICAgWydyZXF1aXNpdGlvbic9PiAkcmVxdWlzaXRpb25dKTsKICAgICAgICAgICAgICAgICRjb250ZW50cyA9ICRib2R5LT5yZW5kZXIoKTsKCiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ3N1Y2Nlc3MnOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydib2R5J10gPSAkY29udGVudHM7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdlcnJvcic7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ21lc3NhZ2UnXSA9ICdEYXRhIG5vdCBmb3VuZC4hISc7CiAgICAgICAgICAgIH0KCiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gJHJlc3BvbnNlOwogICAgfQoKICAgIC8qKgogICAgKiBSZXF1aXN0aW9uIGl0ZW0gbGlzdC4KICAgICogQHBhcmFtICBcSWxsdW1pbmF0ZVxIdHRwXFJlcXVlc3QgICRyZXF1ZXN0CiAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gcmVxdWlzaXRpb25JdGVtc0xpc3QoJGlkKXsKCiAgICAgICAgJHRpdGxlID0gIlJlcXVpc2l0aW9uIEl0ZW1zIExpc3QiOwoKICAgICAgICAvL0ZpbmQgcmVxdWlzdGlvbgogICAgICAgICRyZXF1aXNpdGlvbj1SZXF1aXNpdGlvbjo6d2hlcmUoJ2lkJywkaWQpCiAgICAgICAgLT53aGVuKGlzc2V0KGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfdW5pdF9pZCksIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdocl91bml0X2lkJyxhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX3VuaXRfaWQpOwogICAgICAgIH0pCiAgICAgICAgLT53aGVyZShbJ3N0YXR1cyc9PjEsJ2lzX3NlbmRfdG9fcmZwJz0+J3llcyddKQogICAgICAgIC0+d2hlcmVOb3RJbignZGVsaXZlcnlfc3RhdHVzJyxbJ2RlbGl2ZXJlZCcsJ3BhcnRpYWwtZGVsaXZlcmVkJ10pCiAgICAgICAgLT5maXJzdCgpOwoKICAgICAgICB0cnkgewoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnN0b3JlLnJlcXVpc2l0aW9uLWl0ZW1zLWxpc3QnLCBjb21wYWN0KCd0aXRsZScsJ3JlcXVpc2l0aW9uJykpOwoKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKCiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfSAgIAoKICAgIC8qKgogICAgKiBTZW5kIG5vdGlmaWNhdGlvbiB0byB1c2Vycy4KICAgICogQHBhcmFtICBcSWxsdW1pbmF0ZVxIdHRwXFJlcXVlc3QgICRyZXF1ZXN0CiAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gc2VuZE5vdGlmaWNhdGlvblRvVXNlcnMoUmVxdWVzdCAkcmVxdWVzdCl7CgogICAgICAgIC8vVmFsaWRhdGUgaW5wdXRlIHJlcXVlc3QKICAgICAgICAkdGhpcy0+dmFsaWRhdGUoJHJlcXVlc3QsIFsKICAgICAgICAgICAgJ2l0ZW1zX2lkJyA9PiBbJ3JlcXVpcmVkJ10sCiAgICAgICAgXSk7CgogICAgICAgIC8vRGIgdHJhbnNhY3Rpb24gc3RhcnQKICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwoKICAgICAgICB0cnkgewoKICAgICAgICAgICAgLy9DcmF0ZSBpbnN0YW5jZSBvZiBpdGVtc19pZAogICAgICAgICAgICBmb3JlYWNoKCRyZXF1ZXN0LT5pdGVtc19pZCBhcyAka2V5PT4kaXRlbSl7CiAgICAgICAgICAgICAgICAvL0NoZWNrIHJlcXVpc2l0aW9uIGl0ZW0KICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW09UmVxdWlzaXRpb25JdGVtOjp3aGVyZSgncmVxdWlzaXRpb25faWQnLCRyZXF1ZXN0LT5yZXF1aXNpdGlvbl9pZCkKICAgICAgICAgICAgICAgIC0+d2hlcmUoJ2lkJywkaXRlbSkKICAgICAgICAgICAgICAgIC0+Zmlyc3QoKTsKCiAgICAgICAgICAgICAgICBpZighZW1wdHkoJHJlcXVpc2l0aW9uSXRlbSkpCiAgICAgICAgICAgICAgICB7ICAKICAgICAgICAgICAgICAgICAgICAkbm90aWZpY2F0aW9uID0gbmV3IE5vdGlmaWNhdGlvbigpOwogICAgICAgICAgICAgICAgICAgICRub3RpZmljYXRpb24tPnVzZXJfaWQgPSAkcmVxdWlzaXRpb25JdGVtLT5yZXF1aXNpdGlvbi0+YXV0aG9yX2lkOwogICAgICAgICAgICAgICAgICAgICRub3RpZmljYXRpb24tPnJlcXVpc2l0aW9uX2l0ZW1faWQgPSAkaXRlbTsKCiAgICAgICAgICAgICAgICAgICAgJG1lc3NhZ2U9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJy5yb3V0ZSgncG1zLnJlcXVpc2l0aW9uLmxpc3Qudmlldy5zaG93JywkcmVxdWlzaXRpb25JdGVtLT5yZXF1aXNpdGlvbi0+aWQpLic/dmlldyIgZGF0YS10aXRsZT0iUmVxdWlzaXRpb24gRGV0YWlscyI+UmVmZXJlbmNlIE5vOicuJHJlcXVpc2l0aW9uSXRlbS0+cmVxdWlzaXRpb24tPnJlZmVyZW5jZV9uby4nIEFuZCBJdGVtIE5hbWU6ICcuJHJlcXVpc2l0aW9uSXRlbS0+cHJvZHVjdC0+bmFtZS4nLiBQbGVhc2UgQ29sbGVjdCBZb3VyIHByb2R1Y3QgZnJvbSBzdG9yZTwvc3Bhbj4nOwoKICAgICAgICAgICAgICAgICAgICAkbm90aWZpY2F0aW9uLT5tZXNzYWdlcyA9ICRtZXNzYWdlOwoKICAgICAgICAgICAgICAgICAgICAkbm90aWZpY2F0aW9uLT5zdGF0dXMgPSAncmVxdWlzaXRpb24nOwogICAgICAgICAgICAgICAgICAgICRub3RpZmljYXRpb24tPnNhdmUoKTsKCiAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoV2FybmluZygnTm8gZGF0YSBmb3VuZCcpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIERCOjpjb21taXQoKTsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aFN1Y2Nlc3MoJ1N1Y2Nlc3NmdWxseSBzZW5kIHRvIHVzZXJzJyk7CgogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBiYWNrKCk7CiAgICB9CgogICAgLyoqCiAgICAqIFN0b3JlIGludmVudG9yeSBjb21wYXJlIGRhdGEuCiAgICAqIEBwYXJhbSAgXElsbHVtaW5hdGVcSHR0cFxSZXF1ZXN0ICAkcmVxdWVzdAogICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIHN0b3JlSW52ZW50b3J5Q29tcGFyZSgkaWQpewogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkdGl0bGUgPSAnU3RvcmUgSW52ZW50b3J5IENvbXBhcmUnOwoKICAgICAgICAgICAgJHJlcXVpc2l0aW9uID0gUmVxdWlzaXRpb246OndpdGgoWwogICAgICAgICAgICAgICAgJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnkucmVsRGVsaXZlcnlJdGVtcycsCiAgICAgICAgICAgICAgICAnaXRlbXMucHJvZHVjdC5yZWxJbnZlbnRvcnlEZXRhaWxzJywKICAgICAgICAgICAgICAgICdpdGVtcy5wcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywKICAgICAgICAgICAgICAgICdpdGVtcy5wcm9kdWN0LnByb2R1Y3RVbml0JywKICAgICAgICAgICAgICAgICdpdGVtcy5wcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsCiAgICAgICAgICAgICAgICAncmVsVXNlcnNMaXN0LmVtcGxveWVlLnVuaXQnLAogICAgICAgICAgICAgICAgJ3JlbFVzZXJzTGlzdC5lbXBsb3llZS5kZXBhcnRtZW50JywKICAgICAgICAgICAgICAgICdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUubG9jYXRpb24nLAogICAgICAgICAgICAgICAgJ3Byb2plY3RUYXNrLnN1YkRlbGl2ZXJhYmxlLmRlbGl2ZXJhYmxlLnByb2plY3QnCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgIC8vIC0+d2hlbihpc3NldChhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX3VuaXRfaWQpLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAvLyAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2hyX3VuaXRfaWQnLGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfdW5pdF9pZCk7CiAgICAgICAgICAgIC8vIH0pCiAgICAgICAgICAgIC0+ZmluZE9yRmFpbCgkaWQpOwoKICAgICAgICAgICAgJHJlcXVpc2l0aW9uWydyZXF1aXNpdGlvbl9xdHknXT0kcmVxdWlzaXRpb24tPml0ZW1zLT5zdW0oJ3F0eScpOwoKICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5yZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LT5lYWNoKGZ1bmN0aW9uICgkaXRlbSwkaSl7CiAgICAgICAgICAgICAgICAkaXRlbVsnZGVsaXZlcnlfcXR5J109ICRpdGVtLT5yZWxEZWxpdmVyeUl0ZW1zLT5zdW0oJ2RlbGl2ZXJ5X3F0eScpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgJHJlcXVpc2l0aW9uWyd0b3RhbF9kZWxpdmVyeV9xdHknXT0kcmVxdWlzaXRpb24tPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnN1bSgnZGVsaXZlcnlfcXR5Jyk7CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMuc3RvcmUuc3RvcmUtaW52ZW50b3J5LWNvbXBhcmUnLCBjb21wYWN0KCd0aXRsZScsJ3JlcXVpc2l0aW9uJykpOwoKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAqIENvbmZpcm0gZGVsaXZlcnkgZGF0YSByZXR1cm4gdG8gc3RvcmUgaW52ZW50b3J5IGNvbXBhcmUgZGVsaXZlcnkgLgogICAgKiBAcGFyYW0gIFxJbGx1bWluYXRlXEh0dHBcUmVxdWVzdCAgJHJlcXVlc3QKICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiBjb25maXJtRGVsaXZlcnkoJGlkKXsKCiAgICAgICAgLy9NYWtlIHByZWZpeCBmb3IgY29uZmlybSBkZWxpdmVyeS4KICAgICAgICAkcHJlZml4PSdDRC0nLmRhdGUoJ3knLCBzdHJ0b3RpbWUoZGF0ZSgnWS1tLWQnKSkpLictTUJNLSc7CiAgICAgICAgJHJlZk5vPXVuaXF1ZUNvZGUoMTQsJHByZWZpeCwncmVxdWlzaXRpb25fZGVsaXZlcmllcycsJ2lkJyk7CgogICAgICAgICR1c2VyVW5pdHMgPSBhdXRoKCktPnVzZXIoKS0+cHJpb3JpdGllcy0+cGx1Y2soJ2hyX3VuaXRfaWQnKS0+dG9BcnJheSgpOwogICAgICAgICR1c2VyRGVwYXJ0bWVudHMgPSBhdXRoKCktPnVzZXIoKS0+cHJpb3JpdGllcy0+cGx1Y2soJ2hyX2RlcGFydG1lbnRfaWQnKS0+dG9BcnJheSgpOwogICAgICAgICR1c2VyU2VjdGlvbnMgPSBhdXRoKCktPnVzZXIoKS0+cHJpb3JpdGllcy0+cGx1Y2soJ2hyX3NlY3Rpb25faWQnKS0+dG9BcnJheSgpOwoKICAgICAgICAvL0ZpbmQgcmVxdWlzdGlvbi4KICAgICAgICAkcmVxdWlzaXRpb249UmVxdWlzaXRpb246OndpdGgoJ3JlbFVzZXJzTGlzdCcpCiAgICAgICAgLT53aGVyZUhhcygncmVsVXNlcnNMaXN0LmVtcGxveWVlJywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHVzZXJVbml0cywgJHVzZXJEZXBhcnRtZW50cywgJHVzZXJTZWN0aW9ucyl7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2FzX3VuaXRfaWQnLCAkdXNlclVuaXRzKQogICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUluKCdhc19kZXBhcnRtZW50X2lkJywgJHVzZXJEZXBhcnRtZW50cyk7CiAgICAgICAgfSkKICAgICAgICAtPmZpbmRPckZhaWwoJGlkKTsKICAgICAgICAvL01ha2UgdGl0bGUuCiAgICAgICAgJHRpdGxlID0gJ1N0b3JlIEludmVudG9yeSBDb25maXJtIERlbGl2ZXJ5IHRvOiAnLiRyZXF1aXNpdGlvbi0+cmVsVXNlcnNMaXN0LT5uYW1lOwoKICAgICAgICB0cnkgewoKICAgICAgICAgICAgLy9SZXF1aXN0aW9uIGl0ZW1zIGNvbGxlY3QgdXNpbmcgcmVxdWlzdGlvbklkLgogICAgICAgICAgICAkcmVxdWlzaXRpb25JdGVtcyA9IFJlcXVpc2l0aW9uSXRlbTo6d2l0aChbCiAgICAgICAgICAgICAgICAncHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLAogICAgICAgICAgICAgICAgJ3Byb2R1Y3QucmVsSW52ZW50b3J5U3VtbWFyeScsCiAgICAgICAgICAgICAgICAncHJvZHVjdC5yZWxJbnZlbnRvcnlEZXRhaWxzLnJlbFdhcmVob3VzZScsCiAgICAgICAgICAgICAgICAncHJvZHVjdC5jYXRlZ29yeScKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZUhhcygncmVxdWlzaXRpb24nLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignZGVsaXZlcnlfc3RhdHVzJyxbJ3Byb2Nlc3NpbmcnLCdwYXJ0aWFsLWRlbGl2ZXJlZCcsJ3JmcCddKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZUhhcygncmVxdWlzaXRpb24ucmVsVXNlcnNMaXN0LmVtcGxveWVlJywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHVzZXJVbml0cywgJHVzZXJEZXBhcnRtZW50cywgJHVzZXJTZWN0aW9ucyl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdhc191bml0X2lkJywgJHVzZXJVbml0cykKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlSW4oJ2FzX2RlcGFydG1lbnRfaWQnLCAkdXNlckRlcGFydG1lbnRzKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZSgncmVxdWlzaXRpb25faWQnLCAkaWQpCiAgICAgICAgICAgIC0+Z2V0KCk7CgogICAgICAgICAgICBmb3JlYWNoICgkcmVxdWlzaXRpb25JdGVtcyBhcyAka2V5PT4kaXRlbSl7CiAgICAgICAgICAgICAgICBpZiAoaXNzZXQoJGl0ZW0tPnByb2R1Y3QtPmlkKSl7CiAgICAgICAgICAgICAgICAgICAgaWYgKCRpdGVtLT5xdHkhPSRpdGVtLT5kZWxpdmVyeV9xdHkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGl0ZW1bJ2l0ZW1fc3RvY2tfc3VtJ10gPSBJbnZlbnRvcnlEZXRhaWxzOjp3aGVyZUluKCd3YXJlaG91c2VfaWQnLCBhdXRoKCktPnVzZXIoKS0+cmVsVXNlcnNXYXJlaG91c2UtPnBsdWNrKCdpZCcpLT50b0FycmF5KCkpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmUoWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2NhdGVnb3J5X2lkJyA9PiAkaXRlbS0+cHJvZHVjdC0+Y2F0ZWdvcnlfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAncHJvZHVjdF9pZCcgPT4gJGl0ZW0tPnByb2R1Y3RfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnaHJfdW5pdF9pZCcgPT4gKGlzc2V0KGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfdW5pdF9pZCkgPyBhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX3VuaXRfaWQgOiAwKQogICAgICAgICAgICAgICAgICAgICAgICBdKS0+c3VtKCdxdHknKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpc3NldCgkaXRlbS0+cHJvZHVjdC0+cmVsSW52ZW50b3J5RGV0YWlscykpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRpdGVtV2FyZWhvdXNlU3RvY2sgPSAkaXRlbS0+cHJvZHVjdC0+cmVsSW52ZW50b3J5RGV0YWlscy0+ZWFjaChmdW5jdGlvbiAoJGRhdGEsJGkpIHVzZSgkaXRlbSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaW5fYXJyYXkoJGRhdGEtPndhcmVob3VzZV9pZCwgYXV0aCgpLT51c2VyKCktPnJlbFVzZXJzV2FyZWhvdXNlLT5wbHVjaygnaWQnKS0+dG9BcnJheSgpKSl7CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZGF0YVsnaXRlbV93YXJlaG91c2Vfc3RvY2tfc3VtJ109IEludmVudG9yeURldGFpbHM6OndoZXJlKFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd3YXJlaG91c2VfaWQnID0+ICRkYXRhLT53YXJlaG91c2VfaWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY2F0ZWdvcnlfaWQnID0+ICRpdGVtLT5wcm9kdWN0LT5jYXRlZ29yeV9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwcm9kdWN0X2lkJyA9PiAkaXRlbS0+cHJvZHVjdF9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdocl91bml0X2lkJyA9PiAoaXNzZXQoYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc191bml0X2lkKSA/IGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfdW5pdF9pZCA6IDApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdKS0+c3VtKCdxdHknKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgJGNvc3RDZW50cmVzID0gZ2V0Q29zdENlbnRyZXModHJ1ZSk7CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMuc3RvcmUuc3RvcmUtaW52ZW50b3J5LWRlbGl2ZXJ5JywgY29tcGFjdCgndGl0bGUnLCAncmVxdWlzaXRpb25JdGVtcycsICdyZXF1aXNpdGlvbicsICdyZWZObycsICdjb3N0Q2VudHJlcycpKTsKCiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgKiBDb25maXJtIGRlbGl2ZXJ5IHN1Ym1pdC9zdG9yZS4KICAgICogQHBhcmFtICBcSWxsdW1pbmF0ZVxIdHRwXFJlcXVlc3QgICRyZXF1ZXN0CiAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gY29uZmlybURlbGl2ZXJ5U3VibWl0KFJlcXVlc3QgJHJlcXVlc3QpewoKICAgICAgICAkdGhpcy0+dmFsaWRhdGUoJHJlcXVlc3QsIFsKICAgICAgICAgICAgJ2RlbGl2ZXJ5X3F0eScgID0+ICJyZXF1aXJlZHxhcnJheXxtaW46MSIsCiAgICAgICAgICAgICdkZWxpdmVyeV9kYXRlJyA9PiAncmVxdWlyZWR8ZGF0ZScsCiAgICAgICAgICAgICdyZWZlcmVuY2Vfbm8nICA9PiAicmVxdWlyZWR8dW5pcXVlOnJlcXVpc2l0aW9uX2RlbGl2ZXJpZXN8bWF4OjEwMCIsCiAgICAgICAgXSk7CgogICAgICAgICRjb3VudERlbGl2ZXJ5SXRlbXMgPSBjb3VudChhcnJheV9maWx0ZXIoJHJlcXVlc3QtPmRlbGl2ZXJ5X3F0eSxmdW5jdGlvbiAoJGRlbGl2ZXJ5UXR5KXsKICAgICAgICAgICAgcmV0dXJuICFpc19udWxsKCRkZWxpdmVyeVF0eSk7CiAgICAgICAgfSkpOwoKICAgICAgICBpZiAoJGNvdW50RGVsaXZlcnlJdGVtcyA8PSAwKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aFdhcm5pbmcoJ1BsZWFzZSBzZWxlY3QgYXQgbGVhc3Qgb25lIHByb2R1Y3QgZm9yIGRlbGl2ZXJ5LicpOwogICAgICAgIH0KCiAgICAgICAgaWYoaXNzZXQoJHJlcXVlc3QtPmRlbGl2ZXJ5X3F0eSkgJiYgaXNfYXJyYXkoJHJlcXVlc3QtPmRlbGl2ZXJ5X3F0eSkpewogICAgICAgICAgICBmb3JlYWNoICgkcmVxdWVzdC0+ZGVsaXZlcnlfcXR5IGFzICRwcm9kdWN0SWQgPT4gJHF0eSkgewogICAgICAgICAgICAgICAgaWYoJHF0eSA+IDApewogICAgICAgICAgICAgICAgICAgICRwcm9kdWN0ID0gUHJvZHVjdDo6ZmluZE9yRmFpbCgkcHJvZHVjdElkKTsKICAgICAgICAgICAgICAgICAgICBpZighKCRwcm9kdWN0LT5jYXRlZ29yeS0+aXNfZml4ZWRfYXNzZXQgPT0gMSB8fCAkcHJvZHVjdC0+Y2F0ZWdvcnktPmlzX2N3aXAgPT0gMSkgJiYgJHJlcXVlc3QtPmNvc3RfY2VudHJlX2lkWyRwcm9kdWN0SWRdIDw9IDApewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoV2FybmluZygnUGxlYXNlIHNlbGVjdCBDb3N0IENlbnRyZSBmb3IgSXRlbSBEZWxpdmVyeScpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICB0cnkgewogICAgICAgICAgICAkbGVkZ2VySXRlbXMgPSBbXTsKCiAgICAgICAgICAgICRyZXF1aXNpdGlvbklkID0gJHJlcXVlc3QtPnJlcXVpc2l0aW9uX2lkOwogICAgICAgICAgICAkcmVxdWlzaXRpb24gPSBSZXF1aXNpdGlvbjo6ZmluZE9yRmFpbCgkcmVxdWlzaXRpb25JZCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZigkcmVxdWlzaXRpb24tPnB1cmNoYXNlT3JkZXJzLT5jb3VudCgpID4gMCl7CiAgICAgICAgICAgICAgICAkY29zdF9jZW50cmVfaWQgPSAkcmVxdWlzaXRpb24tPnB1cmNoYXNlT3JkZXJzWzBdLT5wdXJjaGFzZU9yZGVyLT5jb3N0X2NlbnRyZV9pZDsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAkY29zdF9jZW50cmVfaWQgPSBDb3N0Q2VudHJlOjp3aGVyZShbCiAgICAgICAgICAgICAgICAgICAgJ2hyX3VuaXRfaWQnID0+ICRyZXF1aXNpdGlvbi0+cmVsVXNlcnNMaXN0LT5lbXBsb3llZS0+YXNfdW5pdF9pZCwKICAgICAgICAgICAgICAgICAgICAnaHJfZGVwYXJ0bWVudF9pZCcgPT4gJHJlcXVpc2l0aW9uLT5yZWxVc2Vyc0xpc3QtPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkLAogICAgICAgICAgICAgICAgXSktPmZpcnN0KCktPmlkOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkcHJvamVjdCA9IGlzc2V0KCRyZXF1aXNpdGlvbi0+cHJvamVjdFRhc2stPmlkKTsKICAgICAgICAgICAgJHB1cmNoYXNlT3JkZXIgPSBQdXJjaGFzZU9yZGVyOjp3aGVyZUhhcygncHVyY2hhc2VPcmRlclJlcXVpc2l0aW9ucycsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRyZXF1aXNpdGlvbklkKXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdyZXF1aXNpdGlvbl9pZCcsICRyZXF1aXNpdGlvbklkKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5maXJzdCgpOwogICAgICAgICAgICAkcmVxdWlzaXRpb25EZWxpdmVyeSA9ICR0aGlzLT5zdG9yZVJlcXVpc2l0aW9uRGVsaXZlcnkoJHJlcXVlc3QpOwoKICAgICAgICAgICAgJGl0ZW1Ub3RhbERlbGl2ZXJ5UXR5ID0gMDsKICAgICAgICAgICAgJHRvdGFsRGVsaXZlcnlRdHkgPSAwOwogICAgICAgICAgICAkcmVxdWlzaXRpb25EZWxpdmVyeUl0ZW1JbnB1dCA9IFtdOwogICAgICAgICAgICBmb3JlYWNoICgkcmVxdWVzdC0+ZGVsaXZlcnlfcXR5IGFzICRwcm9kdWN0SWQ9PiRkZWxpdmVyeVF0eSl7CiAgICAgICAgICAgICAgICBpZiAoJGRlbGl2ZXJ5UXR5ID4gMCAmJiBpc3NldCgkcmVxdWVzdC0+d2FyZWhvdXNlX2lkWyRwcm9kdWN0SWRdKSAmJiAkcmVxdWVzdC0+d2FyZWhvdXNlX2lkWyRwcm9kdWN0SWRdID4gMCl7CgogICAgICAgICAgICAgICAgICAgIGlmKGlzc2V0KCRyZXF1ZXN0LT5jb3N0X2NlbnRyZV9pZFskcHJvZHVjdElkXSkpewogICAgICAgICAgICAgICAgICAgICAgICAkY29zdF9jZW50cmVfaWQgPSAkcmVxdWVzdC0+Y29zdF9jZW50cmVfaWRbJHByb2R1Y3RJZF07CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvL1ByZXBhcmUgcHJlLXJlcXVpc2l0ZSBkYXRhLgogICAgICAgICAgICAgICAgICAgICRwcm9kdWN0ID0gUHJvZHVjdDo6d2hlcmUoJ2lkJywkcHJvZHVjdElkKS0+Zmlyc3QoKTsKICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25JdGVtID0gUmVxdWlzaXRpb25JdGVtOjp3aGVyZSgncmVxdWlzaXRpb25faWQnLCAkcmVxdWlzaXRpb25JZCkKICAgICAgICAgICAgICAgICAgICAtPndoZXJlKCdwcm9kdWN0X2lkJywgJHByb2R1Y3RJZCkKICAgICAgICAgICAgICAgICAgICAtPmZpcnN0KCk7CgogICAgICAgICAgICAgICAgICAgIC8vKEN1cnJlbnQgZGVsaXZlcnkgcXR5ICsgcHJldmlvdXMgZGVsaXZlcnkgcXR5KQogICAgICAgICAgICAgICAgICAgICRpdGVtVG90YWxEZWxpdmVyeVF0eT0oJGRlbGl2ZXJ5UXR5KyRyZXF1aXNpdGlvbkl0ZW0tPmRlbGl2ZXJ5X3F0eSk7CiAgICAgICAgICAgICAgICAgICAgJHRvdGFsRGVsaXZlcnlRdHkrPSRpdGVtVG90YWxEZWxpdmVyeVF0eTsKCiAgICAgICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkcmVxdWlzaXRpb25EZWxpdmVyeUl0ZW1JbnB1dCwgWwogICAgICAgICAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25fZGVsaXZlcnlfaWQnID0+ICRyZXF1aXNpdGlvbkRlbGl2ZXJ5LT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgJ3dhcmVob3VzZV9pZCcgPT4gJHJlcXVlc3QtPndhcmVob3VzZV9pZFskcHJvZHVjdElkXSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3Byb2R1Y3RfaWQnID0+ICRwcm9kdWN0SWQsCiAgICAgICAgICAgICAgICAgICAgICAgICdkZWxpdmVyeV9xdHknID0+ICRkZWxpdmVyeVF0eSwKICAgICAgICAgICAgICAgICAgICBdKTsKCiAgICAgICAgICAgICAgICAgICAgLy9DaGVjayByZXF1aXNpdGlvbiBxdHkgYW5kIGRlbGl2ZXJ5IHF0eShjdXJyZW50IGRlbGl2ZXJ5IHF0eSArIHByZXZpb3VzIGRlbGl2ZXJ5IHF0eSkKCiAgICAgICAgICAgICAgICAgICAgaWYoJGl0ZW1Ub3RhbERlbGl2ZXJ5UXR5ID4gKCRyZXF1aXNpdGlvbkl0ZW0tPnFjX3F0eSkpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoV2FybmluZygnRGVsaXZlcnkgcXR5IGlzIGdyZWF0ZXIgdGhlbiByZXF1aXNpdGlvbiBxdHkuIFBsZWFzZSBBZGp1c3QgSXQgZm9yIHByb2R1Y3QgJy4kcHJvZHVjdC0+bmFtZSk7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAvLyBVcGRhdGUgaXRlbSB3aXNlIHRvdGFsIGRlbGl2ZXJ5IFF0eSAoY3VycmVudCBkZWxpdmVyeSBxdHkgKyBwcmV2aW91cyBkZWxpdmVyeSBxdHkpCgogICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW0tPnVwZGF0ZShbJ2RlbGl2ZXJ5X3F0eScgPT4gJGl0ZW1Ub3RhbERlbGl2ZXJ5UXR5XSk7CgogICAgICAgICAgICAgICAgICAgICR1bml0UHJpY2UgPSBcQXBwXE1vZGVsc1xQbXNNb2RlbHNcR3JuXEdvb2RzUmVjZWl2ZWRJdGVtU3RvY2tJbjo6d2hlcmVIYXMoJ3JlbFB1cmNoYXNlT3JkZXIucHVyY2hhc2VPcmRlclJlcXVpc2l0aW9ucycsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRyZXF1aXNpdGlvbkl0ZW0pewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncmVxdWlzaXRpb25faWQnLCAkcmVxdWlzaXRpb25JdGVtLT5yZXF1aXNpdGlvbl9pZCk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdyZWxHb29kc1JlY2VpdmVkSXRlbXMnLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkcmVxdWlzaXRpb25JdGVtKXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3Byb2R1Y3RfaWQnLCAkcmVxdWlzaXRpb25JdGVtLT5wcm9kdWN0X2lkKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+Zmlyc3QoKS0+dW5pdF9hbW91bnQ7CgogICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkRlbGl2ZXJ5SXRlbSA9IFJlcXVpc2l0aW9uRGVsaXZlcnlJdGVtOjpjcmVhdGUoWwogICAgICAgICAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25fZGVsaXZlcnlfaWQnID0+ICRyZXF1aXNpdGlvbkRlbGl2ZXJ5LT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgJ3dhcmVob3VzZV9pZCcgPT4gJHJlcXVlc3QtPndhcmVob3VzZV9pZFskcHJvZHVjdElkXSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3Byb2R1Y3RfaWQnID0+ICRwcm9kdWN0SWQsCiAgICAgICAgICAgICAgICAgICAgICAgICdkZWxpdmVyeV9xdHknID0+ICRkZWxpdmVyeVF0eSwKICAgICAgICAgICAgICAgICAgICBdKTsKCiAgICAgICAgICAgICAgICAgICAgaWYoJHJlcXVpc2l0aW9uSXRlbS0+cHJvZHVjdC0+Y2F0ZWdvcnktPmlzX2ZpeGVkX2Fzc2V0ID09IDAgJiYgJHJlcXVpc2l0aW9uSXRlbS0+cHJvZHVjdC0+Y2F0ZWdvcnktPmlzX2N3aXAgPT0gMCAmJiAhJHByb2plY3QgJiYgJGRlbGl2ZXJ5UXR5ID4gMCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5X3B1c2goJGxlZGdlckl0ZW1zLCBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY29zdF9jZW50cmVfaWQnID0+ICRjb3N0X2NlbnRyZV9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdjaGFydF9vZl9hY2NvdW50X2lkJyA9PiAoaXNzZXQoJHJlcXVpc2l0aW9uSXRlbS0+cHJvZHVjdC0+Y29nc19hY2NvdW50X2lkKSAmJiAkcmVxdWlzaXRpb25JdGVtLT5wcm9kdWN0LT5jb2dzX2FjY291bnRfaWQgPiAwID8gJHJlcXVpc2l0aW9uSXRlbS0+cHJvZHVjdC0+Y29nc19hY2NvdW50X2lkIDogYWNjb3VudERlZmF1bHRTZXR0aW5ncygpWydjb2dzX2FjY291bnQnXSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnZGViaXQnID0+ICRkZWxpdmVyeVF0eSokdW5pdFByaWNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2NyZWRpdCcgPT4gMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICduYXJyYXRpb24nID0+ICJQcm9kdWN0IERlbGl2ZXJ5IDo6IENPR1MgRGViaXQiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3R5cGUnID0+ICdwcm9kdWN0LWRlbGl2ZXJ5JywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdzb3VyY2UnID0+ICRyZXF1aXNpdGlvbkRlbGl2ZXJ5SXRlbS0+aWQKICAgICAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFycmF5X3B1c2goJGxlZGdlckl0ZW1zLCBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY29zdF9jZW50cmVfaWQnID0+ICRjb3N0X2NlbnRyZV9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdjaGFydF9vZl9hY2NvdW50X2lkJyA9PiAoaXNzZXQoJHJlcXVpc2l0aW9uSXRlbS0+cHJvZHVjdC0+aW52ZW50b3J5X2FjY291bnRfaWQpICYmICRyZXF1aXNpdGlvbkl0ZW0tPnByb2R1Y3QtPmludmVudG9yeV9hY2NvdW50X2lkID4gMCA/ICRyZXF1aXNpdGlvbkl0ZW0tPnByb2R1Y3QtPmludmVudG9yeV9hY2NvdW50X2lkIDogYWNjb3VudERlZmF1bHRTZXR0aW5ncygpWydpbnZlbnRvcnlfYWNjb3VudCddKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkZWJpdCcgPT4gMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdjcmVkaXQnID0+ICRkZWxpdmVyeVF0eSokdW5pdFByaWNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ25hcnJhdGlvbicgPT4gIlByb2R1Y3QgRGVsaXZlcnkgOjogSW52ZW50b3J5IENyZWRpdCIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAndHlwZScgPT4gJ3Byb2R1Y3QtZGVsaXZlcnknLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3NvdXJjZScgPT4gJHJlcXVpc2l0aW9uRGVsaXZlcnlJdGVtLT5pZAogICAgICAgICAgICAgICAgICAgICAgICBdKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICRyZXN1bHQgPSAkdGhpcy0+dXBkYXRlSW52ZW50b3J5QW5kTG9nKCRyZXF1ZXN0LCAkcHJvZHVjdCwgJGRlbGl2ZXJ5UXR5LCAkcmVxdWVzdC0+d2FyZWhvdXNlX2lkWyRwcm9kdWN0SWRdLCAkcmVxdWlzaXRpb25EZWxpdmVyeS0+cmVmZXJlbmNlX25vKTsKCiAgICAgICAgICAgICAgICAgICAgLy8gY2hlY2sgZGVsaXZlcnkgcXR5IGFuZCB3YXJlaG91c2Ugd2lzZSBwcm9kdWN0IHF0eQogICAgICAgICAgICAgICAgICAgIGlmICgkcmVzdWx0ID09PSBmYWxzZSl7IAogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoV2FybmluZygnRGVsaXZlcnkgcXR5IG1heSBub3QgZ3JhdGVyIHRoYW4gc3RvcmUgcXR5IGZvciBwcm9kdWN0ICcuJHByb2R1Y3QtPm5hbWUpOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uTW9kZWwgPSBSZXF1aXNpdGlvbjo6ZmluZE9yRmFpbCgkcmVxdWlzaXRpb25JZCk7CgogICAgICAgICAgICAgICAgICAgICR0b3RhbFJlcXVpc2l0aW9uUXR5ID0gJHJlcXVpc2l0aW9uTW9kZWwtPnJlcXVpc2l0aW9uSXRlbXMtPnN1bSgncWNfcXR5Jyk7CgogICAgICAgICAgICAgICAgICAgIC8vUmVxdWlzdGlvbiB0cmFja2luZwogICAgICAgICAgICAgICAgICAgIFJlcXVpc2l0aW9uVHJhY2tpbmc6OnN0b3JlUmVxdWlzaXRpb25UcmFja2luZygkcmVxdWlzaXRpb25Nb2RlbC0+aWQsICdkZWxpdmVyZWQnKTsKCiAgICAgICAgICAgICAgICAgICAgLy9VcGRhdGUgcmVxdWlzaXRpb24gc3RhdHVzIChjdXJyZW50IGRlbGl2ZXJ5IHF0eSArIHByZXZpb3VzIGRlbGl2ZXJ5IHF0eSkKICAgICAgICAgICAgICAgICAgICBpZiAoJHRvdGFsRGVsaXZlcnlRdHkgPT0gJHRvdGFsUmVxdWlzaXRpb25RdHkpewogICAgICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25Nb2RlbC0+dXBkYXRlKFsnZGVsaXZlcnlfc3RhdHVzJz0+J2RlbGl2ZXJlZCddKTsKICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uTW9kZWwtPnVwZGF0ZShbJ2RlbGl2ZXJ5X3N0YXR1cyc9PidwYXJ0aWFsLWRlbGl2ZXJlZCddKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIC8vTm90aWZpY2F0aW9uCgogICAgICAgICAgICAgICAgICAgIGlmKCFlbXB0eSgkcmVxdWlzaXRpb25JdGVtKSkKICAgICAgICAgICAgICAgICAgICB7ICAKICAgICAgICAgICAgICAgICAgICAgICAgJG5vdGlmaWNhdGlvbiA9IG5ldyBOb3RpZmljYXRpb24oKTsKICAgICAgICAgICAgICAgICAgICAgICAgJG5vdGlmaWNhdGlvbi0+dXNlcl9pZCA9ICRyZXF1aXNpdGlvbkl0ZW0tPnJlcXVpc2l0aW9uLT5hdXRob3JfaWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICRub3RpZmljYXRpb24tPnJlcXVpc2l0aW9uX2l0ZW1faWQgPSAkcmVxdWlzaXRpb25JdGVtLT5pZDsKCiAgICAgICAgICAgICAgICAgICAgICAgICRtZXNzYWdlPSAnPHNwYW4gY2xhc3M9Im5vdGlmaWNhdGlvbi1saW5rcyIgZGF0YS1zcmM9Iicucm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5saXN0LnZpZXcuc2hvdycsJHJlcXVpc2l0aW9uSXRlbS0+cmVxdWlzaXRpb24tPmlkKS4nP3ZpZXciIGRhdGEtdGl0bGU9IlJlcXVpc2l0aW9uIERldGFpbHMiPlJlZmVyZW5jZSBObzonLiRyZXF1aXNpdGlvbkl0ZW0tPnJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm8uJyBBbmQgSXRlbSBOYW1lOiAnLiRyZXF1aXNpdGlvbkl0ZW0tPnByb2R1Y3QtPm5hbWUuJy4gU3VjY2Vzc2Z1bGx5IGRlbGl2ZXJlZCB5b3VyIHByb2R1Y3QuUGxlYXNlIGFja25vd2xlZGdlIGl0PC9zcGFuPic7CgogICAgICAgICAgICAgICAgICAgICAgICAkbm90aWZpY2F0aW9uLT5tZXNzYWdlcyA9ICRtZXNzYWdlOwoKICAgICAgICAgICAgICAgICAgICAgICAgJG5vdGlmaWNhdGlvbi0+c2F2ZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLyoKICAgICAgICAgICAgLy9QdXNoIHJlcXVpc3Rpb24gZGVsaXZlcnkgaXRlbSBhcnJheSBpbiB0aGlzIG1vZGVsCiAgICAgICAgICAgIGlmKGlzc2V0KCRyZXF1aXNpdGlvbkRlbGl2ZXJ5SXRlbUlucHV0WzBdKSl7CiAgICAgICAgICAgICAgICAvLyBSZXF1aXNpdGlvbkRlbGl2ZXJ5SXRlbTo6aW5zZXJ0KCRyZXF1aXNpdGlvbkRlbGl2ZXJ5SXRlbUlucHV0KTsKCiAgICAgICAgICAgICAgICAkaXRlbXMgPSBSZXF1aXNpdGlvbkRlbGl2ZXJ5SXRlbTo6d2hlcmUoJ3JlcXVpc2l0aW9uX2RlbGl2ZXJ5X2lkJywgJHJlcXVpc2l0aW9uRGVsaXZlcnktPmlkKS0+Z2V0KCk7CiAgICAgICAgICAgICAgICAkY291bnQgPSAwOwogICAgICAgICAgICAgICAgaWYoaXNzZXQoJGl0ZW1zWzBdKSl7CiAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJGl0ZW1zIGFzICRrZXkgPT4gJGl0ZW0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgJGNhcGl0YWxpemUgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICBpZigkcHJvamVjdCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZigkaXRlbS0+cHJvZHVjdC0+Y2F0ZWdvcnktPmlzX2N3aXAgPT0gMSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNhcGl0YWxpemUgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZigkaXRlbS0+cHJvZHVjdC0+Y2F0ZWdvcnktPmlzX2ZpeGVkX2Fzc2V0ID09IDApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRjYXBpdGFsaXplID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIHJldHVybiBbCiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAncHJvamVjdCcgPT4gJHByb2plY3QsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAnaXNfY3dpcCcgPT4gKCRpdGVtLT5wcm9kdWN0LT5jYXRlZ29yeS0+aXNfY3dpcCA9PSAxKSwKICAgICAgICAgICAgICAgICAgICAgICAgLy8gICAgICdpc19maXhlZF9hc3NldCcgPT4gKCRpdGVtLT5wcm9kdWN0LT5jYXRlZ29yeS0+aXNfZml4ZWRfYXNzZXQgPT0gMSksCiAgICAgICAgICAgICAgICAgICAgICAgIC8vICAgICAnY2FwaXRhbGl6ZScgPT4gJGNhcGl0YWxpemUsCiAgICAgICAgICAgICAgICAgICAgICAgIC8vIF07CgogICAgICAgICAgICAgICAgICAgICAgICAvLyBkZCgkY2FwaXRhbGl6ZSk7CgogICAgICAgICAgICAgICAgICAgICAgICBpZigkY2FwaXRhbGl6ZSAmJiAkaXRlbS0+ZGVsaXZlcnlfcXR5ID4gMCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYmF0Y2ggPSBGaXhlZEFzc2V0QmF0Y2g6OmNyZWF0ZShbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3JlcXVpc2l0aW9uX2RlbGl2ZXJ5X2l0ZW1faWQnID0+ICRpdGVtLT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYmF0Y2gnID0+IHVuaXF1ZUNvZGVXaXRob3V0UHJlZml4KDgsICdmaXhlZF9hc3NldF9iYXRjaGVzJywgJ2JhdGNoJyksCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdkZXByZWNpYXRpb25fbWV0aG9kX2lkJyA9PiAkaXRlbS0+cHJvZHVjdC0+ZGVwcmVjaWF0aW9uX21ldGhvZF9pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnYmFzZV9yYXRlJyA9PiAkaXRlbS0+cHJvZHVjdC0+YmFzZV9yYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdyYXRlX211bHRpcGxpZXInID0+ICRpdGVtLT5wcm9kdWN0LT5yYXRlX211bHRpcGxpZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2RlcHJlY2lhdGlvbl9yYXRlJyA9PiAkaXRlbS0+cHJvZHVjdC0+ZGVwcmVjaWF0aW9uX3JhdGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2lzX3llYXJseScgPT4gJGl0ZW0tPnByb2R1Y3QtPmlzX3llYXJseSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAneWVhcnMnID0+ICRpdGVtLT5wcm9kdWN0LT55ZWFycywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnaXNfb25ldGltZScgPT4gJGl0ZW0tPnByb2R1Y3QtPmlzX29uZXRpbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ2RlcHJlY2lhdGlvbl9zdGFydF9kYXRlJyA9PiAkaXRlbS0+cmVsUmVxdWlzaXRpb25EZWxpdmVyeS0+ZGVsaXZlcnlfZGF0ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoJGJhdGNoKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IoJGk9MTskaTw9JGl0ZW0tPmRlbGl2ZXJ5X3F0eTskaSsrKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgRml4ZWRBc3NldEJhdGNoSXRlbTo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdmaXhlZF9hc3NldF9iYXRjaF9pZCcgPT4gJGJhdGNoLT5pZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdhc3NldF9jb2RlJyA9PiAkYmF0Y2gtPmJhdGNoLictJy4kaSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgICovCgogICAgICAgICAgICBpZihpc3NldCgkbGVkZ2VySXRlbXNbMF0pKXsKICAgICAgICAgICAgICAgICRlbnRyeSA9IHNhdmVMZWRnZXJFbnRyaWVzKDUsIGRhdGUoJ1ktbS1kIEg6aTpzJywgc3RydG90aW1lKCRyZXF1ZXN0LT5kZWxpdmVyeV9kYXRlLicgJy5kYXRlKCdIOmk6cycpKSksIDEsICcnLCAnUHJvZHVjdCBEZWxpdmVyeScsICRsZWRnZXJJdGVtcywgJHB1cmNoYXNlT3JkZXItPnJlbFF1b3RhdGlvbi0+ZXhjaGFuZ2VfcmF0ZV9pZCwgMCwgMCwgMCwgZ2V0Q29zdENlbnRyZUNvbXBhbnkoJHB1cmNoYXNlT3JkZXItPmNvc3RfY2VudHJlX2lkKSk7CiAgICAgICAgICAgICAgICBzYXZlUE9FbnRyeSgkZW50cnksICRwdXJjaGFzZU9yZGVyLT5yZWxRdW90YXRpb24tPnN1cHBsaWVyX2lkLCAkcHVyY2hhc2VPcmRlci0+aWQsICdwcm9kdWN0LWRlbGl2ZXJ5Jyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIERCOjpjb21taXQoKTsKCiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhTdWNjZXNzKCdSZXF1aXNpdGlvbiBEZWxpdmVyeSBTdWNjZXNzZnVsbHknKTsKCiAgICAgICAgfWNhdGNoIChUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgKiBTdG9yZSBSZXF1aXN0aW9uIGRlbGl2ZXJ5IGRhdGEuCiAgICAqIEBwYXJhbSAgXElsbHVtaW5hdGVcSHR0cFxSZXF1ZXN0ICAkcmVxdWVzdAogICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIHN0b3JlUmVxdWlzaXRpb25EZWxpdmVyeSgkcmVxdWVzdCl7CiAgICAgICAgcmV0dXJuIFJlcXVpc2l0aW9uRGVsaXZlcnk6OmNyZWF0ZShbCiAgICAgICAgICAgICdyZXF1aXNpdGlvbl9pZCc9PiRyZXF1ZXN0LT5yZXF1aXNpdGlvbl9pZCwKICAgICAgICAgICAgJ3JlZmVyZW5jZV9ubyc9PiRyZXF1ZXN0LT5yZWZlcmVuY2Vfbm8sCiAgICAgICAgICAgICdkZWxpdmVyeV9kYXRlJz0+ZGF0ZSgnWS1tLWQnLHN0cnRvdGltZSgkcmVxdWVzdC0+ZGVsaXZlcnlfZGF0ZSkpLAogICAgICAgICAgICAnbm90ZSc9PiRyZXF1ZXN0LT5ub3RlLAogICAgICAgICAgICAnZGVsaXZlcnlfYnknPT5BdXRoOjp1c2VyKCktPmlkLAogICAgICAgICAgICAnY3JlYXRlZF9ieSc9PkF1dGg6OnVzZXIoKS0+aWQsCiAgICAgICAgXSk7CiAgICB9CgogICAgLyoqCiAgICAqIFVwZGF0ZSBpbnZlbnRvcnkgJiBsb2cuCiAgICAqIEBwYXJhbSAgXElsbHVtaW5hdGVcSHR0cFxSZXF1ZXN0ICAkcmVxdWVzdAogICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIHVwZGF0ZUludmVudG9yeUFuZExvZygkcmVxdWVzdCwkcHJvZHVjdCwkZGVsaXZlcnlRdHksJHdhcmVob3VzZUlkLCRyZWZlcmVuY2Vfbm89JycpewoKICAgICAgICAvL1VwZGF0ZSBJbnZlbnRvcnkgU3VtbWFyeQogICAgICAgICRJbnZlbnRvcnlTdW1tYXJ5ID0gSW52ZW50b3J5U3VtbWFyeTo6d2hlcmUoWwogICAgICAgICAgICAncHJvZHVjdF9pZCc9PiRwcm9kdWN0LT5pZAogICAgICAgIF0pLT5maXJzdCgpOwoKICAgICAgICAkdG90YWxQcmljZSA9ICgoJEludmVudG9yeVN1bW1hcnktPnF0eSktKCRkZWxpdmVyeVF0eSkpKiRJbnZlbnRvcnlTdW1tYXJ5LT51bml0X3ByaWNlOwogICAgICAgICRJbnZlbnRvcnlTdW1tYXJ5LT5xdHkgPSAoJEludmVudG9yeVN1bW1hcnktPnF0eSktKCRkZWxpdmVyeVF0eSk7CiAgICAgICAgJEludmVudG9yeVN1bW1hcnktPnRvdGFsX3ByaWNlID0gJHRvdGFsUHJpY2U7CiAgICAgICAgJEludmVudG9yeVN1bW1hcnktPnN0YXR1cyA9ICdhY3RpdmUnOwogICAgICAgICRJbnZlbnRvcnlTdW1tYXJ5LT5zYXZlKCk7CiAgICAgICAgCiAgICAgICAgLy9VcGRhdGUgSW52ZW50b3J5IGRldGFpbHMKICAgICAgICAkSW52ZW50b3J5RGV0YWlscyA9IEludmVudG9yeURldGFpbHM6OndoZXJlKFsKICAgICAgICAgICAgJ2NhdGVnb3J5X2lkJz0+JHByb2R1Y3QtPmNhdGVnb3J5X2lkLAogICAgICAgICAgICAncHJvZHVjdF9pZCc9PiRwcm9kdWN0LT5pZCwKICAgICAgICAgICAgJ3dhcmVob3VzZV9pZCc9PiR3YXJlaG91c2VJZCwKICAgICAgICAgICAgJ2hyX3VuaXRfaWQnPT5hdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX3VuaXRfaWQsCiAgICAgICAgXSktPmZpcnN0KCk7CgogICAgICAgIGlmICgkZGVsaXZlcnlRdHk+KGlzc2V0KCRJbnZlbnRvcnlEZXRhaWxzLT5xdHkpID8gJEludmVudG9yeURldGFpbHMtPnF0eSA6IDApKXsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0KCiAgICAgICAgJHRvdGFsUHJpY2VPZkludmVudG9yeURldGFpbHMgPSAoKCRJbnZlbnRvcnlEZXRhaWxzLT5xdHkpLSgkZGVsaXZlcnlRdHkpKSokSW52ZW50b3J5RGV0YWlscy0+dW5pdF9wcmljZTsKICAgICAgICAkSW52ZW50b3J5RGV0YWlscy0+cXR5ID0gJEludmVudG9yeURldGFpbHMtPnF0eS0kZGVsaXZlcnlRdHk7CiAgICAgICAgJEludmVudG9yeURldGFpbHMtPnRvdGFsX3ByaWNlID0gJHRvdGFsUHJpY2VPZkludmVudG9yeURldGFpbHM7CiAgICAgICAgJEludmVudG9yeURldGFpbHMtPnN0YXR1cyA9ICdhY3RpdmUnOwogICAgICAgICRJbnZlbnRvcnlEZXRhaWxzLT5zYXZlKCk7CgogICAgICAgIC8vQWRkIFRyYWNlIG9uIEludmV0b3J5IExvZ3MvVHJhbnNlY3Rpb24gVGFibGUKICAgICAgICAkSW52ZW50b3J5TG9ncyA9IG5ldyBJbnZlbnRvcnlMb2dzKCk7CiAgICAgICAgJEludmVudG9yeUxvZ3MtPmNhdGVnb3J5X2lkID0gJHByb2R1Y3QtPmNhdGVnb3J5X2lkOwogICAgICAgICRJbnZlbnRvcnlMb2dzLT5wcm9kdWN0X2lkID0gJHByb2R1Y3QtPmlkOwogICAgICAgICRJbnZlbnRvcnlMb2dzLT53YXJlaG91c2VfaWQgPSAkd2FyZWhvdXNlSWQ7CiAgICAgICAgJEludmVudG9yeUxvZ3MtPmhyX3VuaXRfaWQgPSBpc3NldChhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX3VuaXRfaWQpP2F1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfdW5pdF9pZDpudWxsOwogICAgICAgICRJbnZlbnRvcnlMb2dzLT51bml0X3ByaWNlID0gJEludmVudG9yeURldGFpbHMtPnVuaXRfcHJpY2U7CiAgICAgICAgJEludmVudG9yeUxvZ3MtPnF0eSA9ICRkZWxpdmVyeVF0eTsKICAgICAgICAkSW52ZW50b3J5TG9ncy0+dG90YWxfcHJpY2UgPSAoJGRlbGl2ZXJ5UXR5KiRJbnZlbnRvcnlEZXRhaWxzLT51bml0X3ByaWNlKTsKICAgICAgICAkSW52ZW50b3J5TG9ncy0+cmVmZXJlbmNlID0gJHJlZmVyZW5jZV9ubzsKICAgICAgICAkSW52ZW50b3J5TG9ncy0+c3RhdHVzID0gJ2FjdGl2ZSc7CiAgICAgICAgJEludmVudG9yeUxvZ3MtPnR5cGUgPSAnb3V0JzsKICAgICAgICAkSW52ZW50b3J5TG9ncy0+c2F2ZSgpOwogICAgICAgIHJldHVybiB0cnVlOwogICAgfQoKICAgIC8qKgogICAgICogU2hvdyB0aGUgZm9ybSBmb3IgY3JlYXRpbmcgYSBuZXcgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiBwdXJjaGFzZURlcGFydG1lbnQoUmVxdWVzdCAkcmVxdWVzdCkKICAgIHsKICAgICAgICAkcmVzcG9uc2UgPSBbXTsKCiAgICAgICAgJHJlcXVpc2l0aW9uPVJlcXVpc2l0aW9uOjp3aGVyZShbJ2lkJz0+JHJlcXVlc3QtPnJlcXVpc2l0aW9uX2lkLCdzdGF0dXMnPT4xLCdhcHByb3ZlZF9pZCc9PjEsJ2lzX3NlbmRfdG9fcmZwJz0+J25vJywnZGVsaXZlcnlfc3RhdHVzJz0+J3Byb2Nlc3NpbmcnXSktPmZpcnN0KCk7CgogICAgICAgIC8vU3RhcnQgdHJhbnNhY3Rpb24KICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwoKICAgICAgICB0cnkgewogICAgICAgICAgICBpZihjb3VudCgoYXJyYXkpJHJlcXVpc2l0aW9uKT4wKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb24tPmlzX3NlbmRfdG9fcmZwID0gJ3llcyc7CiAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb24tPnNhdmUoKTsKICAgICAgICAgICAgICAgIC8vVHJhY2tpbmcKICAgICAgICAgICAgICAgIFJlcXVpc2l0aW9uVHJhY2tpbmc6OnN0b3JlUmVxdWlzaXRpb25UcmFja2luZygkcmVxdWlzaXRpb24tPmlkLCdwcm9jZXNzaW5nJyk7CiAgICAgICAgICAgICAgICAvL1NldCBOb3RpZmljYXRpb24KICAgICAgICAgICAgICAgICRtZXNzYWdlPSAnPHNwYW4gY2xhc3M9Im5vdGlmaWNhdGlvbi1saW5rcyIgZGF0YS1zcmM9Iicucm91dGUoJ3Btcy5zdG9yZS1tYW5hZ2Uuc3RvcmUuaW52ZW50b3J5LmNvbXBhcmUnLCRyZXF1aXNpdGlvbi0+aWQpLiciIGRhdGEtdGl0bGU9IlJlcXVpc2l0aW9uIERldGFpbHMiPlJlZmVyZW5jZSBObzonLiRyZXF1aXNpdGlvbi0+cmVmZXJlbmNlX25vLicuV2F0dGluZyBmb3IgUHJvY3VyZW1lbnQvUHVyY2hhc2UuPC9zcGFuPic7CgogICAgICAgICAgICAgICAgQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oJycsZ2V0TWFuYWdlckluZm8oJ1B1cmNoYXNlLURlcGFydG1lbnQnKSwkbWVzc2FnZSwndW5yZWFkJywnc2VudC10by1wdXJjaGFzZScsJycpOwogICAgICAgICAgICAgICAgLy9Db21taXQgZGF0YQogICAgICAgICAgICAgICAgREI6OmNvbW1pdCgpOwoKICAgICAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnc3VjY2Vzcyc7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ21lc3NhZ2UnXSA9ICdTdWNjZXNzZnVsbHkgU2VuZCB0byBQdXJjaGFzZSBEZXBhcnRtZW50ISEnOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnZXJyb3InOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAnRGF0YSBub3QgZm91bmQuISEnOwogICAgICAgICAgICB9CgogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICAvL0lmIHByb2Nlc3MgaGFzIGFueSBwcm9ibGVtIHRoZW4gcm9sbGJhY2sgdGhlIGRhdGEKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnZXJyb3InOwogICAgICAgICAgICAkcmVzcG9uc2VbJ21lc3NhZ2UnXSA9ICR0aC0+Z2V0TWVzc2FnZSgpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICRyZXNwb25zZTsKICAgIH0KCiAgICAvKioKICAgICAqIFNob3cgdGhlIGZvcm0gZm9yIGNyZWF0aW5nIGEgbmV3IHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gY2hhbmdlQWN0aW9uVG9SRlAoUmVxdWVzdCAkcmVxdWVzdCkKICAgIHsKICAgICAgICAkcmVzcG9uc2UgPSBbXTsKCiAgICAgICAgJHJlcXVpc2l0aW9uPVJlcXVpc2l0aW9uOjp3aGVyZShbJ2lkJz0+JHJlcXVlc3QtPnJlcXVpc2l0aW9uX2lkLCdzdGF0dXMnPT4xLCdhcHByb3ZlZF9pZCc9PjEsJ2lzX3NlbmRfdG9fcmZwJz0+J25vJywnZGVsaXZlcnlfc3RhdHVzJz0+J3BhcnRpYWwtZGVsaXZlcmVkJ10pLT5maXJzdCgpOwoKICAgICAgICAvL1N0YXJ0IHRyYW5zYWN0aW9uCiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYoY291bnQoKGFycmF5KSRyZXF1aXNpdGlvbik+MCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5pc19zZW5kX3RvX3JmcCA9ICd5ZXMnOwogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5yZXF1ZXN0X3N0YXR1cyA9ICdyZnAnOwogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5zYXZlKCk7CiAgICAgICAgICAgICAgICAvL1RyYWNraW5nCiAgICAgICAgICAgICAgICBSZXF1aXNpdGlvblRyYWNraW5nOjpzdG9yZVJlcXVpc2l0aW9uVHJhY2tpbmcoJHJlcXVpc2l0aW9uLT5pZCwncHJvY2Vzc2luZycpOwoKICAgICAgICAgICAgICAgICRtZXNzYWdlPSAnPHNwYW4gY2xhc3M9Im5vdGlmaWNhdGlvbi1saW5rcyIgZGF0YS1zcmM9Iicucm91dGUoJ3Btcy5zdG9yZS1tYW5hZ2Uuc3RvcmUuaW52ZW50b3J5LmNvbXBhcmUnLCRyZXF1aXNpdGlvbi0+aWQpLiciIGRhdGEtdGl0bGU9IlJlcXVpc2l0aW9uIERldGFpbHMiPlJlZmVyZW5jZSBObzonLiRyZXF1aXNpdGlvbi0+cmVmZXJlbmNlX25vLicuV2F0dGluZyBmb3IgUHJvY3VyZW1lbnQvUHVyY2hhc2UuPC9zcGFuPic7CgoKICAgICAgICAgICAgICAgIENyZWF0ZU9yVXBkYXRlTm90aWZpY2F0aW9uKCcnLGdldE1hbmFnZXJJbmZvKCdQdXJjaGFzZS1EZXBhcnRtZW50JyksJG1lc3NhZ2UsJ3VucmVhZCcsJ3NlbmQtdG8tcHVyY2hhc2UnLCcnKTsKICAgICAgICAgICAgICAgIC8vQ29tbWl0IGRhdGEKICAgICAgICAgICAgICAgIERCOjpjb21taXQoKTsKCiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ3N1Y2Nlc3MnOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAnU3VjY2Vzc2Z1bGx5IFNlbmQgdG8gUHVyY2hhc2UgRGVwYXJ0bWVudCEhJzsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ2Vycm9yJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJ0FsbHJlYWR5IGdlbmVyYXRlZCBvbmNlISEnOwogICAgICAgICAgICB9CgogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICAvL0lmIHByb2Nlc3MgaGFzIGFueSBwcm9ibGVtIHRoZW4gcm9sbGJhY2sgdGhlIGRhdGEKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnZXJyb3InOwogICAgICAgICAgICAkcmVzcG9uc2VbJ21lc3NhZ2UnXSA9ICR0aC0+Z2V0TWVzc2FnZSgpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICRyZXNwb25zZTsKICAgIH0KCiAgICAvKioKICAgICAqIFNob3cgdGhlIGZvcm0gZm9yIGNyZWF0aW5nIGEgbmV3IHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIGRlbGl2ZXJlZExpc3RIZWFkZXJDb2x1bW5zKCR2YWx1ZT0nJykKICAgIHsKICAgICAgICByZXR1cm4gYXJyYXkoCiAgICAgICAgICAgIFsnU0wnLCAnU0wnXSwgCiAgICAgICAgICAgIFsndW5pdCcsICd1bml0JywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnZGVwYXJ0bWVudCcsICdkZXBhcnRtZW50JywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsncmVxdWlzaXRpb25fZGF0ZScsICdyZXF1aXNpdGlvbl9kYXRlJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnZGVsaXZlcmVkX2RhdGUnLCAnZGVsaXZlcmVkX2RhdGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydyZXF1aXNpdGlvbl9yZWZlcmVuY2UnLCAncmVxdWlzaXRpb25fcmVmZXJlbmNlJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnZGVsaXZlcmVkX3JlZmVyZW5jZScsICdkZWxpdmVyZWRfcmVmZXJlbmNlJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnY2F0ZWdvcnknLCAnY2F0ZWdvcnknLCAndGV4dC1sZWZ0J10sIAogICAgICAgICAgICBbJ3N1Yl9jYXRlZ29yeScsICdzdWJfY2F0ZWdvcnknLCAndGV4dC1sZWZ0J10sIAogICAgICAgICAgICBbJ3Byb2R1Y3QnLCAncHJvZHVjdCcsICd0ZXh0LWxlZnQnXSwgIAogICAgICAgICAgICBbJ3F0eScsICdxdHknLCAndGV4dC1sZWZ0J10sICAKICAgICAgICAgICAgWydvcHRpb25zJywgJ29wdGlvbnMnLCAndGV4dC1jZW50ZXInLCd3aWR0aDoxNSUnXQogICAgICAgICk7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGRlbGl2ZXJlZExpc3QoKQogICAgewogICAgICAgIHRyeXsKICAgICAgICAgICAgJGZyb21fZGF0ZSA9IHJlcXVlc3QoKS0+aGFzKCdmcm9tX2RhdGUnKSA/IHJlcXVlc3QoKS0+Z2V0KCdmcm9tX2RhdGUnKSA6IGRhdGUoJ1ktbS0wMScpOwogICAgICAgICAgICAkdG9fZGF0ZSA9IHJlcXVlc3QoKS0+aGFzKCd0b19kYXRlJykgPyByZXF1ZXN0KCktPmdldCgndG9fZGF0ZScpIDogZGF0ZSgnWS1tLWQnKTsKCiAgICAgICAgICAgICRkZWxpdmVyZWRSZXF1aXNpdGlvbnMgPSBSZXF1aXNpdGlvbkRlbGl2ZXJ5SXRlbTo6b3JkZXJCeSgnaWQnLCdkZXNjJykKICAgICAgICAgICAgLT53aXRoKFsKICAgICAgICAgICAgICAgICdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LnJlbFJlcXVpc2l0aW9uLnJlbFVzZXJzTGlzdC5lbXBsb3llZS51bml0JywKICAgICAgICAgICAgICAgICdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LnJlbFJlcXVpc2l0aW9uLnJlbFVzZXJzTGlzdC5lbXBsb3llZS5kZXBhcnRtZW50JywKICAgICAgICAgICAgICAgICdwcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlSW4oJ3dhcmVob3VzZV9pZCcsIEF1dGg6OnVzZXIoKS0+cmVsVXNlcnNXYXJlaG91c2UtPnBsdWNrKCdpZCcpLT5hbGwoKSkKICAgICAgICAgICAgLT53aGVuKCRmcm9tX2RhdGUsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRmcm9tX2RhdGUpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnknLGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRmcm9tX2RhdGUpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlRGF0ZSgnZGVsaXZlcnlfZGF0ZScsICc+PScsJGZyb21fZGF0ZSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVuKCR0b19kYXRlLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkdG9fZGF0ZSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWlzaXRpb25EZWxpdmVyeScsZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHRvX2RhdGUpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlRGF0ZSgnZGVsaXZlcnlfZGF0ZScsICc8PScsJHRvX2RhdGUpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+YWpheCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gRGF0YVRhYmxlczo6b2YoJGRlbGl2ZXJlZFJlcXVpc2l0aW9ucykKICAgICAgICAgICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigndW5pdCcsIGZ1bmN0aW9uKCRkZWxpdmVyeSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkZGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uLT5yZWxVc2Vyc0xpc3QtPmVtcGxveWVlLT51bml0LT5ocl91bml0X3Nob3J0X25hbWUpPyRkZWxpdmVyeS0+cmVsUmVxdWlzaXRpb25EZWxpdmVyeS0+cmVsUmVxdWlzaXRpb24tPnJlbFVzZXJzTGlzdC0+ZW1wbG95ZWUtPnVuaXQtPmhyX3VuaXRfc2hvcnRfbmFtZTonJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCd1bml0JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnkucmVsUmVxdWlzaXRpb24ucmVsVXNlcnNMaXN0LmVtcGxveWVlLnVuaXQnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ2hyX3VuaXRfc2hvcnRfbmFtZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2RlcGFydG1lbnQnLCBmdW5jdGlvbigkZGVsaXZlcnkpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJGRlbGl2ZXJ5LT5yZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LT5yZWxSZXF1aXNpdGlvbi0+cmVsVXNlcnNMaXN0LT5lbXBsb3llZS0+ZGVwYXJ0bWVudC0+aHJfZGVwYXJ0bWVudF9uYW1lKT8kZGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uLT5yZWxVc2Vyc0xpc3QtPmVtcGxveWVlLT5kZXBhcnRtZW50LT5ocl9kZXBhcnRtZW50X25hbWU6Jyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignZGVwYXJ0bWVudCcsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LnJlbFJlcXVpc2l0aW9uLnJlbFVzZXJzTGlzdC5lbXBsb3llZS5kZXBhcnRtZW50JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdocl9kZXBhcnRtZW50X25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1aXNpdGlvbl9kYXRlJywgZnVuY3Rpb24oJGRlbGl2ZXJ5KXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCRkZWxpdmVyeS0+cmVsUmVxdWlzaXRpb25EZWxpdmVyeS0+cmVsUmVxdWlzaXRpb24tPnJlcXVpc2l0aW9uX2RhdGUpPyBkYXRlKCdkLW0tWScsc3RydG90aW1lKCRkZWxpdmVyeS0+cmVsUmVxdWlzaXRpb25EZWxpdmVyeS0+cmVsUmVxdWlzaXRpb24tPnJlcXVpc2l0aW9uX2RhdGUpKTonJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZXF1aXNpdGlvbl9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnkucmVsUmVxdWlzaXRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3JlcXVpc2l0aW9uX2RhdGUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdkZWxpdmVyZWRfZGF0ZScsIGZ1bmN0aW9uKCRkZWxpdmVyeSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkZGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPmRlbGl2ZXJ5X2RhdGUpPyBkYXRlKCdkLW0tWScsc3RydG90aW1lKCRkZWxpdmVyeS0+cmVsUmVxdWlzaXRpb25EZWxpdmVyeS0+ZGVsaXZlcnlfZGF0ZSkpOicnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2RlbGl2ZXJlZF9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ2RlbGl2ZXJ5X2RhdGUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1aXNpdGlvbl9yZWZlcmVuY2UnLCBmdW5jdGlvbigkZGVsaXZlcnkpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgZGF0YS1pZD0iJy4kZGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uLT5pZC4nIiBjbGFzcz0iYnRuIGJ0bi1saW5rIG0tMSByb3VuZGVkIiBvbmNsaWNrPSJyZXF1aXNpdGlvbnZpZXcoJCh0aGlzKSkiPicuKCBpc3NldCgkZGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm8pPyRkZWxpdmVyeS0+cmVsUmVxdWlzaXRpb25EZWxpdmVyeS0+cmVsUmVxdWlzaXRpb24tPnJlZmVyZW5jZV9ubzonJykuJzwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3JlcXVpc2l0aW9uX3JlZmVyZW5jZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LnJlbFJlcXVpc2l0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdkZWxpdmVyZWRfcmVmZXJlbmNlJywgZnVuY3Rpb24oJGRlbGl2ZXJ5KXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCRkZWxpdmVyeS0+cmVsUmVxdWlzaXRpb25EZWxpdmVyeS0+cmVmZXJlbmNlX25vKT8kZGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnJlZmVyZW5jZV9ubzonJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdkZWxpdmVyZWRfcmVmZXJlbmNlJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3JlZmVyZW5jZV9ubycsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2RlbGl2ZXJlZF9yZWZlcmVuY2UnLCBmdW5jdGlvbigkZGVsaXZlcnkpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHZhbHVlcy0+cHJvZHVjdC0+Y2F0ZWdvcnktPmNhdGVnb3J5LT5uYW1lKT8kdmFsdWVzLT5wcm9kdWN0LT5jYXRlZ29yeS0+Y2F0ZWdvcnktPm5hbWU6Jyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignZGVsaXZlcmVkX3JlZmVyZW5jZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdjYXRlZ29yeScsIGZ1bmN0aW9uKCRkZWxpdmVyeSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkZGVsaXZlcnktPnByb2R1Y3QtPmNhdGVnb3J5LT5jYXRlZ29yeS0+bmFtZSk/JGRlbGl2ZXJ5LT5wcm9kdWN0LT5jYXRlZ29yeS0+Y2F0ZWdvcnktPm5hbWU6Jyc7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3N1Yl9jYXRlZ29yeScsIGZ1bmN0aW9uKCRkZWxpdmVyeSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkZGVsaXZlcnktPnByb2R1Y3QtPmNhdGVnb3J5LT5uYW1lKT8kZGVsaXZlcnktPnByb2R1Y3QtPmNhdGVnb3J5LT5uYW1lOicnOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3N1Yl9jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdwcm9kdWN0LmNhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncHJvZHVjdCcsIGZ1bmN0aW9uKCRkZWxpdmVyeSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkZGVsaXZlcnktPnByb2R1Y3QtPm5hbWUpPyRkZWxpdmVyeS0+cHJvZHVjdC0+bmFtZTonJzsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdwcm9kdWN0JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3Byb2R1Y3QnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdxdHknLCBmdW5jdGlvbigkZGVsaXZlcnkpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbnVtYmVyX2Zvcm1hdCgkdmFsdWVzLT5kZWxpdmVyeV9xdHksIDApOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3F0eScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ2RlbGl2ZXJ5X3F0eScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignb3B0aW9ucycsIGZ1bmN0aW9uKCRkZWxpdmVyeSl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCRkZWxpdmVyeS0+c3RhdHVzPT0ncGVuZGluZycgfHwgJGRlbGl2ZXJ5LT5zdGF0dXM9PSdhY2tub3dsZWRnZScpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGRyb3Bkb3duLXRvZ2dsZSIgZGF0YS10b2dnbGU9ImRyb3Bkb3duIj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0ic3RhdHVzTmFtZScuJGRlbGl2ZXJ5LT5pZC4nIj4nLnVjZmlyc3QoJGRlbGl2ZXJ5LT5zdGF0dXMpLic8L3NwYW4+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2J1dHRvbj4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIDx1bCBjbGFzcz0iZHJvcGRvd24tbWVudSI+CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8bGkgaWQ9ImhpZGVCdG4nLiRkZWxpdmVyeS0+aWQuJyI+PGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBvbmNsaWNrPSJzdG9yZWRlbGl2ZXJlZEFja25vd2xlZGdlKCQodGhpcykpIiBkYXRhLWlkPSInLiRkZWxpdmVyeS0+aWQuJyIgdGl0bGU9IkRlbGl2ZXJlZCI+PGkgY2xhc3M9ImxhIGxhLWNoZWNrIj48L2k+Jm5ic3A7RGVsaXZlcmVkPC9hPgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC9saT4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgPC91bD4KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICA8L2Rpdj4nOwogICAgICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAnRGVsaXZlcmVkJzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsncmVxdWlzaXRpb25fcmVmZXJlbmNlJywgJ29wdGlvbnMnXSkKICAgICAgICAgICAgICAgICAgICAtPnRvSnNvbigpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMuc3RvcmUuc3RvcmUtZGVsaXZlcmVkLXJlcXVpc2l0aW9uLWxpc3QnLCBbCiAgICAgICAgICAgICAgICAndGl0bGUnID0+ICJEZWxpdmVyZCBPcmRlciBMaXN0IiwKICAgICAgICAgICAgICAgICdmcm9tX2RhdGUnID0+ICRmcm9tX2RhdGUsCiAgICAgICAgICAgICAgICAndG9fZGF0ZScgPT4gJHRvX2RhdGUsCiAgICAgICAgICAgICAgICAnaGVhZGVyQ29sdW1ucycgPT4gJHRoaXMtPmRlbGl2ZXJlZExpc3RIZWFkZXJDb2x1bW5zKCksCiAgICAgICAgICAgIF0pOwogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICogRGVsaXZlcmVkIHJlcXVpc3Rpb24gYWNrbm93bGVkZ2UuCiAgICAqCiAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gZGVsaXZlcmVkUmVxdWlzaXRpb25BY2soUmVxdWVzdCAkcmVxdWVzdCl7CgogICAgICAgICRyZXNwb25zZT1bXTsKICAgICAgICAkd2FyZWhvdXNlSWRzPUF1dGg6OnVzZXIoKS0+cmVsVXNlcnNXYXJlaG91c2UtPnBsdWNrKCdpZCcpLT5hbGwoKTsKICAgICAgICAKICAgICAgICAkZGVsaXZlcmVkUmVxdWlzaXRpb24gPSBSZXF1aXNpdGlvbkRlbGl2ZXJ5SXRlbTo6d2hlcmVJbignd2FyZWhvdXNlX2lkJywkd2FyZWhvdXNlSWRzKQogICAgICAgIC0+d2hlcmVOb3RJbignc3RhdHVzJyxbJ2RlbGl2ZXJlZCddKQogICAgICAgIC0+d2hlcmUoJ2lkJywkcmVxdWVzdC0+aWQpCiAgICAgICAgLT5maXJzdCgpOwoKICAgICAgICB0cnl7CgogICAgICAgICAgICBpZiAoaXNzZXQoJGRlbGl2ZXJlZFJlcXVpc2l0aW9uKSkgewoKICAgICAgICAgICAgICAgICRkZWxpdmVyZWRSZXF1aXNpdGlvbi0+c3RhdHVzID0gJ2RlbGl2ZXJlZCc7CiAgICAgICAgICAgICAgICAkZGVsaXZlcmVkUmVxdWlzaXRpb24tPnNhdmUoKTsKCiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ3N1Y2Nlc3MnOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAnU3VjY2Vzc2Z1bGx5IFVwZGF0ZWQgVG8gRGVsaXZlcmVkLic7CgogICAgICAgICAgICB9ZWxzZXsKCiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ2Vycm9yJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJ05vIERhdGEgRm91bmQnOwogICAgICAgICAgICB9CgogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewoKICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdlcnJvcic7CiAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJHRoLT5nZXRNZXNzYWdlKCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gJHJlc3BvbnNlOwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBkZWxpdmVyZWRSZXF1aXNpdGlvblNlYXJjaChSZXF1ZXN0ICRyZXF1ZXN0KXsKICAgICAgICAkcmVzcG9uc2UgPSBbXTsKCiAgICAgICAgJGZyb21EYXRlPWRhdGUoJ1ktbS1kIEg6aTpzJyxzdHJ0b3RpbWUoJHJlcXVlc3QtPmZyb21fZGF0ZSkpOwogICAgICAgICR0b0RhdGU9ZGF0ZSgnWS1tLWQgSDppOnMnLHN0cnRvdGltZSgkcmVxdWVzdC0+dG9fZGF0ZSkpOwoKICAgICAgICAkc3RhdHVzPSRyZXF1ZXN0LT5zdGF0dXM7CgogICAgICAgICR3YXJlaG91c2VJZHM9QXV0aDo6dXNlcigpLT5yZWxVc2Vyc1dhcmVob3VzZS0+cGx1Y2soJ2lkJyktPmFsbCgpOwoKICAgICAgICAkZGVsaXZlcmVkUmVxdWlzaXRpb24gPSBSZXF1aXNpdGlvbkRlbGl2ZXJ5SXRlbTo6d2hlcmVJbignd2FyZWhvdXNlX2lkJywkd2FyZWhvdXNlSWRzKQogICAgICAgIC0+d2hlbigkc3RhdHVzLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkc3RhdHVzKXsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3N0YXR1cycsJHN0YXR1cyk7CiAgICAgICAgfSkKICAgICAgICAtPndoZW4oJGZyb21EYXRlLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkZnJvbURhdGUpewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWlzaXRpb25EZWxpdmVyeScsZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGZyb21EYXRlKXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlRGF0ZSgnZGVsaXZlcnlfZGF0ZScsICc+PScsJGZyb21EYXRlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSkKICAgICAgICAtPndoZW4oJHRvRGF0ZSwgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHRvRGF0ZSl7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5JyxmdW5jdGlvbigkcXVlcnkpIHVzZSgkdG9EYXRlKXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlRGF0ZSgnZGVsaXZlcnlfZGF0ZScsICc8PScsJHRvRGF0ZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pCiAgICAgICAgLT5vcmRlckJ5KCdpZCcsJ0RFU0MnKQogICAgICAgIC0+cGFnaW5hdGUoMzApOwoKICAgICAgICB0cnkgewoKICAgICAgICAgICAgaWYoY291bnQoJGRlbGl2ZXJlZFJlcXVpc2l0aW9uKT4wKQogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAkYm9keSA9IFZpZXc6Om1ha2UoJ3Btcy5iYWNrZW5kLnBhZ2VzLnN0b3JlLnN0b3JlLWRlbGl2ZXJlZC1yZXF1aXNpdGlvbi1zZWFyY2gnLAogICAgICAgICAgICAgICAgICAgIFsnZGVsaXZlcmVkUmVxdWlzaXRpb24nPT4gJGRlbGl2ZXJlZFJlcXVpc2l0aW9uXSk7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnc3VjY2Vzcyc7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ2JvZHknXSA9ICRib2R5LT5yZW5kZXIoKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ2Vycm9yJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJ05vIERhdGEgRm91bmQhISc7CiAgICAgICAgICAgIH0KCiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnZXJyb3InOwogICAgICAgICAgICAkcmVzcG9uc2VbJ21lc3NhZ2UnXSA9ICR0aC0+Z2V0TWVzc2FnZSgpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICRyZXNwb25zZTsKICAgIH0KCiAgICAvKioKICAgICogUmVxdWlzaXRpb24gZGVsaXZlcnkgdmlldy4KICAgICoKICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiByZXF1aXNpdGlvbkRlbGl2ZXJ5VmlldyhSZXF1ZXN0ICRyZXF1ZXN0KXsKICAgICAgICAkcmVzcG9uc2UgPSBbXTsKICAgICAgICAkcmVxdWlzaXRpb24gPSBSZXF1aXNpdGlvbjo6d2l0aCgnaXRlbXMnLCdpdGVtcy5wcm9kdWN0JywnaXRlbXMucHJvZHVjdC5jYXRlZ29yeScpCiAgICAgICAgLT5maW5kT3JGYWlsKCRyZXF1ZXN0LT5pZCk7CiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgIGlmKGlzc2V0KCRyZXF1aXNpdGlvbikpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICRib2R5ID0gVmlldzo6bWFrZSgncG1zLmJhY2tlbmQucGFnZXMucmVxdWlzaXRpb25zLnNob3cnLAogICAgICAgICAgICAgICAgICAgIFsncmVxdWlzaXRpb24nPT4gJHJlcXVpc2l0aW9uXSk7CgogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdzdWNjZXNzJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnYm9keSddID0gJGJvZHktPnJlbmRlcigpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnZXJyb3InOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAnTm8gRGF0YSBGb3VuZCEhJzsKICAgICAgICAgICAgfQoKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdlcnJvcic7CiAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJHRoLT5nZXRNZXNzYWdlKCk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gJHJlc3BvbnNlOwogICAgfQp9Cgo=