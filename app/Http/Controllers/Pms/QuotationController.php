<?php
bolt_decrypt( __FILE__ , '1ZzSDd'); return 0;
##!!!##CgpuYW1lc3BhY2UgQXBwXEh0dHBcQ29udHJvbGxlcnNcUG1zOwoKdXNlIEFwcFxIdHRwXENvbnRyb2xsZXJzXENvbnRyb2xsZXI7CnVzZSBJbGx1bWluYXRlXEh0dHBcUmVxdWVzdDsKdXNlIEFwcFxIdHRwXFJlcXVlc3RzOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHJvZHVjdDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFN1cHBsaWVyczsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFB1cmNoYXNlXFB1cmNoYXNlT3JkZXI7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xQdXJjaGFzZVxQdXJjaGFzZU9yZGVySXRlbTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJmcFxSZXF1ZXN0UHJvcG9zYWw7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xSZnBcUmVxdWVzdFByb3Bvc2FsRGV0YWlsczsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJmcFxSZXF1ZXN0UHJvcG9zYWxEZWZpbmVTdXBwbGllcjsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFF1b3RhdGlvbnM7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xRdW90YXRpb25zSXRlbXM7CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xTdXBwbGllclBheW1lbnRUZXJtOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcU3VwcGxpZXJQYXltZW50Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb247CnVzZSBBcHBcTW9kZWxzXFBtc01vZGVsc1xSZXF1aXNpdGlvblRyYWNraW5nOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb25JdGVtOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHVyY2hhc2VcUHVyY2hhc2VPcmRlclJlcXVpc2l0aW9uOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcQWNjb3VudHNcQ3VycmVuY3lUeXBlOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcQWNjb3VudHNcRXhjaGFuZ2VSYXRlOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcQWNjb3VudHNcQ29zdENlbnRyZTsKdXNlIEFwcFxNb2RlbHNcSHJcVW5pdDsKdXNlIEFwcFxNb2RlbHNcSHJcRGVwYXJ0bWVudDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXENhdGVnb3J5Owp1c2UgQXBwLERCLFBERixEYXRhVGFibGVzOwp1c2UgSWxsdW1pbmF0ZVxTdXBwb3J0XEZhY2FkZXNcQXV0aDsKCmNsYXNzIFF1b3RhdGlvbkNvbnRyb2xsZXIgZXh0ZW5kcyBDb250cm9sbGVyCnsKICAgIC8qKgogICAgICogRGlzcGxheSBhIGxpc3Rpbmcgb2YgdGhlIHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gaW5kZXgoKQogICAgewogICAgICAgICR0aXRsZT0nUXVvdGF0aW9ucyBMaXN0JzsKICAgICAgICB0cnkgewoKICAgICAgICAgICAgJHF1b3RhdGlvbnMgPSBRdW90YXRpb25zOjp3aXRoKFsKICAgICAgICAgICAgICAgICdyZWxSZXF1ZXN0UHJvcG9zYWwnLAogICAgICAgICAgICAgICAgJ3JlbFN1cHBsaWVycycsCiAgICAgICAgICAgICAgICAnZXhjaGFuZ2VSYXRlLmN1cnJlbmN5JwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlTm90SW4oJ3R5cGUnLCBbJ2RpcmVjdC1wdXJjaGFzZSddKQogICAgICAgICAgICAtPndoZW4oIWRhdGF0YWJsZU9yZGVyaW5nKCksIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlcmJ5KCdpZCcsICdkZXNjJyk7CiAgICAgICAgICAgIH0pOwoKICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+YWpheCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gRGF0YVRhYmxlczo6b2YoJHF1b3RhdGlvbnMpCiAgICAgICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1ZXN0X3Byb3Bvc2FsJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIG9uY2xpY2s9Im9wZW5SZXF1ZXN0UHJvcG9zYWxNb2RhbCgnLiR2YWx1ZXMtPnJlcXVlc3RfcHJvcG9zYWxfaWQuJykiICBjbGFzcz0iYnRuIGJ0bi1saW5rIj4nLiR2YWx1ZXMtPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVmZXJlbmNlX25vLic8L2E+JzsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncmVxdWVzdF9wcm9wb3NhbCcsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWwnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBSZXF1ZXN0UHJvcG9zYWw6OnNlbGVjdCgncmVxdWVzdF9wcm9wb3NhbHMucmVmZXJlbmNlX25vJykKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncmVxdWVzdF9wcm9wb3NhbHMuaWQnLCAncXVvdGF0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3F1b3RhdGlvbl9kYXRlJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGUoJ1ktbS1kJyxzdHJ0b3RpbWUoJHZhbHVlcy0+cXVvdGF0aW9uX2RhdGUpKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncXVvdGF0aW9uX2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3F1b3RhdGlvbl9kYXRlJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdxdW90YXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ3F1b3RhdGlvbl9kYXRlJywgJG9yZGVyKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3JlZmVyZW5jZV9ubycsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBvbmNsaWNrPSJvcGVuTW9kYWwoJy4kdmFsdWVzLT5pZC4nKSIgIGNsYXNzPSJidG4gYnRuLWxpbmsiPicuJHZhbHVlcy0+cmVmZXJlbmNlX25vLic8L2E+JzsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignc3VwcGxpZXInLCBmdW5jdGlvbigkdmFsdWVzKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gICR2YWx1ZXMtPnJlbFN1cHBsaWVycy0+bmFtZS4nICgnLiR2YWx1ZXMtPnJlbFN1cHBsaWVycy0+Y29kZS4nKSc7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3N1cHBsaWVyJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsU3VwcGxpZXJzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3N1cHBsaWVyJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgU3VwcGxpZXJzOjpzZWxlY3QoJ3N1cHBsaWVycy5uYW1lJykKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbignc3VwcGxpZXJzLmlkJywgJ3F1b3RhdGlvbnMuc3VwcGxpZXJfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdjdXJyZW5jeScsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAgaXNzZXQoJHZhbHVlcy0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+Y29kZSk/JHZhbHVlcy0+ZXhjaGFuZ2VSYXRlLT5jdXJyZW5jeS0+Y29kZTonJzsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignY3VycmVuY3knLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdleGNoYW5nZVJhdGUuY3VycmVuY3knLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnY29kZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignY3VycmVuY3knLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBFeGNoYW5nZVJhdGU6OnNlbGVjdCgnY3VycmVuY2llcy5jb2RlJykKICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdjdXJyZW5jaWVzJywgJ2N1cnJlbmNpZXMuaWQnLCAnPScsICdleGNoYW5nZV9yYXRlcy5jdXJyZW5jeV9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ2V4Y2hhbmdlX3JhdGVzLmlkJywgJ3F1b3RhdGlvbnMuZXhjaGFuZ2VfcmF0ZV9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLy8gLT5lZGl0Q29sdW1uKCd0b3RhbF9wcmljZScsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgLy8gICAgIHJldHVybiAgbnVtYmVyX2Zvcm1hdCgkdmFsdWVzLT50b3RhbF9wcmljZSwyKTsKICAgICAgICAgICAgICAgIC8vIH0pCiAgICAgICAgICAgICAgICAvLyAtPmVkaXRDb2x1bW4oJ2dyb3NzX3ByaWNlJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAvLyAgICAgcmV0dXJuICBudW1iZXJfZm9ybWF0KCR2YWx1ZXMtPmdyb3NzX3ByaWNlLDIpOwogICAgICAgICAgICAgICAgLy8gfSkKICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbignc3RhdHVzJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICB1Y2ZpcnN0KCR2YWx1ZXMtPnN0YXR1cyk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCd0eXBlJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICB1Y2ZpcnN0KCR2YWx1ZXMtPnR5cGUpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSc8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIG9uY2xpY2s9Im9wZW5Nb2RhbCgnLiR2YWx1ZXMtPmlkLicpIiAgY2xhc3M9ImJ0biBidG4teHMgYnRuLWluZm8iPjxpIGNsYXNzPSJsYXMgbGEtZXllIj48L2k+PC9hPic7CgogICAgICAgICAgICAgICAgICAgIGlmKCR2YWx1ZXMtPmlzX2FwcHJvdmVkID09ICJwcmUtcHJvY2Vzc2luZyIpewoKICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxhIG9uY2xpY2s9InNlbmRUb01hbmFnZW1lbnQoJy4kdmFsdWVzLT5pZC4nKSIgY2xhc3M9ImJ0biBidG4teHMgYnRuLXN1Y2Nlc3MiPjxpIGNsYXNzPSJsYXMgbGEtY2hlY2siPjwvaT4mbmJzcDtTZW5kIHRvIE1hbmFnZW1lbnQ8L2E+JzsKICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgcmV0dXJuICRhY3Rpb25zOwogICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+cmF3Q29sdW1ucyhbJ3JlcXVlc3RfcHJvcG9zYWwnLCdyZWZlcmVuY2Vfbm8nLCAnYWN0aW9ucyddKQogICAgICAgICAgICAgICAgLT5tYWtlKHRydWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucXVvdGF0aW9uLmluZGV4JywgWwogICAgICAgICAgICAgICAgJ3RpdGxlJyA9PiR0aXRsZSwKICAgICAgICAgICAgICAgICdoZWFkZXJDb2x1bW5zJyA9PiAkdGhpcy0+ZXN0aW1hdGVIZWFkZXJDb2x1bW5zKCkKICAgICAgICAgICAgXSk7CiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBlc3RpbWF0ZUhlYWRlckNvbHVtbnMoJHZhbHVlPScnKQogICAgewogICAgICAgIHJldHVybiBhcnJheSgKICAgICAgICAgICAgWydTTCcsICdTTCddLAogICAgICAgICAgICBbJ3JlcXVlc3RfcHJvcG9zYWwnLCAncmVxdWVzdF9wcm9wb3NhbCcsICd0ZXh0LWNlbnRlcicsJ3dpZHRoOjE1JSddLAogICAgICAgICAgICBbJ3F1b3RhdGlvbl9kYXRlJywgJ3F1b3RhdGlvbl9kYXRlJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsncmVmZXJlbmNlX25vJywgJ3JlZmVyZW5jZV9ubycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3N1cHBsaWVyJywgJ3N1cHBsaWVyJywgJ3RleHQtbGVmdCddLAogICAgICAgICAgICBbJ2N1cnJlbmN5JywgJ2N1cnJlbmN5JywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIC8vIFsndG90YWxfcHJpY2UnLCAndG90YWxfcHJpY2UnLCAndGV4dC1yaWdodCddLAogICAgICAgICAgICAvLyBbJ2Rpc2NvdW50JywgJ2Rpc2NvdW50JywgJ3RleHQtcmlnaHQnXSwKICAgICAgICAgICAgLy8gWyd2YXQnLCAndmF0JywgJ3RleHQtcmlnaHQnXSwKICAgICAgICAgICAgLy8gWydncm9zc19wcmljZScsICdncm9zc19wcmljZScsICd0ZXh0LXJpZ2h0J10sCiAgICAgICAgICAgIC8vIFsnc3RhdHVzJywgJ3N0YXR1cycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICAvLyBbJ3R5cGUnLCAndHlwZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2FjdGlvbnMnLCAnYWN0aW9ucycsICd0ZXh0LWNlbnRlciddCiAgICAgICAgKTsKICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gZXN0aW1hdGUoKQogICAgewogICAgICAgICR0aXRsZT0nRXN0aW1hdGUgTGlzdCc7CiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgICRxdW90YXRpb25zID0gUXVvdGF0aW9uczo6d2l0aChbCiAgICAgICAgICAgICAgICAncmVsUmVxdWVzdFByb3Bvc2FsJywKICAgICAgICAgICAgICAgICdyZWxTdXBwbGllcnMnLAogICAgICAgICAgICAgICAgJ2V4Y2hhbmdlUmF0ZS5jdXJyZW5jeScKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZSgndHlwZScsJ2RpcmVjdC1wdXJjaGFzZScpCiAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5hamF4KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhVGFibGVzOjpvZigkcXVvdGF0aW9ucykKICAgICAgICAgICAgICAgIC0+YWRkSW5kZXhDb2x1bW4oKQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWwnLCBmdW5jdGlvbigkdmFsdWVzKXsKICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBvbmNsaWNrPSJvcGVuUmVxdWVzdFByb3Bvc2FsTW9kYWwoJy4kdmFsdWVzLT5yZXF1ZXN0X3Byb3Bvc2FsX2lkLicpIiAgY2xhc3M9ImJ0biBidG4tbGluayI+Jy4kdmFsdWVzLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPnJlZmVyZW5jZV9uby4nPC9hPic7CiAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncmVxdWVzdF9wcm9wb3NhbCcsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWwnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBSZXF1ZXN0UHJvcG9zYWw6OnNlbGVjdCgncmVxdWVzdF9wcm9wb3NhbHMucmVmZXJlbmNlX25vJykKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncmVxdWVzdF9wcm9wb3NhbHMuaWQnLCAncXVvdGF0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3F1b3RhdGlvbl9kYXRlJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGUoJ1ktbS1kJywgc3RydG90aW1lKCR2YWx1ZXMtPnF1b3RhdGlvbl9kYXRlKSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3F1b3RhdGlvbl9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdxdW90YXRpb25fZGF0ZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncXVvdGF0aW9uX2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlckJ5KCdxdW90YXRpb25fZGF0ZScsICRvcmRlcik7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbigkdmFsdWVzKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgb25jbGljaz0ib3Blbk1vZGFsKCcuJHZhbHVlcy0+aWQuJykiICBjbGFzcz0iYnRuIGJ0bi1saW5rIj4nLiR2YWx1ZXMtPnJlZmVyZW5jZV9uby4nPC9hPic7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3N1cHBsaWVyJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICAkdmFsdWVzLT5yZWxTdXBwbGllcnMtPm5hbWUuJyAoJy4kdmFsdWVzLT5yZWxTdXBwbGllcnMtPmNvZGUuJyknOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdzdXBwbGllcicsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFN1cHBsaWVycycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdzdXBwbGllcicsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFN1cHBsaWVyczo6c2VsZWN0KCdzdXBwbGllcnMubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3N1cHBsaWVycy5pZCcsICdxdW90YXRpb25zLnN1cHBsaWVyX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignY3VycmVuY3knLCBmdW5jdGlvbigkdmFsdWVzKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gIGlzc2V0KCR2YWx1ZXMtPmV4Y2hhbmdlUmF0ZS0+Y3VycmVuY3ktPmNvZGUpPyR2YWx1ZXMtPmV4Y2hhbmdlUmF0ZS0+Y3VycmVuY3ktPmNvZGU6Jyc7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2N1cnJlbmN5JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnZXhjaGFuZ2VSYXRlLmN1cnJlbmN5JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ2NvZGUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ2N1cnJlbmN5JywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgRXhjaGFuZ2VSYXRlOjpzZWxlY3QoJ2N1cnJlbmNpZXMuY29kZScpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignY3VycmVuY2llcycsICdjdXJyZW5jaWVzLmlkJywgJz0nLCAnZXhjaGFuZ2VfcmF0ZXMuY3VycmVuY3lfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdleGNoYW5nZV9yYXRlcy5pZCcsICdxdW90YXRpb25zLmV4Y2hhbmdlX3JhdGVfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC8vIC0+ZWRpdENvbHVtbigndG90YWxfcHJpY2UnLCBmdW5jdGlvbigkdmFsdWVzKXsKICAgICAgICAgICAgICAgIC8vICAgICByZXR1cm4gIG51bWJlcl9mb3JtYXQoJHZhbHVlcy0+dG90YWxfcHJpY2UsMik7CiAgICAgICAgICAgICAgICAvLyB9KQogICAgICAgICAgICAgICAgLy8gLT5lZGl0Q29sdW1uKCdncm9zc19wcmljZScsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgLy8gICAgIHJldHVybiAgbnVtYmVyX2Zvcm1hdCgkdmFsdWVzLT5ncm9zc19wcmljZSwyKTsKICAgICAgICAgICAgICAgIC8vIH0pCiAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3N0YXR1cycsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAgdWNmaXJzdCgkdmFsdWVzLT5zdGF0dXMpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbigndHlwZScsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAgdWNmaXJzdCgkdmFsdWVzLT50eXBlKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYWN0aW9ucycsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgICAgICRhY3Rpb25zID0gJyc7CiAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0nPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBvbmNsaWNrPSJvcGVuTW9kYWwoJy4kdmFsdWVzLT5pZC4nKSIgIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1pbmZvIj48aSBjbGFzcz0ibGFzIGxhLWV5ZSI+PC9pPjwvYT4nOwoKICAgICAgICAgICAgICAgICAgICBpZigkdmFsdWVzLT5pc19hcHByb3ZlZCA9PSAicHJlLXByb2Nlc3NpbmciKXsKCiAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49ICc8YSBvbmNsaWNrPSJzZW5kVG9NYW5hZ2VtZW50KCcuJHZhbHVlcy0+aWQuJykiIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIj48aSBjbGFzcz0ibGFzIGxhLWNoZWNrIj48L2k+Jm5ic3A7U2VuZCB0byBNYW5hZ2VtZW50PC9hPic7CiAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgIHJldHVybiAkYWN0aW9uczsKICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydyZXF1ZXN0X3Byb3Bvc2FsJywncmVmZXJlbmNlX25vJywgJ2FjdGlvbnMnXSkKICAgICAgICAgICAgICAgIC0+bWFrZSh0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnF1b3RhdGlvbi5lc3RpbWF0ZV9pbmRleCcsIFsKICAgICAgICAgICAgICAgICd0aXRsZScgPT4kdGl0bGUsCiAgICAgICAgICAgICAgICAnaGVhZGVyQ29sdW1ucycgPT4gJHRoaXMtPmVzdGltYXRlSGVhZGVyQ29sdW1ucygpCiAgICAgICAgICAgIF0pOwogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gc2VuZFRvTWFuYWdlbWVudCgkcXVvdGF0aW9uX2lkKQogICAgewogICAgICAgIGlmKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1EZXBhcnRtZW50JykpewogICAgICAgICAgICAkcXVvdGF0aW9uID0gUXVvdGF0aW9uczo6ZmluZE9yRmFpbCgkcXVvdGF0aW9uX2lkKTsKICAgICAgICAgICAgJHF1b3RhdGlvbi0+aXNfYXBwcm92ZWQgPSAncHJvY2Vzc2luZyc7CiAgICAgICAgICAgICRxdW90YXRpb24tPnNhdmUoKTsKCiAgICAgICAgICAgICRtZXNzYWdlPSAnPHNwYW4gY2xhc3M9Im5vdGlmaWNhdGlvbi1saW5rcyIgZGF0YS1zcmM9Iicucm91dGUoJ3Btcy5xdW90YXRpb24ucXVvdGF0aW9ucy5jcy5wcm9wb3NhbC5kZXRhaWxzJywkcXVvdGF0aW9uLT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKS4nIiBkYXRhLXR0aWxlPSJSZXF1ZXN0IFByb3Bvc2FsIERldGFpbHMiPlJlZmVyZW5jZSBObzonLiRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVmZXJlbmNlX25vLicuV2F0dGluZyBmb3IgTWFuYWdlbWVudCBhcHByb3ZhbC48L3NwYW4+JzsKICAgICAgICAgICAgQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oJycsZ2V0TWFuYWdlckluZm8oJ01hbmFnZW1lbnQnKSwgJG1lc3NhZ2UsJ3VucmVhZCcsJ3NlbmQtdG8tbWFuYWdlcicsJycpOwoKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5yZWRpcmVjdEJhY2tXaXRoU3VjY2VzcygnU3VjY2Vzc2Z1bGx5IHNlbmQgdG8gTWFuYWdlbWVudC4nLCdwbXMuZXN0aW1hdGUuaW5kZXgnKTsKICAgICAgICB9CgogICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigiU29ycnkhIFlvdSBkb24ndCBoYXZlIHRoZSBhY2Nlc3MgdG8gdG8gdGhpcy4iKTsKICAgIH0KCiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiBhbmFseXNpc0luZGV4SGVhZGVyQ29sdW1ucygkdmFsdWU9JycpCiAgICB7CiAgICAgICAgcmV0dXJuIGFycmF5KAogICAgICAgICAgICBbJ1NMJywgJ1NMJ10sCiAgICAgICAgICAgIFsncmVxdWVzdF9wcm9wb3NhbCcsICdyZXF1ZXN0X3Byb3Bvc2FsJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsncmVxdWlzaXRpb25zJywgJ3JlcXVpc2l0aW9ucycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3Byb2R1Y3RzJywgJ3Byb2R1Y3RzJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnc3VwcGxpZXJzJywgJ3N1cHBsaWVycycsICd0ZXh0LWxlZnQnXSwKICAgICAgICAgICAgWydvcHRpb25zJywgJ29wdGlvbnMnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICApOwogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBhbmFseXNpc0luZGV4KCl7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHF1b3RhdGlvbnMgPSBRdW90YXRpb25zOjp3aXRoKFsKICAgICAgICAgICAgICAgICdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsRGV0YWlscy5wcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsCiAgICAgICAgICAgICAgICAncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uLnJlbFJlcXVpc2l0aW9uJywKICAgICAgICAgICAgICAgICdyZWxTZWxmUXVvdGF0aW9uU3VwcGxpZXJCeVByb3Bvc2FsSWQucmVsU3VwcGxpZXJzJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlKCdzdGF0dXMnLCdhY3RpdmUnKQogICAgICAgICAgICAtPndoZXJlRG9lc250SGF2ZSgncmVsU2VsZlF1b3RhdGlvblN1cHBsaWVyQnlQcm9wb3NhbElkJywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2lzX2FwcHJvdmVkJywgWydhcHByb3ZlZCcsICdoYWx0J10pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1B1cmNoYXNlLURlcGFydG1lbnQnKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2lzX2FwcHJvdmVkJywgWydwZW5kaW5nJywgJ3ByZS1wcm9jZXNzaW5nJywgJ3Byb2Nlc3NpbmcnLF0pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1B1cmNoYXNlLUVtcGxveWVlJyksIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdpc19hcHByb3ZlZCcsIFsncGVuZGluZycsICdwcmUtcHJvY2Vzc2luZycsICdwcm9jZXNzaW5nJyxdKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5ncm91cEJ5KCdyZXF1ZXN0X3Byb3Bvc2FsX2lkJykKICAgICAgICAgICAgLT53aGVuKCFkYXRhdGFibGVPcmRlcmluZygpLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJieSgnaWQnLCAnZGVzYycpOwogICAgICAgICAgICB9KTsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIERhdGFUYWJsZXM6Om9mKCRxdW90YXRpb25zKQogICAgICAgICAgICAgICAgLT5hZGRJbmRleENvbHVtbigpCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmVxdWVzdF9wcm9wb3NhbCcsIGZ1bmN0aW9uKCRxdW90YXRpb24pewogICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBvbmNsaWNrPSJvcGVuTW9kYWwoJy4kcXVvdGF0aW9uLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPmlkLicpIiAgY2xhc3M9ImJ0biBidG4tbGluayI+Jy4kcXVvdGF0aW9uLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPnJlZmVyZW5jZV9uby4nPC9hPic7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWwnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdyZXF1ZXN0X3Byb3Bvc2FsJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWVzdFByb3Bvc2FsOjpzZWxlY3QoJ3JlcXVlc3RfcHJvcG9zYWxzLnJlZmVyZW5jZV9ubycpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJywgJ3F1b3RhdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1aXNpdGlvbnMnLCBmdW5jdGlvbigkcXVvdGF0aW9uKXsKICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25zID0gJyc7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi0+Y291bnQoKSA+IDApewogICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24gYXMgJGtleSA9PiAkcmVxdWlzaXRpb24pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9ucyAuPSAoJGtleSA+IDAgPyAnLCAnIDogJycpLic8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGRhdGEtc3JjPSInLnJvdXRlKCdwbXMucmVxdWlzaXRpb24ubGlzdC52aWV3LnNob3cnLCRyZXF1aXNpdGlvbi0+cmVsUmVxdWlzaXRpb24tPmlkKS4nIiBjbGFzcz0idGV4dC1wcmltYXJ5IHJlcXVpc2l0aW9uIG0tMSByb3VuZGVkIHNob3dSZXF1aXN0aW9uRGV0YWlscyIgb25jbGljaz0icmVxdWlzdGlvbkRldGFpbHMoJCh0aGlzKSkiPicuICRyZXF1aXNpdGlvbi0+cmVsUmVxdWlzaXRpb24tPnJlZmVyZW5jZV9ubyAuJzwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHJlcXVpc2l0aW9uczsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncmVxdWlzaXRpb25zJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24ucmVsUmVxdWlzaXRpb24nLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgka2V5d29yZCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3JlcXVpc2l0aW9ucycsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFJlcXVlc3RQcm9wb3NhbDo6c2VsZWN0KCdyZXF1aXNpdGlvbnMucmVmZXJlbmNlX25vJykKICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1aXNpdGlvbnMnLCAncmVxdWlzaXRpb25zLmlkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbF9yZXF1aXNpdGlvbnMucmVxdWlzaXRpb25faWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zJywgJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnLCAnPScsICdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJywgJ3F1b3RhdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0cycsIGZ1bmN0aW9uKCRxdW90YXRpb24pewogICAgICAgICAgICAgICAgICAgICRwcm9kdWN0cyA9ICcnOwogICAgICAgICAgICAgICAgICAgICRzbCA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLT5jb3VudCgpID4gMCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2goJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzIGFzICRrZXkgPT4gJHByb2R1Y3QpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNzZXQoJHByb2R1Y3QtPnByb2R1Y3QtPmlkKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNsKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHByb2R1Y3RzIC49ICgkc2wgPiAxID8gJywgJyA6ICcnKS4kcHJvZHVjdC0+cHJvZHVjdC0+bmFtZS4nICcuZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHByb2R1Y3QtPnByb2R1Y3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHByb2R1Y3RzOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdwcm9kdWN0cycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGtleXdvcmQpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZShmdW5jdGlvbigkcXVlcnkpIHVzZSgka2V5d29yZCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QnLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgka2V5d29yZCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmUoZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGtleXdvcmQpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3Byb2R1Y3RzJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWVzdFByb3Bvc2FsOjpzZWxlY3QoJ3Byb2R1Y3RzLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3Byb2R1Y3RzJywgJ3Byb2R1Y3RzLmlkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbF9kZXRhaWxzLnByb2R1Y3RfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3JlcXVlc3RfcHJvcG9zYWxfZGV0YWlscycsICdyZXF1ZXN0X3Byb3Bvc2FsX2RldGFpbHMucmVxdWVzdF9wcm9wb3NhbF9pZCcsICc9JywgJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucycsICdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbHMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcsICdxdW90YXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignc3VwcGxpZXJzJywgZnVuY3Rpb24oJHF1b3RhdGlvbil7CiAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVycyA9ICcnOwogICAgICAgICAgICAgICAgICAgIGZvcmVhY2goY29sbGVjdCgkcXVvdGF0aW9uLT5yZWxTZWxmUXVvdGF0aW9uU3VwcGxpZXJCeVByb3Bvc2FsSWQpIGFzICRrZXkgPT4gJHN1cHBsaWVyKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNzZXQoJHN1cHBsaWVyLT5yZWxTdXBwbGllcnMtPmlkKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJzIC49ICc8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1wcmltYXJ5Ij4nLiRzdXBwbGllci0+cmVsU3VwcGxpZXJzLT5uYW1lLicgKCcuJHN1cHBsaWVyLT5yZWxTdXBwbGllcnMtPmNvZGUuJykgWycudWN3b3Jkcygkc3VwcGxpZXItPmlzX2FwcHJvdmVkKS4nXTwvYnV0dG9uPiZuYnNwOyc7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRzdXBwbGllcnM7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3N1cHBsaWVycycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFNlbGZRdW90YXRpb25TdXBwbGllckJ5UHJvcG9zYWxJZCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2lzX2FwcHJvdmVkJywgKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1EZXBhcnRtZW50JykgPyBbJ3BlbmRpbmcnLCAncHJlLXByb2Nlc3NpbmcnXSA6IFsncGVuZGluZycsICdwcmUtcHJvY2Vzc2luZyddKSk7CiAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAtPndoZXJlSGFzKCdyZWxTZWxmUXVvdGF0aW9uU3VwcGxpZXJCeVByb3Bvc2FsSWQucmVsU3VwcGxpZXJzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGtleXdvcmQpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmUoJ2NvZGUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdzdXBwbGllcnMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBTdXBwbGllcnM6OnNlbGVjdCgnc3VwcGxpZXJzLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdzdXBwbGllcnMuaWQnLCAncXVvdGF0aW9ucy5zdXBwbGllcl9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ29wdGlvbnMnLCBmdW5jdGlvbigkcXVvdGF0aW9uKXsKICAgICAgICAgICAgICAgICAgICAkb3B0aW9ucyA9ICcnOwogICAgICAgICAgICAgICAgICAgIGlmKGNvbGxlY3QoJHF1b3RhdGlvbi0+cmVsU2VsZlF1b3RhdGlvblN1cHBsaWVyQnlQcm9wb3NhbElkKS0+d2hlcmVJbignaXNfYXBwcm92ZWQnLCAoYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1B1cmNoYXNlLURlcGFydG1lbnQnKSA/IFsncHJvY2Vzc2luZycsICdhcHByb3ZlZCcsICdoYWx0J10gOiBbJ3Byb2Nlc3NpbmcnLCAnYXBwcm92ZWQnLCAnaGFsdCddKSktPmNvdW50KCkgPT0gMCl7CiAgICAgICAgICAgICAgICAgICAgICAgICRvcHRpb25zIC49ICc8YSBocmVmPSInLnJvdXRlKCdwbXMucXVvdGF0aW9uLnF1b3RhdGlvbnMuY3MuY29tcGFyZS5saXN0JywgJHF1b3RhdGlvbi0+cmVxdWVzdF9wcm9wb3NhbF9pZCkuJyIgIHRpdGxlPSJDb21wYXJlIFByb2Nlc3MgQW5hbHlzaXMiICBjbGFzcz0iYnRuIGJ0bi1zdWNjZXNzIGJ0bi14cyI+PGkgY2xhc3M9ImxhcyBsYS1saXN0Ij48L2k+PC9hPic7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAkb3B0aW9ucyAuPSAnPGEgdGFyZ2V0PSJfYmxhbmsiIGhyZWY9Iicucm91dGUoJ3Btcy5xdW90YXRpb24uY3MuaGlzdG9yeScsJHF1b3RhdGlvbi0+cmVxdWVzdF9wcm9wb3NhbF9pZCkuJyIgY2xhc3M9ImJ0biBidG4td2FybmluZyBidG4teHMgbWwtMSIgdGl0bGU9IkNTIEhpc3RvcnkiPjxpIGNsYXNzPSJsYXMgbGEtaGlzdG9yeSI+PC9pPjwvYT4nOwoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJG9wdGlvbnM7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsncmVxdWVzdF9wcm9wb3NhbCcsICdyZXF1aXNpdGlvbnMnLCAnc3VwcGxpZXJzJywgJ29wdGlvbnMnXSkKICAgICAgICAgICAgICAgIC0+dG9Kc29uKCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24uYW5hbHlzaXMtaW5kZXgnLCBbCiAgICAgICAgICAgICAgICAndGl0bGUnID0+ICdRdW90YXRpb25zIEFuYWx5c2lzJywKICAgICAgICAgICAgICAgICdoZWFkZXJDb2x1bW5zJyA9PiAkdGhpcy0+YW5hbHlzaXNJbmRleEhlYWRlckNvbHVtbnMoKQogICAgICAgICAgICBdKTsKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIHF1b3RhdGlvbkl0ZW1zKCRxdW90YXRpb25faWQpewogICAgICAgICR0aXRsZSA9ICJRdW90YXRpb24gd2lzZSBpdGVtcyI7CiAgICAgICAgJHF1b3RhdGlvbnMgPSBRdW90YXRpb25zOjp3aXRoKFsKICAgICAgICAgICAgJ3JlbFN1cHBsaWVycy5TdXBwbGllclJhdGluZ3MnLAogICAgICAgICAgICAncmVsU3VwcGxpZXJQYXltZW50VGVybScsCiAgICAgICAgICAgICdyZWxSZXF1ZXN0UHJvcG9zYWwuY3JlYXRlZEJ5JywKICAgICAgICAgICAgJ2V4Y2hhbmdlUmF0ZS5jdXJyZW5jeScsCiAgICAgICAgICAgICdyZWxRdW90YXRpb25JdGVtcy5yZWxQcm9kdWN0LnByb2R1Y3RVbml0JywKICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbkl0ZW1zLnJlbFByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLAogICAgICAgICAgICAncmVsUXVvdGF0aW9uSXRlbXMucmVsUHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLAogICAgICAgIF0pLT53aGVyZSgnaWQnLCRxdW90YXRpb25faWQpLT53aGVyZSgnc3RhdHVzJywnYWN0aXZlJyktPmZpcnN0KCk7CiAgICAgICAgJHN5c3RlbUN1cnJlbmN5ID0gc3lzdGVtQ3VycmVuY3koKTsKICAgICAgICAkZXhjaGFuZ2VSYXRlID0gZXhjaGFuZ2VSYXRlKCRxdW90YXRpb25zLT5leGNoYW5nZVJhdGUsICRzeXN0ZW1DdXJyZW5jeS0+aWQpOwogICAgICAgICRzYW1lID0gKCRxdW90YXRpb25zLT5leGNoYW5nZVJhdGUtPmN1cnJlbmN5X2lkID09ICRzeXN0ZW1DdXJyZW5jeS0+aWQgPyB0cnVlIDogZmFsc2UpOwogICAgICAgICRhcHByb3ZlZCA9IHJlcXVlc3QoKS0+aGFzKCdhcHByb3ZlZCcpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24uaXRlbS1zaG93JywgY29tcGFjdCgncXVvdGF0aW9ucycsICd0aXRsZScsICdzeXN0ZW1DdXJyZW5jeScsICdleGNoYW5nZVJhdGUnLCAnc2FtZScsICdhcHByb3ZlZCcpKTsKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgIC8qKgogICAgICogRGlzcGxheSB0aGUgc3BlY2lmaWVkIHJlc291cmNlLgogICAgICoKICAgICAqIEBwYXJhbSAgaW50ICAkaWQKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICAgcHVibGljIGZ1bmN0aW9uIHF1b3RhdGlvbkdlbmVyYXRlKCRwcm9wb3NhbF9pZCl7ICAKICAgICAgICAkdGl0bGUgPSAnUXVvdGF0aW9uIEdlbmVyYXRlJzsKICAgICAgICAKICAgICAgICAkcmVxdWVzdFByb3Bvc2FsID0gUmVxdWVzdFByb3Bvc2FsOjp3aGVyZSgnaWQnLCRwcm9wb3NhbF9pZCkKICAgICAgICAtPndpdGgoWwogICAgICAgICAgICAncmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24ucmVsUmVxdWlzaXRpb24uVW5pdCcsCiAgICAgICAgICAgICdkZWZpbmVUb1N1cHBsaWVyLnN1cHBsaWVyLnN1cHBsZWllckN1cnJlbmNpZXMnLAogICAgICAgICAgICAnY3JlYXRlZEJ5JywKICAgICAgICAgICAgJ3JlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsIAogICAgICAgICAgICAncmVxdWVzdFByb3Bvc2FsRGV0YWlscy5wcm9kdWN0LnByb2R1Y3RVbml0JywgCiAgICAgICAgICAgICdyZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywgCiAgICAgICAgXSkKICAgICAgICAtPmZpcnN0KCk7CgogICAgICAgICRjbHVlID0gJ0dSUCc7CiAgICAgICAgJHVuaXRzID0gXEFwcFxNb2RlbHNcSHJcVW5pdDo6d2hlcmVJbignaHJfdW5pdF9pZCcsICRyZXF1ZXN0UHJvcG9zYWwtPnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uLT5wbHVjaygncmVsUmVxdWlzaXRpb24uaHJfdW5pdF9pZCcpKS0+Z2V0KCk7CiAgICAgICAgaWYoJHVuaXRzLT5jb3VudCgpID09IDEpewogICAgICAgICAgICAkY2x1ZSA9ICR1bml0c1swXS0+aHJfdW5pdF9zaG9ydF9uYW1lOwogICAgICAgIH0KCiAgICAgICAgJHByZWZpeCA9ICdRRy0nLmRhdGUoJ3knLCBzdHJ0b3RpbWUoZGF0ZSgnWS1tLWQnKSkpLictJy4kY2x1ZS4nLSc7CiAgICAgICAgJHJlZk5vID0gdW5pcXVlQ29kZSgxNSwkcHJlZml4LCdxdW90YXRpb25zJywnaWQnKTsKICAgICAgICB0cnkgewoKICAgICAgICAgICAgJHN1cHBsaWVyUGF5bWVudFRlcm1zID0gc3VwcGxpZXJQYXltZW50VGVybSgpOwogICAgICAgICAgICAkcXVvdGF0aW9uU3VwcGxpZXIgPSBRdW90YXRpb25zOjp3aGVyZSgncmVxdWVzdF9wcm9wb3NhbF9pZCcsICRwcm9wb3NhbF9pZCktPnNlbGVjdCgnc3VwcGxpZXJfaWQnKS0+Z2V0KCk7CgogICAgICAgICAgICAkcXVvdGF0aW9uU3VwcGxpZXJBcnJheSA9IGFycmF5KCk7CiAgICAgICAgICAgIGZvcmVhY2goJHF1b3RhdGlvblN1cHBsaWVyIGFzICR2YWx1ZXMpewogICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkcXVvdGF0aW9uU3VwcGxpZXJBcnJheSwkdmFsdWVzLT5zdXBwbGllcl9pZCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGlmKCRyZXF1ZXN0UHJvcG9zYWwtPmRlZmluZVRvU3VwcGxpZXItPndoZXJlTm90SW4oJ3N1cHBsaWVyX2lkJywgJHF1b3RhdGlvblN1cHBsaWVyQXJyYXkpLT5jb3VudCgpIDw9IDApewogICAgICAgICAgICAgICAgcmV0dXJuIHJlZGlyZWN0KCdwbXMvcmZwL3JlcXVlc3QtcHJvcG9zYWwnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgJGN1cnJlbmN5VHlwZXMgPSBDdXJyZW5jeVR5cGU6OndoZXJlSGFzKCdjdXJyZW5jaWVzLnN1cHBsaWVycycsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRyZXF1ZXN0UHJvcG9zYWwsICRxdW90YXRpb25TdXBwbGllckFycmF5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ3N1cHBsaWVyX2lkJywgJHJlcXVlc3RQcm9wb3NhbC0+ZGVmaW5lVG9TdXBwbGllci0+d2hlcmVOb3RJbignc3VwcGxpZXJfaWQnLCAkcXVvdGF0aW9uU3VwcGxpZXJBcnJheSktPnBsdWNrKCdzdXBwbGllcl9pZCcpLT50b0FycmF5KCkpOwogICAgICAgICAgICB9KS0+Z2V0KCk7CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucXVvdGF0aW9uLmNyZWF0ZScsIGNvbXBhY3QoJ3RpdGxlJywncmVxdWVzdFByb3Bvc2FsJywncmVmTm8nLCdzdXBwbGllclBheW1lbnRUZXJtcycsJ3F1b3RhdGlvblN1cHBsaWVyQXJyYXknLCAnY3VycmVuY3lUeXBlcycpKTsKCiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogU3RvcmUgYSBuZXdseSBjcmVhdGVkIHJlc291cmNlIGluIHN0b3JhZ2UuCiAgICAgKgogICAgICogQHBhcmFtICBcSWxsdW1pbmF0ZVxIdHRwXFJlcXVlc3QgICRyZXF1ZXN0CiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiBzdG9yZShSZXF1ZXN0ICRyZXF1ZXN0KQogICAgeyAgIAogICAgICAgICRyZXF1ZXN0LT52YWxpZGF0ZShbCiAgICAgICAgICAgICdjdXJyZW5jeV9pZCcgPT4gWydyZXF1aXJlZCddLAogICAgICAgICAgICAncXVvdGF0aW9uX2RhdGUnID0+IFsncmVxdWlyZWQnLCAnZGF0ZSddLAogICAgICAgICAgICAncmVmZXJlbmNlX25vJyA9PiAncmVxdWlyZWR8bWF4OjE1fHVuaXF1ZTpxdW90YXRpb25zJywKICAgICAgICAgICAgInN1cHBsaWVyX2lkIiAgICA9PiAicmVxdWlyZWQiLAogICAgICAgICAgICAic3VwcGxpZXJfaWQuKiIgID0+ICJleGlzdHM6c3VwcGxpZXJzLGlkIiwKICAgICAgICAgICAgInJlcXVlc3RfcHJvcG9zYWxfaWQiICAgID0+ICJyZXF1aXJlZCIsCiAgICAgICAgICAgICJyZXF1ZXN0X3Byb3Bvc2FsX2lkLioiICA9PiAiZXhpc3RzOnJlcXVlc3RfcHJvcG9zYWxzLGlkIiwKICAgICAgICAgICAgJ3N1bV9vZl9zdWJ0b2FsJyA9PiAncmVxdWlyZWQnLAogICAgICAgICAgICAnZGlzY291bnQnID0+ICdudWxsYWJsZScsCiAgICAgICAgICAgICd2YXQnID0+ICdudWxsYWJsZScsCiAgICAgICAgICAgICdncm9zc19wcmljZScgPT4gJ3JlcXVpcmVkJywKICAgICAgICAgICAgJ3R5cGUnID0+ICdyZXF1aXJlZHxpbjpvbmxpbmUsbWFudWFsJywKICAgICAgICBdKTsKCiAgICAgICAgJHR5cGU9JHJlcXVlc3QtPnR5cGU7CiAgICAgICAgJG1vZGFsPVF1b3RhdGlvbnM6OndoZXJlKFsKICAgICAgICAgICAgJ3N1cHBsaWVyX2lkJz0+JHJlcXVlc3QtPnN1cHBsaWVyX2lkLAogICAgICAgICAgICAncmVxdWVzdF9wcm9wb3NhbF9pZCc9PiRyZXF1ZXN0LT5yZXF1ZXN0X3Byb3Bvc2FsX2lkLAogICAgICAgICAgICAndHlwZSc9PiR0eXBlCiAgICAgICAgXSktPmZpcnN0KCk7CgogICAgICAgIGlmKCFlbXB0eSgkbW9kYWwpKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCdBbHJlYWR5IGdlbmVyYXRlIGEgcXVvdGF0aW9uIHVzaW5nIHRoaXMgc3VwcGxpZXIhIScpOwogICAgICAgIH0KCiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICB0cnkgewoKICAgICAgICAgICAgJHF1b3RhdGlvbkZpbGVQYXRoPScnOwogICAgICAgICAgICBpZiAoJHJlcXVlc3QtPmhhc0ZpbGUoJ3F1b3RhdGlvbl9maWxlJykpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICRxdW90YXRpb25GaWxlUGF0aD0kdGhpcy0+ZmlsZVVwbG9hZCgkcmVxdWVzdC0+ZmlsZSgncXVvdGF0aW9uX2ZpbGUnKSwndXBsb2FkL3F1b3RhdGlvbi9wZGYtZmlsZScpOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkcXVvdGF0aW9uPVF1b3RhdGlvbnM6OmNyZWF0ZShbCiAgICAgICAgICAgICAgICAnc3VwcGxpZXJfaWQnPT4kcmVxdWVzdC0+c3VwcGxpZXJfaWQsCiAgICAgICAgICAgICAgICAncmVxdWVzdF9wcm9wb3NhbF9pZCc9PiRyZXF1ZXN0LT5yZXF1ZXN0X3Byb3Bvc2FsX2lkLAogICAgICAgICAgICAgICAgJ3JlZmVyZW5jZV9ubyc9PiRyZXF1ZXN0LT5yZWZlcmVuY2Vfbm8sCiAgICAgICAgICAgICAgICAncXVvdGF0aW9uX2RhdGUnPT5kYXRlKCdZLW0tZCcsc3RydG90aW1lKCRyZXF1ZXN0LT5xdW90YXRpb25fZGF0ZSkpLAogICAgICAgICAgICAgICAgJ2V4Y2hhbmdlX3JhdGVfaWQnPT5nZXRFeGNoYW5nZVJhdGVzKCRyZXF1ZXN0LT5jdXJyZW5jeV9pZClbJ3JhdGUnXS0+aWQsCiAgICAgICAgICAgICAgICAndG90YWxfcHJpY2UnPT4kcmVxdWVzdC0+c3VtX29mX3N1YnRvYWwsCiAgICAgICAgICAgICAgICAnZGlzY291bnQnPT4kcmVxdWVzdC0+ZGlzY291bnQsCiAgICAgICAgICAgICAgICAndmF0Jz0+JHJlcXVlc3QtPnZhdD09bnVsbD8wOiRyZXF1ZXN0LT52YXQsCiAgICAgICAgICAgICAgICAnZ3Jvc3NfcHJpY2UnPT4kcmVxdWVzdC0+Z3Jvc3NfcHJpY2UsCiAgICAgICAgICAgICAgICAnc3RhdHVzJz0+J2FjdGl2ZScsCiAgICAgICAgICAgICAgICAndHlwZSc9PiR0eXBlLAogICAgICAgICAgICAgICAgJ3F1b3RhdGlvbl9maWxlJz0+JHF1b3RhdGlvbkZpbGVQYXRoCiAgICAgICAgICAgIF0pOwoKICAgICAgICAgICAgZm9yZWFjaCAoJHJlcXVlc3QtPnByb2R1Y3RfaWQgYXMgJGk9PiRwcm9kdWN0X2lkKXsKICAgICAgICAgICAgICAgICRxdW90YXRpb25JdGVtc0lucHV0W109WwogICAgICAgICAgICAgICAgICAgICdxdW90YXRpb25faWQnPT4kcXVvdGF0aW9uLT5pZCwKICAgICAgICAgICAgICAgICAgICAncHJvZHVjdF9pZCc9PiRwcm9kdWN0X2lkLAogICAgICAgICAgICAgICAgICAgICd1bml0X3ByaWNlJz0+JHJlcXVlc3QtPnVuaXRfcHJpY2VbJHByb2R1Y3RfaWRdLAogICAgICAgICAgICAgICAgICAgICdxdHknPT4kcmVxdWVzdC0+cXR5WyRwcm9kdWN0X2lkXSwKICAgICAgICAgICAgICAgICAgICAnc3ViX3RvdGFsX3ByaWNlJz0+JHJlcXVlc3QtPnN1Yl90b3RhbF9wcmljZVskcHJvZHVjdF9pZF0sCiAgICAgICAgICAgICAgICAgICAgJ2Rpc2NvdW50Jz0+JHJlcXVlc3QtPml0ZW1fZGlzY291bnRfcGVyY2VudFskcHJvZHVjdF9pZF09PW51bGw/MDokcmVxdWVzdC0+aXRlbV9kaXNjb3VudF9wZXJjZW50WyRwcm9kdWN0X2lkXSwKICAgICAgICAgICAgICAgICAgICAnZGlzY291bnRfYW1vdW50Jz0+JHJlcXVlc3QtPml0ZW1fZGlzY291bnRfYW1vdW50WyRwcm9kdWN0X2lkXSwKICAgICAgICAgICAgICAgICAgICAndmF0X3BlcmNlbnRhZ2UnPT4kcmVxdWVzdC0+cHJvZHVjdF92YXRbJHByb2R1Y3RfaWRdLAogICAgICAgICAgICAgICAgICAgICd2YXQnPT4kcmVxdWVzdC0+c3ViX3RvdGFsX3ZhdF9wcmljZVskcHJvZHVjdF9pZF0sCiAgICAgICAgICAgICAgICAgICAgJ3RvdGFsX3ByaWNlJz0+KCRyZXF1ZXN0LT5zdWJfdG90YWxfcHJpY2VbJHByb2R1Y3RfaWRdLSRyZXF1ZXN0LT5pdGVtX2Rpc2NvdW50X2Ftb3VudFskcHJvZHVjdF9pZF0pKyRyZXF1ZXN0LT5zdWJfdG90YWxfdmF0X3ByaWNlWyRwcm9kdWN0X2lkXSwKICAgICAgICAgICAgICAgICAgICAnY3JlYXRlZF9hdCc9PmRhdGUoJ1ktbS1kIGg6aScpLAogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9RdW90YXRpb24gaXRlbXMgaW5zZXJ0LgogICAgICAgICAgICBRdW90YXRpb25zSXRlbXM6Omluc2VydCgkcXVvdGF0aW9uSXRlbXNJbnB1dCk7CgogICAgICAgICAgICBpZiAoIWlzX251bGwoJHJlcXVlc3QtPnBheW1lbnRfdGVybV9pZCkpIHsKICAgICAgICAgICAgICAgICR0aGlzLT5zdG9yZVN1cHBsaWVyUGF5bWVudFRlcm0oJHF1b3RhdGlvbi0+aWQsICRyZXF1ZXN0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgREI6OmNvbW1pdCgpOwogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoU3VjY2VzcygnUXVvdGF0aW9uIEdlbmVyYXRlZCBTdWNjZXNzZnVsbHknKTsKICAgICAgICB9CiAgICAgICAgY2F0Y2ggKFRocm93YWJsZSAkdGgpewogICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIHN0b3JlU3VwcGxpZXJQYXltZW50VGVybSgkcXVvdGF0aW9uSWQsJHJlcXVlc3QpewogICAgIFN1cHBsaWVyUGF5bWVudFRlcm06OmNyZWF0ZSgKICAgICAgICBbCiAgICAgICAgICAgICdxdW90YXRpb25faWQnPT4kcXVvdGF0aW9uSWQsCiAgICAgICAgICAgICdzdXBwbGllcl9pZCc9PiRyZXF1ZXN0LT5zdXBwbGllcl9pZCwKICAgICAgICAgICAgJ3BheW1lbnRfdGVybV9pZCc9PiRyZXF1ZXN0LT5wYXltZW50X3Rlcm1faWQsCiAgICAgICAgICAgICdwYXltZW50X3BlcmNlbnQnPT4kcmVxdWVzdC0+cGF5bWVudF9wZXJjZW50Pz8wLAogICAgICAgICAgICAncmVtYXJrcyc9PiRyZXF1ZXN0LT5yZW1hcmtzLAogICAgICAgIF0KICAgICk7CiB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KICAgIHB1YmxpYyBmdW5jdGlvbiBjb21wYXJlR3JpZFZpZXcoJHJlcXVlc3RfcHJvcG9zYWxfaWQpCiAgICB7CiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgICR0aXRsZT0nUXVvdGF0aW9ucyBDb21wYXJlIEFuYWx5c2lzJzsKICAgICAgICAgICAgJHF1b3RhdGlvbnM9UXVvdGF0aW9uczo6d2hlcmUoJ3N0YXR1cycsJ2FjdGl2ZScpCiAgICAgICAgICAgIC0+d2hlcmUoJ2lzX2FwcHJvdmVkJywncGVuZGluZycpCiAgICAgICAgICAgIC0+d2hlcmUoJ3JlcXVlc3RfcHJvcG9zYWxfaWQnLCRyZXF1ZXN0X3Byb3Bvc2FsX2lkKQogICAgICAgICAgICAtPm9yZGVyYnkoJ2dyb3NzX3ByaWNlJywnYXNjJykKICAgICAgICAgICAgLT5nZXQoKTsKCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24uX2NvbXBhcmUyJywgY29tcGFjdCgndGl0bGUnLCdxdW90YXRpb25zJykpOwoKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CgogICAgfQoKICAgIC8qKgogICAgICogRGlzcGxheSBhIGxpc3Rpbmcgb2YgdGhlIHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIGNvbXBhcmVMaXN0VmlldygkcmVxdWVzdF9wcm9wb3NhbF9pZCkKICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgICAkdGl0bGUgPSAnUXVvdGF0aW9ucyBDb21wYXJlIEFuYWx5c2lzJzsKICAgICAgICAgICAgJHF1b3RhdGlvbnMgPSBRdW90YXRpb25zOjp3aGVyZSgnc3RhdHVzJywnYWN0aXZlJykKICAgICAgICAgICAgLT53aXRoKFsKICAgICAgICAgICAgICAgICdleGNoYW5nZVJhdGUuY3VycmVuY3knLAogICAgICAgICAgICAgICAgJ3JlbFJlcXVlc3RQcm9wb3NhbC5jcmVhdGVkQnknLAogICAgICAgICAgICAgICAgJ3JlbFN1cHBsaWVycy5yZWxQYXltZW50VGVybXMnLAogICAgICAgICAgICAgICAgJ3JlbFN1cHBsaWVycy5TdXBwbGllclJhdGluZ3MnLAogICAgICAgICAgICAgICAgJ2V4Y2hhbmdlUmF0ZS5jdXJyZW5jeScsCiAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uSXRlbXMucmVsUHJvZHVjdC5wcm9kdWN0VW5pdCcsCiAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uSXRlbXMucmVsUHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsCiAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uSXRlbXMucmVsUHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgIC0+d2hlcmVJbignaXNfYXBwcm92ZWQnLCAoYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1B1cmNoYXNlLURlcGFydG1lbnQnKSA/IFsncGVuZGluZycsICdwcmUtcHJvY2Vzc2luZyddIDogWydwZW5kaW5nJywgJ3ByZS1wcm9jZXNzaW5nJ10pKQogICAgICAgICAgICAtPndoZXJlKCdyZXF1ZXN0X3Byb3Bvc2FsX2lkJywkcmVxdWVzdF9wcm9wb3NhbF9pZCkKICAgICAgICAgICAgLT5vcmRlcmJ5KCdncm9zc19wcmljZScsJ2FzYycpCiAgICAgICAgICAgIC0+Z2V0KCk7CiAgICAgICAgICAgICRzeXN0ZW1DdXJyZW5jeSA9IHN5c3RlbUN1cnJlbmN5KCk7CiAgICAgICAgICAgIGlmIChpc3NldCgkcXVvdGF0aW9uc1swXSkpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24uX2NvbXBhcmUnLCBjb21wYWN0KCd0aXRsZScsJ3F1b3RhdGlvbnMnLCAnc3lzdGVtQ3VycmVuY3knKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGJhY2soKTsKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gY29tcGFyZVN0b3JlKFJlcXVlc3QgJHJlcXVlc3QpewogICAgICAgIGlmKGlzc2V0KCRyZXF1ZXN0LT5xdW90YXRpb25faWRbMF0pKXsKICAgICAgICAgICAgZm9yZWFjaCgkcmVxdWVzdC0+cXVvdGF0aW9uX2lkIGFzICRrZXkgPT4gJHF1b3RhdGlvbl9pZCl7CiAgICAgICAgICAgICAgICBpZihlbXB0eSgkcmVxdWVzdC0+c3VwcGxpZXJfcGF5bWVudF90ZXJtc19pZFskcXVvdGF0aW9uX2lkXSkpewogICAgICAgICAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gIlBsZWFzZSBjaG9vc2UgU3VwcGxpZXIgUGF5bWVudCBUZXJtIGZvciB0aGUgc2VsZWN0ZWQgcXVvdGF0aW9ucyIsCiAgICAgICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYoZW1wdHkoJHJlcXVlc3QtPmRlbGl2ZXJ5X2RhdGVbJHF1b3RhdGlvbl9pZF0pKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICJQbGVhc2UgZW50ZXIgRGVsaXZlcnkgZGF0ZSBmb3IgdGhlIHNlbGVjdGVkIHF1b3RhdGlvbnMiLAogICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAiUGxlYXNlIGNob29zZSBhdCBsZWF0IG9uZSBxdW90YXRpb24gdG8gc2VuZCB0byB0aGUgTWFuYWdlbWVudC4iLAogICAgICAgICAgICBdKTsKICAgICAgICB9CgogICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgIGZvcmVhY2ggKCRyZXF1ZXN0LT5xdW90YXRpb25faWQgYXMgJGtleT0+JHF1b3RhdGlvbl9pZCl7CiAgICAgICAgICAgICAgICAkbW9kYWw9UXVvdGF0aW9uczo6d2hlcmUoWwogICAgICAgICAgICAgICAgICAgICdpZCcgPT4gJHF1b3RhdGlvbl9pZCwKICAgICAgICAgICAgICAgICAgICAncmVxdWVzdF9wcm9wb3NhbF9pZCcgPT4gJHJlcXVlc3QtPnJlcXVlc3RfcHJvcG9zYWxfaWQKICAgICAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICAtPndoZXJlSW4oJ2lzX2FwcHJvdmVkJywgKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1EZXBhcnRtZW50JykgPyBbJ3BlbmRpbmcnLCAncHJlLXByb2Nlc3NpbmcnXSA6IFsncGVuZGluZycsICdwcmUtcHJvY2Vzc2luZyddKSkKICAgICAgICAgICAgICAgIC0+Zmlyc3QoKTsKCiAgICAgICAgICAgICAgICBpZihpc3NldCgkbW9kYWwpKXsKICAgICAgICAgICAgICAgICAgICAvLyAkbW9kYWwtPmlzX2FwcHJvdmVkID0gKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdQdXJjaGFzZS1FbXBsb3llZScpID8gJ3ByZS1wcm9jZXNzaW5nJyA6ICdwcm9jZXNzaW5nJyApOwogICAgICAgICAgICAgICAgICAgICRtb2RhbC0+aXNfYXBwcm92ZWQgPSAncHJvY2Vzc2luZyc7CiAgICAgICAgICAgICAgICAgICAgJG1vZGFsLT5ub3RlID0gJHJlcXVlc3QtPm5vdGVbJHF1b3RhdGlvbl9pZF07CiAgICAgICAgICAgICAgICAgICAgJG1vZGFsLT5kZWxpdmVyeV9kYXRlID0gJHJlcXVlc3QtPmRlbGl2ZXJ5X2RhdGVbJHF1b3RhdGlvbl9pZF07CiAgICAgICAgICAgICAgICAgICAgJG1vZGFsLT5zdXBwbGllcl9wYXltZW50X3Rlcm1zX2lkPSRyZXF1ZXN0LT5zdXBwbGllcl9wYXltZW50X3Rlcm1zX2lkWyRxdW90YXRpb25faWRdOwogICAgICAgICAgICAgICAgICAgICRtb2RhbC0+c2F2ZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvL05vdGlmaWNhdGlvbgogICAgICAgICAgICBpZihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnUHVyY2hhc2UtRW1wbG95ZWUnKSl7CiAgICAgICAgICAgICAgICAkbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJy51cmwoJ3Btcy9xdW90YXRpb24vY3MtY29tcGFyZS12aWV3LW5vdGlmaWNhdGlvbi8nLiRyZXF1ZXN0LT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKS4nIiBkYXRhLXRpdGxlPSJRdW90YXRpb24gQ1MiPlJlZmVyZW5jZSBObzonLiRtb2RhbC0+cmVmZXJlbmNlX25vLicuIFdhdHRpbmcgZm9yIFB1cmNoYXNlIEFwcHJvdmFsLjwvc3Bhbj4nOwoKICAgICAgICAgICAgICAgIENyZWF0ZU9yVXBkYXRlTm90aWZpY2F0aW9uKCcnLGdldE1hbmFnZXJJbmZvKCdQdXJjaGFzZS1EZXBhcnRtZW50JyksICRtZXNzYWdlLCd1bnJlYWQnLCdzZW5kLXRvLXB1cmNoYXNlLWRlcGFydG1lbnQnLCcnKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAkbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJy51cmwoJ3Btcy9xdW90YXRpb24vY3MtY29tcGFyZS12aWV3LW5vdGlmaWNhdGlvbi8nLiRyZXF1ZXN0LT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKS4nIiBkYXRhLXRpdGxlPSJRdW90YXRpb24gQ1MiPlJlZmVyZW5jZSBObzonLiRtb2RhbC0+cmVmZXJlbmNlX25vLicuIFdhdHRpbmcgZm9yIE1hbmFnZW1lbnQgQXBwcm92YWwuPC9zcGFuPic7CgogICAgICAgICAgICAgICAgQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oJycsZ2V0TWFuYWdlckluZm8oJ01hbmFnZW1lbnQnKSwgJG1lc3NhZ2UsJ3VucmVhZCcsJ3NlbmQtdG8tbWFuYWdlcicsJycpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBEQjo6Y29tbWl0KCk7CgogICAgICAgICAgICBzZXNzaW9uKCktPmZsYXNoKCdhbGVydC10eXBlJywnc3VjY2VzcycpOwogICAgICAgICAgICBzZXNzaW9uKCktPmZsYXNoKCdtZXNzYWdlJywnU3VjY2Vzc2Z1bGx5IFNlbmQgZm9yIGFwcHJvdmFsJyk7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiB0cnVlLAogICAgICAgICAgICAgICAgJ3VybCcgPT4gcm91dGUoJ3Btcy5xdW90YXRpb24ucXVvdGF0aW9ucy5jcy5hbmFseXNpcycpLAogICAgICAgICAgICBdKTsKCiAgICAgICAgfWNhdGNoIChUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkdGgtPmdldE1lc3NhZ2UoKSwKICAgICAgICAgICAgXSk7CiAgICAgICAgfQogICAgfQoKCiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIGFwcHJvdmFsSGVhZGVyQ29sdW1ucygkdmFsdWU9JycpCiAgICB7CiAgICAgICAgcmV0dXJuIGFycmF5KAogICAgICAgICAgICBbJ1NMJywgJ1NMJ10sIAogICAgICAgICAgICBbJ3JlcXVlc3RfcHJvcG9zYWwnLCAncmVxdWVzdF9wcm9wb3NhbCcsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3JlcXVpc2l0aW9ucycsICdyZXF1aXNpdGlvbnMnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydwcm9kdWN0cycsICdwcm9kdWN0cycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3N1cHBsaWVyJywgJ3N1cHBsaWVyJywgJ3RleHQtbGVmdCddLAogICAgICAgICAgICBbJ3N0YXR1cycsICdzdGF0dXMnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydhY3Rpb25zJywgJ2FjdGlvbnMnLCAndGV4dC1jZW50ZXIgYWN0aW9uJ10KICAgICAgICApOwogICAgfQogICAgcHVibGljIGZ1bmN0aW9uIGFwcHJvdmFsTGlzdCgpCiAgICB7CiAgICAgICAgJHRpdGxlID0gJ1F1b3RhdGlvbnMgUmVxdWVzdCBGb3IgQXBwcm92ZWQnOwoKICAgICAgICB0cnkgewogICAgICAgICAgICAkcXVvdGF0aW9ucyA9IFF1b3RhdGlvbnM6OndpdGgoWwogICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbkl0ZW1zJywKICAgICAgICAgICAgICAgICdyZWxSZXF1ZXN0UHJvcG9zYWwnLAogICAgICAgICAgICAgICAgJ3JlbFN1cHBsaWVycycsCiAgICAgICAgICAgICAgICAnZXhjaGFuZ2VSYXRlLmN1cnJlbmN5JywKICAgICAgICAgICAgICAgICdyZWxTZWxmUXVvdGF0aW9uU3VwcGxpZXJCeVByb3Bvc2FsSWQucmVsU3VwcGxpZXJzJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlKFsKICAgICAgICAgICAgICAgICdzdGF0dXMnID0+ICdhY3RpdmUnLAogICAgICAgICAgICAgICAgJ2lzX3BvX2dlbmVyYXRlJyA9PiAnbm8nLAogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlKCdpc19hcHByb3ZlZCcsICdwcm9jZXNzaW5nJykKICAgICAgICAgICAgLT53aGVyZURvZXNudEhhdmUoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZWxRdW90YXRpb25zJywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdpc19hcHByb3ZlZCcsICdhcHByb3ZlZCcpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZXJlTm90SW4oJ3R5cGUnLCBbJ2RpcmVjdC1wdXJjaGFzZSddKQogICAgICAgICAgICAtPndoZW4oIWRhdGF0YWJsZU9yZGVyaW5nKCksIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlcmJ5KCdpZCcsICdkZXNjJyk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+Z3JvdXBCeSgncmVxdWVzdF9wcm9wb3NhbF9pZCcpOwoKICAgICAgICAgICAgJGFwcHJvdmFsUmFuZ2UgPSBBdXRoOjp1c2VyKCktPnJlbEFwcHJvdmFsUmFuZ2U7CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5hamF4KCkpIHsKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhVGFibGVzOjpvZigkcXVvdGF0aW9ucykKICAgICAgICAgICAgICAgIC0+YWRkSW5kZXhDb2x1bW4oKQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWwnLCBmdW5jdGlvbigkdmFsdWVzKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgY2xhc3M9ImJ0biBidG4tbGluayIgb25jbGljaz0icmVxdWVzdFByb3Bvc2FsRGV0YWlscygnLiR2YWx1ZXMtPnJlbFJlcXVlc3RQcm9wb3NhbC0+aWQuJykiPicuKGlzc2V0KCR2YWx1ZXMtPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVmZXJlbmNlX25vKT8kdmFsdWVzLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPnJlZmVyZW5jZV9ubzonJykuJzwvYT4nOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZXF1ZXN0X3Byb3Bvc2FsJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3JlZmVyZW5jZV9ubycsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncmVxdWVzdF9wcm9wb3NhbCcsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFJlcXVlc3RQcm9wb3NhbDo6c2VsZWN0KCdyZXF1ZXN0X3Byb3Bvc2Fscy5yZWZlcmVuY2Vfbm8nKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcsICdxdW90YXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmVxdWlzaXRpb25zJywgZnVuY3Rpb24oJHF1b3RhdGlvbil7CiAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9ucyA9ICcnOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24tPmNvdW50KCkgPiAwKXsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCgkcXVvdGF0aW9uLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uIGFzICRrZXkgPT4gJHJlcXVpc2l0aW9uKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbnMgLj0gKCRrZXkgPiAwID8gJywgJyA6ICcnKS4nPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBkYXRhLXNyYz0iJy5yb3V0ZSgncG1zLnJlcXVpc2l0aW9uLmxpc3Qudmlldy5zaG93JywkcmVxdWlzaXRpb24tPnJlbFJlcXVpc2l0aW9uLT5pZCkuJyIgY2xhc3M9InRleHQtcHJpbWFyeSByZXF1aXNpdGlvbiBtLTEgcm91bmRlZCBzaG93UmVxdWlzdGlvbkRldGFpbHMiIG9uY2xpY2s9InJlcXVpc3Rpb25EZXRhaWxzKCQodGhpcykpIj4nLiAkcmVxdWlzaXRpb24tPnJlbFJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm8gLic8L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRyZXF1aXNpdGlvbnM7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3JlcXVpc2l0aW9ucycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uLnJlbFJlcXVpc2l0aW9uJywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGtleXdvcmQpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdyZXF1aXNpdGlvbnMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBSZXF1ZXN0UHJvcG9zYWw6OnNlbGVjdCgncmVxdWlzaXRpb25zLnJlZmVyZW5jZV9ubycpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncmVxdWlzaXRpb25zJywgJ3JlcXVpc2l0aW9ucy5pZCcsICc9JywgJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zLnJlcXVpc2l0aW9uX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucycsICdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbHMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcsICdxdW90YXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncHJvZHVjdHMnLCBmdW5jdGlvbigkcXVvdGF0aW9uKXsKICAgICAgICAgICAgICAgICAgICAkcHJvZHVjdHMgPSAnJzsKICAgICAgICAgICAgICAgICAgICAkc2wgPSAwOwogICAgICAgICAgICAgICAgICAgIGlmKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsRGV0YWlscy0+Y291bnQoKSA+IDApewogICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsRGV0YWlscyBhcyAka2V5ID0+ICRwcm9kdWN0KXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzc2V0KCRwcm9kdWN0LT5wcm9kdWN0LT5uYW1lKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHNsKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHByb2R1Y3RzIC49ICgkc2wgPiAxID8gJywgJyA6ICcnKS4kcHJvZHVjdC0+cHJvZHVjdC0+bmFtZS4nICcuZ2V0UHJvZHVjdEF0dHJpYnV0ZXNGYXN0ZXIoJHByb2R1Y3QtPnByb2R1Y3QpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHByb2R1Y3RzOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdwcm9kdWN0cycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGtleXdvcmQpewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZShmdW5jdGlvbigkcXVlcnkpIHVzZSgka2V5d29yZCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QnLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgka2V5d29yZCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmUoZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGtleXdvcmQpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24nLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbC5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3Byb2R1Y3RzJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWVzdFByb3Bvc2FsOjpzZWxlY3QoJ3Byb2R1Y3RzLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3Byb2R1Y3RzJywgJ3Byb2R1Y3RzLmlkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbF9kZXRhaWxzLnByb2R1Y3RfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3JlcXVlc3RfcHJvcG9zYWxfZGV0YWlscycsICdyZXF1ZXN0X3Byb3Bvc2FsX2RldGFpbHMucmVxdWVzdF9wcm9wb3NhbF9pZCcsICc9JywgJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucycsICdyZXF1ZXN0X3Byb3Bvc2FsX3JlcXVpc2l0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbHMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcsICdxdW90YXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSkKCgogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3N1cHBsaWVyJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgJGRhdGEgPSAnJzsKICAgICAgICAgICAgICAgICAgICBpZiAoJHZhbHVlcy0+cmVsU2VsZlF1b3RhdGlvblN1cHBsaWVyQnlQcm9wb3NhbElkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCR2YWx1ZXMtPnJlbFNlbGZRdW90YXRpb25TdXBwbGllckJ5UHJvcG9zYWxJZC0+d2hlcmVOb3RJbignaXNfYXBwcm92ZWQnLFsncGVuZGluZycsJ2FwcHJvdmVkJywnaGFsdCddKSBhcyAkc3VwcGxpZXIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGlzc2V0KCRzdXBwbGllci0+cmVsU3VwcGxpZXJzLT5uYW1lKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGRhdGEgLj0gJzxidXR0b24gY2xhc3M9ImJ0biBidG4tc20gYnRuLXhzIG0tMSAnLigkc3VwcGxpZXItPmlzX2FwcHJvdmVkPT0naGFsdCc/JyBidG4td2FybmluZyc6J2J0bi1zdWNjZXNzJykuJyI+Jy4kc3VwcGxpZXItPnJlbFN1cHBsaWVycy0+bmFtZS4nICgnLiRzdXBwbGllci0+cmVsU3VwcGxpZXJzLT5jb2RlLicpPC9idXR0b24+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGRhdGE7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3N1cHBsaWVyJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsU3VwcGxpZXJzJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3N1cHBsaWVyJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgU3VwcGxpZXJzOjpzZWxlY3QoJ3N1cHBsaWVycy5uYW1lJykKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbignc3VwcGxpZXJzLmlkJywgJ3F1b3RhdGlvbnMuc3VwcGxpZXJfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdzdGF0dXMnLCBmdW5jdGlvbigkdmFsdWVzKXsKICAgICAgICAgICAgICAgICAgICAkc3RhdHVzID0gJyc7CiAgICAgICAgICAgICAgICAgICAgJGFwcHJvdmVkQ291bnQgPSBRdW90YXRpb25zOjp3aGVyZSgncmVxdWVzdF9wcm9wb3NhbF9pZCcsICR2YWx1ZXMtPnJlcXVlc3RfcHJvcG9zYWxfaWQpLT53aGVyZSgnaXNfYXBwcm92ZWQnLCdhcHByb3ZlZCcpLT5jb3VudCgpOwogICAgICAgICAgICAgICAgICAgIGlmKCRhcHByb3ZlZENvdW50ID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzLj0nPGEgY2xhc3M9ImJ0biBidG4teHMgYnRuLXN1Y2Nlc3MiPkFwcHJvdmVkICgnLiRhcHByb3ZlZENvdW50LicgU3VwcGxpZXIpPC9hPic7CiAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMuPSc8YSBjbGFzcz0iYnRuIGJ0bi14cyBidG4td2FybmluZyI+V2FpdGluZyBmb3IgQXBwcm92YWw8L2E+JzsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiAkc3RhdHVzOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24oJHZhbHVlcykgdXNlKCRhcHByb3ZhbFJhbmdlKXsKICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyA9ICcnOwogICAgICAgICAgICAgICAgICAgICRjb3VudCA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYoaXNzZXQoJGFwcHJvdmFsUmFuZ2VbMF0pKXsKICAgICAgICAgICAgICAgICAgICAgICAgZm9yZWFjaCAoJGFwcHJvdmFsUmFuZ2UgYXMgJHJhbmdlKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkcmFuZ2UtPm1pbl9hbW91bnQgPD0gJHZhbHVlcy0+cmVsUXVvdGF0aW9uSXRlbXMtPnN1bSgndG90YWxfcHJpY2UnKSAmJiAkcmFuZ2UtPm1heF9hbW91bnQgPj0gJHZhbHVlcy0+cmVsUXVvdGF0aW9uSXRlbXMtPnN1bSgndG90YWxfcHJpY2UnKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJGNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCRjb3VudCA+PSAwKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdmFsdWVzLT5yZWxTZWxmUXVvdGF0aW9uU3VwcGxpZXJCeVByb3Bvc2FsSWQtPndoZXJlSW4oJ2lzX2FwcHJvdmVkJywgWydhcHByb3ZlZCcsJ2hhbHQnXSktPmNvdW50KCkgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zLj0nPGEgaHJlZj0iJy5yb3V0ZSgncG1zLnF1b3RhdGlvbi5xdW90YXRpb25zLmNzLmNvbXBhcmUudmlldycsWydpZCc9PiR2YWx1ZXMtPnJlcXVlc3RfcHJvcG9zYWxfaWQsJ3NsdWcnPT4nbGlzdCddKS4nP3R5cGU9cmZwIiAgdGl0bGU9IkNvbXBhcmUgUHJvY2VzcyBBbmFseXNpcyIgIGNsYXNzPSJidG4gYnRuLXN1Y2Nlc3MgYnRuLXhzIj48aSBjbGFzcz0ibGFzIGxhLWxpc3QiPjwvaT48L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucy49JzxhIHRpdGxlPSJPdXQgb2YgQXBwcm92YWwgUmFuZ2UiICBjbGFzcz0iYnRuIGJ0bi1kYW5nZXIgYnRuLXhzIj48aSBjbGFzcz0ibGFzIGxhLWJhbiI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdmFsdWVzLT5yZWxTZWxmUXVvdGF0aW9uU3VwcGxpZXJCeVByb3Bvc2FsSWQtPndoZXJlSW4oJ2lzX2FwcHJvdmVkJywgWydhcHByb3ZlZCcsJ2hhbHQnXSktPmNvdW50KCkgPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMuPSc8YSBocmVmPSInLnJvdXRlKCdwbXMucXVvdGF0aW9uLnF1b3RhdGlvbnMuY3MuY29tcGFyZS52aWV3JyxbJ2lkJz0+JHZhbHVlcy0+cmVxdWVzdF9wcm9wb3NhbF9pZCwnc2x1Zyc9PidsaXN0J10pLic/dHlwZT1yZnAiICB0aXRsZT0iQ29tcGFyZSBQcm9jZXNzIEFuYWx5c2lzIiAgY2xhc3M9ImJ0biBidG4tc3VjY2VzcyBidG4teHMiPjxpIGNsYXNzPSJsYXMgbGEtbGlzdCI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucy49JzxhIHRhcmdldD0iX2JsYW5rIiBocmVmPSInLnJvdXRlKCdwbXMucXVvdGF0aW9uLmNzLmhpc3RvcnknLCR2YWx1ZXMtPnJlcXVlc3RfcHJvcG9zYWxfaWQpLiciIGNsYXNzPSJidG4gYnRuLXdhcm5pbmcgYnRuLXhzIG1sLTEiIHRpdGxlPSJDUyBIaXN0b3J5Ij48aSBjbGFzcz0ibGFzIGxhLWhpc3RvcnkiPjwvaT48L2E+JzsKICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFjdGlvbnM7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsncmVxdWVzdF9wcm9wb3NhbCcsICdyZXF1aXNpdGlvbnMnLCAnc3VwcGxpZXInLCAnc3RhdHVzJywgJ2FjdGlvbnMnXSkKICAgICAgICAgICAgICAgIC0+bWFrZSh0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnF1b3RhdGlvbi5hcHByb3ZhbC1pbmRleCcsIFsKICAgICAgICAgICAgICAgICd0aXRsZScgPT4gJHRpdGxlLAogICAgICAgICAgICAgICAgJ2hlYWRlckNvbHVtbnMnID0+ICR0aGlzLT5hcHByb3ZhbEhlYWRlckNvbHVtbnMoKQogICAgICAgICAgICBdKTsKCiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogRGlzcGxheSBhIGxpc3Rpbmcgb2YgdGhlIHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIGVzdGltYXRlQXBwcm92YWxMaXN0KCkKICAgIHsKICAgICAgICAkdGl0bGUgPSAnRXN0aW1hdGUgUmVxdWVzdCBGb3IgQXBwcm92ZWQnOwoKICAgICAgICB0cnkgewogICAgICAgICAgICAkcXVvdGF0aW9ucyA9IFF1b3RhdGlvbnM6OndpdGgoWwogICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbkl0ZW1zJywKICAgICAgICAgICAgICAgICdyZWxSZXF1ZXN0UHJvcG9zYWwnLAogICAgICAgICAgICAgICAgJ3JlbFN1cHBsaWVycycsCiAgICAgICAgICAgICAgICAnZXhjaGFuZ2VSYXRlLmN1cnJlbmN5JywKICAgICAgICAgICAgICAgICdyZWxTZWxmUXVvdGF0aW9uU3VwcGxpZXJCeVByb3Bvc2FsSWQucmVsU3VwcGxpZXJzJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlKFsKICAgICAgICAgICAgICAgICdzdGF0dXMnID0+ICdhY3RpdmUnLAogICAgICAgICAgICAgICAgJ2lzX3BvX2dlbmVyYXRlJyA9PiAnbm8nLAogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlKCdpc19hcHByb3ZlZCcsJ3Byb2Nlc3NpbmcnKQogICAgICAgICAgICAtPndoZXJlKCd0eXBlJywnZGlyZWN0LXB1cmNoYXNlJyk7CgogICAgICAgICAgICAkYXBwcm92YWxSYW5nZSA9IEF1dGg6OnVzZXIoKS0+cmVsQXBwcm92YWxSYW5nZTsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgICAgICAgICAgJG9wdGlvbnMgPSBbCiAgICAgICAgICAgICAgICAgICAgJ01hbmFnZW1lbnQnID0+IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdNYW5hZ2VtZW50JyksCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgcmV0dXJuIERhdGFUYWJsZXM6Om9mKCRxdW90YXRpb25zKQogICAgICAgICAgICAgICAgLT5hZGRJbmRleENvbHVtbigpCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmVxdWVzdF9wcm9wb3NhbCcsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBjbGFzcz0iYnRuIGJ0bi1saW5rIiBvbmNsaWNrPSJyZXF1ZXN0UHJvcG9zYWxEZXRhaWxzKCcuJHZhbHVlcy0+cmVsUmVxdWVzdFByb3Bvc2FsLT5pZC4nKSI+Jy4oaXNzZXQoJHZhbHVlcy0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZWZlcmVuY2Vfbm8pPyR2YWx1ZXMtPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVmZXJlbmNlX25vOicnKS4nPC9hPic7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWwnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdyZXF1ZXN0X3Byb3Bvc2FsJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWVzdFByb3Bvc2FsOjpzZWxlY3QoJ3JlcXVlc3RfcHJvcG9zYWxzLnJlZmVyZW5jZV9ubycpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJywgJ3F1b3RhdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1aXNpdGlvbnMnLCBmdW5jdGlvbigkcXVvdGF0aW9uKXsKICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25zID0gJyc7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi0+Y291bnQoKSA+IDApewogICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24gYXMgJGtleSA9PiAkcmVxdWlzaXRpb24pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9ucyAuPSAoJGtleSA+IDAgPyAnLCAnIDogJycpLic8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGRhdGEtc3JjPSInLnJvdXRlKCdwbXMucmVxdWlzaXRpb24ubGlzdC52aWV3LnNob3cnLCRyZXF1aXNpdGlvbi0+cmVsUmVxdWlzaXRpb24tPmlkKS4nIiBjbGFzcz0idGV4dC1wcmltYXJ5IHJlcXVpc2l0aW9uIG0tMSByb3VuZGVkIHNob3dSZXF1aXN0aW9uRGV0YWlscyIgb25jbGljaz0icmVxdWlzdGlvbkRldGFpbHMoJCh0aGlzKSkiPicuICRyZXF1aXNpdGlvbi0+cmVsUmVxdWlzaXRpb24tPnJlZmVyZW5jZV9ubyAuJzwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHJlcXVpc2l0aW9uczsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncmVxdWlzaXRpb25zJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24ucmVsUmVxdWlzaXRpb24nLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgka2V5d29yZCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3JlcXVpc2l0aW9ucycsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFJlcXVlc3RQcm9wb3NhbDo6c2VsZWN0KCdyZXF1aXNpdGlvbnMucmVmZXJlbmNlX25vJykKICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1aXNpdGlvbnMnLCAncmVxdWlzaXRpb25zLmlkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbF9yZXF1aXNpdGlvbnMucmVxdWlzaXRpb25faWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zJywgJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnLCAnPScsICdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJywgJ3F1b3RhdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0cycsIGZ1bmN0aW9uKCRxdW90YXRpb24pewogICAgICAgICAgICAgICAgICAgICRwcm9kdWN0cyA9ICcnOwogICAgICAgICAgICAgICAgICAgICRzbCA9IDA7CiAgICAgICAgICAgICAgICAgICAgaWYoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLT5jb3VudCgpID4gMCl7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2goJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzIGFzICRrZXkgPT4gJHByb2R1Y3QpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoaXNzZXQoJHByb2R1Y3QtPnByb2R1Y3QtPm5hbWUpKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkc2wrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcHJvZHVjdHMgLj0gKCRzbCA+IDEgPyAnLCAnIDogJycpLiRwcm9kdWN0LT5wcm9kdWN0LT5uYW1lLicgJy5nZXRQcm9kdWN0QXR0cmlidXRlc0Zhc3RlcigkcHJvZHVjdC0+cHJvZHVjdCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcHJvZHVjdHM7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3Byb2R1Y3RzJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZShmdW5jdGlvbigkcXVlcnkpIHVzZSgka2V5d29yZCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRrZXl3b3JkKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAgJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdCcsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRrZXl3b3JkKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZShmdW5jdGlvbigkcXVlcnkpIHVzZSgka2V5d29yZCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbicsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncHJvZHVjdHMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBSZXF1ZXN0UHJvcG9zYWw6OnNlbGVjdCgncHJvZHVjdHMubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncHJvZHVjdHMnLCAncHJvZHVjdHMuaWQnLCAnPScsICdyZXF1ZXN0X3Byb3Bvc2FsX2RldGFpbHMucHJvZHVjdF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncmVxdWVzdF9wcm9wb3NhbF9kZXRhaWxzJywgJ3JlcXVlc3RfcHJvcG9zYWxfZGV0YWlscy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbHMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zJywgJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnLCAnPScsICdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJywgJ3F1b3RhdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdzdXBwbGllcicsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgICAgICRkYXRhID0gJyc7CiAgICAgICAgICAgICAgICAgICAgaWYgKCR2YWx1ZXMtPnJlbFNlbGZRdW90YXRpb25TdXBwbGllckJ5UHJvcG9zYWxJZCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkdmFsdWVzLT5yZWxTZWxmUXVvdGF0aW9uU3VwcGxpZXJCeVByb3Bvc2FsSWQtPndoZXJlTm90SW4oJ2lzX2FwcHJvdmVkJyxbJ3BlbmRpbmcnLCdhcHByb3ZlZCcsJ2hhbHQnXSkgYXMgJHN1cHBsaWVyKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZGF0YS49JzxidXR0b24gY2xhc3M9ImJ0biBidG4tc20gYnRuLXhzIG1yLTEgJy4oJHN1cHBsaWVyLT5pc19hcHByb3ZlZD09J2hhbHQnPycgYnRuLXdhcm5pbmcnOididG4tc3VjY2VzcycpLiciPicuJHN1cHBsaWVyLT5yZWxTdXBwbGllcnMtPm5hbWUuJyAoJy4kc3VwcGxpZXItPnJlbFN1cHBsaWVycy0+Y29kZS4nKTwvYnV0dG9uPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRkYXRhOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdzdXBwbGllcicsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFN1cHBsaWVycycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdzdXBwbGllcicsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFN1cHBsaWVyczo6c2VsZWN0KCdzdXBwbGllcnMubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3N1cHBsaWVycy5pZCcsICdxdW90YXRpb25zLnN1cHBsaWVyX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignc3RhdHVzJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyA9ICcnOwogICAgICAgICAgICAgICAgICAgICRhcHByb3ZlZENvdW50ID0gUXVvdGF0aW9uczo6d2hlcmUoJ3JlcXVlc3RfcHJvcG9zYWxfaWQnLCR2YWx1ZXMtPnJlcXVlc3RfcHJvcG9zYWxfaWQpLT53aGVyZSgnaXNfYXBwcm92ZWQnLCdhcHByb3ZlZCcpLT5jb3VudCgpOwogICAgICAgICAgICAgICAgICAgIGlmKCRhcHByb3ZlZENvdW50ID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzLj0nPGEgY2xhc3M9ImJ0biBidG4teHMgYnRuLXN1Y2Nlc3MiPkFwcHJvdmVkIE9uY2U8L2E+JzsKICAgICAgICAgICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cy49JzxhIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi13YXJuaW5nIj5XYWl0aW5nIGZvciBBcHByb3ZhbDwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHN0YXR1czsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYWN0aW9ucycsIGZ1bmN0aW9uKCR2YWx1ZXMpIHVzZSgkYXBwcm92YWxSYW5nZSwgJG9wdGlvbnMpewogICAgICAgICAgICAgICAgICAgICRhY3Rpb25zID0gJyc7CiAgICAgICAgICAgICAgICAgICAgJGNvdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICBpZihpc3NldCgkYXBwcm92YWxSYW5nZVswXSkpewogICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkYXBwcm92YWxSYW5nZSBhcyAkcmFuZ2UpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRyYW5nZS0+bWluX2Ftb3VudCA8PSAkdmFsdWVzLT5yZWxRdW90YXRpb25JdGVtcy0+c3VtKCd0b3RhbF9wcmljZScpICYmICRyYW5nZS0+bWF4X2Ftb3VudCA+PSAkdmFsdWVzLT5yZWxRdW90YXRpb25JdGVtcy0+c3VtKCd0b3RhbF9wcmljZScpKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkY291bnQrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYoJGNvdW50ID49IDApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRvcHRpb25zWydNYW5hZ2VtZW50J10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucy49JzxhIGhyZWY9Iicucm91dGUoJ3Btcy5xdW90YXRpb24ucXVvdGF0aW9ucy5jcy5jb21wYXJlLnZpZXcnLFsnaWQnPT4kdmFsdWVzLT5yZXF1ZXN0X3Byb3Bvc2FsX2lkLCdzbHVnJz0+J2xpc3QnXSkuJz90eXBlPWRpcmVjdC1wdXJjaGFzZSIgIHRpdGxlPSJDb21wYXJlIFByb2Nlc3MgQW5hbHlzaXMiICBjbGFzcz0iYnRuIGJ0bi1zdWNjZXNzIGJ0bi14cyI+PGkgY2xhc3M9ImxhcyBsYS1saXN0Ij48L2k+PC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMuPSc8YSB0aXRsZT0iT3V0IG9mIEFwcHJvdmFsIFJhbmdlIiAgY2xhc3M9ImJ0biBidG4tZGFuZ2VyIGJ0bi14cyI+PGkgY2xhc3M9ImxhcyBsYS1iYW4iPjwvaT48L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJG9wdGlvbnNbJ01hbmFnZW1lbnQnXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMuPSc8YSBocmVmPSInLnJvdXRlKCdwbXMucXVvdGF0aW9uLnF1b3RhdGlvbnMuY3MuY29tcGFyZS52aWV3JyxbJ2lkJz0+JHZhbHVlcy0+cmVxdWVzdF9wcm9wb3NhbF9pZCwnc2x1Zyc9PidsaXN0J10pLic/dHlwZT1kaXJlY3QtcHVyY2hhc2UiICB0aXRsZT0iQ29tcGFyZSBQcm9jZXNzIEFuYWx5c2lzIiAgY2xhc3M9ImJ0biBidG4tc3VjY2VzcyBidG4teHMiPjxpIGNsYXNzPSJsYXMgbGEtbGlzdCI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucy49JzxhIHRhcmdldD0iX19ibGFuayIgaHJlZj0iJy5yb3V0ZSgncG1zLnF1b3RhdGlvbi5jcy5oaXN0b3J5JywkdmFsdWVzLT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKS4nIiBjbGFzcz0iYnRuIGJ0bi13YXJuaW5nIGJ0bi14cyBtbC0xIiB0aXRsZT0iIENTIEhpc3RvcnkiPjxpIGNsYXNzPSJsYXMgbGEtaGlzdG9yeSI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIHJldHVybiAkYWN0aW9uczsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydyZXF1ZXN0X3Byb3Bvc2FsJywnc3VwcGxpZXInLCdzdGF0dXMnLCdhY3Rpb25zJywgJ3JlcXVpc2l0aW9ucycsICdwcm9kdWN0cyddKQogICAgICAgICAgICAgICAgLT5tYWtlKHRydWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucXVvdGF0aW9uLmVzdGltYXRlLWluZGV4JywgWyd0aXRsZSc9PiR0aXRsZSwnaGVhZGVyQ29sdW1ucyc9PiR0aGlzLT5hcHByb3ZhbEhlYWRlckNvbHVtbnMoKV0pOwoKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gY29tcGFyZVZpZXcoJGlkLCRzbHVnKXsKICAgICAgICAkdGl0bGUgPSAnUXVvdGF0aW9ucyBDb21wYXJlIEFuYWx5c2lzJzsKICAgICAgICAkcmVxdWVzdFByb3Bvc2FsSWQgPSAkaWQ7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgJHF1b3RhdGlvbnMgPSBRdW90YXRpb25zOjp3aXRoKFsKICAgICAgICAgICAgICAgICdyZWxSZXF1ZXN0UHJvcG9zYWwuY3JlYXRlZEJ5JywKICAgICAgICAgICAgICAgICdyZWxTdXBwbGllcnMuU3VwcGxpZXJSYXRpbmdzJywKICAgICAgICAgICAgICAgICdleGNoYW5nZVJhdGUuY3VycmVuY3knLAogICAgICAgICAgICAgICAgJ3JlbFN1cHBsaWVycycsCiAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uSXRlbXMucmVsUHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsCiAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uSXRlbXMucmVsUHJvZHVjdC5wcm9kdWN0VW5pdCcsCiAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uSXRlbXMucmVsUHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLAogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlKFsKICAgICAgICAgICAgICAgICdzdGF0dXMnID0+ICdhY3RpdmUnLAogICAgICAgICAgICAgICAgJ3JlcXVlc3RfcHJvcG9zYWxfaWQnID0+ICRpZAogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlSW4oJ2lzX2FwcHJvdmVkJyxbJ3Byb2Nlc3NpbmcnLCdoYWx0J10pCiAgICAgICAgICAgIC0+b3JkZXJieSgnZ3Jvc3NfcHJpY2UnLCdhc2MnKQogICAgICAgICAgICAtPmdldCgpOwogICAgICAgICAgICAkc3lzdGVtQ3VycmVuY3kgPSBzeXN0ZW1DdXJyZW5jeSgpOwoKICAgICAgICAgICAgaWYoJHNsdWcgPT0gJ2xpc3QnKXsKICAgICAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24uX2NvbXBhcmVfdmlld19saXN0JywgY29tcGFjdCgndGl0bGUnLCdxdW90YXRpb25zJywncmVxdWVzdFByb3Bvc2FsSWQnLCAnc3lzdGVtQ3VycmVuY3knKSk7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnF1b3RhdGlvbi5fY29tcGFyZV92aWV3X2dyaWQnLCBjb21wYWN0KCd0aXRsZScsJ3F1b3RhdGlvbnMnLCdyZXF1ZXN0UHJvcG9zYWxJZCcpKTsKICAgICAgICAgICAgfQogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiBjb21wYXJlVmlld05vdGlmaWNhdGlvbigkaWQpewogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRxdW90YXRpb25zID0gUXVvdGF0aW9uczo6d2l0aChbCiAgICAgICAgICAgICAgICAncmVsUmVxdWVzdFByb3Bvc2FsLmNyZWF0ZWRCeScsCiAgICAgICAgICAgICAgICAncmVsU3VwcGxpZXJzLlN1cHBsaWVyUmF0aW5ncycsCiAgICAgICAgICAgICAgICAnZXhjaGFuZ2VSYXRlLmN1cnJlbmN5JywKICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb25JdGVtcy5yZWxQcm9kdWN0LnByb2R1Y3RVbml0JywKICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb25JdGVtcy5yZWxQcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywKICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb25JdGVtcy5yZWxQcm9kdWN0LmF0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScsCiAgICAgICAgICAgIF0pLT53aGVyZShbCiAgICAgICAgICAgICAgICAnc3RhdHVzJyA9PiAnYWN0aXZlJywKICAgICAgICAgICAgICAgICdyZXF1ZXN0X3Byb3Bvc2FsX2lkJyA9PiAkaWQKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZU5vdEluKCdpc19hcHByb3ZlZCcsWydwZW5kaW5nJ10pCiAgICAgICAgICAgIC0+b3JkZXJieSgnZ3Jvc3NfcHJpY2UnLCdhc2MnKS0+Z2V0KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAkc3lzdGVtQ3VycmVuY3kgPSBzeXN0ZW1DdXJyZW5jeSgpOwoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnF1b3RhdGlvbi5fY29tcGFyZV92aWV3X2xpc3Rfbm90aWZpY2F0aW9uJywgY29tcGFjdCgncXVvdGF0aW9ucycsICdzeXN0ZW1DdXJyZW5jeScpKTsKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aC0+Z2V0TWVzc2FnZSgpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiBjb21wYXJlVmlld1BkZlZpZXcoJGlkKXsKICAgICAgICB0cnkgewogICAgICAgICAgICAkcXVvdGF0aW9ucyA9IFF1b3RhdGlvbnM6OndpdGgoWwogICAgICAgICAgICAgICAgJ3JlbFJlcXVlc3RQcm9wb3NhbC5jcmVhdGVkQnknLAogICAgICAgICAgICAgICAgJ3JlbFN1cHBsaWVycy5TdXBwbGllclJhdGluZ3MnLAogICAgICAgICAgICAgICAgJ2V4Y2hhbmdlUmF0ZS5jdXJyZW5jeScsCiAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uSXRlbXMucmVsUHJvZHVjdC5wcm9kdWN0VW5pdCcsCiAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uSXRlbXMucmVsUHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsCiAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uSXRlbXMucmVsUHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLAogICAgICAgICAgICBdKS0+d2hlcmUoWwogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gJ2FjdGl2ZScsCiAgICAgICAgICAgICAgICAncmVxdWVzdF9wcm9wb3NhbF9pZCcgPT4gJGlkCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgIC0+d2hlcmVOb3RJbignaXNfYXBwcm92ZWQnLFsncGVuZGluZyddKQogICAgICAgICAgICAtPm9yZGVyYnkoJ2dyb3NzX3ByaWNlJywnYXNjJyktPmdldCgpOwogICAgICAgICAgICAKICAgICAgICAgICAgJHN5c3RlbUN1cnJlbmN5ID0gc3lzdGVtQ3VycmVuY3koKTsKICAgICAgICAgICAgJHRpdGxlPSJDUyBWaWV3IjsKICAgICAgICAgICAgJHB1cmNoYXNlT3JkZXJJZD0kaWQ7CgogICAgICAgICAgICBpZihyZXF1ZXN0KCktPmhhcygnZG93bmxvYWRwZGYnKSl7CiAgICAgICAgICAgICAgICByZXR1cm4gdmlld01QREYoJ3Btcy5iYWNrZW5kLnBhZ2VzLnF1b3RhdGlvbi5jb21wYXJlX3ZpZXdfbGlzdF9wZGZfZG93bmxvYWQnLCBbCiAgICAgICAgICAgICAgICAgICAgJ3RpdGxlJyA9PiAkdGl0bGUsCiAgICAgICAgICAgICAgICAgICAgJ3F1b3RhdGlvbnMnID0+ICRxdW90YXRpb25zLAogICAgICAgICAgICAgICAgICAgICdzeXN0ZW1DdXJyZW5jeScgPT4gJHN5c3RlbUN1cnJlbmN5LAogICAgICAgICAgICAgICAgXSwgJHRpdGxlLCAkdGl0bGUsICdhMycsJ0wnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnF1b3RhdGlvbi5jb21wYXJlX3ZpZXdfbGlzdF9wZGYnLCBjb21wYWN0KCdxdW90YXRpb25zJywgJ3N5c3RlbUN1cnJlbmN5JywndGl0bGUnLCdwdXJjaGFzZU9yZGVySWQnKSk7CiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiAkdGgtPmdldE1lc3NhZ2UoKTsKICAgICAgICB9CiAgICB9CgoKICAgIC8qKgogICAgICogRGlzcGxheSBhIGxpc3Rpbmcgb2YgdGhlIHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIGFwcHJvdmVkKFJlcXVlc3QgJHJlcXVlc3QpeyAgCiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICB0cnkgewogICAgICAgICAgICAkcHJvcG9zYWwgPSBSZXF1ZXN0UHJvcG9zYWw6OndpdGgoWwogICAgICAgICAgICAgICAgJ3JlcXVlc3RQcm9wb3NhbERldGFpbHMnLCAncmVsUXVvdGF0aW9ucycKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT5maW5kT3JGYWlsKCRyZXF1ZXN0LT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKTsKICAgICAgICAgICAgaWYoJHByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLT5jb3VudCgpID4gKGlzc2V0KCRyZXF1ZXN0LT5pdGVtX3JhZGlvcykgJiYgaXNfYXJyYXkoJHJlcXVlc3QtPml0ZW1fcmFkaW9zKSA/IGNvdW50KCRyZXF1ZXN0LT5pdGVtX3JhZGlvcykgOiAwKSl7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAiUGxlYXNlIENoaG9zZSBBbGwgIi4kcHJvcG9zYWwtPnJlcXVlc3RQcm9wb3NhbERldGFpbHMtPmNvdW50KCkuIiBQcm9kdWN0cyIKICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkcXVvdGF0aW9uSXRlbXMgPSBRdW90YXRpb25zSXRlbXM6OndpdGgoWwogICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbicKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZUluKCdpZCcsICRyZXF1ZXN0LT5pdGVtX3JhZGlvcykKICAgICAgICAgICAgLT5nZXQoKTsKICAgICAgICAgICAgJHF1b3RhdGlvbnMgPSBbXTsKICAgICAgICAgICAgJHJlZmVyZW5jZXMgPSBbXTsKICAgICAgICAgICAgaWYoJHF1b3RhdGlvbkl0ZW1zLT5jb3VudCgpID4gMCl7CiAgICAgICAgICAgICAgICBmb3JlYWNoKCRxdW90YXRpb25JdGVtcyBhcyAka2V5ID0+ICRxdW90YXRpb25JdGVtKXsKICAgICAgICAgICAgICAgICAgICAkcXVvdGF0aW9uSXRlbS0+aXNfYXBwcm92ZWQgPSAnYXBwcm92ZWQnOwogICAgICAgICAgICAgICAgICAgICRxdW90YXRpb25JdGVtLT5zYXZlKCk7CgogICAgICAgICAgICAgICAgICAgICRxdW90YXRpb25JdGVtLT5yZWxRdW90YXRpb24tPmlzX2FwcHJvdmVkID0gJ2FwcHJvdmVkJzsKICAgICAgICAgICAgICAgICAgICAkcXVvdGF0aW9uSXRlbS0+cmVsUXVvdGF0aW9uLT5yZW1hcmtzID0gJHJlcXVlc3QtPnJlbWFya3M7CiAgICAgICAgICAgICAgICAgICAgJHF1b3RhdGlvbkl0ZW0tPnJlbFF1b3RhdGlvbi0+c2F2ZSgpOwoKICAgICAgICAgICAgICAgICAgICBhcnJheV9wdXNoKCRyZWZlcmVuY2VzLCAkcXVvdGF0aW9uSXRlbS0+cmVsUXVvdGF0aW9uLT5yZWZlcmVuY2Vfbm8pOwogICAgICAgICAgICAgICAgICAgIGFycmF5X3B1c2goJHF1b3RhdGlvbnMsICRxdW90YXRpb25JdGVtLT5yZWxRdW90YXRpb24tPmlkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgJHF1b3RhdGlvbnMgPSBRdW90YXRpb25zOjp3aGVyZUluKCdpZCcsICRxdW90YXRpb25zKQogICAgICAgICAgICAtPndoZXJlKCd0eXBlJywgJ2RpcmVjdC1wdXJjaGFzZScpCiAgICAgICAgICAgIC0+Z2V0KCk7CiAgICAgICAgICAgIGlmKGlzc2V0KCRxdW90YXRpb25zWzBdKSl7CiAgICAgICAgICAgICAgICBmb3JlYWNoKCRxdW90YXRpb25zIGFzICRrZXkgPT4gJHF1b3RhdGlvbil7CiAgICAgICAgICAgICAgICAgICAgJHB1cmNoYXNlT3JkZXIgPSAkdGhpcy0+ZGlyZWN0UHVyY2hhc2VTdG9yZSgkcXVvdGF0aW9uKTsKICAgICAgICAgICAgICAgICAgICBpZigkcHVyY2hhc2VPcmRlcil7CiAgICAgICAgICAgICAgICAgICAgICAgICRtZXNzYWdlID0gJzxzcGFuIGNsYXNzPSJub3RpZmljYXRpb24tbGlua3MiIGRhdGEtc3JjPSInLnJvdXRlKCdwbXMucHVyY2hhc2Uub3JkZXItbGlzdC5zaG93JywkcHVyY2hhc2VPcmRlci0+aWQpLic/dmlldyIgZGF0YS10aXRsZT0iUHVyY2hhc2UgT3JkZXIgRGV0YWlscyI+UmVmZXJlbmNlIE5vOicuJHB1cmNoYXNlT3JkZXItPnJlZmVyZW5jZV9uby4nLiBSZXF1ZXN0IGZvciBjYXNoIGFwcHJvdmVkLjwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgICAgICBDcmVhdGVPclVwZGF0ZU5vdGlmaWNhdGlvbignJyxnZXRNYW5hZ2VySW5mbygnQWNjb3VudHMnKSwkbWVzc2FnZSwndW5yZWFkJywnc2VuZC10by1hY2NvdW50cycsJycpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgJG1lc3NhZ2UgPSAnPHNwYW4gY2xhc3M9Im5vdGlmaWNhdGlvbi1saW5rcyIgZGF0YS1zcmM9IicudXJsKCdwbXMvcXVvdGF0aW9uL2NzLWNvbXBhcmUtdmlldy1ub3RpZmljYXRpb24vJy4kcmVxdWVzdC0+cmVxdWVzdF9wcm9wb3NhbF9pZCkuJyIgZGF0YS10aXRsZT0iUXVvdGF0aW9uIENTIj5SZWZlcmVuY2VzICgnLmltcGxvZGUoJywgJywgJHJlZmVyZW5jZXMpLicpIEFwcHJvdmVkIEJ5IE1hbmFnZW1lbnQuPC9zcGFuPic7CiAgICAgICAgICAgIENyZWF0ZU9yVXBkYXRlTm90aWZpY2F0aW9uKCcnLGdldE1hbmFnZXJJbmZvKCdQdXJjaGFzZS1EZXBhcnRtZW50JyksJG1lc3NhZ2UsJ3VucmVhZCcsJ3NlbnQtdG8tcHVyY2hhc2UnLCcnKTsKCiAgICAgICAgICAgIERCOjpjb21taXQoKTsKICAgICAgICAgICAgc2Vzc2lvbigpLT5mbGFzaCgnYWxlcnQtdHlwZScsICdzdWNjZXNzJyk7CiAgICAgICAgICAgIHNlc3Npb24oKS0+Zmxhc2goJ21lc3NhZ2UnLCAnQ1MgYXBwcm92ZWQgc3VjY2Vzc2Z1bGx5LicpOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgICAgICd1cmwnID0+IChpc3NldCgkcHJvcG9zYWwtPnJlbFF1b3RhdGlvbnNbMF0tPnR5cGUpICYmICRwcm9wb3NhbC0+cmVsUXVvdGF0aW9uc1swXS0+dHlwZSA9PSAnZGlyZWN0LXB1cmNoYXNlJyA/IHJvdXRlKCdwbXMucXVvdGF0aW9uLnF1b3RhdGlvbnMuZXN0aW1hdGUucmVqZWN0Lmxpc3QnKSA6IHJvdXRlKCdwbXMucXVvdGF0aW9uLmFwcHJvdmFsLmxpc3QnKSkKICAgICAgICAgICAgXSk7CiAgICAgICAgfWNhdGNoIChUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKFsKICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkdGgtPmdldE1lc3NhZ2UoKQogICAgICAgICAgICBdKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCgogICAgcHVibGljIGZ1bmN0aW9uIHJlamVjdEFsbCgkaWQpCiAgICB7ICAKCiAgICAgICAgJHR5cGUgPSAocmVxdWVzdCgpLT5oYXMoJ3R5cGUnKSk/cmVxdWVzdCgpLT5nZXQoJ3R5cGUnKTonJzsKCiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICB0cnkgewoKICAgICAgICAgICAgJHF1b3RhdGlvbiA9IFF1b3RhdGlvbnM6OndoZXJlKCdyZXF1ZXN0X3Byb3Bvc2FsX2lkJywkaWQpCiAgICAgICAgICAgIC0+d2hlcmUoJ2lzX3BvX2dlbmVyYXRlJywnbm8nKQogICAgICAgICAgICAtPndoZXJlTm90SW4oJ2lzX2FwcHJvdmVkJyxbJ3BlbmRpbmcnXSkKICAgICAgICAgICAgLT53aGVuKCR0eXBlID09ICdkaXJlY3QtcHVyY2hhc2UnLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3R5cGUnLCdkaXJlY3QtcHVyY2hhc2UnKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVuKCR0eXBlICE9ICdkaXJlY3QtcHVyY2hhc2UnLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVOb3RJbigndHlwZScsWydkaXJlY3QtcHVyY2hhc2UnXSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+dXBkYXRlKFsKICAgICAgICAgICAgICAgICdpc19hcHByb3ZlZCc9PidoYWx0JwogICAgICAgICAgICBdKTsKCgogICAgICAgICAgICAkcHJvcG9zYWwgPSBSZXF1ZXN0UHJvcG9zYWw6OmZpbmRPckZhaWwoJGlkKTsKCiAgICAgICAgICAgICRtZXNzYWdlID0gJzxzcGFuIGNsYXNzPSJub3RpZmljYXRpb24tbGlua3MiIGRhdGEtc3JjPSInLnVybCgncG1zL3F1b3RhdGlvbi9jcy1jb21wYXJlLXZpZXctbm90aWZpY2F0aW9uLycuJGlkKS4nIiBkYXRhLXRpdGxlPSJRdW90YXRpb24gQ1MiPlJlZmVyZW5jZSBObzonLiRwcm9wb3NhbC0+cmVmZXJlbmNlX25vLicuIFJlamVjdGVkIEFsbCBCeSBNYW5hZ2VtZW50Ljwvc3Bhbj4nOwogICAgICAgICAgICAKICAgICAgICAgICAgQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oJycsZ2V0TWFuYWdlckluZm8oJ1B1cmNoYXNlLURlcGFydG1lbnQnKSwkbWVzc2FnZSwndW5yZWFkJywnc2VudC10by1wdXJjaGFzZScsJycpOwoKICAgICAgICAgICAgREI6OmNvbW1pdCgpOwoKICAgICAgICAgICAgaWYgKCR0eXBlID09ICdkaXJlY3QtcHVyY2hhc2UnKSB7CiAgICAgICAgICAgICByZXR1cm4gJHRoaXMtPnJlZGlyZWN0QmFja1dpdGhTdWNjZXNzKCdTdWNjZXNzZnVsbHkgUmVqZWN0ZWQhIScsJ3Btcy5xdW90YXRpb24ucXVvdGF0aW9ucy5lc3RpbWF0ZS5yZWplY3QubGlzdCcpOwogICAgICAgICB9CgogICAgICAgICByZXR1cm4gJHRoaXMtPnJlZGlyZWN0QmFja1dpdGhTdWNjZXNzKCdTdWNjZXNzZnVsbHkgUmVqZWN0ZWQhIScsJ3Btcy5xdW90YXRpb24ucXVvdGF0aW9ucy5yZWplY3QubGlzdCcpOwoKICAgICB9Y2F0Y2ggKFRocm93YWJsZSAkdGgpewogICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICB9Cn0gICAKCiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiBkaXJlY3RQdXJjaGFzZVN0b3JlKCRxdW90YXRpb24pCiAgICB7ICAgCiAgICAgICAgJHJlcXVpc2l0aW9uID0gaXNzZXQoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvblswXSk/JHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvblswXS0+cmVsUmVxdWlzaXRpb246ZmFsc2U7CgogICAgICAgIGlmKCRyZXF1aXNpdGlvbil7CgogICAgICAgICAgICAkcHJlZml4ID0gJ0lKTy0nLmRhdGUoJ3knLCBzdHJ0b3RpbWUoZGF0ZSgnWS1tLWQnKSkpLictJy51bml0TmFtZSgkcmVxdWlzaXRpb24tPmhyX3VuaXRfaWQpLT5ocl91bml0X3Nob3J0X25hbWUuJy0nOwogICAgICAgICAgICAkcmVmTm8gPSB1bmlxdWVDb2RlKDE3LCRwcmVmaXgsJ3B1cmNoYXNlX29yZGVycycsJ2lkJyk7CgogICAgICAgICAgICAkcG9fZGF0YSA9IG5ldyBQdXJjaGFzZU9yZGVyKCk7CiAgICAgICAgICAgICRwb19kYXRhLT5xdW90YXRpb25faWQgPSAkcXVvdGF0aW9uLT5pZDsKICAgICAgICAgICAgJHBvX2RhdGEtPmhyX3VuaXRfaWQgPSAkcmVxdWlzaXRpb24tPmhyX3VuaXRfaWQ7CiAgICAgICAgICAgICRwb19kYXRhLT5yZWZlcmVuY2Vfbm8gPSAkcmVmTm87CiAgICAgICAgICAgICRwb19kYXRhLT5wb19kYXRlID0gZGF0ZSgnWS1tLWQgaDppOnMnKTsKICAgICAgICAgICAgJHBvX2RhdGEtPnJlbWFya3MgPSAkcXVvdGF0aW9uLT5yZW1hcmtzOwogICAgICAgICAgICAkcG9fZGF0YS0+c2F2ZSgpOwoKICAgICAgICAgICAgJHBvU3ViVG90YWwgPSAwOwogICAgICAgICAgICAkcG9WYXQgPSAwOwogICAgICAgICAgICAkcG9Hcm9zc1RvdGFsID0gMDsKCiAgICAgICAgICAgICRjb2xsZWN0UHJvZHVjdElkID0gW107CiAgICAgICAgICAgIGlmKCRxdW90YXRpb24tPnJlbFF1b3RhdGlvbkl0ZW1zLT53aGVyZSgnaXNfYXBwcm92ZWQnLCAnYXBwcm92ZWQnKS0+Y291bnQoKSA+IDApewogICAgICAgICAgICAgICAgZm9yZWFjaCgkcXVvdGF0aW9uLT5yZWxRdW90YXRpb25JdGVtcy0+d2hlcmUoJ2lzX2FwcHJvdmVkJywgJ2FwcHJvdmVkJykgYXMgJGtleSA9PiAkdmFsdWVzKXsKICAgICAgICAgICAgICAgICAgICAkZGlzY291bnQgPSAoJHZhbHVlcy0+ZGlzY291bnQgPiAwID8gJHZhbHVlcy0+dW5pdF9wcmljZSooJHZhbHVlcy0+ZGlzY291bnQvMTAwKSA6IDApOwogICAgICAgICAgICAgICAgICAgICR1bml0X3ByaWNlID0gc3lzdGVtRG91YmxlVmFsdWUoJHZhbHVlcy0+dW5pdF9wcmljZS0kZGlzY291bnQpOwoKICAgICAgICAgICAgICAgICAgICAkcG9RdHkgPSAkdmFsdWVzLT5xdHk7CiAgICAgICAgICAgICAgICAgICAgJHN1YlRvdGFsID0gJHVuaXRfcHJpY2UqJHBvUXR5OwogICAgICAgICAgICAgICAgICAgICRwb1N1YlRvdGFsICs9ICRzdWJUb3RhbDsKCiAgICAgICAgICAgICAgICAgICAgJHZhdEFtb3VudCA9IHN5c3RlbURvdWJsZVZhbHVlKCR2YWx1ZXMtPnZhdF9wZXJjZW50YWdlID4gMCA/ICRzdWJUb3RhbCooJHZhbHVlcy0+dmF0X3BlcmNlbnRhZ2UvMTAwKSA6IDApOwogICAgICAgICAgICAgICAgICAgICRwb1ZhdCArPSAkdmF0QW1vdW50OwoKICAgICAgICAgICAgICAgICAgICAkZ3Jvc3NUb3RhbCA9IHN5c3RlbURvdWJsZVZhbHVlKCRzdWJUb3RhbCskdmF0QW1vdW50KTsKICAgICAgICAgICAgICAgICAgICAkcG9Hcm9zc1RvdGFsICs9ICRncm9zc1RvdGFsOwoKICAgICAgICAgICAgICAgICAgICAkcG9faXRlbXMgPSBuZXcgUHVyY2hhc2VPcmRlckl0ZW0oKTsKICAgICAgICAgICAgICAgICAgICAkcG9faXRlbXMtPnBvX2lkID0gJHBvX2RhdGEtPmlkOyAKICAgICAgICAgICAgICAgICAgICAkcG9faXRlbXMtPnByb2R1Y3RfaWQgPSAkdmFsdWVzLT5wcm9kdWN0X2lkOyAKICAgICAgICAgICAgICAgICAgICAkcG9faXRlbXMtPnVuaXRfcHJpY2UgPSAkdW5pdF9wcmljZTsgCiAgICAgICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT5xdHkgPSAkcG9RdHk7CiAgICAgICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT5zdWJfdG90YWxfcHJpY2UgPSAkc3ViVG90YWw7CiAgICAgICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT5kaXNjb3VudF9wZXJjZW50YWdlID0gMDsKICAgICAgICAgICAgICAgICAgICAkcG9faXRlbXMtPmRpc2NvdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICAkcG9faXRlbXMtPnZhdF9wZXJjZW50YWdlID0gJHZhbHVlcy0+dmF0X3BlcmNlbnRhZ2U7CiAgICAgICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT52YXQgPSAkdmF0QW1vdW50OwogICAgICAgICAgICAgICAgICAgICRwb19pdGVtcy0+dG90YWxfcHJpY2UgPSAkZ3Jvc3NUb3RhbDsKICAgICAgICAgICAgICAgICAgICAkcG9faXRlbXMtPnNhdmUoKTsKCiAgICAgICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkY29sbGVjdFByb2R1Y3RJZCwkdmFsdWVzLT5wcm9kdWN0X2lkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9VcGRhdGUgUHVyY2Foc2UgT3JkZXIKICAgICAgICAgICAgJHBvX2RhdGEtPnVwZGF0ZShbCiAgICAgICAgICAgICAgICAndG90YWxfcHJpY2UnID0+ICRwb1N1YlRvdGFsLAogICAgICAgICAgICAgICAgJ2Rpc2NvdW50JyA9PiAwLAogICAgICAgICAgICAgICAgJ3ZhdCcgPT4gJHBvVmF0LAogICAgICAgICAgICAgICAgJ2dyb3NzX3ByaWNlJyA9PiAkcG9Hcm9zc1RvdGFsLAogICAgICAgICAgICBdKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIGlmKCRxdW90YXRpb24tPnJlbFN1cHBsaWVyUGF5bWVudFRlcm0tPnR5cGUgPT0gJ3BhaWQnKXsKICAgICAgICAgICAgICAgIC8vQWRkIFN1cHBsaWVyIFB5YW1lbnRzCiAgICAgICAgICAgICAgICAkcGF5X2Ftb3VudCA9ICgkcXVvdGF0aW9uLT5yZWxTdXBwbGllclBheW1lbnRUZXJtLT5wYXltZW50X3BlcmNlbnQgPiAwID8gKCRwb0dyb3NzVG90YWwqKCRxdW90YXRpb24tPnJlbFN1cHBsaWVyUGF5bWVudFRlcm0tPnBheW1lbnRfcGVyY2VudC8xMDApKSA6IDApOwogICAgICAgICAgICAgICAgaWYoJHBheV9hbW91bnQgPiAwKXsKICAgICAgICAgICAgICAgICAgICAkZHVyYXRpb25fZGF0ZSA9ICRxdW90YXRpb24tPnJlbFN1cHBsaWVyUGF5bWVudFRlcm0tPmRheV9kdXJhdGlvbjsKICAgICAgICAgICAgICAgICAgICAkcGF5X2RhdGU9ZGF0ZSgnWS1tLWQgaDppOnMnLCBzdHJ0b3RpbWUoJysnLiRkdXJhdGlvbl9kYXRlLicgZGF5Jywgc3RydG90aW1lKCRwb19kYXRhLT5wb19kYXRlKSkpOwogICAgICAgICAgICAgICAgICAgIC8vUGF5bWVudCBkYXRlIGJhc2VkIG9uIGFkdmFuY2UgJiBkdWUKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudCA9IG5ldyBTdXBwbGllclBheW1lbnQoKTsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudC0+c3VwcGxpZXJfaWQgPSAkcXVvdGF0aW9uLT5zdXBwbGllcl9pZDsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudC0+cHVyY2hhc2Vfb3JkZXJfaWQgPSAkcG9fZGF0YS0+aWQ7CiAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVyX3BheW1lbnQtPnRyYW5zZWN0aW9uX2RhdGUgPSBkYXRlKCdZLW0tZCBoOmk6cycpOwogICAgICAgICAgICAgICAgICAgICRzdXBwbGllcl9wYXltZW50LT50cmFuc2VjdGlvbl90eXBlID0gJ3B1cmNoYXNlJzsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudC0+ZXhjaGFuZ2VfcmF0ZV9pZCA9ICRxdW90YXRpb24tPmV4Y2hhbmdlX3JhdGVfaWQ7CiAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVyX3BheW1lbnQtPmJpbGxfbnVtYmVyID0gJHBvX2RhdGEtPnJlZmVyZW5jZV9ubzsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudC0+cGF5X2Ftb3VudCA9ICRwYXlfYW1vdW50OwogICAgICAgICAgICAgICAgICAgICRzdXBwbGllcl9wYXltZW50LT5wYXlfZGF0ZSA9ICRwYXlfZGF0ZTsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudC0+YmlsbF90eXBlID0gJ3BvLWFkdmFuY2UnOwogICAgICAgICAgICAgICAgICAgICRzdXBwbGllcl9wYXltZW50LT5zYXZlKCk7CgogICAgICAgICAgICAgICAgICAgIC8vTm90aWZpY2F0aW9uIHNlbmQgdG8gYWNjb3VudHMKICAgICAgICAgICAgICAgICAgICAkbWVzc2FnZSA9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiAgZGF0YS10aXRsZT0iUHVyY2hhc2UgT3JkZXIgRGV0YWlscyI+UmVmZXJlbmNlIE5vOicuJHBvX2RhdGEtPnJlZmVyZW5jZV9uby4nLiBBIFBPIGhhcyBiZWVuIHN1Ym1pdHRlZCB3aXRoIGFuIGFkdmFuY2UgYW1vdW50IG9mIFRLICcuJHN1cHBsaWVyX3BheW1lbnQtPnBheV9hbW91bnQuJzwvc3Bhbj4nOwoKICAgICAgICAgICAgICAgICAgICBDcmVhdGVPclVwZGF0ZU5vdGlmaWNhdGlvbignJyxnZXRNYW5hZ2VySW5mbygnQWNjb3VudHMnKSwkbWVzc2FnZSwndW5yZWFkJywnc2VuZC10by1hY2NvdW50cycsJycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICAvL1VwZGF0ZSByZXF1aXNpdGlvbgogICAgICAgICAgICAkcmVxdWlzaXRpb24tPml0ZW1zKCktPndoZXJlSW4oJ3Byb2R1Y3RfaWQnLCAkY29sbGVjdFByb2R1Y3RJZCktPndoZXJlKCdpc19zZW5kJywneWVzJykKICAgICAgICAgICAgLT53aGVyZSgncG9fZ2VuZXJhdGUnLCdubycpCiAgICAgICAgICAgIC0+dXBkYXRlKFsncG9fZ2VuZXJhdGUnPT4neWVzJ10pOwogICAgICAgICAgICAvL3VwZGF0ZSBxdW90YXRpb24KICAgICAgICAgICAgJHF1b3RhdGlvbi0+dXBkYXRlKFsnaXNfcG9fZ2VuZXJhdGUnPT4neWVzJ10pOwoKICAgICAgICAgICAgJHVuY29tbW9uID0gQ2F0ZWdvcnk6OmRvZXNudEhhdmUoJ2NhdGVnb3J5JyktPndoZXJlKCd0eXBlJywgJ3VuY29tbW9uJykKICAgICAgICAgICAgLT53aGVyZUhhcygnc3ViQ2F0ZWdvcnkucHJvZHVjdHMnLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkcmVxdWlzaXRpb24pewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lkJywgJHJlcXVpc2l0aW9uLT5pdGVtcy0+cGx1Y2soJ3Byb2R1Y3RfaWQnKS0+dG9BcnJheSgpKTsKICAgICAgICAgICAgfSktPmNvdW50KCk7CgogICAgICAgICAgICBQdXJjaGFzZU9yZGVyUmVxdWlzaXRpb246OnVwZGF0ZU9yQ3JlYXRlKFsKICAgICAgICAgICAgICAgICdwdXJjaGFzZV9vcmRlcl9pZCcgPT4gJHBvX2RhdGEtPmlkLAogICAgICAgICAgICAgICAgJ3JlcXVpc2l0aW9uX2lkJyA9PiAkcmVxdWlzaXRpb24tPmlkLAogICAgICAgICAgICBdLFsKICAgICAgICAgICAgICAgICdocl9kZXBhcnRtZW50X2lkJyA9PiAkdW5jb21tb24gPiAwID8gJHJlcXVpc2l0aW9uLT5yZWxVc2Vyc0xpc3QtPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkIDogMCwKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICAvL1JlcXVpc2l0aW9uIHRyYWNraW5nIHdpdGggcmVxdWlzaXRvbiBpZAogICAgICAgICAgICBSZXF1aXNpdGlvblRyYWNraW5nOjpzdG9yZVJlcXVpc2l0aW9uVHJhY2tpbmcoJHJlcXVpc2l0aW9uLT5pZCwnUE8tSXNzdWUnKTsKICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiAkcG9fZGF0YTsKICAgICAgICB9CgogICAgICAgIHJldHVybiBmYWxzZTsKCiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IHRoZSBzcGVjaWZpZWQgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHBhcmFtICBpbnQgICRpZAogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gdG9nZ2xlUXVvdGF0aW9uU3RhdHVzKFJlcXVlc3QgJHJlcXVlc3QpewogICAgICAgICRxdW90YXRpb24gPSBRdW90YXRpb25zOjp3aGVyZSgnaWQnLCRyZXF1ZXN0LT5pZCktPmZpcnN0KCk7CgogICAgICAgIGlmKGlzc2V0KCRxdW90YXRpb24tPmlkKSl7CiAgICAgICAgICAgICRuZXdTdGF0dXMgPSAkcmVxdWVzdC0+c3RhdHVzOwogICAgICAgICAgICAkbmV3VGV4dCA9ICRuZXdTdGF0dXMgPT0gJ2FwcHJvdmVkJyA/ICdBcHByb3ZlZCcgOiAoKCRuZXdTdGF0dXMgPT0gJ2hhbHQnKT8gJ0hhbHQnIDogJ1BlbmRpbmcnKTsKICAgICAgICAgICAgJHVwZGF0ZSA9ICRxdW90YXRpb24tPnVwZGF0ZShbJ2lzX2FwcHJvdmVkJyA9PiAkbmV3U3RhdHVzLCd1cGRhdGVkX2F0JyA9PiBkYXRlKCdZLW0tZCBIOmk6cycpLCd1cGRhdGVkX2J5JyA9PiBBdXRoOjp1c2VyKCktPmlkXSk7CiAgICAgICAgICAgIGlmKCR1cGRhdGUpewogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiB0cnVlLAogICAgICAgICAgICAgICAgICAgICduZXdfdGV4dCcgPT4gJG5ld1RleHQsCiAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICdEYXRhIGhhcyBiZWVuIHVwZGF0ZWQhJwogICAgICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IGZhbHNlLAogICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICdTb21ldGhpbmcgV2VudCBXcm9uZyEnCiAgICAgICAgICAgIF0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICdEYXRhIG5vdCBmb3VuZCEnCiAgICAgICAgXSk7CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCgogICAgcHVibGljIGZ1bmN0aW9uIGhhbHRTdGF0dXMoUmVxdWVzdCAkcmVxdWVzdCl7CiAgICAgICAgJHF1b3RhdGlvbiA9IFF1b3RhdGlvbnM6OmZpbmRPckZhaWwoJHJlcXVlc3QtPmlkKTsKICAgICAgICB0cnl7CiAgICAgICAgICAgICRxdW90YXRpb24tPnVwZGF0ZShbCiAgICAgICAgICAgICAgICAncmVtYXJrcycgPT4gJHJlcXVlc3QtPnJlbWFya3MsCiAgICAgICAgICAgICAgICAnaXNfYXBwcm92ZWQnID0+ICdoYWx0JywKICAgICAgICAgICAgICAgICd1cGRhdGVkX2F0JyA9PiBkYXRlKCdZLW0tZCBIOmk6cycpLAogICAgICAgICAgICAgICAgJ3VwZGF0ZWRfYnknID0+IEF1dGg6OnVzZXIoKS0+aWQKICAgICAgICAgICAgXSk7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhTdWNjZXNzKCdRdW90YXRpb24gU3VjY2Vzc2Z1bGx5IEhhbHQhIScpOwogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewoKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gc2VhcmNoKFJlcXVlc3QgJHJlcXVlc3QpCiAgICB7CiAgICAgICAgJHJlc3BvbnNlID0gW107CgogICAgICAgICRmcm9tX2RhdGU9ZGF0ZSgnWS1tLWQnLHN0cnRvdGltZSgkcmVxdWVzdC0+ZnJvbV9kYXRlKSk7CiAgICAgICAgJHRvX2RhdGU9ZGF0ZSgnWS1tLWQnLHN0cnRvdGltZSgkcmVxdWVzdC0+dG9fZGF0ZSkpOwoKICAgICAgICAkaXNfYXBwcm92ZWQ9JHJlcXVlc3QtPmlzX2FwcHJvdmVkOwogICAgICAgICRpc19wb19nZW5lcmF0ZT0kcmVxdWVzdC0+aXNfcG9fZ2VuZXJhdGU7CgogICAgICAgICRkYXRhcyA9IFF1b3RhdGlvbnM6OndoZXJlRGF0ZSgncXVvdGF0aW9uX2RhdGUnLCAnPj0nLCAkZnJvbV9kYXRlKQogICAgICAgIC0+d2hlcmVEYXRlKCdxdW90YXRpb25fZGF0ZScsICc8PScsICR0b19kYXRlKQogICAgICAgIC0+d2hlbigkaXNfYXBwcm92ZWQsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRpc19hcHByb3ZlZCl7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdpc19hcHByb3ZlZCcsJGlzX2FwcHJvdmVkKTsKICAgICAgICB9KQogICAgICAgIC0+d2hlbigkaXNfcG9fZ2VuZXJhdGUsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRpc19wb19nZW5lcmF0ZSl7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdpc19wb19nZW5lcmF0ZScsJGlzX3BvX2dlbmVyYXRlKTsKICAgICAgICB9KQogICAgICAgIC0+d2hlcmUoJ3N0YXR1cycsJ2FjdGl2ZScpCiAgICAgICAgLT53aGVyZSgndHlwZScsJyE9JywnZGlyZWN0LXB1cmNoYXNlJykKICAgICAgICAtPm9yZGVyQnkoJ2lkJywnZGVzYycpCiAgICAgICAgLT5wYWdpbmF0ZSgxMDApOwoKICAgICAgICAkcXVvdGF0aW9uTGlzdCA9IFtdOwogICAgICAgIGZvcmVhY2ggKCRkYXRhcyBhcyAkZGF0YSl7CiAgICAgICAgICAgIGZvcmVhY2ggKEF1dGg6OnVzZXIoKS0+cmVsQXBwcm92YWxSYW5nZSBhcyAkcmFuZ2UpewogICAgICAgICAgICAgICAgaWYgKCRyYW5nZS0+bWluX2Ftb3VudCA8PSAkZGF0YS0+cmVsUXVvdGF0aW9uSXRlbXMtPnN1bSgndG90YWxfcHJpY2UnKSAmJiAkcmFuZ2UtPm1heF9hbW91bnQgPj0gJGRhdGEtPnJlbFF1b3RhdGlvbkl0ZW1zLT5zdW0oJ3RvdGFsX3ByaWNlJykpewogICAgICAgICAgICAgICAgICAgICRxdW90YXRpb25MaXN0W10gPSAkZGF0YTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAkcXVvdGF0aW9uTGlzdCA9ICR0aGlzLT5wYWdpbmF0ZSgkcXVvdGF0aW9uTGlzdCwgMTAwKTsKCiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaWYoY291bnQoJHF1b3RhdGlvbkxpc3QpPjApCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICRib2R5ID0gXElsbHVtaW5hdGVcU3VwcG9ydFxGYWNhZGVzXFZpZXc6Om1ha2UoJ3Btcy5iYWNrZW5kLnBhZ2VzLnF1b3RhdGlvbi5fcXVvdGF0aW9uLWxpc3Qtc2VhcmNoJywKICAgICAgICAgICAgICAgICAgICBbJ3F1b3RhdGlvbkxpc3QnPT4gJHF1b3RhdGlvbkxpc3RdKTsKICAgICAgICAgICAgICAgICRjb250ZW50cyA9ICRib2R5LT5yZW5kZXIoKTsKCiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ3N1Y2Nlc3MnOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydib2R5J10gPSAkY29udGVudHM7CiAgICAgICAgICAgIH1lbHNlewoKICAgICAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnZXJyb3InOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAnRGF0YSBub3QgZm91bmQuISEnOwogICAgICAgICAgICB9CgogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICRyZXNwb25zZTsKICAgIH0KCiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiBncExpc3RIZWFkZXJDb2x1bW5zKCR2YWx1ZT0nJykKICAgIHsKICAgICAgICByZXR1cm4gYXJyYXkoCiAgICAgICAgICAgIFsnU0wnLCAnU0wnXSwgCiAgICAgICAgICAgIFsnZGF0ZScsICdxdW90YXRpb25fZGF0ZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ2RlbGl2ZXJ5X2RhdGUnLCAnZGVsaXZlcnlfZGF0ZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3JlcXVlc3RfcHJvcG9zYWwnLCAncmVxdWVzdF9wcm9wb3NhbCcsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3JlcXVpc2l0aW9ucycsICdyZXF1aXNpdGlvbnMnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydwcm9kdWN0cycsICdwcm9kdWN0cycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3JlZmVyZW5jZV9ubycsICdyZWZlcmVuY2Vfbm8nXSwKICAgICAgICAgICAgWydzdXBwbGllcicsICdzdXBwbGllcicsICd0ZXh0LWxlZnQnXSwKICAgICAgICAgICAgWydhY3Rpb25zJywgJ2FjdGlvbnMnLCAndGV4dC1jZW50ZXIgYWN0aW9uJ10KICAgICAgICApOwogICAgfQoKICAgIC8qKgogICAgICogRGlzcGxheSBhIGxpc3Rpbmcgb2YgdGhlIHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIGdlbmVyYXRlUG9MaXN0KCkKICAgIHsKICAgICAgICAkdGl0bGUgPSAnUXVvdGF0aW9ucyBBcHByb3ZlZCBMaXN0JzsKCiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgICRxdW90YXRpb25MaXN0ID0gUXVvdGF0aW9uczo6d2l0aChbCiAgICAgICAgICAgICAgICAncmVsUmVxdWVzdFByb3Bvc2FsJywKICAgICAgICAgICAgICAgICdyZWxTdXBwbGllcnMnLAogICAgICAgICAgICAgICAgJ3JlbFNlbGZRdW90YXRpb25TdXBwbGllckJ5UHJvcG9zYWxJZC5yZWxTdXBwbGllcnMnLAogICAgICAgICAgICAgICAgJ2V4Y2hhbmdlUmF0ZS5jdXJyZW5jeScKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZShbCiAgICAgICAgICAgICAgICAnc3RhdHVzJyA9PiAnYWN0aXZlJywKICAgICAgICAgICAgICAgICdpc19hcHByb3ZlZCcgPT4gJ2FwcHJvdmVkJywKICAgICAgICAgICAgICAgICdpc19wb19nZW5lcmF0ZScgPT4gJ25vJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlTm90SW4oJ3R5cGUnLFsnZGlyZWN0LXB1cmNoYXNlJ10pCiAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICAkb3B0aW9ucyA9IFsKICAgICAgICAgICAgICAgICdxdW90YXRpb24taGFsdCcgPT4gYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25UbygncXVvdGF0aW9uLWhhbHQnKSwKICAgICAgICAgICAgICAgICdnZW5lcmF0ZS1wbycgPT4gYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25UbygnZ2VuZXJhdGUtcG8nKQogICAgICAgICAgICBdOwoKICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+YWpheCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gRGF0YVRhYmxlczo6b2YoJHF1b3RhdGlvbkxpc3QpCiAgICAgICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdkYXRlJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGUoJ1ktbS1kJywgc3RydG90aW1lKCR2YWx1ZXMtPnF1b3RhdGlvbl9kYXRlKSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdxdW90YXRpb25fZGF0ZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ3F1b3RhdGlvbl9kYXRlJywgJG9yZGVyKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignZGVsaXZlcnlfZGF0ZScsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhZW1wdHkoJHZhbHVlcy0+ZGVsaXZlcnlfZGF0ZSkgPyBkYXRlKCdZLW0tZCcsc3RydG90aW1lKCR2YWx1ZXMtPmRlbGl2ZXJ5X2RhdGUpKTonJzsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignZGVsaXZlcnlfZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2RlbGl2ZXJ5X2RhdGUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ2RlbGl2ZXJ5X2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlckJ5KCdkZWxpdmVyeV9kYXRlJywgJG9yZGVyKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmVxdWVzdF9wcm9wb3NhbCcsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAnPGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBjbGFzcz0iYnRuIGJ0bi1saW5rIiBvbmNsaWNrPSJyZXF1ZXN0UHJvcG9zYWxEZXRhaWxzKCcuJHZhbHVlcy0+cmVsUmVxdWVzdFByb3Bvc2FsLT5pZC4nKSI+Jy4oaXNzZXQoJHZhbHVlcy0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZWZlcmVuY2Vfbm8pPyR2YWx1ZXMtPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVmZXJlbmNlX25vOicnKS4nPC9hPic7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWwnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdyZXF1ZXN0X3Byb3Bvc2FsJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWVzdFByb3Bvc2FsOjpzZWxlY3QoJ3JlcXVlc3RfcHJvcG9zYWxzLnJlZmVyZW5jZV9ubycpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJywgJ3F1b3RhdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1aXNpdGlvbnMnLCBmdW5jdGlvbigkcXVvdGF0aW9uKXsKICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25zID0gJyc7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYoJHF1b3RhdGlvbi0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi0+Y291bnQoKSA+IDApewogICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24gYXMgJGtleSA9PiAkcmVxdWlzaXRpb24pewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9ucyAuPSAoJGtleSA+IDAgPyAnLCAnIDogJycpLic8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGRhdGEtc3JjPSInLnJvdXRlKCdwbXMucmVxdWlzaXRpb24ubGlzdC52aWV3LnNob3cnLCRyZXF1aXNpdGlvbi0+cmVsUmVxdWlzaXRpb24tPmlkKS4nIiBjbGFzcz0idGV4dC1wcmltYXJ5IHJlcXVpc2l0aW9uIG0tMSByb3VuZGVkIHNob3dSZXF1aXN0aW9uRGV0YWlscyIgb25jbGljaz0icmVxdWlzdGlvbkRldGFpbHMoJCh0aGlzKSkiPicuICRyZXF1aXNpdGlvbi0+cmVsUmVxdWlzaXRpb24tPnJlZmVyZW5jZV9ubyAuJzwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHJlcXVpc2l0aW9uczsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncmVxdWlzaXRpb25zJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24ucmVsUmVxdWlzaXRpb24nLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgka2V5d29yZCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3JlcXVpc2l0aW9ucycsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFJlcXVlc3RQcm9wb3NhbDo6c2VsZWN0KCdyZXF1aXNpdGlvbnMucmVmZXJlbmNlX25vJykKICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdyZXF1aXNpdGlvbnMnLCAncmVxdWlzaXRpb25zLmlkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbF9yZXF1aXNpdGlvbnMucmVxdWlzaXRpb25faWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zJywgJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnLCAnPScsICdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJywgJ3F1b3RhdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0cycsIGZ1bmN0aW9uKCRxdW90YXRpb24pewogICAgICAgICAgICAgICAgICAgICRwcm9kdWN0cyA9ICcnOwogICAgICAgICAgICAgICAgICAgIGlmKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsRGV0YWlscy0+Y291bnQoKSA+IDApewogICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoKCRxdW90YXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbC0+cmVxdWVzdFByb3Bvc2FsRGV0YWlscyBhcyAka2V5ID0+ICRwcm9kdWN0KXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRwcm9kdWN0cyAuPSAoJGtleSA+IDAgPyAnLCAnIDogJycpLiRwcm9kdWN0LT5wcm9kdWN0LT5uYW1lLicgJy5nZXRQcm9kdWN0QXR0cmlidXRlc0Zhc3RlcigkcHJvZHVjdC0+cHJvZHVjdCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcHJvZHVjdHM7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3Byb2R1Y3RzJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZShmdW5jdGlvbigkcXVlcnkpIHVzZSgka2V5d29yZCl7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRrZXl3b3JkKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAgJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdCcsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRrZXl3b3JkKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZShmdW5jdGlvbigkcXVlcnkpIHVzZSgka2V5d29yZCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbicsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC0+b3JXaGVyZUhhcygncmVsUmVxdWVzdFByb3Bvc2FsLnJlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdC5hdHRyaWJ1dGVzLmF0dHJpYnV0ZU9wdGlvbi5hdHRyaWJ1dGUnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncHJvZHVjdHMnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBSZXF1ZXN0UHJvcG9zYWw6OnNlbGVjdCgncHJvZHVjdHMubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncHJvZHVjdHMnLCAncHJvZHVjdHMuaWQnLCAnPScsICdyZXF1ZXN0X3Byb3Bvc2FsX2RldGFpbHMucHJvZHVjdF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncmVxdWVzdF9wcm9wb3NhbF9kZXRhaWxzJywgJ3JlcXVlc3RfcHJvcG9zYWxfZGV0YWlscy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJywgJz0nLCAncmVxdWVzdF9wcm9wb3NhbHMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zJywgJ3JlcXVlc3RfcHJvcG9zYWxfcmVxdWlzaXRpb25zLnJlcXVlc3RfcHJvcG9zYWxfaWQnLCAnPScsICdyZXF1ZXN0X3Byb3Bvc2Fscy5pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWxzLmlkJywgJ3F1b3RhdGlvbnMucmVxdWVzdF9wcm9wb3NhbF9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbigkdmFsdWVzKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgb25jbGljaz0ib3Blbk1vZGFsKCcuJHZhbHVlcy0+aWQuJykiICBjbGFzcz0iYnRuIGJ0bi1saW5rIj4nLiR2YWx1ZXMtPnJlZmVyZW5jZV9uby4nPC9hPic7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3JlZmVyZW5jZV9ubycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3JlZmVyZW5jZV9ubycsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3N1cHBsaWVyJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIGJ0bi14cyBtci0xICcuKCR2YWx1ZXMtPmlzX2FwcHJvdmVkPT0naGFsdCc/JyBidG4td2FybmluZyc6J2J0bi1zdWNjZXNzJykuJyI+Jy4kdmFsdWVzLT5yZWxTdXBwbGllcnMtPm5hbWUuJyAoJy4kdmFsdWVzLT5yZWxTdXBwbGllcnMtPmNvZGUuJyk8L2J1dHRvbj4nOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdzdXBwbGllcicsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFN1cHBsaWVycycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKS0+b3JXaGVyZSgnY29kZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignc3VwcGxpZXInLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBTdXBwbGllcnM6OnNlbGVjdCgnc3VwcGxpZXJzLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdzdXBwbGllcnMuaWQnLCAncXVvdGF0aW9ucy5zdXBwbGllcl9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FjdGlvbnMnLCBmdW5jdGlvbigkdmFsdWVzKSB1c2UoJG9wdGlvbnMpewogICAgICAgICAgICAgICAgICAgICRhY3Rpb25zID0gJyc7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMuPSc8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPjxidXR0b24gY2xhc3M9ImJ0biBkcm9wZG93bi10b2dnbGUiIGRhdGEtdG9nZ2xlPSJkcm9wZG93biI+PHNwYW4gaWQ9InN0YXR1c05hbWUnLiR2YWx1ZXMtPmlkLiciPicudWNmaXJzdCgkdmFsdWVzLT5pc19hcHByb3ZlZCkuJzwvc3Bhbj48L2J1dHRvbj48dWwgY2xhc3M9ImRyb3Bkb3duLW1lbnUiPic7CgogICAgICAgICAgICAgICAgICAgICRhY3Rpb25zLj0nPGxpPjxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgb25jbGljaz0ib3Blbk1vZGFsKCcuJHZhbHVlcy0+aWQuJykiPlNob3c8L2E+PC9saT4nOwoKICAgICAgICAgICAgICAgICAgICBpZiAoJHZhbHVlcy0+aXNfYXBwcm92ZWQgPT09ICdhcHByb3ZlZCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCRvcHRpb25zWydxdW90YXRpb24taGFsdCddKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucy49JzxsaT48YSBjbGFzcz0icmVxdWlzaXRpb25BcHByb3ZlZEJ0biIgb25jbGljaz0icmVxdWlzaXRpb25BcHByb3ZlZEJ0bigkKHRoaXMpKSIgZGF0YS1pZD0iJy4kdmFsdWVzLT5pZC4nIiBkYXRhLXN0YXR1cz0iaGFsdCI+SGFsdDwvYT48L2xpPic7CiAgICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgIGlmICgkb3B0aW9uc1snZ2VuZXJhdGUtcG8nXSkgewogICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMuPSc8bGk+PGEgaHJlZj0iJy5yb3V0ZSgncG1zLnF1b3RhdGlvbi5nZW5lcmF0ZS5wby5wcm9jZXNzJywkdmFsdWVzLT5pZCkuJyI+R2VuZXJhdGUgUE88L2E+PC9saT4nOwogICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCR2YWx1ZXMtPnJlbFB1cmNoYXNlT3JkZXIpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zLj0nPGxpPjxhIGNsYXNzPSJjb21wbGV0ZVF1b3RhdGlvbiIgb25jbGljaz0iY29tcGxldGVRdW90YXRpb24oJCh0aGlzKSkiIGRhdGEtaWQ9IicuJHZhbHVlcy0+aWQuJyIgZGF0YS1zdGF0dXM9ImNvbXBsZXRlUXVvdGF0aW9uIj5Db21wbGV0ZTwvYT48L2xpPic7CiAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAkYWN0aW9ucy49JzxsaT48YSB0YXJnZXQ9Il9fYmxhbmsiIGhyZWY9IicudXJsKCdwbXMvcXVvdGF0aW9uL2NzLWNvbXBhcmUtdmlldy1wZGYvJy4kdmFsdWVzLT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKS4nIiBkYXRhLXRpdGxlPSJRdW90YXRpb24gQ1MiPkNTIFZpZXc8L2E+PC9saT4nOwoKICAgICAgICAgICAgICAgICAkYWN0aW9ucy49JzxsaT48YSB0YXJnZXQ9Il9fYmxhbmsiIGhyZWY9Iicucm91dGUoJ3Btcy5xdW90YXRpb24uY3MuaGlzdG9yeScsJHZhbHVlcy0+cmVxdWVzdF9wcm9wb3NhbF9pZCkuJyIgZGF0YS10aXRsZT0iUXVvdGF0aW9uIENTIj5DUyBIaXN0b3J5PC9hPjwvbGk+JzsKCiAgICAgICAgICAgICAgICAgJGFjdGlvbnMuPSc8L3VsPjwvZGl2Pic7CgogICAgICAgICAgICAgICAgIHJldHVybiAkYWN0aW9uczsKICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydyZXF1ZXN0X3Byb3Bvc2FsJywgJ3JlcXVpc2l0aW9ucycsICdzdXBwbGllcicsICdyZWZlcmVuY2Vfbm8nLCAnYWN0aW9ucyddKQogICAgICAgICAgICAgICAgLT5tYWtlKHRydWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucXVvdGF0aW9uLmdlbmVyYXRlLXBvLWxpc3QnLCBbJ3RpdGxlJz0+JHRpdGxlLCdoZWFkZXJDb2x1bW5zJz0+JHRoaXMtPmdwTGlzdEhlYWRlckNvbHVtbnMoKV0pOwoKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gcXVvdGF0aW9uUmVqZWN0TGlzdCgpCiAgICB7CiAgICAgICAgJHRpdGxlID0gJ1F1b3RhdGlvbnMgUmVqZWN0ZWQgTGlzdCc7CgogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkcXVvdGF0aW9uTGlzdCA9IFF1b3RhdGlvbnM6OndpdGgoWwogICAgICAgICAgICAgICAgJ3JlbFJlcXVlc3RQcm9wb3NhbCcsCiAgICAgICAgICAgICAgICAncmVsU2VsZlF1b3RhdGlvblN1cHBsaWVyQnlQcm9wb3NhbElkLnJlbFN1cHBsaWVycycsCiAgICAgICAgICAgICAgICAncmVsU3VwcGxpZXJzJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlKFsKICAgICAgICAgICAgICAgICdzdGF0dXMnID0+ICdhY3RpdmUnLCAnaXNfYXBwcm92ZWQnPT4naGFsdCcsICdpc19wb19nZW5lcmF0ZSc9PidubycKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZSgndHlwZScsJyE9JywnZGlyZWN0LXB1cmNoYXNlJykKICAgICAgICAgICAgLT53aGVuKCFkYXRhdGFibGVPcmRlcmluZygpLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJieSgnaWQnLCAnZGVzYycpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPmdyb3VwQnkoJ3JlcXVlc3RfcHJvcG9zYWxfaWQnKTsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgICAgICAgICAgJG9wdGlvbnMgPSBbCiAgICAgICAgICAgICAgICAgICAgJ3F1b3RhdGlvbi1oYWx0JyA9PiBhdXRoKCktPnVzZXIoKS0+aGFzUGVybWlzc2lvblRvKCdxdW90YXRpb24taGFsdCcpCiAgICAgICAgICAgICAgICBdOwoKICAgICAgICAgICAgICAgIHJldHVybiBEYXRhVGFibGVzOjpvZigkcXVvdGF0aW9uTGlzdCkKICAgICAgICAgICAgICAgIC0+YWRkSW5kZXhDb2x1bW4oKQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2RhdGUnLCBmdW5jdGlvbigkdmFsdWVzKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZSgnWS1tLWQnLCBzdHJ0b3RpbWUoJHZhbHVlcy0+cXVvdGF0aW9uX2RhdGUpKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3F1b3RhdGlvbl9kYXRlJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdkYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJCeSgncXVvdGF0aW9uX2RhdGUnLCAkb3JkZXIpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdkZWxpdmVyeV9kYXRlJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICFlbXB0eSgkdmFsdWVzLT5kZWxpdmVyeV9kYXRlKSA/IGRhdGUoJ1ktbS1kJyxzdHJ0b3RpbWUoJHZhbHVlcy0+ZGVsaXZlcnlfZGF0ZSkpOicnOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdkZWxpdmVyeV9kYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnZGVsaXZlcnlfZGF0ZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignZGVsaXZlcnlfZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ2RlbGl2ZXJ5X2RhdGUnLCAkb3JkZXIpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1ZXN0X3Byb3Bvc2FsJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGNsYXNzPSJidG4gYnRuLWxpbmsiIG9uY2xpY2s9InJlcXVlc3RQcm9wb3NhbERldGFpbHMoJy4kdmFsdWVzLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPmlkLicpIj4nLihpc3NldCgkdmFsdWVzLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPnJlZmVyZW5jZV9ubyk/JHZhbHVlcy0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZWZlcmVuY2Vfbm86JycpLic8L2E+JzsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncmVxdWVzdF9wcm9wb3NhbCcsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWwnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBSZXF1ZXN0UHJvcG9zYWw6OnNlbGVjdCgncmVxdWVzdF9wcm9wb3NhbHMucmVmZXJlbmNlX25vJykKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncmVxdWVzdF9wcm9wb3NhbHMuaWQnLCAncXVvdGF0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmVmZXJlbmNlX25vJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIG9uY2xpY2s9Im9wZW5Nb2RhbCgnLiR2YWx1ZXMtPmlkLicpIiAgY2xhc3M9ImJ0biBidG4tbGluayI+Jy4kdmFsdWVzLT5yZWZlcmVuY2Vfbm8uJzwvYT4nOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdzdXBwbGllcicsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgICAgICRkYXRhID0gJyc7CiAgICAgICAgICAgICAgICAgICAgaWYgKCR2YWx1ZXMtPnJlbFNlbGZRdW90YXRpb25TdXBwbGllckJ5UHJvcG9zYWxJZCkgewogICAgICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkdmFsdWVzLT5yZWxTZWxmUXVvdGF0aW9uU3VwcGxpZXJCeVByb3Bvc2FsSWQtPndoZXJlKCdpc19hcHByb3ZlZCcsJ2hhbHQnKSBhcyAkc3VwcGxpZXIpIHsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZGF0YS49JzxidXR0b24gY2xhc3M9ImJ0biBidG4tc20gYnRuLXhzIG1yLTEgJy4oJHN1cHBsaWVyLT5pc19hcHByb3ZlZD09J2hhbHQnPycgYnRuLXdhcm5pbmcnOididG4tc3VjY2VzcycpLiciPicuJHN1cHBsaWVyLT5yZWxTdXBwbGllcnMtPm5hbWUuJyAoJy4kc3VwcGxpZXItPnJlbFN1cHBsaWVycy0+Y29kZS4nKTwvYnV0dG9uPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRkYXRhOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdzdXBwbGllcicsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFN1cHBsaWVycycsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKS0+b3JXaGVyZSgnY29kZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignc3VwcGxpZXInLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBTdXBwbGllcnM6OnNlbGVjdCgnc3VwcGxpZXJzLm5hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdzdXBwbGllcnMuaWQnLCAncXVvdGF0aW9ucy5zdXBwbGllcl9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+dGFrZSgxKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2FjdGlvbnMnLCBmdW5jdGlvbigkdmFsdWVzKSB1c2UoJG9wdGlvbnMpewogICAgICAgICAgICAgICAgICAgICRhY3Rpb25zID0gJyc7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMuPSc8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPjxidXR0b24gY2xhc3M9ImJ0biBkcm9wZG93bi10b2dnbGUiIGRhdGEtdG9nZ2xlPSJkcm9wZG93biI+PHNwYW4gaWQ9InN0YXR1c05hbWUnLiR2YWx1ZXMtPmlkLiciPicudWNmaXJzdCgkdmFsdWVzLT5pc19hcHByb3ZlZCkuJzwvc3Bhbj48L2J1dHRvbj48dWwgY2xhc3M9ImRyb3Bkb3duLW1lbnUiPic7CgogICAgICAgICAgICAgICAgICAgICRhY3Rpb25zLj0nPGxpPjxhIHRhcmdldD0iX19ibGFuayIgaHJlZj0iJy51cmwoJ3Btcy9xdW90YXRpb24vY3MtY29tcGFyZS12aWV3LXBkZi8nLiR2YWx1ZXMtPnJlcXVlc3RfcHJvcG9zYWxfaWQpLiciIGRhdGEtdGl0bGU9IlF1b3RhdGlvbiBDUyI+Q1MgVmlldzwvYT48L2xpPic7CgogICAgICAgICAgICAgICAgICAgICRhY3Rpb25zLj0nPGxpPjxhIHRhcmdldD0iX19ibGFuayIgaHJlZj0iJy5yb3V0ZSgncG1zLnF1b3RhdGlvbi5jcy5oaXN0b3J5JywkdmFsdWVzLT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKS4nIiBkYXRhLXRpdGxlPSJRdW90YXRpb24gQ1MiPkNTIEhpc3Rvcnk8L2E+PC9saT4nOwoKICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucy49JzwvdWw+PC9kaXY+JzsKCiAgICAgICAgICAgICAgICAgICAgaWYgKCRvcHRpb25zWydxdW90YXRpb24taGFsdCddKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zLj0nPGEgaHJlZj0iJy5yb3V0ZSgncG1zLnF1b3RhdGlvbi5xdW90YXRpb25zLmNzLmNvbXBhcmUudmlldycsWydpZCc9PiR2YWx1ZXMtPnJlbFJlcXVlc3RQcm9wb3NhbC0+aWQsJ3NsdWcnPT4nbGlzdCddKS4nP3R5cGU9cmZwIiAgdGl0bGU9IkNvbXBhcmUgUHJvY2VzcyBBbmFseXNpcyIgY2xhc3M9ImJ0biBidG4tc3VjY2VzcyBidG4teHMiPjxpIGNsYXNzPSJsYXMgbGEtbGlzdCI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhY3Rpb25zOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+cmF3Q29sdW1ucyhbJ3JlcXVlc3RfcHJvcG9zYWwnLCdzdXBwbGllcicsJ3JlZmVyZW5jZV9ubycsJ2FjdGlvbnMnXSkKICAgICAgICAgICAgICAgIC0+bWFrZSh0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnF1b3RhdGlvbi5yZWplY3RlZC1saXN0JywgWyd0aXRsZSc9PiR0aXRsZSwnaGVhZGVyQ29sdW1ucyc9PiR0aGlzLT5ncExpc3RIZWFkZXJDb2x1bW5zKCldKTsKCiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIC8qKgogICAgICogRGlzcGxheSBhIGxpc3Rpbmcgb2YgdGhlIHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIGVzdGltYXRlUmVqZWN0TGlzdCgpCiAgICB7CiAgICAgICAgJHRpdGxlID0gJ0VzdGltYXRlIFJlamVjdGVkIExpc3QnOwoKICAgICAgICB0cnkgewogICAgICAgICAgICAkcXVvdGF0aW9uTGlzdCA9IFF1b3RhdGlvbnM6OndpdGgoWwogICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbkl0ZW1zJywKICAgICAgICAgICAgICAgICdyZWxSZXF1ZXN0UHJvcG9zYWwnLAogICAgICAgICAgICAgICAgJ3JlbFN1cHBsaWVycycsCiAgICAgICAgICAgICAgICAnZXhjaGFuZ2VSYXRlLmN1cnJlbmN5JywKICAgICAgICAgICAgICAgICdyZWxTZWxmUXVvdGF0aW9uU3VwcGxpZXJCeVByb3Bvc2FsSWQucmVsU3VwcGxpZXJzJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPndoZXJlKFsKICAgICAgICAgICAgICAgICdzdGF0dXMnPT4nYWN0aXZlJywKICAgICAgICAgICAgICAgICdpc19hcHByb3ZlZCc9PidoYWx0JywKICAgICAgICAgICAgICAgICdpc19wb19nZW5lcmF0ZSc9PidubycKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT53aGVyZSgndHlwZScsJ2RpcmVjdC1wdXJjaGFzZScpCiAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgfSk7CgogICAgICAgICAgICBpZiAocmVxdWVzdCgpLT5hamF4KCkpIHsKICAgICAgICAgICAgICAgICRvcHRpb25zID0gWwogICAgICAgICAgICAgICAgICAgICdxdW90YXRpb24taGFsdCcgPT4gYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25UbygncXVvdGF0aW9uLWhhbHQnKQogICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuIERhdGFUYWJsZXM6Om9mKCRxdW90YXRpb25MaXN0KQogICAgICAgICAgICAgICAgLT5hZGRJbmRleENvbHVtbigpCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignZGF0ZScsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgICAgIHJldHVybiBkYXRlKCdZLW0tZCcsIHN0cnRvdGltZSgkdmFsdWVzLT5xdW90YXRpb25fZGF0ZSkpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdkYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdxdW90YXRpb25fZGF0ZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ3F1b3RhdGlvbl9kYXRlJywgJG9yZGVyKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignZGVsaXZlcnlfZGF0ZScsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAhZW1wdHkoJHZhbHVlcy0+ZGVsaXZlcnlfZGF0ZSkgPyBkYXRlKCdZLW0tZCcsc3RydG90aW1lKCR2YWx1ZXMtPmRlbGl2ZXJ5X2RhdGUpKTonJzsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignZGVsaXZlcnlfZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnZGVsaXZlcnlfZGF0ZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbignZGVsaXZlcnlfZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ2RlbGl2ZXJ5X2RhdGUnLCAkb3JkZXIpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1ZXN0X3Byb3Bvc2FsJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGNsYXNzPSJidG4gYnRuLWxpbmsiIG9uY2xpY2s9InJlcXVlc3RQcm9wb3NhbERldGFpbHMoJy4kdmFsdWVzLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPmlkLicpIj4nLihpc3NldCgkdmFsdWVzLT5yZWxSZXF1ZXN0UHJvcG9zYWwtPnJlZmVyZW5jZV9ubyk/JHZhbHVlcy0+cmVsUmVxdWVzdFByb3Bvc2FsLT5yZWZlcmVuY2Vfbm86JycpLic8L2E+JzsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncmVxdWVzdF9wcm9wb3NhbCcsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVlc3RQcm9wb3NhbCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3JlcXVlc3RfcHJvcG9zYWwnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBSZXF1ZXN0UHJvcG9zYWw6OnNlbGVjdCgncmVxdWVzdF9wcm9wb3NhbHMucmVmZXJlbmNlX25vJykKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncmVxdWVzdF9wcm9wb3NhbHMuaWQnLCAncXVvdGF0aW9ucy5yZXF1ZXN0X3Byb3Bvc2FsX2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncmVmZXJlbmNlX25vJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICc8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIG9uY2xpY2s9Im9wZW5Nb2RhbCgnLiR2YWx1ZXMtPmlkLicpIiAgY2xhc3M9ImJ0biBidG4tbGluayI+Jy4kdmFsdWVzLT5yZWZlcmVuY2Vfbm8uJzwvYT4nOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbigkcXVlcnksICRrZXl3b3JkKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTs7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3N1cHBsaWVyJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgJGRhdGEgPSAnJzsKICAgICAgICAgICAgICAgICAgICBpZiAoJHZhbHVlcy0+cmVsU2VsZlF1b3RhdGlvblN1cHBsaWVyQnlQcm9wb3NhbElkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCR2YWx1ZXMtPnJlbFNlbGZRdW90YXRpb25TdXBwbGllckJ5UHJvcG9zYWxJZC0+d2hlcmUoJ2lzX2FwcHJvdmVkJywnaGFsdCcpIGFzICRzdXBwbGllcikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGRhdGEuPSc8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXNtIGJ0bi14cyBtci0xICcuKCRzdXBwbGllci0+aXNfYXBwcm92ZWQ9PSdoYWx0Jz8nIGJ0bi13YXJuaW5nJzonYnRuLXN1Y2Nlc3MnKS4nIj4nLiRzdXBwbGllci0+cmVsU3VwcGxpZXJzLT5uYW1lLicgKCcuJHN1cHBsaWVyLT5yZWxTdXBwbGllcnMtPmNvZGUuJyk8L2J1dHRvbj4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiAkZGF0YTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbignc3VwcGxpZXInLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxTdXBwbGllcnMnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyktPm9yV2hlcmUoJ2NvZGUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3N1cHBsaWVyJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgU3VwcGxpZXJzOjpzZWxlY3QoJ3N1cHBsaWVycy5uYW1lJykKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbignc3VwcGxpZXJzLmlkJywgJ3F1b3RhdGlvbnMuc3VwcGxpZXJfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24oJHZhbHVlcykgdXNlKCRvcHRpb25zKXsKICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyA9ICcnOwogICAgICAgICAgICAgICAgICAgIGlmICgkdmFsdWVzLT5yZWxTZWxmUXVvdGF0aW9uU3VwcGxpZXJCeVByb3Bvc2FsSWQtPndoZXJlSW4oJ2lzX2FwcHJvdmVkJywgWydhcHByb3ZlZCddKS0+Y291bnQoKSA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zLj0nPGRpdiBjbGFzcz0iYnRuLWdyb3VwIj48YnV0dG9uIGNsYXNzPSJidG4gZHJvcGRvd24tdG9nZ2xlIiBkYXRhLXRvZ2dsZT0iZHJvcGRvd24iPjxzcGFuIGlkPSJzdGF0dXNOYW1lJy4kdmFsdWVzLT5pZC4nIj4nLnVjZmlyc3QoJHZhbHVlcy0+aXNfYXBwcm92ZWQpLic8L3NwYW4+PC9idXR0b24+PHVsIGNsYXNzPSJkcm9wZG93bi1tZW51Ij4nOwoKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMuPSc8bGk+PGEgdGFyZ2V0PSJfX2JsYW5rIiBocmVmPSInLnVybCgncG1zL3F1b3RhdGlvbi9jcy1jb21wYXJlLXZpZXctcGRmLycuJHZhbHVlcy0+cmVxdWVzdF9wcm9wb3NhbF9pZCkuJyIgZGF0YS10aXRsZT0iUXVvdGF0aW9uIENTIj5DUyBWaWV3PC9hPjwvbGk+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zLj0nPGxpPjxhIHRhcmdldD0iX19ibGFuayIgaHJlZj0iJy5yb3V0ZSgncG1zLnF1b3RhdGlvbi5jcy5oaXN0b3J5JywkdmFsdWVzLT5yZXF1ZXN0X3Byb3Bvc2FsX2lkKS4nIiBkYXRhLXRpdGxlPSJRdW90YXRpb24gQ1MiPkNTIEhpc3Rvcnk8L2E+PC9saT4nOwoKICAgICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMuPSc8L3VsPjwvZGl2Pic7CgogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJG9wdGlvbnNbJ3F1b3RhdGlvbi1oYWx0J10pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zLj0nPGEgaHJlZj0iJy5yb3V0ZSgncG1zLnF1b3RhdGlvbi5xdW90YXRpb25zLmNzLmNvbXBhcmUudmlldycsWydpZCc9PiR2YWx1ZXMtPnJlbFJlcXVlc3RQcm9wb3NhbC0+aWQsJ3NsdWcnPT4nbGlzdCddKS4nP3R5cGU9cmZwIiAgdGl0bGU9IkNvbXBhcmUgUHJvY2VzcyBBbmFseXNpcyIgY2xhc3M9ImJ0biBidG4tc3VjY2VzcyBidG4teHMiPjxpIGNsYXNzPSJsYXMgbGEtbGlzdCI+PC9pPjwvYT4nOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiAkYWN0aW9uczsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydyZXF1ZXN0X3Byb3Bvc2FsJywnc3VwcGxpZXInLCdyZWZlcmVuY2Vfbm8nLCdhY3Rpb25zJ10pCiAgICAgICAgICAgICAgICAtPm1ha2UodHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24uZXN0aW1hdGUtcmVqZWN0ZWQtbGlzdCcsIFsndGl0bGUnPT4kdGl0bGUsJ2hlYWRlckNvbHVtbnMnPT4kdGhpcy0+Z3BMaXN0SGVhZGVyQ29sdW1ucygpXSk7CgogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiBnZW5lcmF0ZVBvUHJvY2VzcygkaWQpCiAgICB7CiAgICAgICAgJHRpdGxlID0gJ0dlbmVyYXRlIFB1cmNoYXNlIE9yZGVyJzsKICAgICAgICAkcXVvdGF0aW9uID0gUXVvdGF0aW9uczo6d2l0aChbCiAgICAgICAgICAgICdyZWxRdW90YXRpb25JdGVtcycsCiAgICAgICAgICAgICdyZWxSZXF1ZXN0UHJvcG9zYWwucmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24nCiAgICAgICAgXSktPndoZXJlKFsnc3RhdHVzJz0+J2FjdGl2ZScsICdpc19hcHByb3ZlZCc9PidhcHByb3ZlZCcsICdpc19wb19nZW5lcmF0ZSc9PidubyddKS0+ZmluZE9yRmFpbCgkaWQpOwoKICAgICAgICAkdW5jb21tb24gPSBDYXRlZ29yeTo6d2hlcmVIYXMoJ3N1YkNhdGVnb3J5LnByb2R1Y3RzJywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHF1b3RhdGlvbil7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2lkJywgJHF1b3RhdGlvbi0+cmVsUXVvdGF0aW9uSXRlbXMtPnBsdWNrKCdwcm9kdWN0X2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgfSktPndoZXJlKCd0eXBlJywgJ3VuY29tbW9uJyktPmNvdW50KCk7CgogICAgICAgICRyZXF1aXNpdGlvbnMgPSBSZXF1aXNpdGlvbjo6d2l0aChbCiAgICAgICAgICAgICdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUnCiAgICAgICAgXSkKICAgICAgICAtPndoZXJlSGFzKCdyZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi5yZWxSZXF1ZXN0UHJvcG9zYWwucmVsUXVvdGF0aW9ucycsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRxdW90YXRpb24pewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaWQnLCAkcXVvdGF0aW9uLT5pZCk7CiAgICAgICAgfSkKICAgICAgICAtPndoZXJlSGFzKCdpdGVtcycsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRxdW90YXRpb24pewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdwcm9kdWN0X2lkJywgJHF1b3RhdGlvbi0+cmVsUXVvdGF0aW9uSXRlbXMtPndoZXJlKCdpc19hcHByb3ZlZCcsICdhcHByb3ZlZCcpLT5wbHVjaygncHJvZHVjdF9pZCcpLT50b0FycmF5KCkpOwogICAgICAgIH0pCiAgICAgICAgLT5nZXQoKTsKCiAgICAgICAgJHVuaXRfaWRzID0gJHJlcXVpc2l0aW9ucy0+cGx1Y2soJ2hyX3VuaXRfaWQnKS0+dG9BcnJheSgpOwogICAgICAgICRkZXBhcnRtZW50X2lkcyA9IFtdOwogICAgICAgIGlmKCRyZXF1aXNpdGlvbnMtPmNvdW50KCkgPiAwKXsKICAgICAgICAgICAgZm9yZWFjaCgkcmVxdWlzaXRpb25zIGFzICRrZXkgPT4gJHJlcXVpc2l0aW9uKXsKICAgICAgICAgICAgICAgIGFycmF5X3B1c2goJGRlcGFydG1lbnRfaWRzLCAkcmVxdWlzaXRpb24tPnJlbFVzZXJzTGlzdC0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpOwogICAgICAgICAgICB9CiAgICAgICAgfQoKICAgICAgICB0cnl7CgogICAgICAgICAgICAkdW5pdHMgPSBVbml0Ojp3aGVyZUluKCdocl91bml0X2lkJywgJHVuaXRfaWRzKS0+Z2V0KCk7CiAgICAgICAgICAgICRkZXBhcnRtZW50cyA9IERlcGFydG1lbnQ6OndoZXJlSW4oJ2hyX2RlcGFydG1lbnRfaWQnLCAkZGVwYXJ0bWVudF9pZHMpLT5nZXQoKTsKCiAgICAgICAgICAgICRzeXN0ZW1DdXJyZW5jeSA9IHN5c3RlbUN1cnJlbmN5KCk7CiAgICAgICAgICAgICRjdXJyZW5jeSA9ICRxdW90YXRpb24tPmV4Y2hhbmdlUmF0ZS0+Y3VycmVuY3ktPmNvZGU7CiAgICAgICAgICAgICRleGNoYW5nZVJhdGUgPSBleGNoYW5nZVJhdGUoJHF1b3RhdGlvbi0+ZXhjaGFuZ2VSYXRlLCAkc3lzdGVtQ3VycmVuY3ktPmlkKTsKICAgICAgICAgICAgJHNhbWUgPSAoJHN5c3RlbUN1cnJlbmN5LT5pZCA9PSAkcXVvdGF0aW9uLT5leGNoYW5nZVJhdGUtPmN1cnJlbmN5X2lkID8gdHJ1ZSA6IGZhbHNlKTsKCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5xdW90YXRpb24uZ2VuZXJhdGUtcG8tcHJvY2VzcycsY29tcGFjdCgndGl0bGUnLCdxdW90YXRpb24nLCd1bml0cycsICdkZXBhcnRtZW50cycsICd1bmNvbW1vbicsICdzeXN0ZW1DdXJyZW5jeScsICdleGNoYW5nZVJhdGUnLCAnY3VycmVuY3knLCAnc2FtZScpKTsKCiAgICAgICAgfWNhdGNoKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBEaXNwbGF5IGEgbGlzdGluZyBvZiB0aGUgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHJldHVybiBcSWxsdW1pbmF0ZVxIdHRwXFJlc3BvbnNlCiAgICAgKi8KCiAgICBwdWJsaWMgZnVuY3Rpb24gdW5pdFdpc2VSZXF1aXNpdGlvbigkdW5pdElkLCRxdW90YXRpb25JZCkKICAgIHsKICAgICAgICB0cnl7CgogICAgICAgICAgICAkcHJvZHVjdElkcyA9IFF1b3RhdGlvbnNJdGVtczo6d2hlcmUoJ3F1b3RhdGlvbl9pZCcsICRxdW90YXRpb25JZCkKICAgICAgICAgICAgLT5wbHVjaygncHJvZHVjdF9pZCcpLT50b0FycmF5KCk7CgogICAgICAgICAgICAkYXJyYXkxID0gUmVxdWlzaXRpb246OndoZXJlKFsKICAgICAgICAgICAgICAgICdocl91bml0X2lkJyA9PiAkdW5pdElkLAogICAgICAgICAgICAgICAgJ2lzX3BvX2dlbmVyYXRlJyA9PiAnbm8nLAogICAgICAgICAgICAgICAgJ2lzX3NlbmRfdG9fcmZwJyA9PiAneWVzJywKICAgICAgICAgICAgICAgICdkZWxpdmVyeV9zdGF0dXMnID0+ICdyZnAnLAogICAgICAgICAgICAgICAgJ2FwcHJvdmVkX2lkJyA9PiAxLAogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gMSwKICAgICAgICAgICAgXSkgCiAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlcXVpc2l0aW9uSXRlbXMnLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkcHJvZHVjdElkcykgewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lzX3NlbmQnLCd5ZXMnKQogICAgICAgICAgICAgICAgLT53aGVyZSgncG9fZ2VuZXJhdGUnLCdubycpCiAgICAgICAgICAgICAgICAtPndoZXJlSW4oJ3Byb2R1Y3RfaWQnLCRwcm9kdWN0SWRzKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZUhhcygncmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb24ucmVsUmVxdWVzdFByb3Bvc2FsLnJlbFF1b3RhdGlvbnMnLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkcXVvdGF0aW9uSWQpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lkJywgJHF1b3RhdGlvbklkKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVuKHJlcXVlc3QoKS0+Z2V0KCd1bmNvbW1vbicpID4gMCwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUnLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhc19kZXBhcnRtZW50X2lkJywgcmVxdWVzdCgpLT5nZXQoJ2hyX2RlcGFydG1lbnRfaWQnKSk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5wbHVjaygnaWQnKS0+dG9BcnJheSgpOwoKICAgICAgICAgICAgJGFycmF5MiA9IFJlcXVpc2l0aW9uOjp3aGVyZShbCiAgICAgICAgICAgICAgICAnaHJfdW5pdF9pZCcgPT4kdW5pdElkLAogICAgICAgICAgICAgICAgJ2FwcHJvdmVkX2lkJyA9PiAxLAogICAgICAgICAgICAgICAgJ3N0YXR1cycgPT4gMSwKICAgICAgICAgICAgICAgICdpc19wb19nZW5lcmF0ZScgPT4gJ25vJywKICAgICAgICAgICAgICAgICdpc19zZW5kX3RvX3JmcCcgPT4gJ3llcycsCiAgICAgICAgICAgICAgICAncmVxdWVzdF9zdGF0dXMnID0+ICdzZW5kX3JmcCcsCiAgICAgICAgICAgICAgICAnZGVsaXZlcnlfc3RhdHVzJyA9PiAncGFydGlhbC1kZWxpdmVyZWQnLAogICAgICAgICAgICBdKSAKICAgICAgICAgICAgLT53aGVyZUhhcygncmVxdWlzaXRpb25JdGVtcycsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRwcm9kdWN0SWRzKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaXNfc2VuZCcsJ3llcycpCiAgICAgICAgICAgICAgICAtPndoZXJlKCdwb19nZW5lcmF0ZScsJ25vJykKICAgICAgICAgICAgICAgIC0+d2hlcmVJbigncHJvZHVjdF9pZCcsJHByb2R1Y3RJZHMpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZXJlSGFzKCdyZXF1ZXN0UHJvcG9zYWxSZXF1aXNpdGlvbi5yZWxSZXF1ZXN0UHJvcG9zYWwucmVsUXVvdGF0aW9ucycsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRxdW90YXRpb25JZCl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaWQnLCAkcXVvdGF0aW9uSWQpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4ocmVxdWVzdCgpLT5nZXQoJ3VuY29tbW9uJykgPiAwLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFVzZXJzTGlzdC5lbXBsb3llZScsIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2FzX2RlcGFydG1lbnRfaWQnLCByZXF1ZXN0KCktPmdldCgnaHJfZGVwYXJ0bWVudF9pZCcpKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPnBsdWNrKCdpZCcpLT50b0FycmF5KCk7CgogICAgICAgICAgICAkYXJyYXkgPSBhcnJheV91bmlxdWUoYXJyYXlfbWVyZ2UoJGFycmF5MSwgJGFycmF5MikpOwoKICAgICAgICAgICAgcmV0dXJuIFJlcXVpc2l0aW9uOjp3aGVyZUluKCdpZCcsJGFycmF5KS0+Z2V0KFsnaWQnLCdyZWZlcmVuY2Vfbm8nXSk7CgogICAgICAgIH1jYXRjaChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGdldENvc3RDZW50cmVzKFJlcXVlc3QgJHJlcXVlc3QpCiAgICB7CiAgICAgICAgJHJlcXVpc2l0aW9ucyA9IFJlcXVpc2l0aW9uOjp3aXRoKFsKICAgICAgICAgICAgJ3JlbFVzZXJzTGlzdC5lbXBsb3llZScKICAgICAgICBdKQogICAgICAgIC0+d2hlcmVJbignaWQnLCAkcmVxdWVzdC0+cmVxdWlzaXRpb25zKQogICAgICAgIC0+Z2V0KCk7CiAgICAgICAgJGRlcGFydG1lbnRzID0gW107CiAgICAgICAgaWYoaXNzZXQoJHJlcXVpc2l0aW9uc1swXSkpewogICAgICAgICAgICBmb3JlYWNoKCRyZXF1aXNpdGlvbnMgYXMgJGtleSA9PiAkcmVxdWlzaXRpb24pewogICAgICAgICAgICAgICAgYXJyYXlfcHVzaCgkZGVwYXJ0bWVudHMsICRyZXF1aXNpdGlvbi0+cmVsVXNlcnNMaXN0LT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CgogICAgICAgICRjb3N0Q2VudHJlcyA9IENvc3RDZW50cmU6OndpdGgoWwogICAgICAgICAgICAnY29tcGFueScKICAgICAgICBdKQogICAgICAgIC0+d2hlcmUoJ2hyX3VuaXRfaWQnLCAkcmVxdWVzdC0+aHJfdW5pdF9pZCkKICAgICAgICAtPndoZXJlSW4oJ2hyX2RlcGFydG1lbnRfaWQnLCAkZGVwYXJ0bWVudHMpCiAgICAgICAgLT5nZXQoKTsKCiAgICAgICAgJGNlbnRyZXMgPSAnJzsKICAgICAgICBpZihpc3NldCgkY29zdENlbnRyZXNbMF0pKXsKICAgICAgICAgICAgZm9yZWFjaCgkY29zdENlbnRyZXMgYXMgJGtleSA9PiAkY29zdENlbnRyZSl7CiAgICAgICAgICAgICAgICAkY2VudHJlcyAuPSAnPG9wdGlvbiB2YWx1ZT0iJy4kY29zdENlbnRyZS0+aWQuJyI+WycuJGNvc3RDZW50cmUtPmNvZGUuJ10gJy4kY29zdENlbnRyZS0+bmFtZS4nICgnLiRjb3N0Q2VudHJlLT5jb21wYW55LT5uYW1lLicpPC9vcHRpb24+JzsKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICRjZW50cmVzOwogICAgfQoKICAgIC8qKgogICAgICogRGlzcGxheSBhIGxpc3Rpbmcgb2YgdGhlIHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIHJlcXVpc2l0aW9uV2lzZUl0ZW1zUXR5KFJlcXVlc3QgJHJlcXVlc3QpCiAgICB7CiAgICAgICAgdHJ5ewoKICAgICAgICAgICAgJGl0ZW1zID0gUXVvdGF0aW9uc0l0ZW1zOjp3aGVyZSgncXVvdGF0aW9uX2lkJywgJHJlcXVlc3QtPnF1b3RhdGlvbklkKS0+Z2V0KCk7CiAgICAgICAgICAgICRkYXRhID0gW107CiAgICAgICAgICAgIGlmKGlzc2V0KCRpdGVtc1swXSkpewogICAgICAgICAgICAgICAgZm9yZWFjaCgkaXRlbXMgYXMgJGtleSA9PiAkaXRlbSl7CiAgICAgICAgICAgICAgICAgICAgJHF0eSA9IFJlcXVpc2l0aW9uSXRlbTo6d2hlcmVJbigncmVxdWlzaXRpb25faWQnLCRyZXF1ZXN0LT5yZXF1aXNpdGlvbklkKQogICAgICAgICAgICAgICAgICAgIC0+d2hlcmUoJ3Byb2R1Y3RfaWQnLCAkaXRlbS0+cHJvZHVjdF9pZCkKICAgICAgICAgICAgICAgICAgICAtPndoZXJlKCdpc19zZW5kJywneWVzJykKICAgICAgICAgICAgICAgICAgICAtPndoZXJlKCdwb19nZW5lcmF0ZScsJ25vJykKICAgICAgICAgICAgICAgICAgICAtPnN1bSgncXR5Jyk7CgogICAgICAgICAgICAgICAgICAgICRkZWxpdmVyeVF0eSA9IFJlcXVpc2l0aW9uSXRlbTo6d2hlcmVJbigncmVxdWlzaXRpb25faWQnLCRyZXF1ZXN0LT5yZXF1aXNpdGlvbklkKQogICAgICAgICAgICAgICAgICAgIC0+d2hlcmUoJ3Byb2R1Y3RfaWQnLCAkaXRlbS0+cHJvZHVjdF9pZCkKICAgICAgICAgICAgICAgICAgICAtPndoZXJlKCdpc19zZW5kJywneWVzJykKICAgICAgICAgICAgICAgICAgICAtPndoZXJlKCdwb19nZW5lcmF0ZScsJ25vJykKICAgICAgICAgICAgICAgICAgICAtPnN1bSgnZGVsaXZlcnlfcXR5Jyk7CgogICAgICAgICAgICAgICAgICAgICRkYXRhWyRpdGVtLT5pZF0gPSAoJGRlbGl2ZXJ5UXR5PjApPyRxdHktJGRlbGl2ZXJ5UXR5OiRxdHk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiAkZGF0YTsKICAgICAgICB9Y2F0Y2goXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICBwdWJsaWMgZnVuY3Rpb24gZ2VuZXJhdGVQb1N0b3JlKFJlcXVlc3QgJHJlcXVlc3QpeyAgIAogICAgICAgICR0aGlzLT52YWxpZGF0ZSgkcmVxdWVzdCwgWwogICAgICAgICAgICAncXVvdGF0aW9uX2lkJyA9PiBbJ3JlcXVpcmVkJ10sCiAgICAgICAgICAgICdwb19xdHknID0+IFsncmVxdWlyZWQnXSwKICAgICAgICAgICAgJ3JlcXVpc2l0aW9uX2lkJyA9PiBbJ3JlcXVpcmVkJ10sCiAgICAgICAgICAgICdocl91bml0X2lkJyA9PiBbJ3JlcXVpcmVkJ10sCiAgICAgICAgICAgICdjb3N0X2NlbnRyZV9pZCcgPT4gWydyZXF1aXJlZCddLAogICAgICAgIF0pOwoKICAgICAgICAkZmlsdGVyUG9RdHkgPSBhcnJheV9kaWZmKCRyZXF1ZXN0LT5wb19xdHksIFswXSk7CiAgICAgICAgJGNvbGxlY3RQcm9kdWN0SWQgPSBhcnJheV9rZXlzKCRmaWx0ZXJQb1F0eSk7CiAgICAgICAgaWYoYXJyYXlfc3VtKCRmaWx0ZXJQb1F0eSk8PTApewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJ1BsZWFzZSBwbyBxdHkgY2FuIG5vdCBiZSAwJyk7CiAgICAgICAgfQoKICAgICAgICAkbW9kYWwgPSBRdW90YXRpb25zOjp3aGVyZSgnaWQnLCRyZXF1ZXN0LT5xdW90YXRpb25faWQpLT5maXJzdCgpOwogICAgICAgICRwcmVmaXggPSAnUE8tJy5kYXRlKCd5Jywgc3RydG90aW1lKGRhdGUoJ1ktbS1kJykpKS4nLScudW5pdE5hbWUoJHJlcXVlc3QtPmhyX3VuaXRfaWQpLT5ocl91bml0X3Nob3J0X25hbWUuJy0nOwogICAgICAgICRyZWZObyA9IHVuaXF1ZUNvZGUoMTYsJHByZWZpeCwncHVyY2hhc2Vfb3JkZXJzJywnaWQnKTsKCiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICB0cnl7CiAgICAgICAgICAgICRwb19kYXRhID0gbmV3IFB1cmNoYXNlT3JkZXIoKTsKICAgICAgICAgICAgJHBvX2RhdGEtPnF1b3RhdGlvbl9pZCA9ICRtb2RhbC0+aWQ7CiAgICAgICAgICAgICRwb19kYXRhLT5ocl91bml0X2lkID0gJHJlcXVlc3QtPmhyX3VuaXRfaWQ7CiAgICAgICAgICAgICRwb19kYXRhLT5yZWZlcmVuY2Vfbm8gPSAkcmVmTm87CiAgICAgICAgICAgICRwb19kYXRhLT5wb19kYXRlID0gZGF0ZSgnWS1tLWQnLHN0cnRvdGltZSgkcmVxdWVzdC0+cG9fZGF0ZSkpOwogICAgICAgICAgICAkcG9fZGF0YS0+cmVtYXJrcyA9ICRyZXF1ZXN0LT5yZW1hcmtzOwogICAgICAgICAgICAkcG9fZGF0YS0+Y29zdF9jZW50cmVfaWQgPSAkcmVxdWVzdC0+Y29zdF9jZW50cmVfaWQ7CiAgICAgICAgICAgICRwb19kYXRhLT5zYXZlKCk7CgogICAgICAgICAgICAkcG9TdWJUb3RhbCA9IDA7CiAgICAgICAgICAgICRwb1ZhdCA9IDA7CiAgICAgICAgICAgICRwb0dyb3NzVG90YWwgPSAwOwoKICAgICAgICAgICAgJGl0ZW1zID0gUXVvdGF0aW9uc0l0ZW1zOjp3aGVyZSgncXVvdGF0aW9uX2lkJywgJG1vZGFsLT5pZCktPndoZXJlSW4oJ3Byb2R1Y3RfaWQnLCRjb2xsZWN0UHJvZHVjdElkKS0+d2hlcmUoJ2lzX2FwcHJvdmVkJywgJ2FwcHJvdmVkJyktPmdldCgpOwogICAgICAgICAgICBmb3JlYWNoKCRpdGVtcyBhcyAka2V5ID0+ICR2YWx1ZXMpewogICAgICAgICAgICAgICAgJGRpc2NvdW50ZWQgPSAoJHZhbHVlcy0+ZGlzY291bnQgPiAwID8gKCR2YWx1ZXMtPnVuaXRfcHJpY2UqKCR2YWx1ZXMtPmRpc2NvdW50LzEwMCkpIDogMCk7CiAgICAgICAgICAgICAgICAkdW5pdF9wcmljZSA9ICgkdmFsdWVzLT51bml0X3ByaWNlLSRkaXNjb3VudGVkKTsKCiAgICAgICAgICAgICAgICAkcG9RdHkgPSAkZmlsdGVyUG9RdHlbJHZhbHVlcy0+cHJvZHVjdF9pZF07CiAgICAgICAgICAgICAgICAkc3ViVG90YWwgPSAkdW5pdF9wcmljZSokcG9RdHk7CiAgICAgICAgICAgICAgICAkcG9TdWJUb3RhbCArPSAkc3ViVG90YWw7CgogICAgICAgICAgICAgICAgJHZhdEFtb3VudCA9ICgkdmFsdWVzLT52YXRfcGVyY2VudGFnZSA+IDAgJiYgJHN1YlRvdGFsID4gMCA/ICgkc3ViVG90YWwqKCR2YWx1ZXMtPnZhdF9wZXJjZW50YWdlLzEwMCkpIDogMCk7CiAgICAgICAgICAgICAgICAkcG9WYXQgKz0gJHZhdEFtb3VudDsKCiAgICAgICAgICAgICAgICAkZ3Jvc3NUb3RhbCA9ICgkc3ViVG90YWwrJHZhdEFtb3VudCk7CiAgICAgICAgICAgICAgICAkcG9Hcm9zc1RvdGFsICs9ICRncm9zc1RvdGFsOwoKICAgICAgICAgICAgICAgICRwb19pdGVtcyA9IG5ldyBQdXJjaGFzZU9yZGVySXRlbSgpOwogICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT5wb19pZCA9ICRwb19kYXRhLT5pZDsgCiAgICAgICAgICAgICAgICAkcG9faXRlbXMtPnByb2R1Y3RfaWQgPSAkdmFsdWVzLT5wcm9kdWN0X2lkOyAKICAgICAgICAgICAgICAgICRwb19pdGVtcy0+dW5pdF9wcmljZSA9ICR1bml0X3ByaWNlOyAKICAgICAgICAgICAgICAgICRwb19pdGVtcy0+cXR5ID0gJHBvUXR5OwogICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT5zdWJfdG90YWxfcHJpY2UgPSAkc3ViVG90YWw7CiAgICAgICAgICAgICAgICAkcG9faXRlbXMtPmRpc2NvdW50X3BlcmNlbnRhZ2UgPSAwOwogICAgICAgICAgICAgICAgJHBvX2l0ZW1zLT5kaXNjb3VudCA9IDA7CiAgICAgICAgICAgICAgICAkcG9faXRlbXMtPnZhdF9wZXJjZW50YWdlID0gJHZhbHVlcy0+dmF0X3BlcmNlbnRhZ2U7CiAgICAgICAgICAgICAgICAkcG9faXRlbXMtPnZhdCA9ICR2YXRBbW91bnQ7CiAgICAgICAgICAgICAgICAkcG9faXRlbXMtPnRvdGFsX3ByaWNlID0gJGdyb3NzVG90YWw7CiAgICAgICAgICAgICAgICAkcG9faXRlbXMtPnNhdmUoKTsKCiAgICAgICAgICAgICAgICAvL3VwZGF0ZSBsYXRlc3QgcHJvZHVjdCBwcmljZQogICAgICAgICAgICAgICAgbGF0ZXN0UHJvZHVjdFByaWNlVXBkYXRlKCR2YWx1ZXMtPnByb2R1Y3RfaWQsICR1bml0X3ByaWNlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgLy9VcGRhdGUgUHVyY2Foc2UgT3JkZXIKICAgICAgICAgICAgUHVyY2hhc2VPcmRlcjo6d2hlcmUoJ2lkJywgJHBvX2RhdGEtPmlkKS0+dXBkYXRlKFsKICAgICAgICAgICAgICAgICd0b3RhbF9wcmljZScgPT4gUHVyY2hhc2VPcmRlckl0ZW06OndoZXJlKCdwb19pZCcsICRwb19kYXRhLT5pZCktPnN1bSgnc3ViX3RvdGFsX3ByaWNlJyksCiAgICAgICAgICAgICAgICAnZGlzY291bnQnID0+IDAsCiAgICAgICAgICAgICAgICAndmF0JyA9PiBQdXJjaGFzZU9yZGVySXRlbTo6d2hlcmUoJ3BvX2lkJywgJHBvX2RhdGEtPmlkKS0+c3VtKCd2YXQnKSwKICAgICAgICAgICAgICAgICdncm9zc19wcmljZScgPT4gUHVyY2hhc2VPcmRlckl0ZW06OndoZXJlKCdwb19pZCcsICRwb19kYXRhLT5pZCktPnN1bSgndG90YWxfcHJpY2UnKSwKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICBpZigkbW9kYWwtPnJlbFN1cHBsaWVyUGF5bWVudFRlcm0tPnR5cGUgPT0gJ3BhaWQnKXsKICAgICAgICAgICAgICAgIC8vQWRkIFN1cHBsaWVyIFB5YW1lbnRzCiAgICAgICAgICAgICAgICAkZHVyYXRpb25fZGF0ZSA9ICRtb2RhbC0+cmVsU3VwcGxpZXJQYXltZW50VGVybS0+ZGF5X2R1cmF0aW9uOwogICAgICAgICAgICAgICAgJHBheV9kYXRlID0gZGF0ZSgnWS1tLWQgaDppOnMnLCBzdHJ0b3RpbWUoJysnLiRkdXJhdGlvbl9kYXRlLicgZGF5Jywgc3RydG90aW1lKCRwb19kYXRhLT5wb19kYXRlKSkpOwogICAgICAgICAgICAgICAgLy9QYXltZW50IGRhdGUgYmFzZWQgb24gYWR2YW5jZSAmIGR1ZQogICAgICAgICAgICAgICAgJHBheV9hbW91bnQgPSAgKCRtb2RhbC0+cmVsU3VwcGxpZXJQYXltZW50VGVybS0+cGF5bWVudF9wZXJjZW50ID4gMCAmJiAkcG9Hcm9zc1RvdGFsID4gMCA/ICgkbW9kYWwtPnJlbFN1cHBsaWVyUGF5bWVudFRlcm0tPnBheW1lbnRfcGVyY2VudCAqICRwb0dyb3NzVG90YWwpLzEwMCA6IDApOwogICAgICAgICAgICAgICAgaWYoJHBheV9hbW91bnQgPiAwKXsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudCA9IG5ldyBTdXBwbGllclBheW1lbnQoKTsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudC0+c3VwcGxpZXJfaWQgPSAkbW9kYWwtPnN1cHBsaWVyX2lkOwogICAgICAgICAgICAgICAgICAgICRzdXBwbGllcl9wYXltZW50LT5wdXJjaGFzZV9vcmRlcl9pZCA9ICRwb19kYXRhLT5pZDsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudC0+dHJhbnNlY3Rpb25fZGF0ZSA9IGRhdGUoJ1ktbS1kIGg6aTpzJyk7CiAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVyX3BheW1lbnQtPnRyYW5zZWN0aW9uX3R5cGUgPSAncHVyY2hhc2UnOwogICAgICAgICAgICAgICAgICAgICRzdXBwbGllcl9wYXltZW50LT5leGNoYW5nZV9yYXRlX2lkID0gJG1vZGFsLT5leGNoYW5nZV9yYXRlX2lkOwogICAgICAgICAgICAgICAgICAgICRzdXBwbGllcl9wYXltZW50LT5iaWxsX251bWJlciA9ICRwb19kYXRhLT5yZWZlcmVuY2Vfbm87CiAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVyX3BheW1lbnQtPnBheV9hbW91bnQgPSAkcGF5X2Ftb3VudDsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudC0+cGF5X2RhdGUgPSAkcGF5X2RhdGU7CiAgICAgICAgICAgICAgICAgICAgJHN1cHBsaWVyX3BheW1lbnQtPmJpbGxfdHlwZSA9ICdwby1hZHZhbmNlJzsKICAgICAgICAgICAgICAgICAgICAkc3VwcGxpZXJfcGF5bWVudC0+c2F2ZSgpOwoKICAgICAgICAgICAgICAgICAgICAvL05vdGlmaWNhdGlvbiBzZW5kIHRvIGFjY291bnRzCiAgICAgICAgICAgICAgICAgICAgJG1lc3NhZ2UgPSAnPHNwYW4gY2xhc3M9Im5vdGlmaWNhdGlvbi1saW5rcyIgIGRhdGEtdGl0bGU9IlB1cmNoYXNlIE9yZGVyIERldGFpbHMiPlJlZmVyZW5jZSBObzonLiRwb19kYXRhLT5yZWZlcmVuY2Vfbm8uJy4gQSBQTyBoYXMgYmVlbiBzdWJtaXR0ZWQgd2l0aCBhbiBhZHZhbmNlIGFtb3VudCBvZiBUSyAnLiRzdXBwbGllcl9wYXltZW50LT5wYXlfYW1vdW50Lic8L3NwYW4+JzsKCiAgICAgICAgICAgICAgICAgICAgQ3JlYXRlT3JVcGRhdGVOb3RpZmljYXRpb24oJycsZ2V0TWFuYWdlckluZm8oJ0FjY291bnRzJyksJG1lc3NhZ2UsJ3VucmVhZCcsJ3NlbmQtdG8tYWNjb3VudHMnLCcnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgLy9VcGRhdGUgcmVxdWlzaXRpb24KICAgICAgICAgICAgUmVxdWlzaXRpb25JdGVtOjp3aGVyZUluKCdyZXF1aXNpdGlvbl9pZCcsICRyZXF1ZXN0LT5yZXF1aXNpdGlvbl9pZCkKICAgICAgICAgICAgLT53aGVyZUluKCdwcm9kdWN0X2lkJywgJGNvbGxlY3RQcm9kdWN0SWQpCiAgICAgICAgICAgIC0+d2hlcmUoJ2lzX3NlbmQnLCd5ZXMnKQogICAgICAgICAgICAtPndoZXJlKCdwb19nZW5lcmF0ZScsJ25vJykKICAgICAgICAgICAgLT51cGRhdGUoWydwb19nZW5lcmF0ZSc9Pid5ZXMnXSk7CgogICAgICAgICAgICBpZihpc3NldCgkcmVxdWVzdC0+cmVxdWlzaXRpb25faWRbMF0pKXsKICAgICAgICAgICAgICAgIGZvcmVhY2goJHJlcXVlc3QtPnJlcXVpc2l0aW9uX2lkIGFzICRrZXkgPT4gJHJlcXVpc2l0aW9uX2lkKXsKICAgICAgICAgICAgICAgICAgICBQdXJjaGFzZU9yZGVyUmVxdWlzaXRpb246OnVwZGF0ZU9yQ3JlYXRlKFsKICAgICAgICAgICAgICAgICAgICAgICAgJ3B1cmNoYXNlX29yZGVyX2lkJyA9PiAkcG9fZGF0YS0+aWQsCiAgICAgICAgICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvbl9pZCcgPT4gJHJlcXVpc2l0aW9uX2lkLAogICAgICAgICAgICAgICAgICAgIF0sWwogICAgICAgICAgICAgICAgICAgICAgICAnaHJfZGVwYXJ0bWVudF9pZCcgPT4gaXNzZXQoJHJlcXVlc3QtPmhyX2RlcGFydG1lbnRfaWQpID8gJHJlcXVlc3QtPmhyX2RlcGFydG1lbnRfaWQgOiAwLAogICAgICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICAgICAgICAgIC8vUmVxdWlzaXRpb24gdHJhY2tpbmcgd2l0aCByZXF1aXNpdG9uIGlkCiAgICAgICAgICAgICAgICAgICAgUmVxdWlzaXRpb25UcmFja2luZzo6c3RvcmVSZXF1aXNpdGlvblRyYWNraW5nKCRyZXF1aXNpdGlvbl9pZCwnUE8tSXNzdWUnKTsKCiAgICAgICAgICAgICAgICAgICAgLy9Ob3RpZmljYXRpb24gZ2VuZXJhdGUKICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25Vc2VyPVJlcXVpc2l0aW9uOjp3aGVyZSgnaWQnLCRyZXF1aXNpdGlvbl9pZCktPmZpcnN0KCk7CiAgICAgICAgICAgICAgICAgICAgJG1lc3NhZ2UgPSAnPHNwYW4gY2xhc3M9Im5vdGlmaWNhdGlvbi1saW5rcyIgIGRhdGEtdGl0bGU9IlB1cmNoYXNlIE9yZGVyIERldGFpbHMiPlBPIFJlZmVyZW5jZSBObyAjJy4kcG9fZGF0YS0+cmVmZXJlbmNlX25vLicuIEEgUE8gaGFzIGJlZW4gSXNzdWVkIGFnYWluc3QgeW91ciByZXF1aXNpdGlvbiAjJy4kcmVxdWlzaXRpb25Vc2VyLT5yZWZlcmVuY2Vfbm8uJzwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgIENyZWF0ZU9yVXBkYXRlTm90aWZpY2F0aW9uKCcnLCRyZXF1aXNpdGlvblVzZXItPmF1dGhvcl9pZCwkbWVzc2FnZSwndW5yZWFkJywncmVxdWlzaXRpb24nLCcnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQoKICAgICAgICAgICAgJGFycmF5ID0gW107CgogICAgICAgICAgICAvL1BPIEdlbmVyYXRlIEVxdWFsbHkgZGlzdHJpYnV0ZQogICAgICAgICAgICBpZihpc3NldCgkcmVxdWVzdC0+cHJvZHVjdF9pZFswXSkpewogICAgICAgICAgICAgICAgZm9yZWFjaCgkcmVxdWVzdC0+cHJvZHVjdF9pZCBhcyAka2V5ID0+ICRwcm9kdWN0X2lkKXsKICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25fcXR5ID0gKGlzc2V0KCRyZXF1ZXN0LT5yZXF1aXNpdGlvbl9xdHlbJHByb2R1Y3RfaWRdKSA/ICRyZXF1ZXN0LT5yZXF1aXNpdGlvbl9xdHlbJHByb2R1Y3RfaWRdIDogMCk7CiAgICAgICAgICAgICAgICAgICAgJHBvX3F0eSA9IChpc3NldCgkcmVxdWVzdC0+cG9fcXR5WyRwcm9kdWN0X2lkXSkgPyAkcmVxdWVzdC0+cG9fcXR5WyRwcm9kdWN0X2lkXSA6IDApOwogICAgICAgICAgICAgICAgICAgICRwZXJjZW50YWdlID0gKCRyZXF1aXNpdGlvbl9xdHkgPiAwICYmICRwb19xdHkgPiAwID8gKCgkcG9fcXR5LyRyZXF1aXNpdGlvbl9xdHkpKjEwMCkgOiAwKTsKCiAgICAgICAgICAgICAgICAgICAgaWYoaXNzZXQoJHJlcXVlc3QtPnJlcXVpc2l0aW9uX2lkWzBdKSl7CiAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2goJHJlcXVlc3QtPnJlcXVpc2l0aW9uX2lkIGFzICRrZXkgPT4gJHJlcXVpc2l0aW9uX2lkKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW1zID0gUmVxdWlzaXRpb25JdGVtOjp3aGVyZSgncmVxdWlzaXRpb25faWQnLCAkcmVxdWlzaXRpb25faWQpLT53aGVyZSgncHJvZHVjdF9pZCcsICRwcm9kdWN0X2lkKS0+Z2V0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihpc3NldCgkcmVxdWlzaXRpb25JdGVtc1swXSkpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvcmVhY2goJHJlcXVpc2l0aW9uSXRlbXMgYXMgJGtleSA9PiAkcmVxdWlzaXRpb25JdGVtKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYoJHBvX3F0eT4wKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0aGlzX3BvX3F0eSA9IHJvdW5kKCgkcGVyY2VudGFnZSA+IDAgPyAoJHJlcXVpc2l0aW9uSXRlbS0+cXR5KigkcGVyY2VudGFnZS8xMDApKSA6IDApKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICR0aGlzX3BvX3F0eSA9ICgkdGhpc19wb19xdHkgPiAkcG9fcXR5ID8gJHBvX3F0eSA6ICR0aGlzX3BvX3F0eSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW0tPnB1cmNoYXNlX3F0eSA9ICR0aGlzX3BvX3F0eTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW0tPnNhdmUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcG9fcXR5ID0gKCRwb19xdHkgLSAkdGhpc19wb19xdHkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICAgICBpZigkcG9fcXR5PjApewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uSXRlbSA9IFJlcXVpc2l0aW9uSXRlbTo6d2hlcmUoJ3JlcXVpc2l0aW9uX2lkJywgJHJlcXVpc2l0aW9uX2lkKS0+d2hlcmUoJ3Byb2R1Y3RfaWQnLCAkcHJvZHVjdF9pZCktPmZpcnN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25JdGVtLT5wdXJjaGFzZV9xdHkgPSAoJHJlcXVpc2l0aW9uSXRlbS0+cHVyY2hhc2VfcXR5K3JvdW5kKCRwb19xdHkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW0tPnNhdmUoKTsKCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIERCOjpjb21taXQoKTsKCiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+cmVkaXJlY3RCYWNrV2l0aFN1Y2Nlc3MoJ1B1cmNoYXNlIE9yZGVyIGhhcyBiZWVuIGdlbmVyYXRlZCBzdWNjZXNzZnVsbHkhJywncG1zLnB1cmNoYXNlLm9yZGVyLWluZGV4Jyk7CgogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICBEQjo6cm9sbGJhY2soKTsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGJhY2soKTsKICAgIH0KCiAgICAvKioKICAgICAqIERpc3BsYXkgYSBsaXN0aW5nIG9mIHRoZSByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiBjb21wbGV0ZVF1b3RhdGlvbihSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewogICAgICAgICRyZXNwb25zZT1bXTsKICAgICAgICAkZGF0YT1RdW90YXRpb25zOjp3aGVyZSgnaWQnLCRyZXF1ZXN0LT5xdW90YXRpb25faWQpLT5maXJzdCgpOwogICAgICAgIC8vU3RhcnQgdHJhbnNhY3Rpb24KICAgICAgICBEQjo6YmVnaW5UcmFuc2FjdGlvbigpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmKCFlbXB0eSgkZGF0YSkpCiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICRkYXRhLT5pc19wb19nZW5lcmF0ZSA9ICd5ZXMnOwogICAgICAgICAgICAgICAgJGRhdGEtPnNhdmUoKTsKICAgICAgICAgICAgICAgIC8vQ29tbWl0IGRhdGEKICAgICAgICAgICAgICAgIERCOjpjb21taXQoKTsKCiAgICAgICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ3N1Y2Nlc3MnOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAnU3VjY2Vzc2Z1bGx5IENvbXBsZXRlIFRoaXMgUXVvdGF0aW9uISEnOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnZXJyb3InOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAnRGF0YSBub3QgZm91bmQuISEnOwogICAgICAgICAgICB9CgogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICAvL0lmIHByb2Nlc3MgaGFzIGFueSBwcm9ibGVtIHRoZW4gcm9sbGJhY2sgdGhlIGRhdGEKICAgICAgICAgICAgREI6OnJvbGxiYWNrKCk7CiAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnZXJyb3InOwogICAgICAgICAgICAkcmVzcG9uc2VbJ21lc3NhZ2UnXSA9ICR0aC0+Z2V0TWVzc2FnZSgpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gJHJlc3BvbnNlOwogICAgfQoKICAgIC8qKgogICAgICogRGlzcGxheSB0aGUgc3BlY2lmaWVkIHJlc291cmNlLgogICAgICoKICAgICAqIEBwYXJhbSAgaW50ICAkaWQKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgoKICAgIHB1YmxpYyBmdW5jdGlvbiBwcm9wb3NhbERldGFpbHNWaWV3KCRpZCkKICAgIHsKICAgICAgICAkdGl0bGUgPSAnUmVxdWVzdHMgUHJvcG9zYWwgRGV0YWlscyc7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgICRyZXF1ZXN0UHJvcG9zYWwgPSBSZXF1ZXN0UHJvcG9zYWw6OndpdGgoWwogICAgICAgICAgICAgICAgJ2RlZmluZVRvU3VwcGxpZXInLAogICAgICAgICAgICAgICAgJ3JlcXVlc3RQcm9wb3NhbERldGFpbHMucHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsCiAgICAgICAgICAgICAgICAncmVxdWVzdFByb3Bvc2FsRGV0YWlscy5wcm9kdWN0LnByb2R1Y3RVbml0JywKICAgICAgICAgICAgICAgICdyZXF1ZXN0UHJvcG9zYWxEZXRhaWxzLnByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywKICAgICAgICAgICAgICAgICdjcmVhdGVkQnknCiAgICAgICAgICAgIF0pLT5maW5kT3JGYWlsKCRpZCk7CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucmZwLnJlcXVlc3QtcHJvcG9zYWwtZGV0YWlscycsIGNvbXBhY3QoJ3RpdGxlJywncmVxdWVzdFByb3Bvc2FsJykpOwogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0gIAoKICAgIC8qKgogICAgICogRGlzcGxheSB0aGUgc3BlY2lmaWVkIHJlc291cmNlLgogICAgICoKICAgICAqIEBwYXJhbSAgaW50ICAkaWQKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIGNzSGlzdG9yeSgkaWQpCiAgICB7CiAgICAgICAgdHJ5ewoKICAgICAgICAgICAgJHRpdGxlID0gIkNTIEhpc3RvcnkiOwogICAgICAgICAgICAkcHJvcG9zYWxzID0gUmVxdWVzdFByb3Bvc2FsOjp3aXRoKCdyZWxRdW90YXRpb25zJyktPndoZXJlKCdpZCcsJGlkKS0+b3JkZXJieSgnaWQnLCdkZXNjJyktPmZpcnN0KCk7CgogICAgICAgICAgICBpZiAoY291bnQoJHByb3Bvc2Fscy0+cmVsUXVvdGF0aW9ucyk+MCkgewogICAgICAgICAgICAgICAgJHB1cmNoYXNlID0gJHByb3Bvc2Fscy0+cmVsUXVvdGF0aW9ucygpLT53aXRoKCdyZWxQdXJjaGFzZU9yZGVyJyktPmZpcnN0KCk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgICRwdXJjaGFzZU9yZGVyID0gaXNzZXQoJHB1cmNoYXNlKT8oIWVtcHR5KCRwdXJjaGFzZS0+cmVsUHVyY2hhc2VPcmRlcik/JHB1cmNoYXNlLT5yZWxQdXJjaGFzZU9yZGVyOicnKTonJzsKCiAgICAgICAgICAgIGlmICghZW1wdHkoJHB1cmNoYXNlT3JkZXIpKSB7CiAgICAgICAgICAgICAgICAkYmlsbE1hbmFnZSA9IFB1cmNoYXNlT3JkZXI6OndpdGgoWwogICAgICAgICAgICAgICAgICAgICdyZWxHb29kUmVjZWl2ZU5vdGUnLAogICAgICAgICAgICAgICAgICAgICdyZWxHb29kc1JlY2VpdmVkSXRlbVN0b2NrSW4nLAogICAgICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb24ucmVsU3VwcGxpZXJzJywKICAgICAgICAgICAgICAgICAgICAncmVsUXVvdGF0aW9uLmV4Y2hhbmdlUmF0ZS5jdXJyZW5jeScsCiAgICAgICAgICAgICAgICAgICAgJ3JlbFB1cmNoYXNlT3JkZXJJdGVtcycsCiAgICAgICAgICAgICAgICAgICAgJ3JlbFBvQXR0YWNobWVudCcKICAgICAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICAtPndoZXJlKCdpc19zZW5kJywneWVzJykKICAgICAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlbEdvb2RSZWNlaXZlTm90ZScsZnVuY3Rpb24gKCRxdWVyeSl7CiAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZVJhdygncHVyY2hhc2Vfb3JkZXJzLmlkPWdvb2RzX3JlY2VpdmVkX25vdGVzLnB1cmNoYXNlX29yZGVyX2lkJyk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT53aGVyZUhhcygncmVsR29vZHNSZWNlaXZlZEl0ZW1TdG9ja0luJywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaXNfZ3JuX2NvbXBsZXRlJywneWVzJyktPndoZXJlKCd0b3RhbF9hbW91bnQnLCAnPicsIDApOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+d2hlcmUoJ2lkJywkcHVyY2hhc2VPcmRlci0+aWQpCiAgICAgICAgICAgICAgICAtPmZpcnN0KCk7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgJGJpbGxNYW5hZ2U9Jyc7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5yZnAucmZwLWhpc3RvcnknLGNvbXBhY3QoJ3RpdGxlJywncHVyY2hhc2VPcmRlcicsJ3Byb3Bvc2FscycsJ2JpbGxNYW5hZ2UnKSk7CiAgICAgICAgfWNhdGNoKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aFdhcm5pbmcoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCn0K