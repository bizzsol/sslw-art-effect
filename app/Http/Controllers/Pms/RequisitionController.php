<?php
bolt_decrypt( __FILE__ , '8T4wRw'); return 0;
##!!!##CgpuYW1lc3BhY2UgQXBwXEh0dHBcQ29udHJvbGxlcnNcUG1zOwoKdXNlIEFwcFxIdHRwXENvbnRyb2xsZXJzXENvbnRyb2xsZXI7Cgp1c2UgQXBwXE1vZGVsc1xNeVByb2plY3RcRGVsaXZlcmFibGVzOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcTWVudVxNZW51Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUHJvZHVjdDsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWVzdFByb3Bvc2FsUmVxdWlzaXRpb25zOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb25UcmFja2luZzsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uSXRlbTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uVHlwZTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXENhdGVnb3J5Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcQ2F0ZWdvcnlEZXBhcnRtZW50Owp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcTm90aWZpY2F0aW9uOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb25EZWxpdmVyeTsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFJlcXVpc2l0aW9uRGVsaXZlcnlJdGVtOwp1c2UgQXBwXE1vZGVsc1xQbXNNb2RlbHNcUmVxdWlzaXRpb25Ob3RlTG9nczsKdXNlIEFwcFxNb2RlbHNcUG1zTW9kZWxzXFB1cmNoYXNlXFB1cmNoYXNlT3JkZXI7CnVzZSBBcHBcTW9kZWxzXE15UHJvamVjdFxQcm9qZWN0Owp1c2UgQXBwXE1vZGVsc1xNeVByb2plY3RcUHJvamVjdFRhc2s7CnVzZSBJbGx1bWluYXRlXEh0dHBcUmVxdWVzdDsKdXNlIFZpZXc7CnVzZSBBcHBcSHR0cFxSZXF1ZXN0czsKdXNlIElsbHVtaW5hdGVcU3VwcG9ydFxGYWNhZGVzXEF1dGg7CnVzZSBEQixWYWxpZGF0b3IsIFN0ciwgRGF0YVRhYmxlczsKdXNlIENhcmJvblxDYXJib247CgpjbGFzcyBSZXF1aXNpdGlvbkNvbnRyb2xsZXIgZXh0ZW5kcyBDb250cm9sbGVyCnsgICAKCiAgICBwdWJsaWMgZnVuY3Rpb24gaGVhZGVyQ29sdW1ucygkdmFsdWU9JycpCiAgICB7CiAgICAgICAgJHJvdz0gYXJyYXkoCiAgICAgICAgICAgIFsnU0wnLCAnU0wnXSwgCiAgICAgICAgICAgIFsncmVmZXJlbmNlX25vJywgJ3JlZmVyZW5jZV9ubycsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3JlcXVpc2l0aW9uX2RhdGUnLCAncmVxdWlzaXRpb25fZGF0ZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3Byb2R1Y3RfY2F0ZWdvcnknLCAncHJvZHVjdF9jYXRlZ29yeScsICd0ZXh0LWNlbnRlciddLAogICAgICAgICAgICBbJ3N0YXR1cycsICdzdGF0dXMnLCAndGV4dC1jZW50ZXInXSwgCiAgICAgICAgICAgIFsnYXR0YWNobWVudCcsICdhdHRhY2htZW50JywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnYWN0aW9ucycsICdhY3Rpb25zJywgJ3RleHQtY2VudGVyJywnd2lkdGg6MTUlJ10KICAgICAgICApOwoKICAgICAgICBpZihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRW1wbG95ZWUnKSB8fCBhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRGVwYXJ0bWVudC1IZWFkJykgfHwgYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1B1cmNoYXNlLURlcGFydG1lbnQnKSkgewoKICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgdW5zZXQoJHJvd1s1XSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gJHJvdzsKICAgIH0KICAgIC8qKgogICAgICogRGlzcGxheSBhIGxpc3Rpbmcgb2YgdGhlIHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gaW5kZXgoKQogICAgeyAgIAogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkc3RhdHVzID0gcmVxdWVzdCgpLT5oYXMoJ3N0YXR1cycpID8gcmVxdWVzdCgpLT5nZXQoJ3N0YXR1cycpIDogLTE7CiAgICAgICAgICAgICRmcm9tID0gcmVxdWVzdCgpLT5oYXMoJ2Zyb20nKSA/IHJlcXVlc3QoKS0+Z2V0KCdmcm9tJykgOiBkYXRlKCdZLW0tMDEnKTsKICAgICAgICAgICAgJHRvID0gcmVxdWVzdCgpLT5oYXMoJ3RvJykgPyByZXF1ZXN0KCktPmdldCgndG8nKSA6IGRhdGUoJ1ktbS10Jyk7CiAgICAgICAgICAgICRjYXRlZ29yeV9pZCA9IHJlcXVlc3QoKS0+aGFzKCdjYXRlZ29yeV9pZCcpID8gcmVxdWVzdCgpLT5nZXQoJ2NhdGVnb3J5X2lkJykgOiAwOwogICAgICAgICAgICAkY2F0ZWdvcnlJZHMgPSBDYXRlZ29yeURlcGFydG1lbnQ6OndoZW4oaXNzZXQoYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdocl9kZXBhcnRtZW50X2lkJywgYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKTsKICAgICAgICAgICAgfSktPnBsdWNrKCdjYXRlZ29yeV9pZCcpLT50b0FycmF5KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAkY2F0ZWdvcmllcyA9IENhdGVnb3J5Ojpkb2VzbnRIYXZlKCdjYXRlZ29yeScpCiAgICAgICAgICAgIC0+d2hlcmVJbignaWQnLCAkY2F0ZWdvcnlJZHMpCiAgICAgICAgICAgIC0+Z2V0KCk7CgogICAgICAgICAgICAkcmVxdWlzaXRpb25zID0gUmVxdWlzaXRpb246OndpdGgoWydpdGVtcycsJ2l0ZW1zLnByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknXSkKICAgICAgICAgICAgLT53aGVyZSgnYXV0aG9yX2lkJywgYXV0aCgpLT51c2VyKCktPmlkKQogICAgICAgICAgICAtPndoZW4oc3RydG90aW1lKCRmcm9tKT4wLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkZnJvbSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZURhdGUoJ3JlcXVpc2l0aW9uX2RhdGUnLCAnPj0nLCAkZnJvbSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbihzdHJ0b3RpbWUoJHRvKT4wLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkdG8pewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVEYXRlKCdyZXF1aXNpdGlvbl9kYXRlJywgJzw9JywgJHRvKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVuKCRzdGF0dXM+PTAsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRzdGF0dXMpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3N0YXR1cycsICRzdGF0dXMpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oJGNhdGVnb3J5X2lkPjAsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRjYXRlZ29yeV9pZCl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnaXRlbXMucHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRjYXRlZ29yeV9pZCl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lkJywgJGNhdGVnb3J5X2lkKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oIWVtcHR5KHJlcXVlc3QoKS0+Z2V0KCdzZWFyY2hfdGV4dCcpKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3JlZmVyZW5jZV9ubycsICdMSUtFJywgJyUnLnJlcXVlc3QoKS0+Z2V0KCdzZWFyY2hfdGV4dCcpLiclJykKICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmUoJ3JlbWFya3MnLCAnTElLRScsICclJy5yZXF1ZXN0KCktPmdldCgnc2VhcmNoX3RleHQnKS4nJScpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZU5vdEluKCdzdGF0dXMnLCBbMl0pOwoKICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+YWpheCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gRGF0YXRhYmxlczo6b2YoJHJlcXVpc2l0aW9ucykKICAgICAgICAgICAgICAgIC0+YWRkSW5kZXhDb2x1bW4oKQogICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbigkcmVxdWlzaXRpb24pewogICAgICAgICAgICAgICAgICAgIHJldHVybiAgJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgZGF0YS1zcmM9Iicucm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5saXN0LnZpZXcuc2hvdycsJHJlcXVpc2l0aW9uLT5pZCkuJyIgY2xhc3M9ImJ0biBidG4tbGluayByZXF1aXNpdGlvbiBtLTEgcm91bmRlZCBzaG93UmVxdWlzdGlvbkRldGFpbHMiIG9uY2xpY2s9InJlcXVpc3Rpb25EZXRhaWxzKCQodGhpcykpIj4nLiAkcmVxdWlzaXRpb24tPnJlZmVyZW5jZV9ubyAuJzwvYT4nOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1aXNpdGlvbl9kYXRlJywgZnVuY3Rpb24oJHJlcXVpc2l0aW9uKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZSgnWS1tLWQnLHN0cnRvdGltZSgkcmVxdWlzaXRpb24tPnJlcXVpc2l0aW9uX2RhdGUpKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmZpbHRlckNvbHVtbigncmVxdWlzaXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgncmVxdWlzaXRpb25fZGF0ZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncmVxdWlzaXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ3JlcXVpc2l0aW9uX2RhdGUnLCAkb3JkZXIpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24oJHJlcXVpc2l0aW9uKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHJlcXVpc2l0aW9uLT5pdGVtc1swXS0+cHJvZHVjdC0+Y2F0ZWdvcnktPmNhdGVnb3J5LT5uYW1lKT8kcmVxdWlzaXRpb24tPml0ZW1zWzBdLT5wcm9kdWN0LT5jYXRlZ29yeS0+Y2F0ZWdvcnktPm5hbWU6Jyc7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3Byb2R1Y3RfY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdpdGVtcy5wcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3Byb2R1Y3RfY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBSZXF1aXNpdGlvbkl0ZW06OnNlbGVjdCgnbWFpbl9jYXRlZ29yeS5uYW1lJykKICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdwcm9kdWN0cycsICdwcm9kdWN0cy5pZCcsICc9JywgJ3JlcXVpc2l0aW9uX2l0ZW1zLnByb2R1Y3RfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2NhdGVnb3JpZXMgYXMgc3ViX2NhdGVnb3J5JywgJ3N1Yl9jYXRlZ29yeS5pZCcsICc9JywgJ3Byb2R1Y3RzLmNhdGVnb3J5X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdjYXRlZ29yaWVzIGFzIG1haW5fY2F0ZWdvcnknLCAnbWFpbl9jYXRlZ29yeS5pZCcsICc9JywgJ3N1Yl9jYXRlZ29yeS5wYXJlbnRfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1aXNpdGlvbl9pdGVtcy5yZXF1aXNpdGlvbl9pZCcsICdyZXF1aXNpdGlvbnMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbignc3RhdHVzJywgZnVuY3Rpb24oJHJlcXVpc2l0aW9uKXsKICAgICAgICAgICAgICAgICAgICAkc3RhdHVzID0nJzsKICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49JzxwIGlkPSJzdGF0dXMnLiRyZXF1aXNpdGlvbi0+aWQuJyI+JzsKICAgICAgICAgICAgICAgICAgICBpZigkcmVxdWlzaXRpb24tPnN0YXR1cz09MCl7CiAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMuPSc8c3BhbiBjbGFzcz0iYnRuIGJ0bi14cyBidG4td2FybmluZyI+UGVuZGluZzwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlaWYoJHJlcXVpc2l0aW9uLT5zdGF0dXM9PTEpewoKICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cy49JzxzcGFuIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIj5BcHByb3ZlZDwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlaWYoJHJlcXVpc2l0aW9uLT5zdGF0dXM9PTIpewogICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzLj0nPHNwYW4gY2xhc3M9ImJ0biBidG4teHMgYnRuLWRhbmdlciI+SGFsdDwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlaWYoJHJlcXVpc2l0aW9uLT5zdGF0dXM9PTMpewogICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzLj0nPHNwYW4gY2xhc3M9ImJ0biBidG4teHMgYnRuLXdhcm5pbmciPkRyYWZ0PC9zcGFuPic7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICRzdGF0dXMgLj0nPC9wPic7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRzdGF0dXM7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ2F0dGFjaG1lbnQnLCBmdW5jdGlvbigkcmVxdWlzaXRpb24pewogICAgICAgICAgICAgICAgICAgICRhdHRhY2htZW50ID0nJzsKICAgICAgICAgICAgICAgICAgICBpZihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRW1wbG95ZWUnKSB8fCBhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRGVwYXJ0bWVudC1IZWFkJykgfHwgYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1B1cmNoYXNlLURlcGFydG1lbnQnKSl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCFlbXB0eSgkcmVxdWlzaXRpb24tPmF0dGFjaG1lbnQpICYmIGZpbGVfZXhpc3RzKHB1YmxpY19wYXRoKCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkpKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICRhdHRhY2htZW50Lj0nPGEgaHJlZj0iJy4gdXJsKCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkgLiciIHRhcmdldD0iX2JsYW5rIiBjbGFzcz0iYnRuIGJ0bi14cyBidG4tcHJpbWFyeSI+PGkgY2xhc3M9ImxhcyBsYS1wYXBlcmNsaXAiPjwvaT5BdHRhY2htZW50PC9hPic7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhdHRhY2htZW50OwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24oJHJlcXVpc2l0aW9uKXsKICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyA9ICcnOwoKICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucy49JzxkaXYgY2xhc3M9ImJ0bi1ncm91cCI+CiAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGRyb3Bkb3duLXRvZ2dsZSIgZGF0YS10b2dnbGU9ImRyb3Bkb3duIj4KICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0ic3RhdHVzTmFtZScuJHJlcXVpc2l0aW9uLT5pZC4nIj4KICAgICAgICAgICAgICAgICAgICA8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiBmaWxsPSJjdXJyZW50Q29sb3IiIGNsYXNzPSJiaSBiaS10aHJlZS1kb3RzLXZlcnRpY2FsIiB2aWV3Qm94PSIwIDAgMTYgMTYiPjxwYXRoIGQ9Ik05LjUgMTNhMS41IDEuNSAwIDEgMS0zIDAgMS41IDEuNSAwIDAgMSAzIDB6bTAtNWExLjUgMS41IDAgMSAxLTMgMCAxLjUgMS41IDAgMCAxIDMgMHptMC01YTEuNSAxLjUgMCAxIDEtMyAwIDEuNSAxLjUgMCAwIDEgMyAweiIvPjwvc3ZnPjwvc3Bhbj48L2J1dHRvbj4KICAgICAgICAgICAgICAgICAgICA8dWwgY2xhc3M9ImRyb3Bkb3duLW1lbnUiPgogICAgICAgICAgICAgICAgICAgIDxsaT48YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIHRpdGxlPSJUcmFja2luZyBSZXF1aXNpdGlvbiIgZGF0YS1zcmM9Iicucm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5saXN0LnZpZXcuc2hvdycsJHJlcXVpc2l0aW9uLT5pZCkuJyIgY2xhc3M9InNob3dSZXF1aXN0aW9uRGV0YWlscyIgIG9uY2xpY2s9InJlcXVpc3Rpb25EZXRhaWxzKCQodGhpcykpIj48aSBjbGFzcz0ibGEgbGEtZXllIj48L2k+VmlldzwvYT48L2xpPic7CgogICAgICAgICAgICAgICAgICAgICRhY3Rpb25zLj0nPGxpPjxhIGhyZWY9IicuIHJvdXRlKCdwbXMucmVxdWlzaXRpb24ucmVxdWlzaXRpb24uZWRpdCcsJHJlcXVpc2l0aW9uLT5pZCkgLic/cmVkaXJlY3Q9cmVxdWlzaXRpb24mZWRpdG9yPWF1dGhvciIgdGl0bGU9IkNsaWNrIEhlcmUgVG8gRWRpdCIgY2xhc3M9InJlcXVpc2l0aW9uLWVkaXQiPjxpIGNsYXNzPSJsYSBsYS1lZGl0Ij48L2k+RWRpdDwvYT4KICAgICAgICAgICAgICAgICAgICA8L2xpPic7CgogICAgICAgICAgICAgICAgICAgIGlmKCRyZXF1aXNpdGlvbi0+c3RhdHVzPT0zKXsKCiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zLj0nPGxpPjxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgIG9uY2xpY2s9InNlbmRSZXF1aXNpdGlvbigkKHRoaXMpKSIgY2xhc3M9InNlbmRSZXF1aXNpdGlvbiIgZGF0YS1pZD0iJy4kcmVxdWlzaXRpb24tPmlkLiciIGRhdGEtc3RhdHVzPSIwIiB0aXRsZT0iQ2xpY2sgSGVyZSBUbyBTZW5kIj48aSBjbGFzcz0ibGEgbGEtcGFwZXItcGxhbmUiPjwvaT5TZW5kPC9hPgogICAgICAgICAgICAgICAgICAgICAgICA8L2xpPic7CiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zLj0nPGxpPgogICAgICAgICAgICAgICAgICAgICAgICA8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGRhdGEtcm9sZT0iZGVsZXRlIiBkYXRhLXNyYz0iJy4gcm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5yZXF1aXNpdGlvbi5kZXN0cm95JywgJHJlcXVpc2l0aW9uLT5pZCkgLiciIGNsYXNzPSJ0ZXh0LWRhbmdlciBkZWxldGVCdG4gcmVxdWlzaXRpb24tZGVsZXRlIiBvbmNsaWNrPSJkZWxldGVCdG4oJCh0aGlzKSkiPjxpIGNsYXNzPSJsYXMgbGEtdHJhc2giPjwvaT4mbmJzcDtEZWxldGU8L2E+CiAgICAgICAgICAgICAgICAgICAgICAgIDwvbGk+JzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSB0YXJnZXQ9Il9fYmxhbmsiIGhyZWY9Iicucm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5oaXN0b3J5JywkcmVxdWlzaXRpb24tPmlkKS4nIj48aSBjbGFzcz0ibGEgbGEtaGlzdG9yeSIgdGl0bGU9IlJlcXVpc2l0aW9uIEhpc3RvcnkiPjwvaT5SZXF1aXNpdGlvbiBIaXN0b3J5PC9hPjwvbGk8L2E+PC9saT4nOwoKICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucy49JzxsaT48YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIHRpdGxlPSJUcmFja2luZyBSZXF1aXNpdGlvbiIgY2xhc3M9InRyYWNraW5nUmVxdWlzdGlvblN0YXR1cyIgb25jbGljaz0idHJhY2tpbmdSZXF1aXN0aW9uU3RhdHVzKCQodGhpcykpIiBkYXRhLWlkPSInLiRyZXF1aXNpdGlvbi0+aWQuJyI+PGkgY2xhc3M9ImxhIGxhLW1hcCI+PC9pPlRyYWNrIFByb2dyZXNzPC9hPjwvbGk+PC91bD48L2Rpdj4nOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAkYWN0aW9uczsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydyZWZlcmVuY2Vfbm8nLCdzdGF0dXMnLCdhdHRhY2htZW50JywgJ2FjdGlvbnMnXSkKICAgICAgICAgICAgICAgIC0+bWFrZSh0cnVlKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnJlcXVpc2l0aW9ucy5pbmRleCcsIFsndGl0bGUnPT4nUmVxdWlzaXRpb24nLAogICAgICAgICAgICAgICAgJ2Zyb20nID0+ICRmcm9tLCd0bycgPT4gJHRvLCdjYXRlZ29yeV9pZCcgPT4gJGNhdGVnb3J5X2lkLCdjYXRlZ29yaWVzJyA9PiAkY2F0ZWdvcmllcywnaGVhZGVyQ29sdW1ucyc9PiR0aGlzLT5oZWFkZXJDb2x1bW5zKCldKTsKCiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBoYWx0KCkKICAgIHsKICAgICAgICB0cnkgewoKICAgICAgICAgICAgJHRpdGxlID0gJ0hhbHQgUmVxdWlzaXRpb25zJzsKICAgICAgICAgICAgCiAgICAgICAgICAgICRmcm9tID0gcmVxdWVzdCgpLT5oYXMoJ2Zyb20nKSA/IHJlcXVlc3QoKS0+Z2V0KCdmcm9tJykgOiBkYXRlKCdZLW0tMDEnKTsKICAgICAgICAgICAgJHRvID0gcmVxdWVzdCgpLT5oYXMoJ3RvJykgPyByZXF1ZXN0KCktPmdldCgndG8nKSA6IGRhdGUoJ1ktbS10Jyk7CiAgICAgICAgICAgICRjYXRlZ29yeV9pZCA9IHJlcXVlc3QoKS0+aGFzKCdjYXRlZ29yeV9pZCcpID8gcmVxdWVzdCgpLT5nZXQoJ2NhdGVnb3J5X2lkJykgOiAwOwogICAgICAgICAgICAkY2F0ZWdvcnlJZHMgPSBDYXRlZ29yeURlcGFydG1lbnQ6OndoZW4oaXNzZXQoYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdocl9kZXBhcnRtZW50X2lkJywgYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKTsKICAgICAgICAgICAgfSktPnBsdWNrKCdjYXRlZ29yeV9pZCcpLT50b0FycmF5KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAkY2F0ZWdvcmllcyA9IENhdGVnb3J5Ojpkb2VzbnRIYXZlKCdjYXRlZ29yeScpCiAgICAgICAgICAgIC0+d2hlcmVJbignaWQnLCAkY2F0ZWdvcnlJZHMpCiAgICAgICAgICAgIC0+Z2V0KCk7CgogICAgICAgICAgICAkcmVxdWlzaXRpb25zID0gUmVxdWlzaXRpb246OndpdGgoWydpdGVtcycsJ2l0ZW1zLnByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknXSkKICAgICAgICAgICAgLT53aGVuKGlzc2V0KGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCksIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXV0aG9yX2lkJyxBdXRoOjp1c2VyKCktPmlkKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVuKHN0cnRvdGltZSgkZnJvbSk+MCwgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGZyb20pewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVEYXRlKCdyZXF1aXNpdGlvbl9kYXRlJywgJz49JywgJGZyb20pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oc3RydG90aW1lKCR0byk+MCwgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHRvKXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlRGF0ZSgncmVxdWlzaXRpb25fZGF0ZScsICc8PScsICR0byk7CiAgICAgICAgICAgIH0pCgogICAgICAgICAgICAtPndoZW4oJGNhdGVnb3J5X2lkPjAsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRjYXRlZ29yeV9pZCl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnaXRlbXMucHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRjYXRlZ29yeV9pZCl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lkJywgJGNhdGVnb3J5X2lkKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oIWVtcHR5KHJlcXVlc3QoKS0+Z2V0KCdzZWFyY2hfdGV4dCcpKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3JlZmVyZW5jZV9ubycsICdMSUtFJywgJyUnLnJlcXVlc3QoKS0+Z2V0KCdzZWFyY2hfdGV4dCcpLiclJykKICAgICAgICAgICAgICAgICAgICAtPm9yV2hlcmUoJ3JlbWFya3MnLCAnTElLRScsICclJy5yZXF1ZXN0KCktPmdldCgnc2VhcmNoX3RleHQnKS4nJScpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZUluKCdzdGF0dXMnLCBbMl0pOwoKICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+YWpheCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gRGF0YXRhYmxlczo6b2YoJHJlcXVpc2l0aW9ucykKICAgICAgICAgICAgICAgIC0+YWRkSW5kZXhDb2x1bW4oKQogICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbigkcmVxdWlzaXRpb24pewogICAgICAgICAgICAgICAgICAgIHJldHVybiAgJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgZGF0YS1zcmM9Iicucm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5saXN0LnZpZXcuc2hvdycsJHJlcXVpc2l0aW9uLT5pZCkuJyIgY2xhc3M9ImJ0biBidG4tbGluayByZXF1aXNpdGlvbiBtLTEgcm91bmRlZCBzaG93UmVxdWlzdGlvbkRldGFpbHMiIG9uY2xpY2s9InJlcXVpc3Rpb25EZXRhaWxzKCQodGhpcykpIj4nLiAkcmVxdWlzaXRpb24tPnJlZmVyZW5jZV9ubyAuJzwvYT4nOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1aXNpdGlvbl9kYXRlJywgZnVuY3Rpb24oJHJlcXVpc2l0aW9uKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZSgnWS1tLWQnLCBzdHJ0b3RpbWUoJHJlcXVpc2l0aW9uLT5yZXF1aXNpdGlvbl9kYXRlKSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3JlcXVpc2l0aW9uX2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3JlcXVpc2l0aW9uX2RhdGUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3JlcXVpc2l0aW9uX2RhdGUnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlckJ5KCdyZXF1aXNpdGlvbl9kYXRlJywgJG9yZGVyKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbigncHJvZHVjdF9jYXRlZ29yeScsIGZ1bmN0aW9uKCRyZXF1aXNpdGlvbil7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCRyZXF1aXNpdGlvbi0+aXRlbXNbMF0tPnByb2R1Y3QtPmNhdGVnb3J5LT5jYXRlZ29yeS0+bmFtZSk/JHJlcXVpc2l0aW9uLT5pdGVtc1swXS0+cHJvZHVjdC0+Y2F0ZWdvcnktPmNhdGVnb3J5LT5uYW1lOicnOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygnaXRlbXMucHJvZHVjdC5jYXRlZ29yeS5jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHBsZWFzZVNvcnRNZSgkcXVlcnksICRvcmRlciwgUmVxdWlzaXRpb25JdGVtOjpzZWxlY3QoJ21haW5fY2F0ZWdvcnkubmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbigncHJvZHVjdHMnLCAncHJvZHVjdHMuaWQnLCAnPScsICdyZXF1aXNpdGlvbl9pdGVtcy5wcm9kdWN0X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdjYXRlZ29yaWVzIGFzIHN1Yl9jYXRlZ29yeScsICdzdWJfY2F0ZWdvcnkuaWQnLCAnPScsICdwcm9kdWN0cy5jYXRlZ29yeV9pZCcpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+am9pbignY2F0ZWdvcmllcyBhcyBtYWluX2NhdGVnb3J5JywgJ21haW5fY2F0ZWdvcnkuaWQnLCAnPScsICdzdWJfY2F0ZWdvcnkucGFyZW50X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigncmVxdWlzaXRpb25faXRlbXMucmVxdWlzaXRpb25faWQnLCAncmVxdWlzaXRpb25zLmlkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT50YWtlKDEpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmVkaXRDb2x1bW4oJ3N0YXR1cycsIGZ1bmN0aW9uKCRyZXF1aXNpdGlvbil7CiAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyA9Jyc7CiAgICAgICAgICAgICAgICAgICAgJHN0YXR1cyAuPSc8cCBpZD0ic3RhdHVzJy4kcmVxdWlzaXRpb24tPmlkLiciPic7CiAgICAgICAgICAgICAgICAgICAgaWYoJHJlcXVpc2l0aW9uLT5zdGF0dXM9PTApewogICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzLj0nPHNwYW4gY2xhc3M9ImJ0biBidG4teHMgYnRuLXdhcm5pbmciPlBlbmRpbmc8L3NwYW4+JzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZWlmKCRyZXF1aXNpdGlvbi0+c3RhdHVzPT0xKXsKCiAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMuPSc8c3BhbiBjbGFzcz0iYnRuIGJ0bi14cyBidG4tc3VjY2VzcyI+QXBwcm92ZWQ8L3NwYW4+JzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZWlmKCRyZXF1aXNpdGlvbi0+c3RhdHVzPT0yKXsKICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cy49JzxzcGFuIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1kYW5nZXIiPkhhbHQ8L3NwYW4+JzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZWlmKCRyZXF1aXNpdGlvbi0+c3RhdHVzPT0zKXsKICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cy49JzxzcGFuIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi13YXJuaW5nIj5EcmFmdDwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49JzwvcD4nOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAkc3RhdHVzOwogICAgICAgICAgICAgICAgfSkKCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYXR0YWNobWVudCcsIGZ1bmN0aW9uKCRyZXF1aXNpdGlvbil7CiAgICAgICAgICAgICAgICAgICAgJGF0dGFjaG1lbnQgPScnOwogICAgICAgICAgICAgICAgICAgIGlmKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdFbXBsb3llZScpIHx8IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdEZXBhcnRtZW50LUhlYWQnKSB8fCBhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnUHVyY2hhc2UtRGVwYXJ0bWVudCcpKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWVtcHR5KCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkgJiYgZmlsZV9leGlzdHMocHVibGljX3BhdGgoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSkpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGF0dGFjaG1lbnQuPSc8YSBocmVmPSInLiB1cmwoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSAuJyIgdGFyZ2V0PSJfYmxhbmsiIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1wcmltYXJ5Ij48aSBjbGFzcz0ibGFzIGxhLXBhcGVyY2xpcCI+PC9pPkF0dGFjaG1lbnQ8L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRhdHRhY2htZW50OwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24oJHJlcXVpc2l0aW9uKXsKICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyA9ICcnOwoKICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucy49JzxkaXYgY2xhc3M9ImJ0bi1ncm91cCI+CiAgICAgICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGRyb3Bkb3duLXRvZ2dsZSIgZGF0YS10b2dnbGU9ImRyb3Bkb3duIj4KICAgICAgICAgICAgICAgICAgICA8c3BhbiBpZD0ic3RhdHVzTmFtZScuJHJlcXVpc2l0aW9uLT5pZC4nIj4KICAgICAgICAgICAgICAgICAgICA8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiBmaWxsPSJjdXJyZW50Q29sb3IiIGNsYXNzPSJiaSBiaS10aHJlZS1kb3RzLXZlcnRpY2FsIiB2aWV3Qm94PSIwIDAgMTYgMTYiPjxwYXRoIGQ9Ik05LjUgMTNhMS41IDEuNSAwIDEgMS0zIDAgMS41IDEuNSAwIDAgMSAzIDB6bTAtNWExLjUgMS41IDAgMSAxLTMgMCAxLjUgMS41IDAgMCAxIDMgMHptMC01YTEuNSAxLjUgMCAxIDEtMyAwIDEuNSAxLjUgMCAwIDEgMyAweiIvPjwvc3ZnPjwvc3Bhbj48L2J1dHRvbj4KICAgICAgICAgICAgICAgICAgICA8dWwgY2xhc3M9ImRyb3Bkb3duLW1lbnUiPgogICAgICAgICAgICAgICAgICAgIDxsaT48YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIHRpdGxlPSJUcmFja2luZyBSZXF1aXNpdGlvbiIgZGF0YS1zcmM9Iicucm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5saXN0LnZpZXcuc2hvdycsJHJlcXVpc2l0aW9uLT5pZCkuJyIgY2xhc3M9InNob3dSZXF1aXN0aW9uRGV0YWlscyIgIG9uY2xpY2s9InJlcXVpc3Rpb25EZXRhaWxzKCQodGhpcykpIj48aSBjbGFzcz0ibGEgbGEtZXllIj48L2k+IFZpZXc8L2E+PC9saT4nOwogICAgICAgICAgICAgICAgICAgICRhY3Rpb25zLj0nPGxpPgogICAgICAgICAgICAgICAgICAgIDxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgZGF0YS1yb2xlPSJkZWxldGUiIGRhdGEtc3JjPSInLiByb3V0ZSgncG1zLnJlcXVpc2l0aW9uLnJlcXVpc2l0aW9uLmRlc3Ryb3knLCAkcmVxdWlzaXRpb24tPmlkKSAuJyIgY2xhc3M9InRleHQtZGFuZ2VyIGRlbGV0ZUJ0biByZXF1aXNpdGlvbi1kZWxldGUiIG9uY2xpY2s9ImRlbGV0ZUJ0bigkKHRoaXMpKSI+PGkgY2xhc3M9ImxhcyBsYS10cmFzaCI+PC9pPiZuYnNwO0RlbGV0ZTwvYT4KICAgICAgICAgICAgICAgICAgICA8L2xpPic7CiAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMuPSc8bGk+PGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiB0aXRsZT0iVHJhY2tpbmcgUmVxdWlzaXRpb24iIGNsYXNzPSJ0cmFja2luZ1JlcXVpc3Rpb25TdGF0dXMiIG9uY2xpY2s9InRyYWNraW5nUmVxdWlzdGlvblN0YXR1cygkKHRoaXMpKSIgZGF0YS1pZD0iJy4kcmVxdWlzaXRpb24tPmlkLiciPjxpIGNsYXNzPSJsYSBsYS1tYXAiPjwvaT5UcmFjayBQcm9ncmVzczwvYT48L2xpPjwvdWw+PC9kaXY+JzsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGFjdGlvbnM7CgogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+cmF3Q29sdW1ucyhbJ3JlZmVyZW5jZV9ubycsJ3N0YXR1cycsJ2F0dGFjaG1lbnQnLCAnYWN0aW9ucyddKQogICAgICAgICAgICAgICAgLT5tYWtlKHRydWUpOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucmVxdWlzaXRpb25zLmhhbHQtaW5kZXgnLCBbJ3RpdGxlJz0+J1JlcXVpc2l0aW9uJywKICAgICAgICAgICAgICAgICdmcm9tJyA9PiAkZnJvbSwndG8nID0+ICR0bywnY2F0ZWdvcnlfaWQnID0+ICRjYXRlZ29yeV9pZCwnY2F0ZWdvcmllcycgPT4gJGNhdGVnb3JpZXMsJ2hlYWRlckNvbHVtbnMnPT4kdGhpcy0+aGVhZGVyQ29sdW1ucygpXSk7CgogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNob3cgdGhlIGZvcm0gZm9yIGNyZWF0aW5nIGEgbmV3IHJlc291cmNlLgogICAgICoKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gY3JlYXRlKCkKICAgIHsKICAgICAgICBpZiAoIWF1dGgoKS0+dXNlcigpLT5lbXBsb3llZSl7CiAgICAgICAgICAgIHJldHVybiByZWRpcmVjdCgpLT5iYWNrKCk7CiAgICAgICAgfQoKICAgICAgICB0cnkgewogICAgICAgICAgICAkdGFzayA9IG51bGw7CiAgICAgICAgICAgIGlmKHJlcXVlc3QoKS0+aGFzKCd0YXNrLWlkJykpewogICAgICAgICAgICAgICAgJHRhc2sgPSBQcm9qZWN0VGFzazo6d2l0aChbCiAgICAgICAgICAgICAgICAgICAgJ3N1YkRlbGl2ZXJhYmxlLmRlbGl2ZXJhYmxlLnByb2plY3QnCiAgICAgICAgICAgICAgICBdKS0+ZmluZE9yRmFpbChyZXF1ZXN0KCktPmdldCgndGFzay1pZCcpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAKICAgICAgICAgICAgJGNhdGVnb3J5SWQgPSBDYXRlZ29yeURlcGFydG1lbnQ6OndoZW4oaXNzZXQoYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdocl9kZXBhcnRtZW50X2lkJywgYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKTsKICAgICAgICAgICAgfSktPnBsdWNrKCdjYXRlZ29yeV9pZCcpLT50b0FycmF5KCk7CiAgICAgICAgICAgIAogICAgICAgICAgICAkY2F0ZWdvcmllcyA9IENhdGVnb3J5Ojpkb2VzbnRIYXZlKCdjYXRlZ29yeScpCiAgICAgICAgICAgIC0+d2l0aChbJ3N1YkNhdGVnb3J5J10pCiAgICAgICAgICAgIC0+d2hlcmVJbignaWQnLCAkY2F0ZWdvcnlJZCkKICAgICAgICAgICAgLT53aGVyZShbCiAgICAgICAgICAgICAgICAnaXNfZml4ZWRfYXNzZXQnID0+IDAsCiAgICAgICAgICAgICAgICAnaXNfY3dpcCcgPT4gMCwKICAgICAgICAgICAgXSkKICAgICAgICAgICAgLT5nZXQoKTsKICAgICAgICAgICAgJGZpeGVkQXNzZXRDYXRlZ29yaWVzID0gQ2F0ZWdvcnk6OmRvZXNudEhhdmUoJ2NhdGVnb3J5JykKICAgICAgICAgICAgLT53aXRoKFsnc3ViQ2F0ZWdvcnknXSkKICAgICAgICAgICAgLT53aGVyZUluKCdpZCcsICRjYXRlZ29yeUlkKQogICAgICAgICAgICAtPndoZXJlKFsKICAgICAgICAgICAgICAgICdpc19maXhlZF9hc3NldCcgPT4gMSwKICAgICAgICAgICAgICAgICdpc19jd2lwJyA9PiAwLAogICAgICAgICAgICBdKQogICAgICAgICAgICAtPmdldCgpOwogICAgICAgICAgICAkY3dpcENhdGVnb3JpZXMgPSBDYXRlZ29yeTo6ZG9lc250SGF2ZSgnY2F0ZWdvcnknKQogICAgICAgICAgICAtPndpdGgoWydzdWJDYXRlZ29yeSddKQogICAgICAgICAgICAtPndoZXJlSW4oJ2lkJywgJGNhdGVnb3J5SWQpCiAgICAgICAgICAgIC0+d2hlcmUoWwogICAgICAgICAgICAgICAgJ2lzX2ZpeGVkX2Fzc2V0JyA9PiAwLAogICAgICAgICAgICAgICAgJ2lzX2N3aXAnID0+IDEsCiAgICAgICAgICAgIF0pCiAgICAgICAgICAgIC0+Z2V0KCk7CgogICAgICAgICAgICAkdGl0bGUgPSAnQ3JlYXRlIFJlcXVpc2l0aW9uJzsKICAgICAgICAgICAgJHJlcXVpc2l0aW9uID0gbnVsbDsKCiAgICAgICAgICAgICRwcmVmaXggPSAnUlEtJy5kYXRlKCd5Jywgc3RydG90aW1lKGRhdGUoJ1ktbS1kJykpKS4nLScuYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT51bml0LT5ocl91bml0X3Nob3J0X25hbWUuJy0nOwogICAgICAgICAgICAkcmVmTm8gPSB1bmlxdWVDb2RlKDE2LCRwcmVmaXgsJ3JlcXVpc2l0aW9ucycsJ2lkJyk7CgogICAgICAgICAgICAvLyAkcHJvamVjdHMgPSBbXTsKICAgICAgICAgICAgLy8gJHRhc2tzID0gUHJvamVjdFRhc2s6OndpdGgoWwogICAgICAgICAgICAvLyAgICAgJ3N1YkRlbGl2ZXJhYmxlLmRlbGl2ZXJhYmxlLnByb2plY3QnCiAgICAgICAgICAgIC8vIF0pCiAgICAgICAgICAgIC8vIC0+d2hlcmUoJ3VzZXJfaWQnLCBhdXRoKCktPnVzZXIoKS0+aWQpCiAgICAgICAgICAgIC8vIC0+Z2V0KCk7CiAgICAgICAgICAgIC8vIGlmKGlzc2V0KCR0YXNrc1swXSkpewogICAgICAgICAgICAvLyAgICAgZm9yZWFjaCAoJHRhc2tzIGFzICR0YXNrKXsKICAgICAgICAgICAgLy8gICAgICAgICAkcHJvamVjdHNbXSA9ICR0YXNrLT5zdWJEZWxpdmVyYWJsZS0+ZGVsaXZlcmFibGUtPnByb2plY3Q7CiAgICAgICAgICAgIC8vICAgICB9CiAgICAgICAgICAgIC8vIH0KCiAgICAgICAgICAgIC8vICRwcm9qZWN0cyA9IFByb2plY3Q6OndoZXJlSW4oImlkIiwgYXJyYXlfa2V5cyhjb2xsZWN0KCRwcm9qZWN0cyktPmdyb3VwQnkoJ2lkJyktPnRvQXJyYXkoKSkpLT5nZXQoKTsKCiAgICAgICAgICAgICR1bml0SWQgPSBpc3NldChhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX3VuaXRfaWQpP2F1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfdW5pdF9pZDpudWxsOwoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnJlcXVpc2l0aW9ucy5jcmVhdGUnLCBjb21wYWN0KCd0aXRsZScsICdyZXF1aXNpdGlvbicsICdyZWZObycsICdjYXRlZ29yaWVzJywgJ2ZpeGVkQXNzZXRDYXRlZ29yaWVzJywgJ2N3aXBDYXRlZ29yaWVzJywgJ3VuaXRJZCcsICd0YXNrJykpOwogICAgICAgIH1jYXRjaCAoVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgfQogICAgfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBsb2FkUHJvamVjdFdpc2VEZWxpdmVyYWJsZXMoUHJvamVjdCAkcHJvamVjdCA9IG51bGwpCiAgICB7CiAgICAgICAgJGRlbGl2ZXJhYmxlcyA9IFtdOwogICAgICAgIGZvcmVhY2ggKEF1dGg6OnVzZXIoKS0+cHJvamVjdFRhc2sgYXMgJHRhc2spewogICAgICAgICAgICBpZiAoJHRhc2stPnN1YkRlbGl2ZXJhYmxlLT5kZWxpdmVyYWJsZS0+cHJvamVjdF9pZCA9PSAkcHJvamVjdC0+aWQpewogICAgICAgICAgICAgICAgJGRlbGl2ZXJhYmxlc1tdID0gJHRhc2stPnN1YkRlbGl2ZXJhYmxlLT5kZWxpdmVyYWJsZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICAkZGVsaXZlcmFibGVzID0gYXJyYXlfa2V5cyhjb2xsZWN0KCRkZWxpdmVyYWJsZXMpLT5ncm91cEJ5KCdpZCcpLT50b0FycmF5KCkpOwogICAgICAgICRkZWxpdmVyYWJsZXMgPSBEZWxpdmVyYWJsZXM6OndoZXJlSW4oImlkIiwgJGRlbGl2ZXJhYmxlcyktPmdldCgpOwoKICAgICAgICAkb3V0cHV0ID0gW107CiAgICAgICAgJG91dHB1dFtdID0gIjxvcHRpb24+U2VsZWN0IE9uZTwvb3B0aW9uPiI7CiAgICAgICAgZm9yZWFjaCAoJGRlbGl2ZXJhYmxlcyBhcyAkZGVsaXZlcmFibGUpewogICAgICAgICAgICAkb3V0cHV0W10gPSAnPG9wdGlvbiB2YWx1ZT0iJy4kZGVsaXZlcmFibGUtPmlkLiciPicuJGRlbGl2ZXJhYmxlLT5uYW1lLic8L29wdGlvbj4nOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihpbXBsb2RlKCcsJywkb3V0cHV0KSk7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGxvYWRDYXRlZ29yeVdpc2VQcm9kdWN0cygkY2F0ZWdvcnlJZCxSZXF1ZXN0ICRyZXF1ZXN0KXsKICAgICAgICAkcmVzcG9uc2U9Jyc7CgogICAgICAgICRjYXRlZ29yeUlkcyA9IENhdGVnb3J5RGVwYXJ0bWVudDo6d2hlbihpc3NldChhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaHJfZGVwYXJ0bWVudF9pZCcsIGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCk7CiAgICAgICAgfSktPnBsdWNrKCdjYXRlZ29yeV9pZCcpLT50b0FycmF5KCk7CgoKICAgICAgICAkY2F0ZWdvcnlQcm9kdWN0cz1Qcm9kdWN0Ojp3aXRoKFsKICAgICAgICAgICAgJ3Byb2R1Y3RVbml0JywgJ2NhdGVnb3J5LmNhdGVnb3J5JywgJ2F0dHJpYnV0ZXMuYXR0cmlidXRlT3B0aW9uLmF0dHJpYnV0ZScKICAgICAgICBdKQogICAgICAgIC0+d2hlcmUoJ3N0YXR1cycsICdhcHByb3ZlZCcpCiAgICAgICAgLT53aGVuKCFlbXB0eSgkY2F0ZWdvcnlJZCksIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRjYXRlZ29yeUlkKXsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGNhdGVnb3J5SWQpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2NhdGVnb3J5X2lkJywgJGNhdGVnb3J5SWQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KQogICAgICAgIC0+d2hlcmVIYXMoJ2NhdGVnb3J5JywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3BhcmVudF9pZCcsIHJlcXVlc3QoKS0+Z2V0KCdwYXJlbnRfaWQnKSk7CiAgICAgICAgfSkKICAgICAgICAtPndoZXJlKCdpc19maW5hbF9hc3NldCcsIDApCiAgICAgICAgLT53aGVyZUluKCdjYXRlZ29yeV9pZCcsICRjYXRlZ29yeUlkcyk7CgogICAgICAgIGlmIChpc3NldCgkcmVxdWVzdC0+cHJvZHVjdHNfaWQpKXsKICAgICAgICAgICAgJGV4aXN0ZWRQcm9kdWN0cyA9IGV4cGxvZGUoJywnLCRyZXF1ZXN0LT5wcm9kdWN0c19pZCk7CiAgICAgICAgICAgIGlmKHJlcXVlc3QoKS0+aGFzKCdzZWxlY3RlZCcpKXsKICAgICAgICAgICAgICAgICRleGlzdGVkUHJvZHVjdHMgPSBhcnJheV9kaWZmKCRleGlzdGVkUHJvZHVjdHMsIFtyZXF1ZXN0KCktPmdldCgnc2VsZWN0ZWQnKV0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICAkY2F0ZWdvcnlQcm9kdWN0cyA9ICRjYXRlZ29yeVByb2R1Y3RzLT53aGVyZU5vdEluKCdpZCcsICRleGlzdGVkUHJvZHVjdHMpOwogICAgICAgIH0KCiAgICAgICAgJGNhdGVnb3J5UHJvZHVjdHM9JGNhdGVnb3J5UHJvZHVjdHMtPmdldCgpOwoKICAgICAgICAkcmVzcG9uc2UgLj0gJzxzZWxlY3QgbmFtZT0icHJvZHVjdF9pZFtdIiBpZD0icHJvZHVjdF8xIiBjbGFzcz0iZm9ybS1jb250cm9sIHNlbGVjdDIgcHJvZHVjdCIgb25jaGFuZ2U9ImdldFVPTSgpIiByZXF1aXJlZD4nOwogICAgICAgICRyZXNwb25zZSAuPSAnPG9wdGlvbiB2YWx1ZT0iIiBkYXRhLXVvbT0iIj5TZWxlY3QgUHJvZHVjdDwvb3B0aW9uPic7CiAgICAgICAgaWYgKCFlbXB0eSgkY2F0ZWdvcnlQcm9kdWN0cykpIHsKICAgICAgICAgICAgZm9yZWFjaCAoJGNhdGVnb3J5UHJvZHVjdHMgYXMgJGRhdGEpIHsKICAgICAgICAgICAgICAgICRyZXNwb25zZS49ICc8b3B0aW9uIGRhdGEtdW9tPSInLigkZGF0YS0+cHJvZHVjdFVuaXQgPyAkZGF0YS0+cHJvZHVjdFVuaXQtPnVuaXRfbmFtZSA6ICcnKS4nIiB2YWx1ZT0iJyAuICRkYXRhLT5pZCAuICciIGRhdGEtc3ViLWNhdGVnb3J5LWlkPSInIC4gJGRhdGEtPmNhdGVnb3J5X2lkIC4nIiBkYXRhLWNhdGVnb3J5LWlkPSInIC4gJGRhdGEtPmNhdGVnb3J5LT5wYXJlbnRfaWQgLiciICcuKHJlcXVlc3QoKS0+Z2V0KCdzZWxlY3RlZCcpID09ICRkYXRhLT5pZCA/ICdzZWxlY3RlZCcgOiAnJykuJz4nLiAkZGF0YS0+bmFtZSAuICcgJy5nZXRQcm9kdWN0QXR0cmlidXRlc0Zhc3RlcigkZGF0YSkuJzwvb3B0aW9uPic7CiAgICAgICAgICAgIH0KICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgJHJlc3BvbnNlIC49ICI8b3B0aW9uIHZhbHVlPScnPk5vIFByb2R1Y3QgRm91bmQhITwvb3B0aW9uPiI7CiAgICAgICAgfQogICAgICAgICRyZXNwb25zZSAuPSAiPC9zZWxlY3Q+IjsKCiAgICAgICAgcmV0dXJuICRyZXNwb25zZTsKICAgIH0KICAgIAogICAgcHVibGljIGZ1bmN0aW9uIGxvYWRDYXRlZ29yeVdpc2VTdWJjYXRlZ29yeSgkY2F0ZWdvcnlJZCl7CiAgICAgICAgJHJlc3BvbnNlID0gJyc7CiAgICAgICAgJHN1YkNhdGVnb3J5PUNhdGVnb3J5Ojp3aGVuKCFlbXB0eSgkY2F0ZWdvcnlJZCksIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRjYXRlZ29yeUlkKXsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3BhcmVudF9pZCcsJGNhdGVnb3J5SWQpOwogICAgICAgIH0pLT5nZXQoKTsKCiAgICAgICAgaWYgKGlzc2V0KCRzdWJDYXRlZ29yeSkgJiYgY291bnQoKGFycmF5KSRzdWJDYXRlZ29yeSk+MCkgewogICAgICAgICAgICAkcmVzcG9uc2UgLj0gJzxvcHRpb24gdmFsdWU9IiI+LS1TZWxlY3QgU3ViY2F0ZWdvcnktLTwvb3B0aW9uPic7CiAgICAgICAgICAgIGZvcmVhY2ggKCRzdWJDYXRlZ29yeSBhcyAkZGF0YSkgewogICAgICAgICAgICAgICAgJHJlc3BvbnNlLj0gJzxvcHRpb24gdmFsdWU9IicuJGRhdGEtPmlkLiciPicuJGRhdGEtPm5hbWUuJygnLiRkYXRhLT5jb2RlLicpJy4nPC9vcHRpb24+JzsKICAgICAgICAgICAgfQogICAgICAgIH1lbHNlewogICAgICAgICAgICAkcmVzcG9uc2UgLj0gIjxvcHRpb24gdmFsdWU9Jyc+Tm8gQ2F0ZWdvcnkgRm91bmQhITwvb3B0aW9uPiI7CiAgICAgICAgfQogICAgICAgIAogICAgICAgIHJldHVybiAkcmVzcG9uc2U7CiAgICB9CgogICAgLyoqCiAgICAgKiBTdG9yZSBhIG5ld2x5IGNyZWF0ZWQgcmVzb3VyY2UgaW4gc3RvcmFnZS4KICAgICAqCiAgICAgKiBAcGFyYW0gIFxJbGx1bWluYXRlXEh0dHBcUmVxdWVzdCAgJHJlcXVlc3QKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIHN0b3JlKFJlcXVlc3QgJHJlcXVlc3QsICRlZGl0ID0gZmFsc2UpCiAgICB7CiAgICAgICAgJHJlcXVlc3QtPnZhbGlkYXRlKFsKICAgICAgICAgICAgJ3JlbWFya3MnID0+ICdyZXF1aXJlZCcsCiAgICAgICAgICAgICdwcm9kdWN0X2lkJyA9PiAncmVxdWlyZWQnLAogICAgICAgICAgICAncHJvZHVjdF9pZC4qJyA9PiAncmVxdWlyZWQnLAogICAgICAgIF0pOwogICAgICAgIAogICAgICAgIGlmKCRyZXF1ZXN0LT5oYXNGaWxlKCdmaWxlJykpewogICAgICAgICAgICAkdGhpcy0+dmFsaWRhdGUoJHJlcXVlc3QsIFsKICAgICAgICAgICAgICAgICdmaWxlJyA9PiBbJ21heDoxMDAwMCddLAogICAgICAgICAgICBdKTsKICAgICAgICB9CgogICAgICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgIC8vVGFzayBCdWRnZXQgVmFsaWRhdGlvbgogICAgICAgICAgICAkcHJvamVjdF90YXNrX2lkID0gKCRyZXF1ZXN0LT5hcHByb3ZhbF9xdHk9PSd0cnVlJykgPyAkcmVxdWVzdC0+cHJvamVjdF90YXNrX2lkIDogKGlzc2V0KCRyZXF1ZXN0LT5wcm9qZWN0X3Rhc2tfaWQpID8gJHJlcXVlc3QtPnByb2plY3RfdGFza19pZCA6IG51bGwpOwogICAgICAgICAgICAkcHJvamVjdFRhc2sgPSBQcm9qZWN0VGFzazo6ZmluZCgkcHJvamVjdF90YXNrX2lkKTsKICAgICAgICAgICAgaWYoaXNzZXQoJHByb2plY3RUYXNrLT5pZCkpewogICAgICAgICAgICAgICAgJGNvbnN1bXB0aW9ucyA9IDA7CiAgICAgICAgICAgICAgICBpZihpc3NldCgkcHJvamVjdFRhc2stPnJlcXVpc2l0aW9uc1swXSkpewogICAgICAgICAgICAgICAgICAgIGZvcmVhY2goJHByb2plY3RUYXNrLT5yZXF1aXNpdGlvbnMgYXMgJGtleSA9PiAkdGhpc19yZXF1aXNpdGlvbil7CiAgICAgICAgICAgICAgICAgICAgICAgICRjb25zdW1wdGlvbnMgKz0gZXN0aW1hdGVkVmFsdWUoJHRoaXNfcmVxdWlzaXRpb24pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KCiAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb25fY29uc3VtcHRpb24gPSAwOwogICAgICAgICAgICAgICAgZm9yZWFjaCAoJHJlcXVlc3QtPnF0eSBhcyAka2V5ID0+ICRxdHkpewogICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbl9jb25zdW1wdGlvbiArPSBQcm9kdWN0OjpmaW5kKCRyZXF1ZXN0LT5wcm9kdWN0X2lkWyRrZXldKS0+dW5pdF9wcmljZSokcXR5OwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRjb25zdW1wdGlvbnMgKz0gJHJlcXVpc2l0aW9uX2NvbnN1bXB0aW9uOwoKICAgICAgICAgICAgICAgIGlmKCRjb25zdW1wdGlvbnMgPiAkcHJvamVjdFRhc2stPnN1YkRlbGl2ZXJhYmxlLT5idWRnZXQpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcignUHJvamVjdCBCdWRnZXQgYWxsb2NhdGlvbiAoJy4kcHJvamVjdFRhc2stPmJ1ZGdldC4nIEJEVCkgaGFzIGJlZW4gZXhjZWVkZWQgZm9yIHRoaXMgcmVxdWlzaXRpb24gKCcuJHJlcXVpc2l0aW9uX2NvbnN1bXB0aW9uLicgQkRUKS4gUmVtYWluaW5nIEJ1ZGdldCBpcyAoJy4oJHByb2plY3RUYXNrLT5zdWJEZWxpdmVyYWJsZS0+YnVkZ2V0ID4gJGNvbnN1bXB0aW9ucyA/ICRwcm9qZWN0VGFzay0+c3ViRGVsaXZlcmFibGUtPmJ1ZGdldCAtICRjb25zdW1wdGlvbnMgOiAwKS4nIEJEVCknKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICAvL1Rhc2sgQnVkZ2V0IFZhbGlkYXRpb24KCiAgICAgICAgICAgICRyZXF1aXNpdGlvbj1SZXF1aXNpdGlvbjo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvbic9PnVuaXF1ZVN0cmluZ0dlbmVyYXRvcigpLAogICAgICAgICAgICAgICAgJ3JlZmVyZW5jZV9ubyc9PiRyZXF1ZXN0LT5yZWZlcmVuY2Vfbm8sCgogICAgICAgICAgICAgICAgJ2hyX3VuaXRfaWQnPT5pc3NldCgkcmVxdWVzdC0+aHJfdW5pdF9pZCk/JHJlcXVlc3QtPmhyX3VuaXRfaWQ6bnVsbCwKCiAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25fZGF0ZSc9PmRhdGUoJ1ktbS1kIGg6aScsc3RydG90aW1lKCRyZXF1ZXN0LT5yZXF1aXNpdGlvbl9kYXRlKSksCiAgICAgICAgICAgICAgICAnYXV0aG9yX2lkJz0+KCRyZXF1ZXN0LT5hcHByb3ZhbF9xdHk9PSd0cnVlJyk/JHJlcXVlc3QtPmF1dGhvcl9pZDpBdXRoOjp1c2VyKCktPmlkLAoKICAgICAgICAgICAgICAgICdwcm9qZWN0X2lkJz0+KCRyZXF1ZXN0LT5hcHByb3ZhbF9xdHk9PSd0cnVlJyk/JHJlcXVlc3QtPnByb2plY3RfaWQ6KGlzc2V0KCRyZXF1ZXN0LT5wcm9qZWN0X2lkKT8kcmVxdWVzdC0+cHJvamVjdF9pZDpudWxsKSwKCiAgICAgICAgICAgICAgICAnZGVsaXZlcmFibGVfaWQnID0+KCRyZXF1ZXN0LT5hcHByb3ZhbF9xdHk9PSd0cnVlJyk/JHJlcXVlc3QtPmRlbGl2ZXJhYmxlX2lkOihpc3NldCgkcmVxdWVzdC0+ZGVsaXZlcmFibGVfaWQpPyRyZXF1ZXN0LT5kZWxpdmVyYWJsZV9pZDpudWxsKSwKCiAgICAgICAgICAgICAgICAncHJvamVjdF90YXNrX2lkJyA9PigkcmVxdWVzdC0+YXBwcm92YWxfcXR5PT0ndHJ1ZScpPyRyZXF1ZXN0LT5wcm9qZWN0X3Rhc2tfaWQ6KGlzc2V0KCRyZXF1ZXN0LT5wcm9qZWN0X3Rhc2tfaWQpPyRyZXF1ZXN0LT5wcm9qZWN0X3Rhc2tfaWQ6bnVsbCksCiAgICAgICAgICAgICAgICAnc3RhdHVzJz0+KCRyZXF1ZXN0LT5hcHByb3ZhbF9xdHk9PSd0cnVlJyk/MDozLAogICAgICAgICAgICAgICAgJ3JlbWFya3MnPT4kcmVxdWVzdC0+cmVtYXJrcywKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICBpZigkcmVxdWVzdC0+aGFzRmlsZSgnZmlsZScpKXsKICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCA9ICR0aGlzLT5maWxlVXBsb2FkKCRyZXF1ZXN0LT5maWxlKCdmaWxlJyksICd1cGxvYWQvcmVxdWlzaXRpb24tYXR0YWNobWVudHMnKTsKICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbi0+c2F2ZSgpOwogICAgICAgICAgICB9CgogICAgICAgICAgICBmb3JlYWNoICgkcmVxdWVzdC0+cXR5IGFzICRrZXk9PiRxdHkpewogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uSXRlbUlucHV0W109WwogICAgICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvbl9pZCc9PiRyZXF1aXNpdGlvbi0+aWQsCiAgICAgICAgICAgICAgICAgICAgJ3Byb2R1Y3RfaWQnPT4kcmVxdWVzdC0+cHJvZHVjdF9pZFska2V5XSwKICAgICAgICAgICAgICAgICAgICAncXR5Jz0+JHF0eSwKICAgICAgICAgICAgICAgICAgICAncmVxdWlzaXRpb25fcXR5Jz0+KCRyZXF1ZXN0LT5hcHByb3ZhbF9xdHk9PSd0cnVlJyk/KGlzc2V0KCRyZXF1ZXN0LT5vbGRfcXR5WyRrZXldKT8kcmVxdWVzdC0+b2xkX3F0eVska2V5XTokcXR5KTokcXR5LAogICAgICAgICAgICAgICAgICAgICdjcmVhdGVkX2F0Jz0+ZGF0ZSgnWS1tLWQgaDppJyksCiAgICAgICAgICAgICAgICAgICAgJ2NyZWF0ZWRfYnknPT4oJHJlcXVlc3QtPmFwcHJvdmFsX3F0eT09J3RydWUnKT8kcmVxdWVzdC0+YXV0aG9yX2lkOkF1dGg6OnVzZXIoKS0+aWQsCiAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICB9CgogICAgICAgICAgICBSZXF1aXNpdGlvbkl0ZW06Omluc2VydCgkcmVxdWlzaXRpb25JdGVtSW5wdXQpOwoKICAgICAgICAgICAgUmVxdWlzaXRpb25UcmFja2luZzo6c3RvcmVSZXF1aXNpdGlvblRyYWNraW5nKCRyZXF1aXNpdGlvbi0+aWQsJ3BlbmRpbmcnKTsKCiAgICAgICAgICAgIC8vSW5zZXJ0IG5vdGVzIGxvZ2dpbmcKICAgICAgICAgICAgUmVxdWlzaXRpb25Ob3RlTG9nczo6Y3JlYXRlKFsKICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvbl9pZCc9PiRyZXF1aXNpdGlvbi0+aWQsCiAgICAgICAgICAgICAgICAnbm90ZXMnPT4kcmVxdWVzdC0+cmVtYXJrcywKICAgICAgICAgICAgICAgICd0eXBlJz0+KCRyZXF1ZXN0LT5hcHByb3ZhbF9xdHk9PSd0cnVlJyk/J2RlcGFydG1lbnQtaGVhZCc6J3JlcXVpc2l0aW9uJywKICAgICAgICAgICAgXSk7CgogICAgICAgICAgICAvL1RyYWNraW5nCiAgICAgICAgICAgIERCOjpjb21taXQoKTsKCiAgICAgICAgICAgIGlmICgkZWRpdD09ZmFsc2UpewogICAgICAgICAgICAgICAgaWYoaXNzZXQoJHJlcXVlc3QtPndoZXJlX3RvX2dvKSAmJiAkcmVxdWVzdC0+d2hlcmVfdG9fZ28gPT0gJ2JhY2snKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoU3VjY2VzcygnUmVxdWlzaXRpb24gaGFzIGJlZW4gc3VjY2Vzc2Z1bGx5IGFwcGxpZWQnKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5yZWRpcmVjdEJhY2tXaXRoU3VjY2VzcygnUmVxdWlzaXRpb24gaGFzIGJlZW4gc3VjY2Vzc2Z1bGx5IGFwcGxpZWQnLCdwbXMucmVxdWlzaXRpb24ucmVxdWlzaXRpb24uaW5kZXgnKTsKICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICByZXR1cm4gJHJlcXVpc2l0aW9uOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCgogICAgLyoqCiAgICAgKiBEaXNwbGF5IHRoZSBzcGVjaWZpZWQgcmVzb3VyY2UuCiAgICAgKgogICAgICogQHBhcmFtICBcQXBwXE1vZGVsc1xSZXF1aXNpdGlvbiAgJHJlcXVpc2l0aW9uCiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwogICAgcHVibGljIGZ1bmN0aW9uIHNob3coUmVxdWlzaXRpb24gJHJlcXVpc2l0aW9uKQogICAgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgICR0aXRsZSA9ICdSZXF1aXNpdGlvbiBTaG93JzsKICAgICAgICAgICAgJHJlcXVpc2l0aW9uID0gUmVxdWlzaXRpb246OndpdGgoJ2l0ZW1zJywnaXRlbXMucHJvZHVjdCcsJ2l0ZW1zLnByb2R1Y3QuY2F0ZWdvcnknLCdwcm9qZWN0VGFzaycpLT5maW5kT3JGYWlsKCRyZXF1aXNpdGlvbi0+aWQpOwoKICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnJlcXVpc2l0aW9ucy5zaG93JywgY29tcGFjdCgndGl0bGUnLCdyZXF1aXNpdGlvbicpKTsKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIHNob3dSZXF1aXNpdGlvbigkaWQpCiAgICB7CiAgICAgICAgdHJ5IHsKCiAgICAgICAgICAgICR0aXRsZSA9ICdSZXF1aXNpdGlvbiBTaG93JzsKICAgICAgICAgICAgJHJlcXVpc2l0aW9uID0gUmVxdWlzaXRpb246OndpdGgoWwogICAgICAgICAgICAgICAgJ3Byb2plY3RUYXNrLnN1YkRlbGl2ZXJhYmxlLmRlbGl2ZXJhYmxlLnByb2plY3QnLAogICAgICAgICAgICAgICAgJ2l0ZW1zLnByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLAogICAgICAgICAgICAgICAgJ2l0ZW1zLnByb2R1Y3QucHJvZHVjdFVuaXQnLAogICAgICAgICAgICAgICAgJ2l0ZW1zLnByb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywKICAgICAgICAgICAgICAgICdpdGVtcy5wcm9kdWN0LnJlbEludmVudG9yeVN1bW1hcnknLAogICAgICAgICAgICAgICAgJ3JlbFVzZXJzTGlzdC5lbXBsb3llZS5sb2NhdGlvbicsCiAgICAgICAgICAgICAgICAncmVsVXNlcnNMaXN0LmVtcGxveWVlLmRlcGFydG1lbnQnLAogICAgICAgICAgICAgICAgJ3JlbFVzZXJzTGlzdC5lbXBsb3llZS51bml0JwogICAgICAgICAgICBdKS0+ZmluZE9yRmFpbCgkaWQpOwoKICAgICAgICAgICAgJGJvZHkgPSBWaWV3OjptYWtlKCdwbXMuYmFja2VuZC5wYWdlcy5yZXF1aXNpdGlvbnMuc2hvdycsCiAgICAgICAgICAgICAgICBbJ3JlcXVpc2l0aW9uJz0+ICRyZXF1aXNpdGlvbiwndGl0bGUnPT4gJHRpdGxlXSk7CiAgICAgICAgICAgICRjb250ZW50cyA9ICRib2R5LT5yZW5kZXIoKTsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmhhcygndmlldycpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJGNvbnRlbnRzOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbigkY29udGVudHMpOwogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFNob3cgdGhlIGZvcm0gZm9yIGVkaXRpbmcgdGhlIHNwZWNpZmllZCByZXNvdXJjZS4KICAgICAqCiAgICAgKiBAcGFyYW0gIFxBcHBcTW9kZWxzXFJlcXVpc2l0aW9uICAkcmVxdWlzaXRpb24KICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gZWRpdCgkaWQpCiAgICB7ICAgCiAgICAgICAgJHJlcXVpc2l0aW9uID0gUmVxdWlzaXRpb246OndpdGgoWwogICAgICAgICAgICAncmVxdWlzaXRpb25JdGVtcy5wcm9kdWN0JwogICAgICAgIF0pCiAgICAgICAgLT53aGVuKGlzc2V0KEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpICYmIGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdFbXBsb3llZScpLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXV0aG9yX2lkJyxBdXRoOjp1c2VyKCktPmlkKTsKICAgICAgICB9KQogICAgICAgIC0+d2hlbihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRGVwYXJ0bWVudC1IZWFkJyksIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSW4oJ2F1dGhvcl9pZCcsIGluY2x1ZGVVc2VycygpKTsKICAgICAgICB9KQogICAgICAgIC0+d2hlbihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnU0JVIEhlYWQnKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVJbignYXV0aG9yX2lkJywgaW5jbHVkZVVzZXJzKCkpOwogICAgICAgIH0pCiAgICAgICAgLT53aGVyZSgnaWQnLCRpZCkKICAgICAgICAtPmZpcnN0KCk7CgogICAgICAgIGlmICghZW1wdHkoJHJlcXVpc2l0aW9uKSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgJHRpdGxlID0gJ1JlcXVpc2l0aW9uIFVwZGF0ZSc7CgogICAgICAgICAgICAgICAgJGNhdGVnb3J5SWQgPSBDYXRlZ29yeURlcGFydG1lbnQ6OndoZW4oaXNzZXQoYXV0aCgpLT51c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaHJfZGVwYXJ0bWVudF9pZCcsIGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCk7CiAgICAgICAgICAgICAgICB9KS0+cGx1Y2soJ2NhdGVnb3J5X2lkJyktPnRvQXJyYXkoKTsKCiAgICAgICAgICAgICAgICAkY2F0ZWdvcmllcyA9IENhdGVnb3J5Ojpkb2VzbnRIYXZlKCdjYXRlZ29yeScpCiAgICAgICAgICAgICAgICAtPndpdGgoWydzdWJDYXRlZ29yeSddKQogICAgICAgICAgICAgICAgLT53aGVyZUluKCdpZCcsICRjYXRlZ29yeUlkKQogICAgICAgICAgICAgICAgLT53aGVyZShbCiAgICAgICAgICAgICAgICAgICAgJ2lzX2ZpeGVkX2Fzc2V0JyA9PiAwLAogICAgICAgICAgICAgICAgICAgICdpc19jd2lwJyA9PiAwLAogICAgICAgICAgICAgICAgXSkKICAgICAgICAgICAgICAgIC0+Z2V0KCk7CiAgICAgICAgICAgICAgICAkZml4ZWRBc3NldENhdGVnb3JpZXMgPSBDYXRlZ29yeTo6ZG9lc250SGF2ZSgnY2F0ZWdvcnknKQogICAgICAgICAgICAgICAgLT53aXRoKFsnc3ViQ2F0ZWdvcnknXSkKICAgICAgICAgICAgICAgIC0+d2hlcmVJbignaWQnLCAkY2F0ZWdvcnlJZCkKICAgICAgICAgICAgICAgIC0+d2hlcmUoWwogICAgICAgICAgICAgICAgICAgICdpc19maXhlZF9hc3NldCcgPT4gMSwKICAgICAgICAgICAgICAgICAgICAnaXNfY3dpcCcgPT4gMCwKICAgICAgICAgICAgICAgIF0pCiAgICAgICAgICAgICAgICAtPmdldCgpOwogICAgICAgICAgICAgICAgJGN3aXBDYXRlZ29yaWVzID0gQ2F0ZWdvcnk6OmRvZXNudEhhdmUoJ2NhdGVnb3J5JykKICAgICAgICAgICAgICAgIC0+d2l0aChbJ3N1YkNhdGVnb3J5J10pCiAgICAgICAgICAgICAgICAtPndoZXJlSW4oJ2lkJywgJGNhdGVnb3J5SWQpCiAgICAgICAgICAgICAgICAtPndoZXJlKFsKICAgICAgICAgICAgICAgICAgICAnaXNfZml4ZWRfYXNzZXQnID0+IDAsCiAgICAgICAgICAgICAgICAgICAgJ2lzX2N3aXAnID0+IDEsCiAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgLT5nZXQoKTsKCiAgICAgICAgICAgICAgICAkY2F0ZWdvcnkgPSBDYXRlZ29yeTo6d2hlcmVIYXMoJ3N1YkNhdGVnb3J5LnByb2R1Y3RzJywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHJlcXVpc2l0aW9uKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdpZCcsICRyZXF1aXNpdGlvbi0+aXRlbXMtPnBsdWNrKCdwcm9kdWN0X2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgICAgICAgICB9KS0+Zmlyc3QoKTsKICAgICAgICAgICAgICAgICRjYXRlZ29yeV9pZCA9IChpc3NldCgkY2F0ZWdvcnktPmlkKSA/ICRjYXRlZ29yeS0+aWQgOiAwKTsKCgogICAgICAgICAgICAgICAgJHByb2plY3RzID0gW107CiAgICAgICAgICAgICAgICAkdGFza3MgPSBQcm9qZWN0VGFzazo6d2l0aChbCiAgICAgICAgICAgICAgICAgICAgJ3N1YkRlbGl2ZXJhYmxlLmRlbGl2ZXJhYmxlLnByb2plY3QnCiAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgLT53aGVyZSgndXNlcl9pZCcsIGF1dGgoKS0+dXNlcigpLT5pZCkKICAgICAgICAgICAgICAgIC0+Z2V0KCk7CiAgICAgICAgICAgICAgICBpZihpc3NldCgkdGFza3NbMF0pKXsKICAgICAgICAgICAgICAgICAgICBmb3JlYWNoICgkdGFza3MgYXMgJHRhc2spewogICAgICAgICAgICAgICAgICAgICAgICAkcHJvamVjdHNbXSA9ICR0YXNrLT5zdWJEZWxpdmVyYWJsZS0+ZGVsaXZlcmFibGUtPnByb2plY3Q7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJHByb2plY3RzID0gUHJvamVjdDo6d2hlcmVJbigiaWQiLCBhcnJheV9rZXlzKGNvbGxlY3QoJHByb2plY3RzKS0+Z3JvdXBCeSgnaWQnKS0+dG9BcnJheSgpKSktPmdldCgpOwoKICAgICAgICAgICAgICAgICRkZWxpdmVyYWJsZXMgPSBbXTsKICAgICAgICAgICAgICAgIGlmKGlzc2V0KCR0YXNrc1swXSkpewogICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCR0YXNrcyBhcyAkdGFzayl7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgkdGFzay0+c3ViRGVsaXZlcmFibGUtPmRlbGl2ZXJhYmxlLT5wcm9qZWN0X2lkID09ICRyZXF1aXNpdGlvbi0+cHJvamVjdF9pZCl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkZGVsaXZlcmFibGVzW10gPSAkdGFzay0+c3ViRGVsaXZlcmFibGUtPmRlbGl2ZXJhYmxlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJGRlbGl2ZXJhYmxlcyA9IERlbGl2ZXJhYmxlczo6d2hlcmVJbigiaWQiLCBhcnJheV9rZXlzKGNvbGxlY3QoJGRlbGl2ZXJhYmxlcyktPmdyb3VwQnkoJ2lkJyktPnRvQXJyYXkoKSkpLT5nZXQoKTsKCiAgICAgICAgICAgICAgICAkbW9kaWZpZWROYW1lID0gZmFsc2U7CiAgICAgICAgICAgICAgICAkdGFzayA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKCRyZXF1aXNpdGlvbi0+cHJvamVjdF90YXNrX2lkKSB7CiAgICAgICAgICAgICAgICAgICAgJHRhc2s9UHJvamVjdFRhc2s6OmZpbmRPckZhaWwoJHJlcXVpc2l0aW9uLT5wcm9qZWN0X3Rhc2tfaWQpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5yZXF1aXNpdGlvbnMuZWRpdCcsIGNvbXBhY3QoJ3RpdGxlJywgJ2NhdGVnb3JpZXMnLCAnZml4ZWRBc3NldENhdGVnb3JpZXMnLCAnY3dpcENhdGVnb3JpZXMnLCAncmVxdWlzaXRpb24nLCdwcm9qZWN0cycsICdkZWxpdmVyYWJsZXMnLCAnY2F0ZWdvcnlfaWQnLCdtb2RpZmllZE5hbWUnLCd0YXNrJykpOwogICAgICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICAgICAgICAgIH0KICAgICAgICB9ZWxzZXsKCiAgICAgICAgICAgIGlmIChyZXF1ZXN0KCktPmhhcygncmVkaXJlY3QnKSAmJiByZXF1ZXN0KCktPmdldCgncmVkaXJlY3QnKSA9PSAnbGlzdC12aWV3Jyl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHRoaXMtPnJlZGlyZWN0QmFja1dpdGhFcnJvcignUmVxdWlzaXRpb24gbm90IGZvdW5kJywncG1zLnJlcXVpc2l0aW9uLmxpc3Qudmlldy5pbmRleCcpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+cmVkaXJlY3RCYWNrV2l0aEVycm9yKCdSZXF1aXNpdGlvbiBub3QgZm91bmQnLCdwbXMucmVxdWlzaXRpb24ucmVxdWlzaXRpb24uaW5kZXgnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFVwZGF0ZSB0aGUgc3BlY2lmaWVkIHJlc291cmNlIGluIHN0b3JhZ2UuCiAgICAgKgogICAgICogQHBhcmFtICBcSWxsdW1pbmF0ZVxIdHRwXFJlcXVlc3QgICRyZXF1ZXN0CiAgICAgKiBAcGFyYW0gIFxBcHBcTW9kZWxzXFJlcXVpc2l0aW9uICAkcmVxdWlzaXRpb24KICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgogICAgcHVibGljIGZ1bmN0aW9uIHVwZGF0ZShSZXF1ZXN0ICRyZXF1ZXN0LCBSZXF1aXNpdGlvbiAkcmVxdWlzaXRpb24pCiAgICB7CiAgICAgICAgaWYoJHJlcXVlc3QtPmhhc0ZpbGUoJ2VkaXRfZmlsZScpKXsKICAgICAgICAgICAgJHRoaXMtPnZhbGlkYXRlKCRyZXF1ZXN0LCBbCiAgICAgICAgICAgICAgICAnZWRpdF9maWxlJyA9PiBbJ21heDoxMDAwMCddLAogICAgICAgICAgICBdKTsKICAgICAgICB9CgogICAgICAgIC8vQmVnaW4gZGIgdHJhbnNhY3Rpb24uCiAgICAgICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgICAgICB0cnkgewoKICAgICAgICAgICAgaWYgKCRyZXF1aXNpdGlvbi0+c3RhdHVzPT0xKSB7CiAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb24tPnJlbWFya3MgPSAkcmVxdWVzdC0+cmVtYXJrczsKICAgICAgICAgICAgICAgIGlmKCRyZXF1ZXN0LT5oYXNGaWxlKCdlZGl0X2ZpbGUnKSl7CiAgICAgICAgICAgICAgICAgICAgaWYoIWVtcHR5KCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkgJiYgZmlsZV9leGlzdHMocHVibGljX3BhdGgoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSkpewogICAgICAgICAgICAgICAgICAgICAgICB1bmxpbmsocHVibGljX3BhdGgoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCA9ICR0aGlzLT5maWxlVXBsb2FkKCRyZXF1ZXN0LT5maWxlKCdlZGl0X2ZpbGUnKSwgJ3VwbG9hZC9yZXF1aXNpdGlvbi1hdHRhY2htZW50cycpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uLT5zYXZlKCk7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgUmVxdWlzaXRpb25JdGVtOjp3aGVyZSgncmVxdWlzaXRpb25faWQnLCRyZXF1aXNpdGlvbi0+aWQpLT5kZWxldGUoKTsKCiAgICAgICAgICAgICAgICAkcmVxdWlzaXRpb24tPnJlcXVpc2l0aW9uX2RhdGUgPSBkYXRlKCdZLW0tZCBoOmk6cycsIHN0cnRvdGltZSgkcmVxdWVzdC0+cmVxdWlzaXRpb25fZGF0ZSkpOwoKICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbi0+cmVtYXJrcyA9ICRyZXF1ZXN0LT5yZW1hcmtzOwogICAgICAgICAgICAgICAgaWYoJHJlcXVlc3QtPmhhc0ZpbGUoJ2VkaXRfZmlsZScpKXsKICAgICAgICAgICAgICAgICAgICBpZighZW1wdHkoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSAmJiBmaWxlX2V4aXN0cyhwdWJsaWNfcGF0aCgkcmVxdWlzaXRpb24tPmF0dGFjaG1lbnQpKSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHVubGluayhwdWJsaWNfcGF0aCgkcmVxdWlzaXRpb24tPmF0dGFjaG1lbnQpKTsKICAgICAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCA9ICR0aGlzLT5maWxlVXBsb2FkKCRyZXF1ZXN0LT5maWxlKCdlZGl0X2ZpbGUnKSwgJ3VwbG9hZC9yZXF1aXNpdGlvbi1hdHRhY2htZW50cycpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbi0+c2F2ZSgpOwoKICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRyZXF1ZXN0LT5wcm9kdWN0X2lkIGFzICRrZXkgPT4gJHByb2R1Y3RfaWQpewogICAgICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbkl0ZW1JbnB1dFtdPVsKICAgICAgICAgICAgICAgICAgICAgICAgJ3JlcXVpc2l0aW9uX2lkJyA9PiAkcmVxdWlzaXRpb24tPmlkLAogICAgICAgICAgICAgICAgICAgICAgICAncHJvZHVjdF9pZCcgPT4gJHJlcXVlc3QtPnByb2R1Y3RfaWRbJGtleV0sCiAgICAgICAgICAgICAgICAgICAgICAgICdxdHknID0+ICRyZXF1ZXN0LT5xdHlbJGtleV0sCiAgICAgICAgICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvbl9xdHknID0+IChyZXF1ZXN0KCktPmhhcygnZWRpdG9yJykgJiYgcmVxdWVzdCgpLT5nZXQoJ2VkaXRvcicpID09ICJib3NzIiA/ICRyZXF1ZXN0LT5vbGRfcXR5WyRrZXldIDogJHJlcXVlc3QtPnF0eVska2V5XSksCiAgICAgICAgICAgICAgICAgICAgICAgICdjcmVhdGVkX2F0JyA9PiBkYXRlKCdZLW0tZCBoOmk6cycpLAogICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgUmVxdWlzaXRpb25JdGVtOjppbnNlcnQoJHJlcXVpc2l0aW9uSXRlbUlucHV0KTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgREI6OmNvbW1pdCgpOwoKICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+aGFzKCdyZWRpcmVjdCcpICYmIHJlcXVlc3QoKS0+Z2V0KCdyZWRpcmVjdCcpID09ICdsaXN0LXZpZXcnKXsKICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+cmVkaXJlY3RCYWNrV2l0aFN1Y2Nlc3MoJ1JlcXVpc2l0aW9uIGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSBVcGRhdGVkJywncG1zLnJlcXVpc2l0aW9uLmxpc3Qudmlldy5pbmRleCcpOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgIHJldHVybiAkdGhpcy0+cmVkaXJlY3RCYWNrV2l0aFN1Y2Nlc3MoJ1JlcXVpc2l0aW9uIGhhcyBiZWVuIHN1Y2Nlc3NmdWxseSBVcGRhdGVkJywncG1zLnJlcXVpc2l0aW9uLnJlcXVpc2l0aW9uLmluZGV4Jyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgfQogICAgICAgIGNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJlbW92ZSB0aGUgc3BlY2lmaWVkIHJlc291cmNlIGZyb20gc3RvcmFnZS4KICAgICAqCiAgICAgKiBAcGFyYW0gIFxBcHBcTW9kZWxzXFJlcXVpc2l0aW9uICAkcmVxdWlzaXRpb24KICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gZGVzdHJveSgkaWQpCiAgICB7CiAgICAgICAgJHJlcXVpc2l0aW9uID0gUmVxdWlzaXRpb246OmZpbmQoJGlkKTsKICAgICAgICBpZighaW5fYXJyYXkoJHJlcXVpc2l0aW9uLT5zdGF0dXMsIFswLCAyLCAzXSkpewogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gIlJlcXVpc2l0aW9uIGNhbm5vdCBiZSBkZWxldGVkISIKICAgICAgICAgICAgXSk7CiAgICAgICAgfQoKICAgICAgICAkcmVxdWlzaXRpb24gPSBSZXF1aXNpdGlvbjo6ZmluZCgkaWQpOwogICAgICAgICRkZWxldGUgPSBSZXF1aXNpdGlvbjo6ZmluZCgkaWQpLT5kZWxldGUoKTsKICAgICAgICBpZigkZGVsZXRlKXsKICAgICAgICAgICAgaWYoIWVtcHR5KCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkgJiYgZmlsZV9leGlzdHMocHVibGljX3BhdGgoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSkpewogICAgICAgICAgICAgICAgdW5saW5rKHB1YmxpY19wYXRoKCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIAogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gdHJ1ZSwKICAgICAgICAgICAgXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICJTb21ldGhpbmcgd2VudCB3cm9uZyEiCiAgICAgICAgXSk7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGRlc3Ryb3lJdGVtKFJlcXVpc2l0aW9uSXRlbSAkaXRlbSkKICAgIHsKICAgICAgICB0cnkgewogICAgICAgICAgICAkcmVxdWlzaXRpb24gPSAkaXRlbS0+cmVxdWlzaXRpb247CiAgICAgICAgICAgICRpdGVtLT5kZWxldGUoKTsKICAgICAgICAgICAgaWYgKCRyZXF1aXNpdGlvbi0+aXRlbXMtPmNvdW50KCkgPCAxKXsKICAgICAgICAgICAgICAgICRyZXF1aXNpdGlvbi0+ZGVsZXRlKCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oJHJlcXVpc2l0aW9uLT5pdGVtcy0+Y291bnQoKSk7CiAgICAgICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CiAgICAgICAgICAgIHJldHVybiByZXNwb25zZSgpLT5qc29uKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CgogICAgLyoqCiAgICAgKiBSZnAgbGlzdCB2aWV3LgogICAgICovCiAgICBwdWJsaWMgZnVuY3Rpb24gdXNlckhlYWRlckNvbHVtbnMoJHZhbHVlPScnKQogICAgewogICAgICAgICRyb3c9IGFycmF5KAogICAgICAgICAgICBbJ1NMJywgJ1NMJ10sIAogICAgICAgICAgICBbJ3JlZmVyZW5jZV9ubycsICdyZWZlcmVuY2Vfbm8nLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydyZXF1aXNpdGlvbl9kYXRlJywgJ3JlcXVpc2l0aW9uX2RhdGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydwcm9kdWN0X2NhdGVnb3J5JywgJ3Byb2R1Y3RfY2F0ZWdvcnknLCAndGV4dC1jZW50ZXInXSwKICAgICAgICAgICAgWydyZXF1aXNpdGlvbl9ieScsICdyZXF1aXNpdGlvbl9ieScsICd0ZXh0LWNlbnRlciddLCAKICAgICAgICAgICAgWyd1bml0JywgJ3VuaXQnLCAndGV4dC1jZW50ZXInXSwgCiAgICAgICAgICAgIFsnYXR0YWNobWVudCcsICdhdHRhY2htZW50JywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgICAgIFsnc3RhdHVzJywgJ3N0YXR1cycsICd0ZXh0LWNlbnRlciddLCAKICAgICAgICAgICAgWydhY3Rpb25zJywgJ2FjdGlvbnMnLCAndGV4dC1jZW50ZXInXQogICAgICAgICk7CiAgICAgICAgcmV0dXJuICRyb3c7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIHJlcXVpc2l0aW9uTGlzdFZpZXcoKQogICAgewogICAgICAgIHRyeSB7CgogICAgICAgICAgICAkdGl0bGUgPSAnVXNlciBSZXF1aXNpdGlvbiBMaXN0JzsKICAgICAgICAgICAgJHN0YXR1cyA9IHJlcXVlc3QoKS0+aGFzKCdzdGF0dXMnKSA/IHJlcXVlc3QoKS0+Z2V0KCdzdGF0dXMnKSA6IC0xOwogICAgICAgICAgICAkZnJvbSA9IHJlcXVlc3QoKS0+aGFzKCdmcm9tJykgPyByZXF1ZXN0KCktPmdldCgnZnJvbScpIDogZGF0ZSgnWS1tLTAxJyk7CiAgICAgICAgICAgICR0byA9IHJlcXVlc3QoKS0+aGFzKCd0bycpID8gcmVxdWVzdCgpLT5nZXQoJ3RvJykgOiBkYXRlKCdZLW0tdCcpOwogICAgICAgICAgICAkY2F0ZWdvcnlfaWQgPSByZXF1ZXN0KCktPmhhcygnY2F0ZWdvcnlfaWQnKSA/IHJlcXVlc3QoKS0+Z2V0KCdjYXRlZ29yeV9pZCcpIDogMDsKICAgICAgICAgICAgJGF1dGhvcl9pZCA9IHJlcXVlc3QoKS0+aGFzKCdhdXRob3JfaWQnKSA/IHJlcXVlc3QoKS0+Z2V0KCdhdXRob3JfaWQnKSA6IDA7CgogICAgICAgICAgICAkY2F0ZWdvcmllcyA9IENhdGVnb3J5Ojpkb2VzbnRIYXZlKCdjYXRlZ29yeScpCiAgICAgICAgICAgIC0+d2hlcmVIYXMoJ2RlcGFydG1lbnRzTGlzdCcsIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUluKCdocl9kZXBhcnRtZW50X2lkJywgYXV0aCgpLT51c2VyKCktPnByaW9yaXRpZXMtPnBsdWNrKCdocl9kZXBhcnRtZW50X2lkJyktPnRvQXJyYXkoKSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+Z2V0KCk7CgogICAgICAgICAgICAkaW5jbHVkZVVzZXJzID0gaW5jbHVkZVVzZXJzKCk7CgogICAgICAgICAgICAkcmVxdWlzaXRpb25Vc2VyTGlzdHMgPSBSZXF1aXNpdGlvbjo6d2hlcmVJbignYXV0aG9yX2lkJywgJGluY2x1ZGVVc2VycykKICAgICAgICAgICAgLT5qb2luKCd1c2VycycsJ3VzZXJzLmlkJywnPScsJ3JlcXVpc2l0aW9ucy5hdXRob3JfaWQnKQogICAgICAgICAgICAtPmdyb3VwQnkoJ3JlcXVpc2l0aW9ucy5hdXRob3JfaWQnKQogICAgICAgICAgICAtPmdldChbJ3VzZXJzLmlkJywndXNlcnMubmFtZSddKTsKCiAgICAgICAgICAgICRkYXRhID0gWwogICAgICAgICAgICAgICAgJ3RpdGxlJz0+J1JlcXVpc2l0aW9uJywKICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvblVzZXJMaXN0cycgPT4gJHJlcXVpc2l0aW9uVXNlckxpc3RzLAogICAgICAgICAgICAgICAgJ2Zyb20nID0+ICRmcm9tLAogICAgICAgICAgICAgICAgJ3RvJyA9PiAkdG8sCiAgICAgICAgICAgICAgICAnc3RhdHVzJyA9PiAkc3RhdHVzLAogICAgICAgICAgICAgICAgJ2NhdGVnb3J5X2lkJyA9PiAkY2F0ZWdvcnlfaWQsCiAgICAgICAgICAgICAgICAnYXV0aG9yX2lkJyA9PiAkYXV0aG9yX2lkLAogICAgICAgICAgICAgICAgJ2NhdGVnb3JpZXMnID0+ICRjYXRlZ29yaWVzLAogICAgICAgICAgICAgICAgJ2hlYWRlckNvbHVtbnMnID0+ICR0aGlzLT51c2VySGVhZGVyQ29sdW1ucygpCiAgICAgICAgICAgIF07CgogICAgICAgICAgICAkcmVxdWlzaXRpb25zID0gUmVxdWlzaXRpb246OndpdGgoWydpdGVtcycsJ2l0ZW1zLnByb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLCdyZWxVc2Vyc0xpc3QnLCdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUudW5pdCddKQogICAgICAgICAgICAtPndoZXJlSW4oJ2F1dGhvcl9pZCcsICRpbmNsdWRlVXNlcnMpCiAgICAgICAgICAgIC0+d2hlbihzdHJ0b3RpbWUoJGZyb20pPjAsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRmcm9tKXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlRGF0ZSgncmVxdWlzaXRpb25fZGF0ZScsICc+PScsICRmcm9tKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVuKHN0cnRvdGltZSgkdG8pPjAsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCR0byl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZURhdGUoJ3JlcXVpc2l0aW9uX2RhdGUnLCAnPD0nLCAkdG8pOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPndoZW4oJHN0YXR1cz49MCwgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHN0YXR1cyl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnc3RhdHVzJywgJHN0YXR1cyk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbigkYXV0aG9yX2lkPjAsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRhdXRob3JfaWQpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2F1dGhvcl9pZCcsJGF1dGhvcl9pZCk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbigkY2F0ZWdvcnlfaWQ+MCwgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGNhdGVnb3J5X2lkKXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdpdGVtcy5wcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGNhdGVnb3J5X2lkKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnaWQnLCAkY2F0ZWdvcnlfaWQpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0pCiAgICAgICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT53aGVyZU5vdEluKCdzdGF0dXMnLCBbM10pOwoKICAgICAgICAgICAgaWYgKHJlcXVlc3QoKS0+YWpheCgpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gRGF0YXRhYmxlczo6b2YoJHJlcXVpc2l0aW9ucykKICAgICAgICAgICAgICAgIC0+YWRkSW5kZXhDb2x1bW4oKQogICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdyZWZlcmVuY2Vfbm8nLCBmdW5jdGlvbigkcmVxdWlzaXRpb24pewogICAgICAgICAgICAgICAgICAgIHJldHVybiAgJzxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgZGF0YS1zcmM9Iicucm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5saXN0LnZpZXcuc2hvdycsJHJlcXVpc2l0aW9uLT5pZCkuJyIgY2xhc3M9ImJ0biBidG4tbGluayByZXF1aXNpdGlvbiBtLTEgcm91bmRlZCBzaG93UmVxdWlzdGlvbkRldGFpbHMiIG9uY2xpY2s9InJlcXVpc3Rpb25EZXRhaWxzKCQodGhpcykpIj4nLiAkcmVxdWlzaXRpb24tPnJlZmVyZW5jZV9ubyAuJzwvYT4nOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZWRpdENvbHVtbigncmVxdWlzaXRpb25fZGF0ZScsIGZ1bmN0aW9uKCRyZXF1aXNpdGlvbil7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGUoJ1ktbS1kJyxzdHJ0b3RpbWUoJHJlcXVpc2l0aW9uLT5yZXF1aXNpdGlvbl9kYXRlKSk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5vcmRlckNvbHVtbigncmVxdWlzaXRpb25fZGF0ZScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyQnkoJ3JlcXVpc2l0aW9uX2RhdGUnLCAkb3JkZXIpOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdwcm9kdWN0X2NhdGVnb3J5JywgZnVuY3Rpb24oJHJlcXVpc2l0aW9uKXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gaXNzZXQoJHJlcXVpc2l0aW9uLT5pdGVtc1swXS0+cHJvZHVjdC0+Y2F0ZWdvcnktPmNhdGVnb3J5LT5uYW1lKT8kcmVxdWlzaXRpb24tPml0ZW1zWzBdLT5wcm9kdWN0LT5jYXRlZ29yeS0+Y2F0ZWdvcnktPm5hbWU6Jyc7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3Byb2R1Y3RfY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdpdGVtcy5wcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3Byb2R1Y3RfY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBSZXF1aXNpdGlvbkl0ZW06OnNlbGVjdCgnbWFpbl9jYXRlZ29yeS5uYW1lJykKICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdwcm9kdWN0cycsICdwcm9kdWN0cy5pZCcsICc9JywgJ3JlcXVpc2l0aW9uX2l0ZW1zLnByb2R1Y3RfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2NhdGVnb3JpZXMgYXMgc3ViX2NhdGVnb3J5JywgJ3N1Yl9jYXRlZ29yeS5pZCcsICc9JywgJ3Byb2R1Y3RzLmNhdGVnb3J5X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT5qb2luKCdjYXRlZ29yaWVzIGFzIG1haW5fY2F0ZWdvcnknLCAnbWFpbl9jYXRlZ29yeS5pZCcsICc9JywgJ3N1Yl9jYXRlZ29yeS5wYXJlbnRfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPndoZXJlQ29sdW1uKCdyZXF1aXNpdGlvbl9pdGVtcy5yZXF1aXNpdGlvbl9pZCcsICdyZXF1aXNpdGlvbnMuaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPnRha2UoMSkKICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1aXNpdGlvbl9ieScsIGZ1bmN0aW9uKCRyZXF1aXNpdGlvbil7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCRyZXF1aXNpdGlvbi0+cmVsVXNlcnNMaXN0LT5uYW1lKT8gJHJlcXVpc2l0aW9uLT5yZWxVc2Vyc0xpc3QtPm5hbWUgOicnOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdyZXF1aXNpdGlvbl9ieScsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFVzZXJzTGlzdCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCduYW1lJywgJ0xJS0UnLCAnJScuJGtleXdvcmQuJyUnKTsKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdyZXF1aXNpdGlvbl9ieScsIGZ1bmN0aW9uICgkcXVlcnksICRvcmRlcikgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBwbGVhc2VTb3J0TWUoJHF1ZXJ5LCAkb3JkZXIsIFVzZXI6OnNlbGVjdCgnbmFtZScpCiAgICAgICAgICAgICAgICAgICAgICAgIC0+d2hlcmVDb2x1bW4oJ3VzZXJzLmlkJywgJ3JlcXVpc2l0aW9ucy5hdXRob3JfaWQnKQogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5hZGRDb2x1bW4oJ3VuaXQnLCBmdW5jdGlvbigkcmVxdWlzaXRpb24pewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpc3NldCgkcmVxdWlzaXRpb24tPnJlbFVzZXJzTGlzdC0+ZW1wbG95ZWUtPnVuaXQtPmhyX3VuaXRfc2hvcnRfbmFtZSk/JHJlcXVpc2l0aW9uLT5yZWxVc2Vyc0xpc3QtPmVtcGxveWVlLT51bml0LT5ocl91bml0X3Nob3J0X25hbWU6Jyc7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3VuaXQnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxVc2Vyc0xpc3QuZW1wbG95ZWUudW5pdCcsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdocl91bml0X3Nob3J0X25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+b3JkZXJDb2x1bW4oJ3VuaXQnLCBmdW5jdGlvbiAoJHF1ZXJ5LCAkb3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gcGxlYXNlU29ydE1lKCRxdWVyeSwgJG9yZGVyLCBcQXBwXFVzZXI6OnNlbGVjdCgnaHJfdW5pdC5ocl91bml0X3Nob3J0X25hbWUnKQogICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2hyX2FzX2Jhc2ljX2luZm8nLCAnaHJfYXNfYmFzaWNfaW5mby5hc3NvY2lhdGVfaWQnLCAnPScsICd1c2Vycy5hc3NvY2lhdGVfaWQnKQogICAgICAgICAgICAgICAgICAgICAgICAtPmpvaW4oJ2hyX3VuaXQnLCAnaHJfdW5pdC5ocl91bml0X2lkJywgJz0nLCAnaHJfYXNfYmFzaWNfaW5mby5hc191bml0X2lkJykKICAgICAgICAgICAgICAgICAgICAgICAgLT53aGVyZUNvbHVtbigndXNlcnMuaWQnLCAncmVxdWlzaXRpb25zLmF1dGhvcl9pZCcpCiAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAtPmFkZENvbHVtbignYXR0YWNobWVudCcsIGZ1bmN0aW9uKCRyZXF1aXNpdGlvbil7CiAgICAgICAgICAgICAgICAgICAgJGF0dGFjaG1lbnQgPScnOwogICAgICAgICAgICAgICAgICAgIGlmKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdFbXBsb3llZScpIHx8IGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdEZXBhcnRtZW50LUhlYWQnKSB8fCBhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnUHVyY2hhc2UtRGVwYXJ0bWVudCcpKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYoIWVtcHR5KCRyZXF1aXNpdGlvbi0+YXR0YWNobWVudCkgJiYgZmlsZV9leGlzdHMocHVibGljX3BhdGgoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSkpewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGF0dGFjaG1lbnQuPSc8YSBocmVmPSInLiB1cmwoJHJlcXVpc2l0aW9uLT5hdHRhY2htZW50KSAuJyIgdGFyZ2V0PSJfYmxhbmsiIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1wcmltYXJ5Ij48aSBjbGFzcz0ibGFzIGxhLXBhcGVyY2xpcCI+PC9pPkF0dGFjaG1lbnQ8L2E+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gJGF0dGFjaG1lbnQ7CiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdzdGF0dXMnLCBmdW5jdGlvbigkcmVxdWlzaXRpb24pewogICAgICAgICAgICAgICAgICAgICRzdGF0dXMgPScnOwoKICAgICAgICAgICAgICAgICAgICBpZigkcmVxdWlzaXRpb24tPnN0YXR1cz09MCl7CiAgICAgICAgICAgICAgICAgICAgICAgICRzdGF0dXMuPSc8c3BhbiBjbGFzcz0iYnRuIGJ0bi14cyBidG4td2FybmluZyI+UGVuZGluZzwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlaWYoJHJlcXVpc2l0aW9uLT5zdGF0dXM9PTEpewoKICAgICAgICAgICAgICAgICAgICAgICAgJHN0YXR1cy49JzxzcGFuIGNsYXNzPSJidG4gYnRuLXhzIGJ0bi1zdWNjZXNzIj5BY2tub3dsZWRnZTwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlaWYoJHJlcXVpc2l0aW9uLT5zdGF0dXM9PTIpewogICAgICAgICAgICAgICAgICAgICAgICAkc3RhdHVzLj0nPHNwYW4gY2xhc3M9ImJ0biBidG4teHMgYnRuLWRhbmdlciI+SGFsdDwvc3Bhbj4nOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAkc3RhdHVzIC49JzwvcD4nOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAkc3RhdHVzOwogICAgICAgICAgICAgICAgfSkKICAgICAgICAgICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgPSAnJzsKCiAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMuPSc8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPjxidXR0b24gY2xhc3M9ImJ0biBkcm9wZG93bi10b2dnbGUiIGRhdGEtdG9nZ2xlPSJkcm9wZG93biI+PHNwYW4gaWQ9InN0YXR1c05hbWUnLiR2YWx1ZXMtPmlkLiciPjxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIGZpbGw9ImN1cnJlbnRDb2xvciIgY2xhc3M9ImJpIGJpLXRocmVlLWRvdHMtdmVydGljYWwiIHZpZXdCb3g9IjAgMCAxNiAxNiI+PHBhdGggZD0iTTkuNSAxM2ExLjUgMS41IDAgMSAxLTMgMCAxLjUgMS41IDAgMCAxIDMgMHptMC01YTEuNSAxLjUgMCAxIDEtMyAwIDEuNSAxLjUgMCAwIDEgMyAwem0wLTVhMS41IDEuNSAwIDEgMS0zIDAgMS41IDEuNSAwIDAgMSAzIDB6Ii8+PC9zdmc+PC9zcGFuPjwvYnV0dG9uPjx1bCBjbGFzcz0iZHJvcGRvd24tbWVudSI+JzsKCiAgICAgICAgICAgICAgICAgICAgaWYoJHZhbHVlcy0+aXNfc2VuZF90b19yZnA9PSdubycpewogICAgICAgICAgICAgICAgICAgICAgICBpZigkdmFsdWVzLT5zdGF0dXMgIT0wICYmIGF1dGgoKS0+dXNlcigpLT5oYXNQZXJtaXNzaW9uVG8oJ3BlbmRpbmcnKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucy49JzxsaT48YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIHRpdGxlPSJDbGljayBIZXJlIFRvIFBlbmRpbmciIGNsYXNzPSJyZXF1aXNpdGlvbkFwcHJvdmVkQnRuIiBkYXRhLWlkPSInLiR2YWx1ZXMtPmlkLiciIG9uY2xpY2s9InJlcXVpc2l0aW9uQXBwcm92ZWRCdG4oJCh0aGlzKSkiICBkYXRhLWRhdGE9InBlbmRpbmciIGRhdGEtc3RhdHVzPSIwIj48aSBjbGFzcz0ibGEgbGEtcGF1c2UiPjwvaT5QZW5kaW5nPC9hPjwvbGk+JzsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSc8bGk+PGEgaHJlZj0iJy5yb3V0ZSgncG1zLnJlcXVpc2l0aW9uLnJlcXVpc2l0aW9uLmVkaXQnLCR2YWx1ZXMtPmlkKS4nP3JlZGlyZWN0PWxpc3QtdmlldyZlZGl0b3I9Ym9zcyIgdGl0bGU9IkNsaWNrIEhlcmUgVG8gRWRpdCI+PGkgY2xhc3M9ImxhIGxhLWVkaXQiPjwvaT5FZGl0PC9hPjwvbGk+JzsKCiAgICAgICAgICAgICAgICAgICAgICAgIGlmKCR2YWx1ZXMtPnN0YXR1cyAhPTEpewoKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihhdXRoKCktPnVzZXIoKS0+aGFzUGVybWlzc2lvblRvKCdyZXF1aXNpdGlvbi1hY2tub3dsZWRnZScpKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucy49JzxsaT48YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIHRpdGxlPSJDbGljayBIZXJlIFRvIEFja25vd2xlZGdlIiBjbGFzcz0icmVxdWlzaXRpb25BcHByb3ZlZEJ0biIgb25jbGljaz0icmVxdWlzaXRpb25BcHByb3ZlZEJ0bigkKHRoaXMpKSIgZGF0YS1pZD0iJy4kdmFsdWVzLT5pZC4nIiBkYXRhLWRhdGE9ImFja25vd2xlZGdlZCIgZGF0YS1zdGF0dXM9IjEiPjxpIGNsYXNzPSJsYSBsYS1jaGVjayI+PC9pPkFja25vd2xlZGdlPC9hPjwvbGk+JzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAgICAgaWYoYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25UbygnaGFsdCcpKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKCR2YWx1ZXMtPnN0YXR1cyAhPSAyKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucyAuPSc8bGk+PGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiB0aXRsZT0iQ2xpY2sgSGVyZSBUbyBIYWx0IiBjbGFzcz0icmVxdWlzaXRpb25BcHByb3ZlZEJ0biIgb25jbGljaz0icmVxdWlzaXRpb25BcHByb3ZlZEJ0bigkKHRoaXMpKSIgZGF0YS1kYXRhPSJoYWx0IiBkYXRhLWlkPSInLiR2YWx1ZXMtPmlkLiciIGRhdGEtc3RhdHVzPSIyIj48aSBjbGFzcz0ibGEgbGEtYmFuIj48L2k+SGFsdDwvYT48L2xpPic7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYoYXV0aCgpLT51c2VyKCktPmhhc1Blcm1pc3Npb25Ubygnc2VuZC10by1yZnAnKSl7CiAgICAgICAgICAgICAgICAgICAgICAgICRhY3Rpb25zIC49JzxsaT48YSBjbGFzcz0ic2VuZFRvUHVyY2hhc2VEZXBhcnRtZW50IiBkYXRhLXNyYz0iJy5yb3V0ZSgncG1zLnN0b3JlLW1hbmFnZS5zZW5kLnRvLnB1cmNoYXNlLmRlcGFydG1lbnQnKS4nIiBvbmNsaWNrPSJzZW5kVG9QdXJjaGFzZURlcGFydG1lbnQoJCh0aGlzKSkiICBkYXRhLWlkPSInLiR2YWx1ZXMtPmlkLiciICB0aXRsZT0iU2VuZCBUbyBwcm9jdXJlbWVudCI+U2VuZCBUbyBQcm9jdXJlbWVudDwvYT48L2xpPic7CiAgICAgICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICAgICAkYWN0aW9ucy49JzxsaT48YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIHRpdGxlPSJUcmFja2luZyBSZXF1aXNpdGlvbiIgY2xhc3M9InRyYWNraW5nUmVxdWlzdGlvblN0YXR1cyIgb25jbGljaz0idHJhY2tpbmdSZXF1aXN0aW9uU3RhdHVzKCcuJHZhbHVlcy0+aWQuJykiID48aSBjbGFzcz0ibGEgbGEtbWFwIj48L2k+VHJhY2sgUHJvZ3Jlc3M8L2E+PC9saT4nOwoKICAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMgLj0gJzxsaT48YSB0YXJnZXQ9Il9fYmxhbmsiIGhyZWY9Iicucm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5oaXN0b3J5JywkdmFsdWVzLT5pZCkuJyI+PGkgY2xhc3M9ImxhIGxhLWhpc3RvcnkiIHRpdGxlPSJSZXF1aXNpdGlvbiBIaXN0b3J5Ij48L2k+UmVxdWlzaXRpb24gSGlzdG9yeTwvYT48L2xpPC9hPjwvbGk+JzsKCgogICAgICAgICAgICAgICAgICAgICRhY3Rpb25zLj0nPC91bD48L2Rpdj4nOwogICAgICAgICAgICAgICAgICAgIHJldHVybiAkYWN0aW9uczsKCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgLT5yYXdDb2x1bW5zKFsncmVmZXJlbmNlX25vJywnc3RhdHVzJywnYXR0YWNobWVudCcsICdhY3Rpb25zJ10pCiAgICAgICAgICAgICAgICAtPm1ha2UodHJ1ZSk7CiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIHJldHVybiB2aWV3KCdwbXMuYmFja2VuZC5wYWdlcy5yZXF1aXNpdGlvbnMucmVxdWlzaXRpb24tbGlzdC1pbmRleCcsICRkYXRhKTsKICAgICAgICB9Y2F0Y2ggKFRocm93YWJsZSAkdGgpewogICAgICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KCiAgICAvKioKICAgICAqIFJmcCBsaXN0IHZpZXcgc2VyYXJjaC4KICAgICAqIFNlYXJjaCBiZXR3ZWVuIGZyb20gYW5kIHRvIGRhdGUgYW5kIGFsc28gdXNlciBjYW4gc2VhcmNoIGJ5IGVtcGxveWVlCiAgICAgKiBAcGFyYW0gIFxJbGx1bWluYXRlXEh0dHBcUmVxdWVzdCAgJHJlcXVlc3QKICAgICAqIEByZXR1cm4gXElsbHVtaW5hdGVcSHR0cFxSZXNwb25zZQogICAgICovCgogICAgZnVuY3Rpb24gbmVlZHRva2VlcCgpewogICAgICAgICRyZXF1aXN0aW9ucz1SZXF1aXNpdGlvbjo6d2hlbihpc3NldChBdXRoOjp1c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFVzZXJzTGlzdC5lbXBsb3llZScsZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhc19kZXBhcnRtZW50X2lkJyxBdXRoOjp1c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSkKICAgICAgICAtPndoZXJlKCdzdGF0dXMnLDApCiAgICAgICAgLT5nZXQoKTsKCiAgICAgICAgJHJlcXVpc3Rpb25fZGF0YSA9IFtdOwogICAgICAgIGZvcmVhY2ggKCRyZXF1aXN0aW9ucyBhcyAkcmVxdWlzdGlvbil7CiAgICAgICAgICAgICR0cD0wOwogICAgICAgICAgICBmb3JlYWNoICgkcmVxdWlzdGlvbi0+aXRlbXMgYXMgJGl0ZW0pewogICAgICAgICAgICAgICAgJHRwICs9ICgkaXRlbS0+cHJvZHVjdC0+dW5pdF9wcmljZSAqICRpdGVtLT5xdHkpOwogICAgICAgICAgICB9OwogICAgICAgICAgICAkcmVxdWlzdGlvbi0+dG90YWxfcHJpY2UgPSAkdHA7CiAgICAgICAgICAgIGZvcmVhY2ggKEF1dGg6OnVzZXIoKS0+cmVsQXBwcm92YWxSYW5nZSBhcyAkcmFuZ2UpewogICAgICAgICAgICAgICAgaWYgKCRyYW5nZS0+bWluX2Ftb3VudCA8PSAkcmVxdWlzdGlvbi0+dG90YWxfcHJpY2UgJiYgJHJhbmdlLT5tYXhfYW1vdW50ID49ICRyZXF1aXN0aW9uLT50b3RhbF9wcmljZSl7CiAgICAgICAgICAgICAgICAgICAgJHJlcXVpc3Rpb25fZGF0YVtdID0gJHJlcXVpc3Rpb247CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuICR0aGlzLT5wYWdpbmF0ZSgkcmVxdWlzdGlvbl9kYXRhLCAzMCk7CiAgICB9CiAgICAvKioKICAgICAqIFJmcCBsaXN0IHZpZXcuCiAgICAgKiBDaGFuZ2UgcmVxdWlzaXRvbiBzdGF0dXMgKEFwcHJvdmUgYW5kIHJlamVjdGVkKQogICAgICogQHBhcmFtICBcSWxsdW1pbmF0ZVxIdHRwXFJlcXVlc3QgICRyZXF1ZXN0CiAgICAgKiBAcmV0dXJuIFxJbGx1bWluYXRlXEh0dHBcUmVzcG9uc2UKICAgICAqLwoKICAgIHB1YmxpYyBmdW5jdGlvbiB0b2dnbGVSZXF1aXNpdGlvblN0YXR1cyhSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewogICAgICAgICRyZXF1aXNpdGlvbiA9IFJlcXVpc2l0aW9uOjp3aGVyZSgnaWQnLCRyZXF1ZXN0LT5pZCktPmZpcnN0KCk7CiAgICAgICAgaWYoaXNzZXQoJHJlcXVpc2l0aW9uLT5pZCkpewoKICAgICAgICAgICAgJG5ld1N0YXR1cyA9ICRyZXF1ZXN0LT5zdGF0dXM7CiAgICAgICAgICAgICRuZXdUZXh0ID0gJG5ld1N0YXR1cyA9PSAxID8gJ0Fja25vd2xlZGdlJyA6ICgoJG5ld1N0YXR1cyA9PSAyKT8gJ0hhbHQnIDogJ1BlbmRpbmcnKTsKICAgICAgICAgICAgJG5ld0FwcHJvdmVkID0gJG5ld1N0YXR1cyA9PSAxID8gMTooKCRuZXdTdGF0dXMgPT0gMik/IDEgOiBOdWxsKTsKICAgICAgICAgICAgJG5ld01lc3NhZ2U9ICRuZXdTdGF0dXMgPT0gMSA/ICdTdWNjZXNmdWxseSBVcGRhdGVkIFRvIEFja25vd2xlZGdlbWVudCcgOiAoKCRuZXdTdGF0dXMgPT0gMik/ICdTdWNjZXNmdWxseSBVcGRhdGVkIFRvIEhhbHQnIDogKCgkbmV3U3RhdHVzID09IDApPyAnU3VjY2VzZnVsbHkgU2VuZCB0byAnLihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRGVwYXJ0bWVudC1IZWFkJykgPyAnU0JVIGhlYWQnIDogKGF1dGgoKS0+dXNlcigpLT5oYXNSb2xlKCdTQlUgSGVhZCcpID8gJ01hbmFnZW1lbnQnIDogJ0RlcGFydG1lbnQgaGVhZCcpKTonU3VjY2VzZnVsbHkgVXBkYXRlZCBUbyBQZW5kaW5nJykpOwoKICAgICAgICAgICAgJHVwZGF0ZSA9ICRyZXF1aXNpdGlvbi0+dXBkYXRlKFsKICAgICAgICAgICAgICAgICdzdGF0dXMnID0+ICRuZXdTdGF0dXMsCiAgICAgICAgICAgICAgICAnYXBwcm92ZWRfaWQnID0+ICRuZXdBcHByb3ZlZCwKICAgICAgICAgICAgICAgICdhZG1pbl9yZW1hcmsnID0+ICRyZXF1ZXN0LT5hZG1pbl9yZW1hcmssCiAgICAgICAgICAgICAgICAndXBkYXRlZF9hdCcgPT4gZGF0ZSgnWS1tLWQgSDppOnMnKSwKICAgICAgICAgICAgICAgICd1cGRhdGVkX2J5JyA9PiBBdXRoOjp1c2VyKCktPmlkLAogICAgICAgICAgICAgICAgJ2FwcHJvdmVkX2J5JyA9PiBBdXRoOjp1c2VyKCktPmlkCiAgICAgICAgICAgIF0pOwogICAgICAgICAgICBpZiAoJG5ld1N0YXR1cz09MSkgewogICAgICAgICAgICAgICAgUmVxdWlzaXRpb25UcmFja2luZzo6c3RvcmVSZXF1aXNpdGlvblRyYWNraW5nKCRyZXF1aXNpdGlvbi0+aWQsJ2FwcHJvdmVkJyk7CgogICAgICAgICAgICAgICAgJG1lc3NhZ2U9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJy5yb3V0ZSgncG1zLnN0b3JlLW1hbmFnZS5zdG9yZS5pbnZlbnRvcnkuY29tcGFyZScsJHJlcXVpc2l0aW9uLT5pZCkuJyIgZGF0YS10aXRsZT0iUmVxdWlzaXRpb24gRGV0YWlscyI+UmVmZXJlbmNlIE5vOicuJHJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm8uJy5XYXR0aW5nIGZvciBQcm9jdXJlbWVudC9EZWxpdmVyeS48L3NwYW4+JzsKCiAgICAgICAgICAgICAgICBDcmVhdGVPclVwZGF0ZU5vdGlmaWNhdGlvbignJyxnZXRNYW5hZ2VySW5mbygnU3RvcmUtTWFuYWdlcicsJHJlcXVpc2l0aW9uLT5ocl91bml0X2lkKSwkbWVzc2FnZSwndW5yZWFkJywnc2VuZC10by1zdG9yZScsJycpOwogICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlKCktPmpzb24oWwogICAgICAgICAgICAgICAgICAgICdzdWNjZXNzJyA9PiB0cnVlLAogICAgICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAnU3VjY2VzZnVsbHkgVXBkYXRlZCBUbyBBY2tub3dsZWRnZW1lbnQnLAogICAgICAgICAgICAgICAgICAgICduZXdfdGV4dCcgPT4gJG5ld1RleHQKICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICBpZiAoJG5ld1N0YXR1cyA9PSAwKSB7CiAgICAgICAgICAgICAgICBSZXF1aXNpdGlvblRyYWNraW5nOjpzdG9yZVJlcXVpc2l0aW9uVHJhY2tpbmcoJHJlcXVpc2l0aW9uLT5pZCwncGVuZGluZycpOwogICAgICAgICAgICAgICAgJG1lc3NhZ2U9ICc8c3BhbiBjbGFzcz0ibm90aWZpY2F0aW9uLWxpbmtzIiBkYXRhLXNyYz0iJy5yb3V0ZSgncG1zLnJlcXVpc2l0aW9uLmxpc3Qudmlldy5zaG93JywkcmVxdWlzaXRpb24tPmlkKS4nIiBkYXRhLXRpdGxlPSJSZXF1aXNpdGlvbiBEZXRhaWxzIj5SZWZlcmVuY2UgTm86Jy4kcmVxdWlzaXRpb24tPnJlZmVyZW5jZV9uby4nLiBXYXR0aW5nIGZvciBhcHByb3ZhbC48L3NwYW4+JzsKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgJHJlY2VpdmVyID0gZ2V0RGVwYXJ0bWVudEhlYWQoJHJlcXVpc2l0aW9uLT5hdXRob3JfaWQpOwogICAgICAgICAgICAgICAgJHJlY2VpdmVyX3NsdWcgPSAnc2VuZC10by1kZXBhcnRtZW50LWhlYWQnOwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBpZihhdXRoKCktPnVzZXIoKS0+aGFzUm9sZSgnRGVwYXJ0bWVudC1IZWFkJykpewogICAgICAgICAgICAgICAgICAgICRyZWNlaXZlciA9IGdldE1hbmFnZXJJbmZvKCdTQlUgSGVhZCcsIGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfdW5pdF9pZCk7CiAgICAgICAgICAgICAgICAgICAgJHJlY2VpdmVyX3NsdWcgPSAnc2VuZC10by1zYnUtaGVhZCc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgaWYoYXV0aCgpLT51c2VyKCktPmhhc1JvbGUoJ1NCVSBIZWFkJykpewogICAgICAgICAgICAgICAgICAgICRyZWNlaXZlciA9IGdldE1hbmFnZXJJbmZvKCdNYW5hZ2VtZW50Jyk7CiAgICAgICAgICAgICAgICAgICAgJHJlY2VpdmVyX3NsdWcgPSAnc2VuZC10by1tYW5hZ21lbnQnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICBDcmVhdGVPclVwZGF0ZU5vdGlmaWNhdGlvbignJywgJHJlY2VpdmVyLCRtZXNzYWdlLCAndW5yZWFkJywgJHJlY2VpdmVyX3NsdWcsICcnKTsKICAgICAgICAgICAgfQoKICAgICAgICAgICAgaWYoJHVwZGF0ZSl7CiAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAgICAgJ3N1Y2Nlc3MnID0+IHRydWUsCiAgICAgICAgICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICRuZXdNZXNzYWdlLAogICAgICAgICAgICAgICAgICAgICduZXdfdGV4dCcgPT4gJG5ld1RleHQKICAgICAgICAgICAgICAgIF0pOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICAgICAnc3VjY2VzcycgPT4gZmFsc2UsCiAgICAgICAgICAgICAgICAnbWVzc2FnZScgPT4gJ1NvbWV0aGluZyBXZW50IFdyb25nIScKICAgICAgICAgICAgXSk7CiAgICAgICAgfQoKICAgICAgICByZXR1cm4gcmVzcG9uc2UoKS0+anNvbihbCiAgICAgICAgICAgICdzdWNjZXNzJyA9PiBmYWxzZSwKICAgICAgICAgICAgJ21lc3NhZ2UnID0+ICdEYXRhIG5vdCBmb3VuZCEnCiAgICAgICAgXSk7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGhhbHRSZXF1aXNpdGlvblN0YXR1cyhSZXF1ZXN0c1xQbXNcUmVxdWlzaXRpb25SZXF1ZXN0ICRyZXF1ZXN0KXsKCiAgICAgICAgLy9GaW5kIHJlcXVpc3Rpb24KICAgICAgICAkcmVxdWlzaXRpb24gPSBSZXF1aXNpdGlvbjo6ZmluZE9yRmFpbCgkcmVxdWVzdC0+aWQpOyAgIAogICAgICAgIHRyeXsKICAgICAgICAgICAgLy9JZiBmaW5kIHRoZW4gdXBkYXRlCiAgICAgICAgICAgICRyZXF1aXNpdGlvbi0+dXBkYXRlKFsKICAgICAgICAgICAgICAgICdhZG1pbl9yZW1hcmsnID0+ICRyZXF1ZXN0LT5hZG1pbl9yZW1hcmssCiAgICAgICAgICAgICAgICAnc3RhdHVzJyA9PiAyLAogICAgICAgICAgICAgICAgJ3VwZGF0ZWRfYXQnID0+IGRhdGUoJ1ktbS1kIEg6aTpzJyksCiAgICAgICAgICAgICAgICAndXBkYXRlZF9ieScgPT4gQXV0aDo6dXNlcigpLT5pZAogICAgICAgICAgICBdKTsKCiAgICAgICAgICAgICRtZXNzYWdlPSAnPHNwYW4gY2xhc3M9Im5vdGlmaWNhdGlvbi1saW5rcyIgZGF0YS1zcmM9Iicucm91dGUoJ3Btcy5yZXF1aXNpdGlvbi5saXN0LnZpZXcuc2hvdycsJHJlcXVpc2l0aW9uLT5pZCkuJyIgZGF0YS10aXRsZT0iUmVxdWlzaXRpb24gRGV0YWlscyI+UmVmZXJlbmNlIE5vOicuJHJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm8uJy4gRGVwYXJ0bWVudCBIZWFkIEhhbHQgVGhpcyBSZXF1aXNpdGlvbi4uPC9zcGFuPic7CiAgICAgICAgICAgIENyZWF0ZU9yVXBkYXRlTm90aWZpY2F0aW9uKCcnLCRyZXF1aXNpdGlvbi0+YXV0aG9yX2lkLCRtZXNzYWdlLCd1bnJlYWQnLCdyZXF1aXNpdGlvbicsJycpOwoKICAgICAgICAgICAgLy9SZXF1aXN0aW9uIHRyYWNraW5nIGZ1bmN0aW9uIGNhbGwKICAgICAgICAgICAgUmVxdWlzaXRpb25UcmFja2luZzo6c3RvcmVSZXF1aXNpdGlvblRyYWNraW5nKCRyZXF1aXNpdGlvbi0+aWQsJ2hhbHQnLCRyZXF1ZXN0LT5hZG1pbl9yZW1hcmspOwogICAgICAgICAgICAvL05vdHRpZmljYXRpb24KICAgICAgICAgICAgLy9JZiBzdWNjZXNzIHRoZW4gcmV0dXJuIHdpdGggc3VjY2VzcyBtZXNzYWdlCiAgICAgICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhTdWNjZXNzKCdSZXF1aXNpdGlvbiBTdWNjZXNzZnVsbHkgSGFsdCcpOwoKICAgICAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKICAgICAgICB9CiAgICB9CiAgICBwdWJsaWMgZnVuY3Rpb24gc2hvd1RyYWNraW5nKFJlcXVlc3QgJHJlcXVlc3QpewogICAgICAgIHRyeXsKICAgICAgICAgICAgJHJlc3BvbnNlID0gW107CiAgICAgICAgICAgICRyZXF1aXNpdGlvbiA9IFJlcXVpc2l0aW9uOjp3aXRoKFsKICAgICAgICAgICAgICAgICdyZXF1aXNpdGlvblRyYWNraW5nJwogICAgICAgICAgICBdKQogICAgICAgICAgICAtPmZpbmRPckZhaWwoJHJlcXVlc3QtPmlkKTsKICAgICAgICAgICAgJHJlc3BvbnNlID0gWwogICAgICAgICAgICAgICAgJ3Jlc3VsdCcgPT4gJ3N1Y2Nlc3MnLAogICAgICAgICAgICAgICAgJ2JvZHknID0+IFZpZXc6Om1ha2UoJ3Btcy5iYWNrZW5kLnBhZ2VzLnJlcXVpc2l0aW9ucy50cmFja2luZycsIFsKICAgICAgICAgICAgICAgICAgICAncmVxdWlzaXRpb24nID0+ICRyZXF1aXNpdGlvbgogICAgICAgICAgICAgICAgXSktPnJlbmRlcigpCiAgICAgICAgICAgIF07CiAgICAgICAgfWNhdGNoKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgJHJlc3BvbnNlID0gWwogICAgICAgICAgICAgICAgJ3Jlc3VsdCcgPT4gJ2Vycm9yJywKICAgICAgICAgICAgICAgICdtZXNzYWdlJyA9PiAkdGgtPmdldE1lc3NhZ2UoKQogICAgICAgICAgICBdOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuICRyZXNwb25zZTsKICAgIH0KCiAgICBwdWJsaWMgIGZ1bmN0aW9uIG5vdGlmaWNhdGlvbkhlYWRlckNvbHVtbnMoJHZhbHVlPScnKQogICAgewogICAgICAgJHJvdyA9IGFycmF5KAogICAgICAgIFsnU0wnLCAnU0wnXSwgCiAgICAgICAgWydkYXRlJywgJ2NyZWF0ZWRfYXQnLCAndGV4dC1jZW50ZXInLCd3aWR0aDoxNSUnXSwKICAgICAgICBbJ21lc3NhZ2VzJywgJ21lc3NhZ2VzJywgJ3RleHQtbGVmdCddLAogICAgICAgIFsnc3RhdHVzJywgJ3R5cGUnLCAndGV4dC1jZW50ZXInXSwKICAgICAgICBbJ2FjdGlvbnMnLCAnYWN0aW9ucycsICd0ZXh0LWNlbnRlciBhY3Rpb24nLCd3aWR0aDoxNSUnXQogICAgKTsKICAgICAgIHJldHVybiAkcm93OwogICB9CiAgIHB1YmxpYyBmdW5jdGlvbiBub3RpZmljYXRpb25BbGwoKQogICB7CiAgICB0cnl7CgogICAgICAgICR0aXRsZT0iTm90aWZpY2F0aW9uIjsKICAgICAgICAkbm90aWZpY2F0aW9uID0gTm90aWZpY2F0aW9uOjp3aGVuKGlzc2V0KEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpLGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxVc2VyLmVtcGxveWVlJyxmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2FzX2RlcGFydG1lbnRfaWQnLEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KQogICAgICAgIC0+d2hlbighZGF0YXRhYmxlT3JkZXJpbmcoKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+b3JkZXJieSgnaWQnLCAnZGVzYycpOwogICAgICAgIH0pOwoKICAgICAgICAkdW5yZWFkTm90aWZpY2F0aW9uID0gTm90aWZpY2F0aW9uOjp3aGVyZSgndXNlcl9pZCcsYXV0aCgpLT51c2VyKCktPmlkKS0+d2hlcmUoJ3R5cGUnLCd1bnJlYWQnKS0+Y291bnQoKTsKCiAgICAgICAgaWYgKHJlcXVlc3QoKS0+YWpheCgpKSB7CiAgICAgICAgICAgIHJldHVybiBEYXRhdGFibGVzOjpvZigkbm90aWZpY2F0aW9uKQogICAgICAgICAgICAtPmFkZEluZGV4Q29sdW1uKCkKICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdkYXRlJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICAgICByZXR1cm4gIGRhdGUoJ1ktbS1kJyxzdHJ0b3RpbWUoJHZhbHVlcy0+Y3JlYXRlZF9hdCkpOwogICAgICAgICAgICB9KQogICAgICAgICAgICAtPm9yZGVyQ29sdW1uKCdkYXRlJywgZnVuY3Rpb24gKCRxdWVyeSwgJG9yZGVyKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT5vcmRlckJ5KCdjcmVhdGVkX2F0JywgJG9yZGVyKTsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5lZGl0Q29sdW1uKCdzdGF0dXMnLCBmdW5jdGlvbigkdmFsdWVzKXsKICAgICAgICAgICAgICAgICRzdGF0dXMgPScnOwogICAgICAgICAgICAgICAgJHN0YXR1cyAuPSc8cCBpZD0idHlwZScuJHZhbHVlcy0+aWQuJyIgY2xhc3M9InR5cGUiPic7CgogICAgICAgICAgICAgICAgaWYoJHZhbHVlcy0+dHlwZT09J3JlYWQnKXsKCiAgICAgICAgICAgICAgICAgICAkc3RhdHVzLj0nPHNwYW4gY2xhc3M9ImJ0biBidG4tc20gYnRuLXN1Y2Nlc3MiPjxpIGNsYXNzPSJsYXMgbGEtY2hlY2stY2lyY2xlIj48L2k+PC9zcGFuPic7CiAgICAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgICAgJHN0YXR1cy49JzxzcGFuIGNsYXNzPSJidG4gYnRuLXNtIGJ0bi13YXJuaW5nIj48aSBjbGFzcz0ibGFzIGxhLWluYm94Ij48L2k+PC9zcGFuPic7CgogICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAkc3RhdHVzIC49JzwvcD4nOwogICAgICAgICAgICAgICByZXR1cm4gJHN0YXR1czsKICAgICAgICAgICB9KQogICAgICAgICAgICAtPmFkZENvbHVtbignYWN0aW9ucycsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICAgICAgJGFjdGlvbnMgPSAnJzsKICAgICAgICAgICAgICAgICRhY3Rpb25zID0gJzxwIGlkPSJhY3Rpb24nLiR2YWx1ZXMtPmlkLiciIGNsYXNzPSJhY3Rpb24iPic7CiAgICAgICAgICAgICAgICBpZigkdmFsdWVzLT50eXBlPT0ndW5yZWFkJyl7CiAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMuPSc8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPgogICAgICAgICAgICAgICAgICAgIDxidXR0b24gY2xhc3M9ImJ0biBkcm9wZG93bi10b2dnbGUiIGRhdGEtdG9nZ2xlPSJkcm9wZG93biI+CiAgICAgICAgICAgICAgICAgICAgPHNwYW4gaWQ9InN0YXR1c05hbWUnLiR2YWx1ZXMtPmlkLiciPgogICAgICAgICAgICAgICAgICAgIDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIGZpbGw9ImN1cnJlbnRDb2xvciIgY2xhc3M9ImJpIGJpLXRocmVlLWRvdHMtdmVydGljYWwiIHZpZXdCb3g9IjAgMCAxNiAxNiI+PHBhdGggZD0iTTkuNSAxM2ExLjUgMS41IDAgMSAxLTMgMCAxLjUgMS41IDAgMCAxIDMgMHptMC01YTEuNSAxLjUgMCAxIDEtMyAwIDEuNSAxLjUgMCAwIDEgMyAwem0wLTVhMS41IDEuNSAwIDEgMS0zIDAgMS41IDEuNSAwIDAgMSAzIDB6Ii8+PC9zdmc+PC9zcGFuPjwvYnV0dG9uPjx1bCBjbGFzcz0iZHJvcGRvd24tbWVudSI+JzsKCiAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMuPSc8bGk+PGEgaHJlZj0iamF2YXNjcmlwdDp2b2lkKDApIiBjbGFzcz0ibWFya0FzUmVhZCIgZGF0YS1pZD0iJy4kdmFsdWVzLT5pZC4nIiBvbmNsaWNrPSJtYXJrQXNSZWFkKCQodGhpcykpIiB0aXRsZT0iTWFyayBBcyBSZWFkIj48aSBjbGFzcz0ibGEgbGEtY2hlY2siPjwvaT4gTWFyayBBcyBSZWFkPC9hPjwvbGk+PC91bD48L2Rpdj4nOwogICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgJGFjdGlvbnMuPSdBbHJlYWR5IFJlYWQnOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgJGFjdGlvbnMuPSc8L3A+JzsKICAgICAgICAgICAgICAgIHJldHVybiAkYWN0aW9uczsKICAgICAgICAgICAgfSkKICAgICAgICAgICAgLT5lc2NhcGVDb2x1bW5zKFtdKQogICAgICAgICAgICAtPnJhd0NvbHVtbnMoWydtZXNzYWdlcycsJ3N0YXR1cycsJ2FjdGlvbnMnXSkKICAgICAgICAgICAgLT5tYWtlKHRydWUpOwogICAgICAgIH0KCiAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnJlcXVpc2l0aW9ucy5ub3RpZmljYXRpb24tbGlzdCcsIFsndGl0bGUnPT4kdGl0bGUsCiAgICAgICAgICAgICd1bnJlYWROb3RpZmljYXRpb24nID0+ICR1bnJlYWROb3RpZmljYXRpb24sJ2hlYWRlckNvbHVtbnMnPT4kdGhpcy0+bm90aWZpY2F0aW9uSGVhZGVyQ29sdW1ucygpXSk7CiAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICByZXR1cm4gJHRoaXMtPmJhY2tXaXRoRXJyb3IoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgfQp9CgpwdWJsaWMgZnVuY3Rpb24gbWFya0FzUmVhZChSZXF1ZXN0ICRyZXF1ZXN0KQp7CiAgICAkcmVzcG9uc2U9W107CiAgICAgICAgLy9GaW5kIG5vdGlmaWNhdGlvbgogICAgJG5vdGlmaWNhdGlvbiA9IE5vdGlmaWNhdGlvbjo6d2hlcmUoJ2lkJywkcmVxdWVzdC0+aWQpLT5maXJzdCgpOwoKICAgIERCOjpiZWdpblRyYW5zYWN0aW9uKCk7CiAgICB0cnkgewoKICAgICAgICBpZiAoaXNzZXQoJG5vdGlmaWNhdGlvbikpIHsKICAgICAgICAgICAgJG5vdGlmaWNhdGlvbi0+dHlwZSA9ICdyZWFkJzsKICAgICAgICAgICAgJG5vdGlmaWNhdGlvbi0+cmVhZF9hdCA9IGRhdGUoJ1ktbS1kIGg6aTpzJyk7CiAgICAgICAgICAgICRub3RpZmljYXRpb24tPnNhdmUoKTsKCiAgICAgICAgICAgIERCOjpjb21taXQoKTsKICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdzdWNjZXNzJzsKICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAnU3VjY2Vzc2Z1bGx5IFJlYWQgTm90aWZpY2F0aW9uJzsKICAgICAgICAgICAgJHJlc3BvbnNlWyd0b3RhbF9ub3RpZmljYXRpb24nXSA9IE5vdGlmaWNhdGlvbjo6d2hlcmUoJ3R5cGUnLCd1bnJlYWQnKS0+d2hlcmUoJ3VzZXJfaWQnLGF1dGg6OnVzZXIoKS0+aWQpLT53aGVuKGlzc2V0KEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpLGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsVXNlci5lbXBsb3llZScsZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXNfZGVwYXJ0bWVudF9pZCcsQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSktPmNvdW50KCk7CgogICAgICAgIH1lbHNlewogICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ2Vycm9yJzsKICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAnTm8gTm90aWZpY2F0aW9uIEZvdW5kJzsKICAgICAgICAgICAgJHJlc3BvbnNlWyd0b3RhbF9ub3RpZmljYXRpb24nXSA9IE5vdGlmaWNhdGlvbjo6d2hlcmUoJ3R5cGUnLCd1bnJlYWQnKS0+d2hlcmUoJ3VzZXJfaWQnLGF1dGg6OnVzZXIoKS0+aWQpLT53aGVuKGlzc2V0KEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpLGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsVXNlci5lbXBsb3llZScsZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXNfZGVwYXJ0bWVudF9pZCcsQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCk7CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfSktPmNvdW50KCk7CiAgICAgICAgfQoKICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgICAgIERCOjpyb2xsYmFjaygpOwogICAgICAgIHJldHVybiAkdGhpcy0+YmFja1dpdGhFcnJvcigkdGgtPmdldE1lc3NhZ2UoKSk7CiAgICB9CgogICAgcmV0dXJuICRyZXNwb25zZTsKfQoKcHVibGljIGZ1bmN0aW9uIG1hcmtBc1JlYWRBbGwoUmVxdWVzdCAkcmVxdWVzdCkKewogICAgJHJlc3BvbnNlPVtdOwoKICAgICRub3RpZmljYXRpb25zID0gTm90aWZpY2F0aW9uOjp3aGVyZSgndXNlcl9pZCcsYXV0aCgpLT51c2VyKCktPmlkKS0+d2hlcmUoJ3R5cGUnLCd1bnJlYWQnKS0+Z2V0KCk7CgogICAgREI6OmJlZ2luVHJhbnNhY3Rpb24oKTsKICAgIHRyeSB7CgogICAgICAgIGlmIChjb3VudCgkbm90aWZpY2F0aW9ucyk+MCkgewoKICAgICAgICAgICAgZm9yZWFjaCgkbm90aWZpY2F0aW9ucyBhcyAkbm90aWZpY2F0aW9uKXsKICAgICAgICAgICAgICAgIE5vdGlmaWNhdGlvbjo6d2hlcmUoJ2lkJywkbm90aWZpY2F0aW9uLT5pZCktPnVwZGF0ZSgKICAgICAgICAgICAgICAgICAgICBbJ3R5cGUnPT4ncmVhZCcsJ3JlYWRfYXQnPT5kYXRlKCdZLW0tZCBoOmk6cycpXQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ3N1Y2Nlc3MnOwogICAgICAgICAgICAkcmVzcG9uc2VbJ21lc3NhZ2UnXSA9ICdTdWNjZXNzZnVsbHkgUmVhZCBOb3RpZmljYXRpb24nOwogICAgICAgICAgICAkcmVzcG9uc2VbJ3RvdGFsX25vdGlmaWNhdGlvbiddID0gTm90aWZpY2F0aW9uOjp3aGVyZSgndHlwZScsJ3VucmVhZCcpLT53aGVyZSgndXNlcl9pZCcsYXV0aDo6dXNlcigpLT5pZCktPndoZW4oaXNzZXQoQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCksZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxVc2VyLmVtcGxveWVlJyxmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhc19kZXBhcnRtZW50X2lkJyxBdXRoOjp1c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KS0+Y291bnQoKTsKCiAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnZXJyb3InOwogICAgICAgICAgICAkcmVzcG9uc2VbJ21lc3NhZ2UnXSA9ICdObyBOb3RpZmljYXRpb24gRm91bmQnOwogICAgICAgICAgICAkcmVzcG9uc2VbJ3RvdGFsX25vdGlmaWNhdGlvbiddID0gTm90aWZpY2F0aW9uOjp3aGVyZSgndHlwZScsJ3VucmVhZCcpLT53aGVyZSgndXNlcl9pZCcsYXV0aDo6dXNlcigpLT5pZCktPndoZW4oaXNzZXQoQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCksZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxVc2VyLmVtcGxveWVlJyxmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhc19kZXBhcnRtZW50X2lkJyxBdXRoOjp1c2VyKCktPmVtcGxveWVlLT5hc19kZXBhcnRtZW50X2lkKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KS0+Y291bnQoKTsKICAgICAgICB9CgogICAgICAgIERCOjpjb21taXQoKTsKCiAgICB9Y2F0Y2ggKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICBEQjo6cm9sbGJhY2soKTsKCiAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdlcnJvcic7CiAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAkdGgtPmdldE1lc3NhZ2UoKTsKICAgIH0KCiAgICByZXR1cm4gJHJlc3BvbnNlOwp9CgpwdWJsaWMgZnVuY3Rpb24gZEhlYWRlckNvbHVtbnMoJHZhbHVlPScnKQp7CiAgICAkcm93PSBhcnJheSgKICAgICAgICBbJ1NMJywgJ1NMJ10sIAogICAgICAgIFsncmVmZXJlbmNlX25vJywgJ3JlZmVyZW5jZV9ubycsICd0ZXh0LWNlbnRlciddLAogICAgICAgIFsncmVxdWlzaXRpb25fZGF0ZScsICdyZXF1aXNpdGlvbl9kYXRlJywgJ3RleHQtY2VudGVyJ10sCiAgICAgICAgWydkZWxpdmVyZWRfcmVmX25vJywgJ2RlbGl2ZXJlZF9yZWZfbm8nLCAndGV4dC1jZW50ZXInXSwKICAgICAgICBbJ2RlbGl2ZXJ5X2RhdGUnLCAnZGVsaXZlcnlfZGF0ZScsICd0ZXh0LWNlbnRlciddLAogICAgICAgIFsnY2F0ZWdvcnknLCAnY2F0ZWdvcnknLCAndGV4dC1jZW50ZXInXSwKICAgICAgICBbJ3N1Yl9jYXRlZ29yeScsICdzdWJfY2F0ZWdvcnknLCAndGV4dC1jZW50ZXInXSwKICAgICAgICBbJ3Byb2R1Y3QnLCAncHJvZHVjdCcsICd0ZXh0LWNlbnRlciddLAogICAgICAgIFsnZGVsaXZlcnlfcXR5JywgJ2RlbGl2ZXJ5X3F0eScsICd0ZXh0LWxlZnQnXSwKICAgICAgICBbJ2FjdGlvbnMnLCAnYWN0aW9ucycsICd0ZXh0LWNlbnRlcicsJ3dpZHRoOjE1JSddCiAgICApOwoKICAgIHJldHVybiAkcm93Owp9CgpwdWJsaWMgZnVuY3Rpb24gZGVsaXZlcmVkUmVxdWlzaXRpb25MaXN0KCkKewogdHJ5ewogICAgJHN0YXR1cyA9IHJlcXVlc3QoKS0+aGFzKCdzdGF0dXMnKSA/IHJlcXVlc3QoKS0+Z2V0KCdzdGF0dXMnKSA6ICcnOwoKICAgICRmcm9tID0gcmVxdWVzdCgpLT5oYXMoJ2Zyb20nKSA/IHJlcXVlc3QoKS0+Z2V0KCdmcm9tJykgOiBkYXRlKCdZLW0tMDEnKTsKICAgICR0byA9IHJlcXVlc3QoKS0+aGFzKCd0bycpID8gcmVxdWVzdCgpLT5nZXQoJ3RvJykgOiBkYXRlKCdZLW0tdCcpOwogICAgJGNhdGVnb3J5X2lkID0gcmVxdWVzdCgpLT5oYXMoJ2NhdGVnb3J5X2lkJykgPyByZXF1ZXN0KCktPmdldCgnY2F0ZWdvcnlfaWQnKSA6IDA7CgogICAgJGNhdGVnb3J5SWRzID0gQ2F0ZWdvcnlEZXBhcnRtZW50Ojp3aGVuKGlzc2V0KGF1dGgoKS0+dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCksIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2hyX2RlcGFydG1lbnRfaWQnLCBhdXRoKCktPnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpOwogICAgfSktPnBsdWNrKCdjYXRlZ29yeV9pZCcpLT50b0FycmF5KCk7CgogICAgJGNhdGVnb3JpZXMgPSBDYXRlZ29yeTo6ZG9lc250SGF2ZSgnY2F0ZWdvcnknKQogICAgLT53aGVyZUluKCdpZCcsICRjYXRlZ29yeUlkcykKICAgIC0+Z2V0KFsnaWQnLCduYW1lJywnY29kZSddKTsKCiAgICAkZGVsaXZlcmVkUmVxdWlzaXRpb24gPSBSZXF1aXNpdGlvbkRlbGl2ZXJ5SXRlbTo6d2l0aChbCiAgICAgICAgJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnkucmVsUmVxdWlzaXRpb24nLAogICAgICAgICdwcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywKICAgICAgICAncHJvZHVjdC5wcm9kdWN0VW5pdCcsCiAgICAgICAgJ3Byb2R1Y3QuYXR0cmlidXRlcy5hdHRyaWJ1dGVPcHRpb24uYXR0cmlidXRlJywKICAgIF0pCiAgICAtPndoZW4oaXNzZXQoQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCksIGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnkucmVsUmVxdWlzaXRpb24ucmVsVXNlcnNMaXN0LmVtcGxveWVlJyxmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXNfZGVwYXJ0bWVudF9pZCcsIEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpOwogICAgICAgIH0pOwogICAgfSkKICAgIC0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnkucmVsUmVxdWlzaXRpb24nLGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2F1dGhvcl9pZCcsQXV0aDo6dXNlcigpLT5pZCk7CiAgICB9KQogICAgLT53aGVuKHN0cnRvdGltZSgkZnJvbSk+MCwgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGZyb20pewogICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5JyxmdW5jdGlvbigkcXVlcnkpIHVzZSgkZnJvbSl7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlRGF0ZSgnZGVsaXZlcnlfZGF0ZScsICc+PScsJGZyb20pOwogICAgICAgIH0pOwogICAgfSkKICAgIC0+d2hlbihzdHJ0b3RpbWUoJHRvKT4wLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkdG8pewogICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5JyxmdW5jdGlvbigkcXVlcnkpIHVzZSgkdG8pewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZURhdGUoJ2RlbGl2ZXJ5X2RhdGUnLCAnPD0nLCR0byk7CiAgICAgICAgfSk7CiAgICB9KQogICAgLT53aGVuKCFlbXB0eSgkc3RhdHVzKSwgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJHN0YXR1cyl7CiAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ3N0YXR1cycsICRzdGF0dXMpOwogICAgfSkKICAgIC0+d2hlbigkY2F0ZWdvcnlfaWQ+MCwgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGNhdGVnb3J5X2lkKXsKICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncmVsUmVxdWlzaXRpb25EZWxpdmVyeS5yZWxSZXF1aXNpdGlvbi5pdGVtcy5wcm9kdWN0LmNhdGVnb3J5LmNhdGVnb3J5JywgZnVuY3Rpb24oJHF1ZXJ5KSB1c2UoJGNhdGVnb3J5X2lkKXsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lkJywgJGNhdGVnb3J5X2lkKTsKICAgICAgICB9KTsKICAgIH0pCiAgICAtPndoZW4oIWVtcHR5KHJlcXVlc3QoKS0+Z2V0KCdzZWFyY2hfdGV4dCcpKSwgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5JywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgncmVmZXJlbmNlX25vJywgJ0xJS0UnLCAnJScucmVxdWVzdCgpLT5nZXQoJ3NlYXJjaF90ZXh0JykuJyUnKTsKICAgIH0pOwogICB9KQogICAgLT53aGVuKCFkYXRhdGFibGVPcmRlcmluZygpLCBmdW5jdGlvbigkcXVlcnkpewogICAgICAgIHJldHVybiAkcXVlcnktPm9yZGVyYnkoJ2lkJywgJ2Rlc2MnKTsKICAgIH0pOwoKICAgIGlmIChyZXF1ZXN0KCktPmFqYXgoKSkgewogICAgICAgIHJldHVybiBEYXRhdGFibGVzOjpvZigkZGVsaXZlcmVkUmVxdWlzaXRpb24pCiAgICAgICAgLT5hZGRJbmRleENvbHVtbigpCiAgICAgICAgLT5hZGRDb2x1bW4oJ3JlZmVyZW5jZV9ubycsIGZ1bmN0aW9uKCR2YWx1ZXMpewogICAgICAgICAgICByZXR1cm4gICc8YSBocmVmPSJqYXZhc2NyaXB0OnZvaWQoMCkiIGRhdGEtc3JjPSInLnJvdXRlKCdwbXMucmVxdWlzaXRpb24ubGlzdC52aWV3LnNob3cnLCR2YWx1ZXMtPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uLT5pZCkuJyIgIGNsYXNzPSJidG4gYnRuLWxpbmsgcmVxdWlzaXRpb24gbS0xIHJvdW5kZWQgc2hvd1JlcXVpc3Rpb25EZXRhaWxzIiBvbmNsaWNrPSJzaG93UmVxdWlzdGlvbkRldGFpbHMoJCh0aGlzKSkiPicuKGlzc2V0KCR2YWx1ZXMtPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm8pPyR2YWx1ZXMtPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnJlbFJlcXVpc2l0aW9uLT5yZWZlcmVuY2Vfbm86JycpLic8L2E+PC90ZD4nOwogICAgICAgIH0pCiAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ3JlZmVyZW5jZV9ubycsIGZ1bmN0aW9uICgkcXVlcnksICRrZXl3b3JkKSB7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LnJlbFJlcXVpc2l0aW9uJywgZnVuY3Rpb24gKCRxdWVyeSkgdXNlKCRrZXl3b3JkKSB7CiAgICAgICAgICAgICAgICAkcXVlcnktPndoZXJlKCdyZWZlcmVuY2Vfbm8nLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KQogICAgICAgIC0+YWRkQ29sdW1uKCdyZXF1aXNpdGlvbl9kYXRlJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgIHJldHVybiBpc3NldCgkdmFsdWVzLT5yZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LT5yZWxSZXF1aXNpdGlvbi0+cmVxdWlzaXRpb25fZGF0ZSk/IGRhdGUoJ1ktbS1kJyxzdHJ0b3RpbWUoJHZhbHVlcy0+cmVsUmVxdWlzaXRpb25EZWxpdmVyeS0+cmVsUmVxdWlzaXRpb24tPnJlcXVpc2l0aW9uX2RhdGUpKTonJzsKICAgICAgICB9KQogICAgICAgIC0+YWRkQ29sdW1uKCdkZWxpdmVyZWRfcmVmX25vJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgIHJldHVybiBpc3NldCgkdmFsdWVzLT5yZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LT5yZWZlcmVuY2Vfbm8pPyR2YWx1ZXMtPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPnJlZmVyZW5jZV9ubzonJzsKICAgICAgICB9KQogICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdkZWxpdmVyZWRfcmVmX25vJywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ3JlZmVyZW5jZV9ubycsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pCiAgICAgICAgLT5hZGRDb2x1bW4oJ2RlbGl2ZXJ5X2RhdGUnLCBmdW5jdGlvbigkdmFsdWVzKXsKICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCR2YWx1ZXMtPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPmRlbGl2ZXJ5X2RhdGUpPyBkYXRlKCdZLW0tZCcsc3RydG90aW1lKCR2YWx1ZXMtPnJlbFJlcXVpc2l0aW9uRGVsaXZlcnktPmRlbGl2ZXJ5X2RhdGUpKTonJzsKICAgICAgICB9KQogICAgICAgIC0+YWRkQ29sdW1uKCdjYXRlZ29yeScsIGZ1bmN0aW9uKCR2YWx1ZXMpewoKICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCR2YWx1ZXMtPnByb2R1Y3QtPmNhdGVnb3J5LT5jYXRlZ29yeS0+bmFtZSk/JHZhbHVlcy0+cHJvZHVjdC0+Y2F0ZWdvcnktPmNhdGVnb3J5LT5uYW1lOicnOwogICAgICAgIH0pCiAgICAgICAgLT5maWx0ZXJDb2x1bW4oJ2NhdGVnb3J5JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3Byb2R1Y3QuY2F0ZWdvcnkuY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KQogICAgICAgIC0+YWRkQ29sdW1uKCdzdWJfY2F0ZWdvcnknLCBmdW5jdGlvbigkdmFsdWVzKXsKICAgICAgICAgICAgcmV0dXJuIGlzc2V0KCR2YWx1ZXMtPnByb2R1Y3QtPmNhdGVnb3J5LT5uYW1lKT8kdmFsdWVzLT5wcm9kdWN0LT5jYXRlZ29yeS0+bmFtZTonJzsKICAgICAgICB9KQogICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdzdWJfY2F0ZWdvcnknLCBmdW5jdGlvbiAoJHF1ZXJ5LCAka2V5d29yZCkgewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZUhhcygncHJvZHVjdC5jYXRlZ29yeScsIGZ1bmN0aW9uICgkcXVlcnkpIHVzZSgka2V5d29yZCkgewogICAgICAgICAgICAgICAgJHF1ZXJ5LT53aGVyZSgnbmFtZScsICdMSUtFJywgJyUnLiRrZXl3b3JkLiclJyk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0pCiAgICAgICAgLT5hZGRDb2x1bW4oJ3Byb2R1Y3QnLCBmdW5jdGlvbigkdmFsdWVzKXsKICAgICAgICAgICAgcmV0dXJuICBpc3NldCgkdmFsdWVzLT5wcm9kdWN0LT5uYW1lKT8kdmFsdWVzLT5wcm9kdWN0LT5uYW1lOicnLihpc3NldCgkdmFsdWVzLT5wcm9kdWN0LT5pZCkgPyBnZXRQcm9kdWN0QXR0cmlidXRlc0Zhc3RlcigkdmFsdWVzLT5wcm9kdWN0KSA6ICcnKTsKICAgICAgICB9KQogICAgICAgIC0+ZmlsdGVyQ29sdW1uKCdwcm9kdWN0JywgZnVuY3Rpb24gKCRxdWVyeSwgJGtleXdvcmQpIHsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3Byb2R1Y3QnLCBmdW5jdGlvbiAoJHF1ZXJ5KSB1c2UoJGtleXdvcmQpIHsKICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmUoJ25hbWUnLCAnTElLRScsICclJy4ka2V5d29yZC4nJScpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KQogICAgICAgIC0+ZWRpdENvbHVtbignZGVsaXZlcnlfcXR5JywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgIHJldHVybiBudW1iZXJfZm9ybWF0KCR2YWx1ZXMtPmRlbGl2ZXJ5X3F0eSwwKTsKICAgICAgICB9KQogICAgICAgIC0+YWRkQ29sdW1uKCdhY3Rpb25zJywgZnVuY3Rpb24oJHZhbHVlcyl7CiAgICAgICAgICAgICRhY3Rpb25zID0gJyc7CiAgICAgICAgICAgICRhY3Rpb25zID0nPHAgaWQ9ImFjdGlvbicuJHZhbHVlcy0+aWQuJyI+JzsKICAgICAgICAgICAgaWYgKCR2YWx1ZXMtPnN0YXR1cz09J3BlbmRpbmcnIHx8JHZhbHVlcy0+c3RhdHVzPT0nZGVsaXZlcmVkJykgewogICAgICAgICAgICAgICAgJGFjdGlvbnMuPSc8ZGl2IGNsYXNzPSJidG4tZ3JvdXAiPgogICAgICAgICAgICAgICAgPGJ1dHRvbiBjbGFzcz0iYnRuIGRyb3Bkb3duLXRvZ2dsZSIgZGF0YS10b2dnbGU9ImRyb3Bkb3duIj4KICAgICAgICAgICAgICAgIDxzcGFuIGlkPSJzdGF0dXNOYW1lJy4kdmFsdWVzLT5pZC4nIj4KICAgICAgICAgICAgICAgICcudWNmaXJzdCgkdmFsdWVzLT5zdGF0dXMpLicgCiAgICAgICAgICAgICAgICA8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2IiBmaWxsPSJjdXJyZW50Q29sb3IiIGNsYXNzPSJiaSBiaS10aHJlZS1kb3RzLXZlcnRpY2FsIiB2aWV3Qm94PSIwIDAgMTYgMTYiPgogICAgICAgICAgICAgICAgPHBhdGggZD0iTTkuNSAxM2ExLjUgMS41IDAgMSAxLTMgMCAxLjUgMS41IDAgMCAxIDMgMHptMC01YTEuNSAxLjUgMCAxIDEtMyAwIDEuNSAxLjUgMCAwIDEgMyAwem0wLTVhMS41IDEuNSAwIDEgMS0zIDAgMS41IDEuNSAwIDAgMSAzIDB6Ii8+CiAgICAgICAgICAgICAgICA8L3N2Zz4KICAgICAgICAgICAgICAgIDwvc3Bhbj4KICAgICAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICAgICAgPHVsIGNsYXNzPSJkcm9wZG93bi1tZW51Ij48bGkgaWQ9ImhpZGVCdG4nLiR2YWx1ZXMtPmlkLiciPjxhIGhyZWY9ImphdmFzY3JpcHQ6dm9pZCgwKSIgb25jbGljaz0iZGVsaXZlcmVkQWNrbm93bGVkZ2UoJCh0aGlzKSkiIGNsYXNzPSJkZWxpdmVyZWRBY2tub3dsZWRnZSIgZGF0YS1pZD0iJy4kdmFsdWVzLT5pZC4nIiB0aXRsZT0iQWNrbm93bGVkZ2VkIj48aSBjbGFzcz0ibGEgbGEtY2hlY2siPjwvaT5BY2tub3dsZWRnZWQ8L2E+CiAgICAgICAgICAgICAgICA8L2xpPgogICAgICAgICAgICAgICAgPC91bD4KICAgICAgICAgICAgICAgIDwvZGl2Pic7CiAgICAgICAgICAgIH1lbHNlewogICAgICAgICAgICAgICAgJGFjdGlvbnMuPSdBY2tub3dsZWRnZWQnOwogICAgICAgICAgICB9CgogICAgICAgICAgICByZXR1cm4gJGFjdGlvbnM7CiAgICAgICAgfSkKICAgICAgICAtPnJhd0NvbHVtbnMoWydyZWZlcmVuY2Vfbm8nLCdwcm9kdWN0JywnYWN0aW9ucyddKQogICAgICAgIC0+bWFrZSh0cnVlKTsKICAgIH0KCiAgICAkZGF0YT1bCiAgICAgICAgJ3RpdGxlJz0+J0RlbGl2ZXJkIFJlcXVpc2l0aW9uJywKICAgICAgICAnZnJvbScgPT4gJGZyb20sCiAgICAgICAgJ3RvJyA9PiAkdG8sCiAgICAgICAgJ3N0YXR1c3MnID0+IFsncGVuZGluZycsJ2Fja25vd2xlZGdlJywnZGVsaXZlcmVkJ10sCiAgICAgICAgJ2NhdGVnb3J5X2lkJyA9PiAkY2F0ZWdvcnlfaWQsCiAgICAgICAgJ2NhdGVnb3JpZXMnID0+ICRjYXRlZ29yaWVzLAogICAgICAgICdoZWFkZXJDb2x1bW5zJyA9PiAkdGhpcy0+ZEhlYWRlckNvbHVtbnMoKSwKICAgIF07CgogICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnJlcXVpc2l0aW9uLWRlbGl2ZXJ5LmRlbGl2ZXJlZC1yZXF1aXNpdGlvbi1saXN0JywkZGF0YSk7Cn1jYXRjaCAoXFRocm93YWJsZSAkdGgpewogICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aEVycm9yKCR0aC0+Z2V0TWVzc2FnZSgpKTsKfQp9CgpwdWJsaWMgZnVuY3Rpb24gZGVsaXZlcmVkUmVxdWlzaXRpb25BY2soUmVxdWVzdCAkcmVxdWVzdCl7ICAgCgogICAgJHJlc3BvbnNlPVtdOwoKICAgICRkZWxpdmVyZWRSZXF1aXNpdGlvbiA9IFJlcXVpc2l0aW9uRGVsaXZlcnlJdGVtOjp3aGVuKGlzc2V0KEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpLGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnkucmVsUmVxdWlzaXRpb24ucmVsVXNlcnNMaXN0LmVtcGxveWVlJyxmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnYXNfZGVwYXJ0bWVudF9pZCcsQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCk7CiAgICAgICAgfSk7CiAgICB9KS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnkucmVsUmVxdWlzaXRpb24nLGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2F1dGhvcl9pZCcsQXV0aDo6dXNlcigpLT5pZCk7CiAgICB9KQogICAgLT53aGVyZSgnaWQnLCRyZXF1ZXN0LT5pZCkKICAgIC0+Zmlyc3QoKTsKCiAgICB0cnl7CiAgICAgICAgaWYgKGlzc2V0KCRkZWxpdmVyZWRSZXF1aXNpdGlvbikpIHsKCiAgICAgICAgICAgICRkZWxpdmVyZWRSZXF1aXNpdGlvbi0+c3RhdHVzID0gJ2Fja25vd2xlZGdlJzsKICAgICAgICAgICAgJGRlbGl2ZXJlZFJlcXVpc2l0aW9uLT5zYXZlKCk7CgogICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ3N1Y2Nlc3MnOwogICAgICAgICAgICAkcmVzcG9uc2VbJ21lc3NhZ2UnXSA9ICdTdWNjZXNzZnVsbHkgQWNrbm93bGVkZ2VkLic7CgogICAgICAgICAgICBSZXF1aXNpdGlvblRyYWNraW5nOjpzdG9yZVJlcXVpc2l0aW9uVHJhY2tpbmcoJGRlbGl2ZXJlZFJlcXVpc2l0aW9uLT5yZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5LT5yZWxSZXF1aXNpdGlvbi0+aWQsJ3JlY2VpdmVkJyk7CgogICAgICAgIH1lbHNlewogICAgICAgICAgICAkcmVzcG9uc2VbJ3Jlc3VsdCddID0gJ2Vycm9yJzsKICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAnTm8gRGF0YSBGb3VuZCc7CiAgICAgICAgfQogICAgfWNhdGNoIChcVGhyb3dhYmxlICR0aCl7CgogICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnZXJyb3InOwogICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJHRoLT5nZXRNZXNzYWdlKCk7CiAgICB9CgogICAgcmV0dXJuICRyZXNwb25zZTsKfQoKICAgIHB1YmxpYyBmdW5jdGlvbiBkZWxpdmVyZWRSZXF1aXNpdGlvblNlYXJjaChSZXF1ZXN0ICRyZXF1ZXN0KQogICAgewogICAgICAgICRyZXNwb25zZSA9IFtdOwoKICAgICAgICAkZnJvbURhdGU9ZGF0ZSgnWS1tLWQgSDppOnMnLHN0cnRvdGltZSgkcmVxdWVzdC0+ZnJvbV9kYXRlKSk7CiAgICAgICAgJHRvRGF0ZT1kYXRlKCdZLW0tZCBIOmk6cycsc3RydG90aW1lKCRyZXF1ZXN0LT50b19kYXRlKSk7CgogICAgICAgICRzdGF0dXM9JHJlcXVlc3QtPnN0YXR1czsKCiAgICAgICAgJGRlbGl2ZXJlZFJlcXVpc2l0aW9uID0gUmVxdWlzaXRpb25EZWxpdmVyeUl0ZW06OndoZW4oaXNzZXQoQXV0aDo6dXNlcigpLT5lbXBsb3llZS0+YXNfZGVwYXJ0bWVudF9pZCksZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnkucmVsUmVxdWlzaXRpb24ucmVsVXNlcnNMaXN0LmVtcGxveWVlJyxmdW5jdGlvbigkcXVlcnkpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2FzX2RlcGFydG1lbnRfaWQnLEF1dGg6OnVzZXIoKS0+ZW1wbG95ZWUtPmFzX2RlcGFydG1lbnRfaWQpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnkucmVsUmVxdWlzaXRpb24nLGZ1bmN0aW9uKCRxdWVyeSl7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlKCdhdXRob3JfaWQnLEF1dGg6OnVzZXIoKS0+aWQpOwogICAgICAgIH0pCiAgICAgICAgLT53aGVuKCRzdGF0dXMsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRzdGF0dXMpewogICAgICAgICAgICByZXR1cm4gJHF1ZXJ5LT53aGVyZSgnc3RhdHVzJywkc3RhdHVzKTsKICAgICAgICB9KQogICAgICAgIC0+d2hlbigkZnJvbURhdGUsIGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCRmcm9tRGF0ZSl7CiAgICAgICAgICAgIHJldHVybiAkcXVlcnktPndoZXJlSGFzKCdyZWxSZXF1aXNpdGlvbkRlbGl2ZXJ5JyxmdW5jdGlvbigkcXVlcnkpIHVzZSgkZnJvbURhdGUpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVEYXRlKCdkZWxpdmVyeV9kYXRlJywgJz49JywkZnJvbURhdGUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9KQogICAgICAgIC0+d2hlbigkdG9EYXRlLCBmdW5jdGlvbigkcXVlcnkpIHVzZSgkdG9EYXRlKXsKICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVIYXMoJ3JlbFJlcXVpc2l0aW9uRGVsaXZlcnknLGZ1bmN0aW9uKCRxdWVyeSkgdXNlKCR0b0RhdGUpewogICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmVEYXRlKCdkZWxpdmVyeV9kYXRlJywgJzw9JywkdG9EYXRlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfSkKICAgICAgICAtPm9yZGVyQnkoJ2lkJywnREVTQycpCiAgICAgICAgLT5wYWdpbmF0ZSgzMCk7CgogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmKGNvdW50KCRkZWxpdmVyZWRSZXF1aXNpdGlvbik+MCkKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgJGJvZHkgPSBWaWV3OjptYWtlKCdwbXMuYmFja2VuZC5wYWdlcy5yZXF1aXNpdGlvbi1kZWxpdmVyeS5kZWxpdmVyZWQtcmVxdWlzaXRpb24tc2VhcmNoJywKICAgICAgICAgICAgICAgICAgICBbJ2RlbGl2ZXJlZFJlcXVpc2l0aW9uJz0+ICRkZWxpdmVyZWRSZXF1aXNpdGlvbl0pOwogICAgICAgICAgICAgICAgJGNvbnRlbnRzID0gJGJvZHktPnJlbmRlcigpOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdzdWNjZXNzJzsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsnYm9keSddID0gJGNvbnRlbnRzOwogICAgICAgICAgICB9ZWxzZXsKICAgICAgICAgICAgICAgICRyZXNwb25zZVsncmVzdWx0J10gPSAnZXJyb3InOwogICAgICAgICAgICAgICAgJHJlc3BvbnNlWydtZXNzYWdlJ10gPSAnTm8gRGF0YSBGb3VuZCEhJzsKICAgICAgICAgICAgfQogICAgICAgIH1jYXRjaCAoXFRocm93YWJsZSAkdGgpewoKICAgICAgICAgICAgJHJlc3BvbnNlWydyZXN1bHQnXSA9ICdlcnJvcic7CiAgICAgICAgICAgICRyZXNwb25zZVsnbWVzc2FnZSddID0gJHRoLT5nZXRNZXNzYWdlKCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiAkcmVzcG9uc2U7CiAgICB9CgogICAgcHVibGljIGZ1bmN0aW9uIGhpc3RvcnkoJGlkKQogICAgewogICAgICAgIHRyeXsKCiAgICAgICAgICAgICR0aXRsZSA9ICJSZXF1aXNpdGlvbiBIaXN0b3J5IjsKCiAgICAgICAgICAgICRyZXF1aXNpdGlvbiA9IFJlcXVlc3RQcm9wb3NhbFJlcXVpc2l0aW9uczo6d2hlcmUoJ3JlcXVpc2l0aW9uX2lkJywkaWQpLT5maXJzdCgpOwoKICAgICAgICAgICAgaWYgKCRyZXF1aXNpdGlvbikgewogICAgICAgICAgICAgICAgJHByb3Bvc2FscyA9ICgkcmVxdWlzaXRpb24tPnJlbFJlcXVlc3RQcm9wb3NhbCk/JHJlcXVpc2l0aW9uLT5yZWxSZXF1ZXN0UHJvcG9zYWw6Jyc7CgogICAgICAgICAgICAgICAgaWYgKCRwcm9wb3NhbHMgJiYgY291bnQoJHByb3Bvc2Fscy0+cmVsUXVvdGF0aW9ucyk+MCkgewogICAgICAgICAgICAgICAgICAgICRwdXJjaGFzZSA9ICRwcm9wb3NhbHMtPnJlbFF1b3RhdGlvbnMoKS0+d2l0aCgncmVsUHVyY2hhc2VPcmRlcicpLT5maXJzdCgpOwogICAgICAgICAgICAgICAgfQoKICAgICAgICAgICAgICAgICRwdXJjaGFzZU9yZGVyID0gaXNzZXQoJHB1cmNoYXNlKT8oIWVtcHR5KCRwdXJjaGFzZS0+cmVsUHVyY2hhc2VPcmRlcik/JHB1cmNoYXNlLT5yZWxQdXJjaGFzZU9yZGVyOicnKTonJzsKCiAgICAgICAgICAgICAgICBpZiAoJHB1cmNoYXNlT3JkZXIpIHsKICAgICAgICAgICAgICAgICAgICAkYmlsbE1hbmFnZSA9IFB1cmNoYXNlT3JkZXI6OndpdGgoWwogICAgICAgICAgICAgICAgICAgICAgICAncmVsR29vZFJlY2VpdmVOb3RlJywKICAgICAgICAgICAgICAgICAgICAgICAgJ3JlbEdvb2RzUmVjZWl2ZWRJdGVtU3RvY2tJbicsCiAgICAgICAgICAgICAgICAgICAgICAgICdyZWxRdW90YXRpb24ucmVsU3VwcGxpZXJzJywKICAgICAgICAgICAgICAgICAgICAgICAgJ3JlbFF1b3RhdGlvbi5leGNoYW5nZVJhdGUuY3VycmVuY3knLAogICAgICAgICAgICAgICAgICAgICAgICAncmVsUHVyY2hhc2VPcmRlckl0ZW1zJywKICAgICAgICAgICAgICAgICAgICAgICAgJ3JlbFBvQXR0YWNobWVudCcKICAgICAgICAgICAgICAgICAgICBdKQogICAgICAgICAgICAgICAgICAgIC0+d2hlcmUoJ2lzX3NlbmQnLCd5ZXMnKQogICAgICAgICAgICAgICAgICAgIC0+d2hlcmVIYXMoJ3JlbEdvb2RSZWNlaXZlTm90ZScsZnVuY3Rpb24gKCRxdWVyeSl7CiAgICAgICAgICAgICAgICAgICAgICAgICRxdWVyeS0+d2hlcmVSYXcoJ3B1cmNoYXNlX29yZGVycy5pZD1nb29kc19yZWNlaXZlZF9ub3Rlcy5wdXJjaGFzZV9vcmRlcl9pZCcpOwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICAgICAgLT53aGVyZUhhcygncmVsR29vZHNSZWNlaXZlZEl0ZW1TdG9ja0luJywgZnVuY3Rpb24oJHF1ZXJ5KXsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICRxdWVyeS0+d2hlcmUoJ2lzX2dybl9jb21wbGV0ZScsJ3llcycpLT53aGVyZSgndG90YWxfYW1vdW50JywgJz4nLCAwKTsKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgICAgIC0+d2hlcmUoJ2lkJywkcHVyY2hhc2VPcmRlci0+aWQpCiAgICAgICAgICAgICAgICAgICAgLT5maXJzdCgpOwogICAgICAgICAgICAgICAgfWVsc2V7CiAgICAgICAgICAgICAgICAgICAgJGJpbGxNYW5hZ2U9Jyc7CiAgICAgICAgICAgICAgICB9CgogICAgICAgICAgICAgICAgcmV0dXJuIHZpZXcoJ3Btcy5iYWNrZW5kLnBhZ2VzLnJmcC5yZnAtaGlzdG9yeScsY29tcGFjdCgndGl0bGUnLCdwdXJjaGFzZU9yZGVyJywncHJvcG9zYWxzJywnYmlsbE1hbmFnZScpKTsKICAgICAgICAgICAgfWVsc2V7CgogICAgICAgICAgICAgICAgJHJlcXVpc2l0aW9uID0gUmVxdWlzaXRpb246OndoZXJlKCdpZCcsJGlkKS0+Zmlyc3QoKTsKCiAgICAgICAgICAgICAgICByZXR1cm4gdmlldygncG1zLmJhY2tlbmQucGFnZXMucmVxdWlzaXRpb25zLmhpc3RvcnknLGNvbXBhY3QoJ3RpdGxlJywncmVxdWlzaXRpb24nKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgCiAgICAgICAgfWNhdGNoKFxUaHJvd2FibGUgJHRoKXsKICAgICAgICAgICAgcmV0dXJuICR0aGlzLT5iYWNrV2l0aFdhcm5pbmcoJHRoLT5nZXRNZXNzYWdlKCkpOwogICAgICAgIH0KICAgIH0KfQoK